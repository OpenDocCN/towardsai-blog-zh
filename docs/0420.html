<html>
<head>
<title>Predicting Sales using R programming</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用R编程预测销售额</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/predicting-sales-using-r-programming-84b66d11c35d?source=collection_archive---------0-----------------------#2020-04-21">https://pub.towardsai.net/predicting-sales-using-r-programming-84b66d11c35d?source=collection_archive---------0-----------------------#2020-04-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="ab60" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我将预测一家跨国零售公司的销售额。这个数据集可以在Kaggle上找到。我们已经获得了每周销售数据，我们根据这些数据训练模型，并使用最佳模型来预测未来日期的每周销售值。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/11323bffa3eeb66ec1eff8ad54dc2d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vlUp4rcmeLYzHOTr.jpg"/></div></div></figure><p id="557a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">所需库</strong>:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="6936" class="lc ld iq ky b gy le lf l lg lh">library(dplyr)<br/>library(forecast)<br/>library(reshape)<br/>library(ggplot2)<br/>library(tidyverse)</span></pre><p id="d26a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">原始数据集包含大约45家商店和99个部门的数据。为了简化计算，我刚刚考虑了1st store的1st部门的数据。我将数据分为两部分——基于日期的sample_ train和sample_test。数据集包含以下字段:</p><ul class=""><li id="472c" class="li lj iq jp b jq jr ju jv jy lk kc ll kg lm kk ln lo lp lq bi translated">商店——商店编号</li><li id="48bf" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">部门——部门编号</li><li id="3f0c" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">日期—星期</li><li id="abac" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">Weekly_Sales —给定商店中给定部门的销售额</li><li id="fda4" class="li lj iq jp b jq lr ju ls jy lt kc lu kg lv kk ln lo lp lq bi translated">IsHoliday —该周是否为特殊假日周</li></ul><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="5641" class="lc ld iq ky b gy le lf l lg lh">dept1_train &lt;- train %&gt;% filter(Store == "1" &amp; Dept == "1")<br/>dept1_test &lt;- test %&gt;% filter(Store == "1" &amp; Dept == "1")<br/>dept1_test$ Weekly_Sales &lt;- 0</span><span id="6835" class="lc ld iq ky b gy lw lf l lg lh">dept1_train$Date &lt;- as.Date(dept1_train$Date , format = "%Y-%m-%d")<br/>sample_train &lt;- dept1_train %&gt;% filter(Date &lt; as.Date("2012-02-06"))<br/>sample_test &lt;- dept1_train %&gt;% filter(Date &gt;= as.Date("2012-02-06"))</span><span id="2ee0" class="lc ld iq ky b gy lw lf l lg lh">summary(sample_train)</span><span id="4352" class="lc ld iq ky b gy lw lf l lg lh">Store        Dept        Date             Weekly_Sales        <br/> Min.   :1   Min.   :1   Min.   :2010-02-05   Min.   :14537     <br/> 1st Qu.:1   1st Qu.:1   1st Qu.:2010-08-06   1st Qu.:16329          <br/> Median :1   Median :1   Median :2011-02-04   Median :18820          <br/> Mean   :1   Mean   :1   Mean   :2011-02-04   Mean   :22777                  <br/> 3rd Qu.:1   3rd Qu.:1   3rd Qu.:2011-08-05   3rd Qu.:23388                  <br/> Max.   :1   Max.   :1   Max.   :2012-02-03   Max.   :57258</span><span id="5d09" class="lc ld iq ky b gy lw lf l lg lh">IsHoliday      <br/>   Mode :logical  <br/>   FALSE:97       <br/>   TRUE :8</span><span id="7360" class="lc ld iq ky b gy lw lf l lg lh">summary(sample_test)</span><span id="2a4e" class="lc ld iq ky b gy lw lf l lg lh">Store        Dept        Date             Weekly_Sales        <br/> Min.   :1   Min.   :1   Min.   :2012-02-10   Min.   :15723   <br/> 1st Qu.:1   1st Qu.:1   1st Qu.:2012-04-14   1st Qu.:16645        <br/> Median :1   Median :1   Median :2012-06-18   Median :18243          <br/> Mean   :1   Mean   :1   Mean   :2012-06-18   Mean   :21784                  <br/> 3rd Qu.:1   3rd Qu.:1   3rd Qu.:2012-08-22   3rd Qu.:22057                  <br/> Max.   :1   Max.   :1   Max.   :2012-10-26   Max.   :57592</span><span id="d6f8" class="lc ld iq ky b gy lw lf l lg lh">IsHoliday      <br/>    Mode :logical  <br/>    FALSE:36       <br/>   TRUE :2</span></pre><p id="2fe3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于样品_训练日期范围从2010年2月5日到2012年2月3日，对于样品_测试日期范围从2012年2月10日到2012年10月26日。我为sample_train的weekly_sales数据创建了一个时间序列。</p><p id="5aed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">时间序列</strong>:在连续的等间隔时间点获取的序列。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="3563" class="lc ld iq ky b gy le lf l lg lh">ts_train_uni &lt;- ts(sample_train$Weekly_Sales , start = c(2010,5) , frequency = 52)</span></pre><p id="6f6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">起点是2010年2月的第一周。频率=52表示它是周数据。</p><p id="d876" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我用来训练数据集的三个模型是ARIMA、霍尔特温特斯和内塔。</p><p id="b71d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> ARIMA </strong>:自回归<em class="lx">综合移动平均线</em></p><p id="edee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它描述了数据点之间的相关性，并考虑了值的差异。显示平稳性的模型是显示数据随着时间的推移而保持不变的模型。大多数经济和市场数据显示趋势，所以差异是用来消除任何趋势或季节性结构。本例中的季节差异为1。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="708d" class="lc ld iq ky b gy le lf l lg lh">arima_model &lt;- auto.arima(ts_train_uni , seasonal.test = "seas"   )<br/>arima_pred = forecast(arima_model , h = 38)<br/>arima_pred &lt;- as.data.frame(arima_pred$mean)</span></pre><p id="b0fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">Holt Winters</strong>:Holt-Winters预测算法允许用户平滑时间序列，并使用该数据预测感兴趣的区域。未知参数通过最小化预测误差的平方来确定。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="9ad6" class="lc ld iq ky b gy le lf l lg lh">holt_model &lt;- HoltWinters(ts_train_uni)<br/>p &lt;- predict(holt_model , 38 , prediction.interval = TRUE)<br/>p &lt;- as.data.frame(p)</span></pre><p id="d00d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> nnetar </strong>:单隐层滞后输入的前馈神经网络，用于预测单变量时间序列。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="27d4" class="lc ld iq ky b gy le lf l lg lh">neural &lt;- nnetar(ts_train_uni)<br/>neural_pred &lt;- forecast(neural , h=38)<br/>neural_pred &lt;- as.data.frame(neural_pred)</span></pre><p id="a64e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在各种模型的帮助下预测值之后，我使用tidyverse包中的add_column函数将预测值追加到sample_test。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="5281" class="lc ld iq ky b gy le lf l lg lh">pred_data &lt;- sample_test %&gt;%add_column(arima_pred = arima_pred$x , holt_pred = p$fit , neural_pred = neural_pred$`Point Forecast`  )</span></pre><p id="8cac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我使用ggplot函数绘制sample_test的weekly_sales数据的值，并将其与我们的模型在同一时期预测的值进行比较。这将有助于我们分析模型的结果。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="c5ad" class="lc ld iq ky b gy le lf l lg lh">pred_data %&gt;% gather(key = "predictions" , value = "value" , -c(Store , Dept , IsHoliday ,Date))%&gt;% <br/>    ggplot(aes(x = Date ,y =  value , colour = predictions)) + geom_line() + scale_x_date(date_breaks = "4 week")</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ly"><img src="../Images/53122166b8ee02a6466413841eb5742e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WFR33GMFyoFSQaWrZj5-Ew.png"/></div></div></figure><p id="249a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">紫线代表的实际weekly_sales数据在开始时有两个峰值，在结束时销售额再次增加。所有模型都捕捉到了第一个峰值。然而，没有一个模型准确地捕捉到第二个峰值。Arima和HoltWinters的模型与weekly_sales数据的其他分布一致，而神经网络模型与实际的周数据相差甚远，可以安全地拒绝。为了计算哪个模型是正确的选择，我们必须找出均方根误差(RMSE)。</p><p id="b969" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> RMSE </strong>是一种常用的衡量模型或估计器预测值与观察值之间差异的方法。它是残差(预测误差)的标准偏差。其计算方式如下:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/1fddf52df242b0601886ed39db639382.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/0*mCuOy32_y-5jpS2W.png"/></div></figure><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="1977" class="lc ld iq ky b gy le lf l lg lh">for (j in 6:ncol(pred_data)) {<br/>  <br/>  error &lt;- pred_data[4] - pred_data[j]<br/>  <br/>  y &lt;- error ^2<br/>  z&lt;- colMeans(y)<br/>  <br/>  rmse[j] &lt;- sqrt(z)<br/>  <br/>}</span><span id="2368" class="lc ld iq ky b gy lw lf l lg lh">&gt;rmse[6] #arima<br/>         <br/>9097.075</span><span id="56bd" class="lc ld iq ky b gy lw lf l lg lh">&gt; rmse[7] #holtwinters<br/>         <br/>9106.965</span><span id="9751" class="lc ld iq ky b gy lw lf l lg lh">&gt; rmse[8] #nnetar<br/>         <br/>10123.48</span></pre><p id="1601" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如所料，Arima和holtwinters的rmse低于nnetar，因为Arima的rmse最低。我用这个模型来预测未来的价值。</p><p id="248b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，对2012年11月2日至2013年7月26日期间的预测是</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="61c3" class="lc ld iq ky b gy le lf l lg lh">ts_train_uni &lt;- ts(dept1_train$Weekly_Sales , start = c(2010,5) , frequency = 52)<br/> <br/> arima_model &lt;- auto.arima(ts_train_uni , seasonal.test = "seas"   )<br/> arima_pred1 = forecast(arima_model , h = 39)<br/> arima_pred1 &lt;- as.data.frame(arima_pred1$mean)<br/> plot(forecast(arima_model , h=39)) #arima plot<br/> dept1_test$Weekly_Sales &lt;- arima_pred1$x<br/> dept1_test &lt;- subset(dept1_test , select = -arima)<br/> dept1_test$Date &lt;- as.Date(dept1_test$Date)</span><span id="c98c" class="lc ld iq ky b gy lw lf l lg lh">ggplot(dept1_test , aes(x = Date , y = Weekly_Sales) ) +     geom_line(color = "blue") + theme_classic() +<br/>   scale_x_date(breaks = "4 weeks")</span></pre><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ma"><img src="../Images/6e04c7085efa643abdf2bf2da2214f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-eoaY7s6-IN2ktn-1BpSUg.png"/></div></div><figcaption class="mb mc gj gh gi md me bd b be z dk translated">预测销售价值</figcaption></figure><p id="df11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个部门在十二月、二月和四月的销售额较高。关于这个部门销售的产品种类，没有提供任何信息。我们已经得到了关于各种假期的信息。此外，包括这些假期在内的周在评估中的权重是非假期周的五倍，并且在此期间折扣很大。因此，我们可以在这几个月中看到这些峰值。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="6eed" class="lc ld iq ky b gy le lf l lg lh">The table below shows the head of the  range of values at 80% and 95% confidence intervals for arima model.</span><span id="d5a2" class="lc ld iq ky b gy lw lf l lg lh">Point Forecast     Lo 80    Hi 80     Lo 95      Hi 95<br/>       36424.86   27138.911  45710.81 22223.227 50626.49<br/>       18689.54   7514.632  29864.45  1598.993 35780.09<br/>       19050.66   7875.752  30225.57  1960.113 36141.21<br/>       20911.25   9736.342  32086.16  3820.703 38001.80<br/>       25293.49  14118.582  36468.40  8202.943 42384.04<br/>       33305.92  22131.012  44480.83 16215.373 50396.47</span></pre><p id="eb76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lx">因此，我们能够使用机器学习模型预测销售价值，并找出不同置信区间的范围。95%的置信区间表示实际值有95%的机会在低95和高95的范围内。在下一篇文章中，我将使用RShiny开发一个交互式工具，该工具用于通过单击按钮来预测值。如果你喜欢这篇文章，请鼓掌并评论。谢谢:)</em></p></div></div>    
</body>
</html>