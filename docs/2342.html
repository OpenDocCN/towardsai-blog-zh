<html>
<head>
<title>Things to watch out for while working with the MTA turnstile data in 2022</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在2022年使用MTA十字转门数据时需要注意的事项</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/things-to-watch-out-while-working-with-the-mta-turnstile-data-in-2022-e557cfc49472?source=collection_archive---------1-----------------------#2021-11-17">https://pub.towardsai.net/things-to-watch-out-while-working-with-the-mta-turnstile-data-in-2022-e557cfc49472?source=collection_archive---------1-----------------------#2021-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="7d2d" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/data-analysis" rel="noopener ugc nofollow" target="_blank">数据分析</a></h2><div class=""/><p id="ec32" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">无论您是使用纽约大都会运输管理局(MTA)的数据进行专业项目还是与训练营相关的项目，您都需要了解一些事情。我的动机是分析这个数据集，作为在<strong class="jy ja">伊斯坦堡数据科学院</strong>的项目的一部分，用于探索性数据分析(<strong class="jy ja"> EDA </strong>)的目的。本项目使用的数据是从<strong class="jy ja">2021年5月到2021年11月</strong>共<strong class="jy ja"> 25周</strong>和<strong class="jy ja">500多万行。</strong></p><p id="10f2" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">数据相关信息从MTA数据字典和其他公开来源收集，总结如下。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="ef64" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">关于数据</strong></p><p id="0e8d" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">大都会运输管理局是北美最大的运输网络，服务于纽约市周围5，000平方英里的旅行区域内的1，530万人口，途经长岛、纽约州东南部和康涅狄格州。</p><p id="b7e6" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">MTA网络包括全国最大的公交车队，比美国所有其他交通系统加起来还多的地铁和通勤列车。MTA的运营机构是MTA纽约市运输公司、MTA公共汽车公司、长岛铁路公司、地铁-北方铁路公司和MTA桥梁与隧道公司。</p><p id="35e4" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><a class="ae lb" href="http://web.mta.info/developers/turnstile.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jy ja">十字转门数据</strong> </a>来源于控制区(车站)的物理设备，用于收集进入系统的费用。收集的数据然后被传输到一个叫做自动售检票系统(AFC)的主机应用程序。</p><p id="58dd" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">每周在<strong class="jy ja">周六</strong>从中央数据库中提取审计登记数据，用于发布。实际的登记数据每隔<strong class="jy ja"> 4小时</strong>在十字转门设备上生成，此时设备将数据上传到中央数据库。</p><p id="733e" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">四小时间隔将不同于其他站点，因为需要错开，以防止审计读数同时淹没系统</strong>。在全系统范围内，站点已被设置为在00至03小时之间开始审核传输，然后在一天的第一次审核后每4小时进行一次。</p><p id="c392" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">数据被分解为每天和每小时的时间段。数据为<strong class="jy ja"> 10位数</strong>和<strong class="jy ja">长，在溢出</strong>时将翻转到零(0)。可能影响数据的其他因素有:</p><ul class=""><li id="7c69" class="lc ld iq jy b jz ka kd ke kh le kl lf kp lg kt lh li lj lk bi translated">需要更换和初始化硬盘的硬件故障。</li><li id="b39c" class="lc ld iq jy b jz ll kd lm kh ln kl lo kp lp kt lh li lj lk bi translated">故障设备造成的数据损坏，或十字转门的重击。</li></ul><p id="7002" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja"/>代表“<strong class="jy ja">定期</strong>计划审计事件(通常每4小时发生一次)</p><ul class=""><li id="79cb" class="lc ld iq jy b jz ka kd ke kh le kl lf kp lg kt lh li lj lk bi translated">由于计划或故障排除活动，审核可能会超过4小时。</li><li id="0a9a" class="lc ld iq jy b jz ll kd lm kh ln kl lo kp lp kt lh li lj lk bi translated">此外，可能还有一个<strong class="jy ja">“reco VR AUD”</strong>条目:这是指已恢复的遗漏审计。如果发送了恢复的审计，并且该审计与先前的寄存器读数相同，则该审计将被忽略。</li></ul><p id="3f9e" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">入口</strong>和<strong class="jy ja">出口</strong>是设备的累计值。该寄存器在系统设置期间初始化。它是一个<strong class="jy ja"> 10位数的数字</strong>,代表特定设备自开始以来的数值数量。在计数器翻转、擦除包含登记数据的存储设备以及更换旋转门的处理设备时，可以进行其他形式的初始化。</p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><p id="59b1" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">探索性数据分析(EDA) </strong></p><p id="21a8" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">数据列:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="a086" class="lz ma iq lv b gy mb mc l md me">Index(['C/A', 'UNIT', 'SCP', 'STATION', 'LINENAME', 'DIVISION', 'DATE', 'TIME',<br/>       'DESC', 'ENTRIES', 'EXITS'],<br/>      dtype='object')</span></pre><p id="2ad7" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">行和列的总数:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="8d3a" class="lz ma iq lv b gy mb mc l md me">df_copy<strong class="lv ja">.</strong>shape</span><span id="7ca8" class="lz ma iq lv b gy mf mc l md me">(5242282, 11)</span></pre><p id="5d72" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">没有空值:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="0e29" class="lz ma iq lv b gy mb mc l md me">df_copy<strong class="lv ja">.</strong>isnull()<strong class="lv ja">.</strong>sum()</span><span id="4408" class="lz ma iq lv b gy mf mc l md me">C/A          0<br/>UNIT         0<br/>SCP          0<br/>STATION      0<br/>LINENAME     0<br/>DIVISION     0<br/>DATE         0<br/>TIME         0<br/>DESC         0<br/>ENTRIES      0<br/>EXITS        0<br/>TURNSTILE    0<br/>dtype: int64</span></pre><p id="b948" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">零个重复值:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="6096" class="lz ma iq lv b gy mb mc l md me">df_copy<strong class="lv ja">.</strong>duplicated()<strong class="lv ja">.</strong>sum()</span><span id="1f59" class="lz ma iq lv b gy mf mc l md me">0</span></pre><p id="f795" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">有379个地铁站:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="c52a" class="lz ma iq lv b gy mb mc l md me">len(df_copy["STATION"]<strong class="lv ja">.</strong>unique())</span><span id="9f08" class="lz ma iq lv b gy mf mc l md me">379</span></pre><p id="b3c2" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">如果您在创建<strong class="jy ja"> 4_Hour_Entries </strong>、<strong class="jy ja"> 4_Hour_Exits、</strong>和<strong class="jy ja"> Foot_Traffic </strong>列之前，按照十字转门和日期时间值从最小值到最大值对值进行排序</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="7b85" class="lz ma iq lv b gy mb mc l md me">df.sort_values([‘TURNSTILE’,’Datetime’], ascending= (True,True) , inplace=True)</span></pre><p id="e42f" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我们使用shift()方法来计算渐变行之间的值</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="0c4c" class="lz ma iq lv b gy mb mc l md me">FOUR_HOUR_ENTRIES = df.ENTRIES - df.ENTRIES.shift(1)<br/>df['FOUR_HOUR_ENTRIES'] = FOUR_HOUR_ENTRIES.fillna(0)</span><span id="fccb" class="lz ma iq lv b gy mf mc l md me">FOUR_HOUR_EXITS = df.EXITS - df.EXITS.shift(1)<br/>df['FOUR_HOUR_EXITS'] = FOUR_HOUR_EXITS.fillna(0)</span></pre><p id="69ea" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">尽管我们已经对值进行了排序，但我们仍然得到大量的正数和负数:</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="1bde" class="lz ma iq lv b gy mb mc l md me">df_copy<strong class="lv ja">.</strong>FOUR_HOUR_ENTRIES<strong class="lv ja">.</strong>max()</span><span id="e6dd" class="lz ma iq lv b gy mf mc l md me">2146993563.0</span><span id="effa" class="lz ma iq lv b gy mf mc l md me">df_copy<strong class="lv ja">.</strong>FOUR_HOUR_ENTRIES<strong class="lv ja">.</strong>min()</span><span id="fe70" class="lz ma iq lv b gy mf mc l md me">-2144271150.0</span><span id="3090" class="lz ma iq lv b gy mf mc l md me">df_copy<strong class="lv ja">.</strong>FOUR_HOUR_EXITS<strong class="lv ja">.</strong>max()</span><span id="6cb4" class="lz ma iq lv b gy mf mc l md me">2133740922.0</span><span id="5c1c" class="lz ma iq lv b gy mf mc l md me">df_copy<strong class="lv ja">.</strong>FOUR_HOUR_EXITS<strong class="lv ja">.</strong>min()</span><span id="3d92" class="lz ma iq lv b gy mf mc l md me">-2133740909.0</span></pre><p id="5d75" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">当我们深入挖掘数据集时，我们发现当天的进出值比第二天大得多。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="0a7c" class="lz ma iq lv b gy mb mc l md me">df_copy[df_copy['FOOT_TRAFFIC'] == df_copy['FOOT_TRAFFIC'].min()]</span><span id="5376" class="lz ma iq lv b gy mf mc l md me">df_copy[df_copy<strong class="lv ja">.</strong>index <strong class="lv ja">==</strong>2472558 ]</span></pre><figure class="lq lr ls lt gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mg"><img src="../Images/8ca3d50d2d1bfb83bbe15c4f3d924fdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h4UpPHLPTGlJaA3wdh8NcA.png"/></div></div></figure><p id="17c7" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">对于'<strong class="jy ja">47–50 STS-ROCK</strong>'特定调查，我们可以看到不规则的时间条目。所以对于所有的十字转门来说，4小时的观察是不一样的。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="2c63" class="lz ma iq lv b gy mb mc l md me">st = '47-50 STS ROCK'</span><span id="a61c" class="lz ma iq lv b gy mf mc l md me">dfx = df_copy[df_copy['STATION']==st].reset_index(drop=True).iloc[10:,:]</span><span id="1859" class="lz ma iq lv b gy mf mc l md me">dfx.plot("Datetime", "FOOT_TRAFFIC")</span><span id="6763" class="lz ma iq lv b gy mf mc l md me">dfx.tail(20)</span></pre><figure class="lq lr ls lt gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mo"><img src="../Images/30a34d3f750c3f856c73a64b72620b5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y9LDowpjOh-_u0NNsErb5Q.png"/></div></div></figure><p id="0915" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">如果你仔细观察数据(在下面的截图中)，你会发现甚至有分钟显示，这是不应该的。这也使得分组非常困难，因为数据收集时间范围是4小时。按分钟输入只会使情况变得更糟..</p><figure class="lq lr ls lt gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mp"><img src="../Images/3700acdd5f011d7cb49f6e24d97a2848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RvVOXGYWKp5swmOZG9uPBw.png"/></div></div></figure><p id="98d4" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我想在这里提到的另一件事是，如果我们不对4_hour_entries和4_hour_exits列设置某个入口级别的限制，正如从下面的截图中可以看到的那样，这些数字会大幅上升。</p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="9550" class="lz ma iq lv b gy mb mc l md me">#Summing up traffic by station</span><span id="8345" class="lz ma iq lv b gy mf mc l md me">station_totals = df_copy.groupby('STATION').sum().sort_values('FOOT_TRAFFIC', ascending=False).head(5)</span><span id="9128" class="lz ma iq lv b gy mf mc l md me">station_totals.sort_values(by='FOOT_TRAFFIC', ascending=False, inplace=True)</span><span id="bf11" class="lz ma iq lv b gy mf mc l md me">station_totals.reset_index(inplace=True)</span><span id="a75d" class="lz ma iq lv b gy mf mc l md me">station_totals['FOUR_HOUR_ENTRIES'] = station_totals['FOUR_HOUR_ENTRIES'].astype('int64')</span><span id="02f1" class="lz ma iq lv b gy mf mc l md me">station_totals['FOUR_HOUR_EXITS'] = station_totals['FOUR_HOUR_EXITS'].astype('int64')</span><span id="3e73" class="lz ma iq lv b gy mf mc l md me">station_totals['FOOT_TRAFFIC'] = station_totals['FOOT_TRAFFIC'].astype('int64')</span><span id="4c09" class="lz ma iq lv b gy mf mc l md me">top_5 = station_totals.head(5)</span><span id="a474" class="lz ma iq lv b gy mf mc l md me">top_5</span></pre><figure class="lq lr ls lt gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mq"><img src="../Images/2dd7978c3fce08102f2345d4ac2a247c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HvMagw6mT3UeEzLxbJCiiA.png"/></div></div></figure><p id="3198" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">在这里，我借用了Chris Whong的方法，显然，他也从别人那里得到了这个方法。但你可以在这里 阅读更多关于他处理这个<a class="ae lb" href="https://medium.com/qri-io/taming-the-mtas-unruly-turnstile-data-c945f5f96ba0" rel="noopener"> <strong class="jy ja">的方法。它所做的是排除大于10000和小于0的值，考虑到在审计时间范围内不超过10000人不能通过十字转门。</strong></a></p><pre class="lq lr ls lt gt lu lv lw lx aw ly bi"><span id="dd38" class="lz ma iq lv b gy mb mc l md me">df_copy['FOUR_HOUR_ENTRIES'] = df_copy.groupby(['TURNSTILE']).FOUR_HOUR_ENTRIES.transform(lambda x: np.where((x&lt;0)|(x&gt;10000),x.mask((x&lt;0)|(x&gt;10000)).mean(),x))</span><span id="8a58" class="lz ma iq lv b gy mf mc l md me">df_copy['FOUR_HOUR_EXITS'] = df_copy.groupby(['TURNSTILE']).FOUR_HOUR_EXITS.transform(lambda x: np.where((x&lt;0)|(x&gt;10000),x.mask((x&lt;0)|(x&gt;10000)).mean(),x))</span></pre><figure class="lq lr ls lt gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mp"><img src="../Images/bd639559d48ba22e286b6d1b4e030fba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wYFMVnoxiDrEBSOLXLIy3Q.png"/></div></div></figure><p id="b5b8" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我希望这篇文章足够成功，能够解决您在理解数据时可能面临的一些挑战。我知道在开源项目中没有一种方法。请随时分享您对数据或文章的任何反馈或意见。我希望回到这个项目，如果可能的话，改进它。</p></div></div>    
</body>
</html>