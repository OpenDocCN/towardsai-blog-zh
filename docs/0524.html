<html>
<head>
<title>Stock Downloader API with Alpha Vantage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Alpha Vantage股票下载API</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/stock-downloader-api-a9e95c913363?source=collection_archive---------2-----------------------#2020-05-25">https://pub.towardsai.net/stock-downloader-api-a9e95c913363?source=collection_archive---------2-----------------------#2020-05-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="3208" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">金融</h2><div class=""/><div class=""><h2 id="fcd5" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">下载过去20年的历史股票数据</h2></div><p id="17d5" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><a class="ae ln" href="https://github.com/arditoibryan/Projects/tree/master/20200524_Stock_Downloader" rel="noopener ugc nofollow" target="_blank">我的GitHub库上有完整的代码</a>。</p><p id="3ffe" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在过去的几周里，我在网上搜寻下载历史股票价格的可靠方法。不幸的是，很难找到一个有效且可靠的工具来下载金融数据:</p><ul class=""><li id="c37c" class="lo lp it kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">是最新的</li><li id="66da" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">提供了一个尚未被弃用的工作API</li><li id="1b6c" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">免费(至少对于一些小容量数据)</li><li id="7857" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">没有过多的请求限制</li></ul><p id="96cf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">对于不知道API是什么意思的人来说，它只是一个工具，允许程序员使用算法连接到数据库，而不是手动干预下载数据。如果您只需要分析几千行数据，这并没有太大的区别。如果你需要同时分析数以千计的股票，你需要自动化这个过程。</p><h2 id="c9ed" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">我的不幸</h2><p id="0bd5" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">不幸的是，在互联网上搜寻可靠的API后，我发现:</p><ul class=""><li id="a726" class="lo lp it kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">雅虎财经；反对</li><li id="7b35" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">谷歌金融；反对</li></ul><p id="2969" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">即使仍在运行，这些也不是下载数据的最佳工具。</p><ul class=""><li id="9658" class="lo lp it kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">Quandl似乎没有发布所有最新的股票信息。</li><li id="2cc5" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">Quantopian你只能使用他们的IDE来下载数据</li><li id="a647" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">Finnhub您只能下载每日或最近的信息</li></ul><p id="d108" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我需要的是至少去年的历史数据。</p><h1 id="e56b" class="mz md it bd me na nb nc mh nd ne nf mk ki ng kj mn kl nh km mq ko ni kp mt nj bi translated">阿尔法优势</h1><p id="7890" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">在这些工具中，我找到了Alpha Vantage。我的代码已经过修改，可以使用他们的API集合下载数据。</p><h2 id="2497" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">你需要什么:</h2><ul class=""><li id="6e0e" class="lo lp it kt b ku mu kx mv la nk le nl li nm lm lt lu lv lw bi translated"><a class="ae ln" href="https://www.alphavantage.co/" rel="noopener ugc nofollow" target="_blank">你的API键</a></li><li id="6501" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">运行代码的笔记本(如果您是专家，也可以放在本地机器上)</li></ul><p id="69b2" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下载限制是可管理的:每分钟5个请求，每天500个请求。</p><h1 id="45c9" class="mz md it bd me na nb nc mh nd ne nf mk ki ng kj mn kl nh km mq ko ni kp mt nj bi translated">设置算法</h1><p id="d975" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">您需要安装alpha包。因为我使用的是Google Collaboratory notebook，所以我可以通过使用下面的代码行来简单地做到这一点。如果你在本地工作，你可能需要尝试不同的方法。</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="b6c9" class="mc md it ns b gy nw nx l ny nz">!pip install alpha_vantage</span></pre><h2 id="473a" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">创建连接</h2><p id="3b93" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">使用download_stock函数，我创建了你可以连接到数据库，下载过去20年的所有股票数据。注意正确使用输出尺寸:</p><ul class=""><li id="f36b" class="lo lp it kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">outputsize='compact ':仅下载最近100天的单只股票的价格</li><li id="ec39" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">outputsize='full ':下载一只股票在过去20年的价格</li></ul><p id="5989" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我将使用股票标签来标识我想要下载的股票，“GOOG”就是一个例子:</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="3e8b" class="mc md it ns b gy nw nx l ny nz">from alpha_vantage.timeseries import TimeSeries</span><span id="c28c" class="mc md it ns b gy oa nx l ny nz">empty = pd.DataFrame()<br/>def download_stock(tag):<br/>  key = ‘your key’<br/>  ts = TimeSeries(key)<br/>  stock, meta = ts.get_daily(symbol=tag, outputsize=’full’)<br/>  return stock, meta</span></pre><h2 id="82df" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">创建数据帧</h2><p id="2ee2" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">因为我已经下载了过去20年价格的股票数组，所以根据我的需要，我需要修改:</p><ul class=""><li id="5db2" class="lo lp it kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">仅保存最后365天</li><li id="8929" class="lo lp it kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">将所有数据从字符串(信息最初编码的类型)转换为浮点型</li></ul><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="c712" class="mc md it ns b gy nw nx l ny nz">import pandas as pd<br/>import time</span><span id="08f7" class="mc md it ns b gy oa nx l ny nz">#converting array to DataFrame<br/>def stock(tag, df_to_add):<br/>  df_, _ = download_stock(tag)<br/>  df_ = pd.DataFrame(df_)<br/>  df_ = df_.transpose()<br/>  df_ = df_.loc[‘2020–05–22’:’2019–04–22']<br/>  df_ = df_[‘1. open’]<br/>  df_ = pd.DataFrame(df_)<br/>  df_.columns = [tag]<br/>  df_ = df_[tag].values.astype(float)<br/>  df_ = pd.concat([df_to_add, pd.DataFrame(df_)], axis=1)<br/>  return df_</span></pre><p id="30c0" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">当我需要将日期索引重新附加到一个惟一的股票集合时，我将最后使用这个算法。csv文件。</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="7eec" class="mc md it ns b gy nw nx l ny nz">def get_index(tag):<br/>  df_, _ = download_stock(tag)<br/>  df_ = pd.DataFrame(df_)<br/>  df_ = df_.transpose()<br/>  df_ = df_.loc[‘2020–05–22’:’2019–04–22']<br/>  df_ = df_[‘1. open’]<br/>  df_ = pd.DataFrame(df_)<br/>  #extract index and return it as series<br/>  df_ = df_.reset_index()<br/>  return df_[‘index’]</span></pre><h2 id="79fc" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">下载股票列表</h2><p id="b0a6" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">要同时下载多只股票，我将使用它们的标签收集在一个列表中:</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="c468" class="mc md it ns b gy nw nx l ny nz">tag_list = [‘AAPL’, ‘ABBV’, ‘GOOG’, ‘NFLX’, ‘MDLZ’, ‘FANG’, ‘VAR’, ‘UPS’, ‘UDR’]</span></pre><h1 id="fc0f" class="mz md it bd me na nb nc mh nd ne nf mk ki ng kj mn kl nh km mq ko ni kp mt nj bi translated">下载算法</h1><p id="8e7f" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">我们终于可以开始下载数据了。我将把下载算法分解成几个部分，分别进行解释。</p><h2 id="f6eb" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">索引</h2><p id="1459" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">首先，我将简单地运行get_index，将整个时间序列保存在一列中。合并股票价格后，我将指数应用于数据框架:</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="e5ad" class="mc md it ns b gy nw nx l ny nz">#index<br/>index = get_index(tag_list[0])<br/>index = pd.DataFrame(index) #conta come 1 richiesta</span></pre><h2 id="6261" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">下载第一只股票</h2><p id="8521" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">因为我们需要创建一个DataFrame来附加其他列，所以我们将使用在post开始时创建的一个空DataFrame，称为empty。使用这段代码，我们下载了第一列价格，并将其放入名为df的数据帧中。</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="9fcf" class="mc md it ns b gy nw nx l ny nz">#csv of stocks<br/>df = pd.DataFrame()</span><span id="40e7" class="mc md it ns b gy oa nx l ny nz">#csv of remaining stocks<br/>#we run the first one once<br/>df = stock(tag_list[0], empty)</span></pre><h2 id="9a7a" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">下载剩下的股票</h2><p id="d2e1" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">对于剩余的每一只股票，我们只需要将它们作为附加列添加到原始df中。因为我们每分钟不能发出超过5个请求，所以我们将遍历列表，对于每4个请求，我们将暂停70秒。</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="5caa" class="mc md it ns b gy nw nx l ny nz">for k in range(1, len(tag_list)):<br/>  print(k, tag_list[k])<br/>  df = stock(tag_list[k], df)<br/>  if k%4 == 0:<br/>  time.sleep(70)</span></pre><p id="9e1c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">算法运行后，我们将看到以下输出:</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="37e2" class="mc md it ns b gy nw nx l ny nz">ABBV <br/>GOOG <br/>NFLX <br/>MDLZ <br/>FANG <br/>VAR <br/>UPS <br/>UDR</span></pre><p id="65f1" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">第一个标签丢失了，因为我们已经单独下载了它。所有剩余的股票都已添加到df中。</p><p id="f906" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我现在将制作一份副本，以避免从头重新加载数据，以防编辑错误:</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="e806" class="mc md it ns b gy nw nx l ny nz">df1 = df.copy()</span></pre><h2 id="49f8" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">重命名列</h2><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="85b0" class="mc md it ns b gy nw nx l ny nz">#rename columns<br/>df1.columns = tag_list<br/>df1</span></pre><h2 id="976d" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">创建日期索引</h2><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="9add" class="mc md it ns b gy nw nx l ny nz">#reattach index<br/>total = pd.concat([index, df1], axis=1)<br/>total = total.set_index(‘index’)<br/>total</span></pre><figure class="nn no np nq gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi ob"><img src="../Images/b51f12e99f9b07ba27cd95202fda90f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkC1QyB1zr6F8BhTOxCrSA.png"/></div></div></figure><p id="6cfb" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">如你所见，这是最终结果:对于每一列，我们有不同的股票价格时间序列。我们可以使用它们进行多种目的的分析。出于视觉目的，我将概述其中最重要的几个。</p><h1 id="fad2" class="mz md it bd me na nb nc mh nd ne nf mk ki ng kj mn kl nh km mq ko ni kp mt nj bi translated">相关矩阵</h1><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="fa0d" class="mc md it ns b gy nw nx l ny nz">import matplotlib.pyplot as plt<br/>import seaborn as sns</span><span id="0c0a" class="mc md it ns b gy oa nx l ny nz">corr = total.corr()<br/>fig, ax = plt.subplots(figsize=(15,15))</span><span id="c89a" class="mc md it ns b gy oa nx l ny nz">ax = sns.heatmap(<br/>corr,<br/>vmin=-1, vmax=1, center=0,<br/>cmap=sns.diverging_palette(0, 256, n=200),<br/>square=True,<br/>ax=ax,<br/>annot=True<br/>)</span></pre><figure class="nn no np nq gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi oj"><img src="../Images/66d33c6b16aefcf36d23ffdd1c890fe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ucg7XT5rXqeqSaJ4rCai8g.png"/></div></div><figcaption class="ok ol gj gh gi om on bd b be z dk translated">我们的股票列表的相关矩阵</figcaption></figure><h2 id="fc2d" class="mc md it bd me mf mg dn mh mi mj dp mk la ml mm mn le mo mp mq li mr ms mt iz bi translated">两只股票之间的单一相关性</h2><p id="5489" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">如果我们不想通过图形来可视化数据，我们总是可以用下面的代码找出两组数据之间的相关性:</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="db98" class="mc md it ns b gy nw nx l ny nz">#single correlation<br/>import numpy as np<br/>print(np.corrcoef(total[‘GOOG’], total[‘AAPL’]))<br/>[[1.         0.88737511]  <br/>[0.88737511 1.        ]]</span></pre><h1 id="25ac" class="mz md it bd me na nb nc mh nd ne nf mk ki ng kj mn kl nh km mq ko ni kp mt nj bi translated">配对图</h1><p id="0517" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">配对图似乎没有太多的分析价值。然而，它允许我们可视化股票价格之间的协方差，并理解为什么一些组合的相关性如此之高，而另一些组合的相关性却如此之低。</p><pre class="nn no np nq gt nr ns nt nu aw nv bi"><span id="c3b5" class="mc md it ns b gy nw nx l ny nz">import seaborn as sns<br/>import matplotlib.pyplot as plt</span><span id="b1ae" class="mc md it ns b gy oa nx l ny nz">sns.pairplot(total, corner=True)<br/>#they are scaled automatically</span></pre><figure class="nn no np nq gt oc gh gi paragraph-image"><div role="button" tabindex="0" class="od oe di of bf og"><div class="gh gi oo"><img src="../Images/ca74605a0a32f896be37793f715f318c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f8Cnb84uwxAQL6f8E5r0sQ.png"/></div></div><figcaption class="ok ol gj gh gi om on bd b be z dk translated">我们的股票列表的配对图矩阵</figcaption></figure><h1 id="8e48" class="mz md it bd me na nb nc mh nd ne nf mk ki ng kj mn kl nh km mq ko ni kp mt nj bi translated">结论</h1><p id="3b3b" class="pw-post-body-paragraph kr ks it kt b ku mu kd kw kx mv kg kz la mw lc ld le mx lg lh li my lk ll lm im bi translated">你对Alpha Vantage工具满意吗？有没有推荐其他更可靠的API？</p></div></div>    
</body>
</html>