<html>
<head>
<title>Safest Way To Containerize a Deep Learning Flask API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">封装深度学习Flask API的最安全方式</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/safest-way-to-containerize-deep-learning-flask-api-8441eee8488f?source=collection_archive---------0-----------------------#2020-08-14">https://pub.towardsai.net/safest-way-to-containerize-deep-learning-flask-api-8441eee8488f?source=collection_archive---------0-----------------------#2020-08-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/431448c064227f332ec636e07d313b40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GjJyPWfNkNjEq-syY0wyGg.png"/></div></div></figure><h2 id="68a8" class="iz ja jb bd b dl jc jd je jf jg jh dk ji translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/machine-learning/deep-learning" rel="noopener ugc nofollow" target="_blank">深度学习</a>，<a class="ae ep" href="https://towardsai.net/p/category/programming" rel="noopener ugc nofollow" target="_blank">编程</a></h2><div class=""/><div class=""><h2 id="e5e6" class="pw-subtitle-paragraph kh jk jb bd b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dk translated">以最安全的方式构建和推送深度学习Flask API的Docker映像。</h2></div><p id="6e2e" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">在本文中，我们将不会讨论开发机器学习模型，而是在<strong class="lb jl"> Docker </strong>的帮助下，将我们准备部署的<strong class="lb jl"> ML API (Flask) </strong>容器化，这样就不会有我们的模型在生产环境中不工作或者在云上部署它或者只是将工作模型分享给朋友和同事的麻烦。</p><p id="7fce" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">注意 :- Docker是一种有用的工具，也是当今的潮流，所以最好开始将你的模型容器化。</p><p id="0b98" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">首先，我假设如果你正在阅读这篇文章，你可能已经熟悉了Docker。如果没有，不要担心，我仍然会用我自己的外行话来定义它😄。</p><h2 id="96b8" class="lv lw jb bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm jh bi translated">那么，Docker是什么？</h2><p id="f921" class="pw-post-body-paragraph kz la jb lb b lc mn kl le lf mo ko lh li mp lk ll lm mq lo lp lq mr ls lt lu ij bi translated"><strong class="lb jl"> Docker </strong>是一个工具，它允许我们设置整个操作系统级虚拟化，以开发和共享名为<strong class="lb jl"> Docker Images </strong>的包中的项目。然后，要么手动共享这些图像(很难)，要么简单地将这些图像推送到DockerHub上，并在需要时随时提取。</p><p id="4030" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">当这些映像在系统上运行时，它们被称为<strong class="lb jl"> Docker容器</strong>。因此，<strong class="lb jl">容器</strong>是Docker <strong class="lb jl">图像的运行实例。</strong>更通俗地说，图像被认为是类，容器被认为是对象。</p><h2 id="5153" class="lv lw jb bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm jh bi translated">先决条件</h2><ol class=""><li id="77e0" class="ms mt jb lb b lc mn lf mo li mu lm mv lq mw lu mx my mz na bi translated">我假设您已经在系统中安装了Docker。如果不是简单的按照自己<a class="ae nb" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">的<strong class="lb jl">官方文件</strong>的</a>去做。</li><li id="fd51" class="ms mt jb lb b lc nc lf nd li ne lm nf lq ng lu mx my mz na bi translated">已经开发了可以部署的深度学习或机器学习Flask API。如果还没有，那么你可以试试我在本教程中用过的那个。</li><li id="8b9b" class="ms mt jb lb b lc nc lf nd li ne lm nf lq ng lu mx my mz na bi translated">稳定快速的互联网连接。这似乎是显而易见的，但是相信我，如果互联网不稳定，你会从守护进程得到很多错误响应。</li></ol><h2 id="d505" class="lv lw jb bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm jh bi translated">让我们开始工作吧</h2><p id="7c24" class="pw-post-body-paragraph kz la jb lb b lc mn kl le lf mo ko lh li mp lk ll lm mq lo lp lq mr ls lt lu ij bi translated">下面的代码片段显示了我的深度学习Flask API，它生成了所提供输入的抽象摘要。同样的，我用过<strong class="lb jl">火炬</strong>和<strong class="lb jl">变形金刚</strong>库。选择这个模型作为例子的唯一目的是使用著名的深度学习库，这些库在制作图像时可能会产生一些问题(Tensorflow和Keras也可以很容易地安装)。使用<code class="fe nh ni nj nk b">pip install package_name</code>安装所需的软件包。</p><figure class="nl nm nn no gt is"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="751c" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">现在，在为Docker映像编写命令之前，我们必须创建一个<code class="fe nh ni nj nk b">requirements.txt</code>文件来在我们的映像中安装所有需要的包。这个文件可以用<code class="fe nh ni nj nk b">pip freeze</code>生成，然后那些依赖项可以用<code class="fe nh ni nj nk b">pip install -r requirements.txt</code>安装。但是在一些特殊情况下，比如<code class="fe nh ni nj nk b">torch</code>，我们必须给出一个下载那个包的链接。在我们的例子中，它看起来如下:-</p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="4265" class="lv lw jb nk b gy nv nw l nx ny">Flask==1.1.1<br/>transformers==2.11.0<br/>--find-links <a class="ae nb" href="https://download.pytorch.org/whl/torch_stable.html" rel="noopener ugc nofollow" target="_blank">https://download.pytorch.org/whl/torch_stable.html</a><br/>torch==1.5.1</span></pre><p id="cc64" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">为了制作我们项目的docker映像，我们首先必须选择一个基础映像，我关注的大多数文章都使用了<strong class="lb jl"> alpine </strong>来制作，因为它是轻量级的，但在我的情况下，这似乎会导致python和pip安装的问题，这就是为什么我选择<strong class="lb jl"> ubuntu </strong>(更值得信任和舒适)。</p><p id="9d95" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">这个文件应该被命名为<strong class="lb jl"> Dockerfile.txt </strong>，并且应该位于项目的根目录中。从命令中的<strong class="lb jl">将提取作为我们图像的<strong class="lb jl">操作系统</strong>的基础图像。下一个命令<strong class="lb jl"> COPY </strong>会将所有数据复制到名为app的文件夹中。<strong class="lb jl"> RUN </strong>用于运行我们docker镜像中的任何命令。在这里，我们已经更新和升级了我们的ubuntu，并安装了<code class="fe nh ni nj nk b">python 3</code>和<code class="fe nh ni nj nk b">pip3</code>来安装python包。然后我们使用<strong class="lb jl"> RUN </strong>命令来安装<code class="fe nh ni nj nk b">requirements.txt</code>中出现的所有依赖项(注意:这里我使用了<code class="fe nh ni nj nk b">default-timeout=100</code>以避免等待连接类型的错误)。然后我们使用<strong class="lb jl"> WORKDIR </strong>来设置我们的工作目录，即<code class="fe nh ni nj nk b">app</code>文件夹，并且我们使用<strong class="lb jl"> EXPOSE </strong>来通知<strong class="lb jl"> Docker </strong>容器在运行时监听端口5000。最后，为了在初始化映像时自动运行我们的程序文件，即<code class="fe nh ni nj nk b">flask_api.py</code>，我们使用了运行默认可执行文件的<strong class="lb jl"> CMD </strong>。</strong></p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="e2b5" class="lv lw jb nk b gy nv nw l nx ny"><strong class="nk jl">FROM</strong> ubuntu:18.04<br/><strong class="nk jl">COPY</strong> . /app<br/><strong class="nk jl">RUN</strong> apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install -y python3 python3-pip  <br/><strong class="nk jl">RUN</strong> pip3 --no-cache-dir install --default-timeout=100 -r /app/requirements.txt<br/><strong class="nk jl">WORKDIR</strong> /app<br/><strong class="nk jl">EXPOSE</strong> 5000<br/><strong class="nk jl">CMD</strong> python3 /app/flask_api.py</span></pre><p id="d73e" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">现在，只需运行下面给出的命令，开始构建您的Docker映像。这里，<code class="fe nh ni nj nk b">deep_learning_api</code>是图像的名称，<strong class="lb jl"> 1.0 </strong>是标签。还有，记得复制那个点(。)最后。😆</p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="a28e" class="lv lw jb nk b gy nv nw l nx ny">sudo docker build -t deep_learning_api:1.0 .</span></pre><p id="1dc5" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">运行这个命令后，放松下来，看看整个过程。如果您在任何阶段遇到任何与网络相关的错误，只需简单地<strong class="lb jl">重启</strong>整个过程。我附上了一些过程的截图供你参考。</p><figure class="nl nm nn no gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nz"><img src="../Images/fad5fec3691c36f7871359d06c8da68b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x5bEFiUAQEPrGP0SYlvbRg.png"/></div></div></figure><figure class="nl nm nn no gt is gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/0f443f0491bd21cf53e2723f44efffbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*I6G18WxKGWgSJpCozRjung.png"/></div></figure><figure class="nl nm nn no gt is gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/54084aefc6fb68398d7625948b99e220.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*jriB9tv6SimYsvvFWliGjA.png"/></div></figure><p id="67ad" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">您的Docker映像已成功构建。但是它工作正常吗？让我们找出答案。运行以下命令来获取一个<strong class="lb jl">映像id </strong>。复制您最近构建的映像<strong class="lb jl">的<strong class="lb jl">映像id </strong>。对我来说是574f233e0957。</strong></p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="99e6" class="lv lw jb nk b gy nv nw l nx ny">sudo docker images</span></pre><p id="6629" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">现在使用下面的命令来运行我们的Docker容器。如果它工作正常，您将得到类似下面截图所示的内容。</p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="9492" class="lv lw jb nk b gy nv nw l nx ny">sudo docker run 574f233e0957</span></pre><figure class="nl nm nn no gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oc"><img src="../Images/6cf82b2f2c671d3496e6f9161e273a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JLm_p2tKlPW6-1ZRwbQsFg.png"/></div></div></figure><p id="a75a" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">但是，如果你点击这个地址，什么也不会出现。那是因为容器的IP地址不一样。所以我们必须提取出来。打开另一个终端，使用这个命令获取运行容器的ID。复制<strong class="lb jl">容器ID </strong>。(我的是7c2a2d25bb9d)</p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="e636" class="lv lw jb nk b gy nv nw l nx ny">sudo docker container ls -la</span></pre><p id="0b5a" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">现在，通过运行下面的命令，你将获得很多关于你的容器的信息，但是我们感兴趣的是<strong class="lb jl"> IPAddress </strong>。搜索相同的并使用它代替<strong class="lb jl"> 0.0.0.0 </strong></p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="1704" class="lv lw jb nk b gy nv nw l nx ny">sudo docker inspect 7c2a2d25bb9d</span></pre><figure class="nl nm nn no gt is gh gi paragraph-image"><div class="gh gi od"><img src="../Images/360cecbcbe2fe71cf165650e5e539be2.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*YLejonsx-lYU_8wD3AIH_g.png"/></div></figure><p id="70d7" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">最后，您将在浏览器中看到结果。</p><figure class="nl nm nn no gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oe"><img src="../Images/e443602f21c37ad47a76011ab5c1430c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AaCM7-ErDBUhKTol0hNcSg.png"/></div></div><figcaption class="of og gj gh gi oh oi bd b be z dk translated">默认路由</figcaption></figure><figure class="nl nm nn no gt is gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/5779c1a1af5cec969b2faf1f83f4d10c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*xgcqEOAK6pYu69EmdtFh2Q.png"/></div><figcaption class="of og gj gh gi oh oi bd b be z dk translated">完成所有深度学习处理的总结路线</figcaption></figure><p id="148b" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">好了，我们已经建成了。但是怎么分享呢？</p><p id="41ca" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">答案是<a class="ae nb" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb jl"> DockerHub </strong> </a>。如果您还没有创建您的帐户，创建一个，因为这将是非常有益的工作与Docker。创建帐户后，创建一个新的存储库。我把它命名为<code class="fe nh ni nj nk b">deep_learning_flask_api_demo</code>。然后在命令行上使用<code class="fe nh ni nj nk b">sudo docker login</code>登录你的docker账户。</p><p id="7047" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">然后如前所述检查您的图像ID，并用以下命令标记您的图像。</p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="2b7f" class="lv lw jb nk b gy nv nw l nx ny">sudo docker tag 574f233e0957 yourDockerHubUserName/RepoName:1.0</span></pre><p id="8346" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">标记后，只需用下面的命令将它推上DockerHub。</p><pre class="nl nm nn no gt nr nk ns nt aw nu bi"><span id="13c5" class="lv lw jb nk b gy nv nw l nx ny">sudo docker push yourDockerHubUserName/RepoName</span></pre><p id="8ac7" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">从现在开始，你可以简单地用<code class="fe nh ni nj nk b">pull</code>命令拉出你的docker图像。</p><p id="3013" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">注意:-你的回购默认是公开的，作为一个无偿用户，你只能得到一个私人回购。</p><p id="fe27" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">希望你已经成功构建了深度学习Flask API的Docker镜像。如果您仍然遇到任何类型的错误，请随时联系我。我将非常乐意帮助任何人。😃</p><p id="ac81" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">源代码可以在<a class="ae nb" href="https://github.com/PushkaraSharma/medium_articles_code/tree/master/Containerize_Deep_Learning_Docker" rel="noopener ugc nofollow" target="_blank"> <strong class="lb jl"> GitHub </strong> </a>上找到。</p><p id="18f7" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">链接我的<a class="ae nb" href="https://hub.docker.com/r/pushkarasharma11/deep_learning_flask_api_demo" rel="noopener ugc nofollow" target="_blank"> <strong class="lb jl"> Docker图片</strong> </a>。</p><p id="3b08" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">谢谢你宝贵的时间。😊我希望你喜欢这个教程。</p><p id="9877" class="pw-post-body-paragraph kz la jb lb b lc ld kl le lf lg ko lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">此外，请查看我关于使用Python 从头开始进行<a class="ae nb" href="https://medium.com/towards-artificial-intelligence/logistic-regression-from-scratch-with-only-python-code-9d3ae607e739" rel="noopener">逻辑回归的教程。</a></p><div class="ip iq gp gr ir ok"><a href="https://medium.com/towards-artificial-intelligence/logistic-regression-from-scratch-with-only-python-code-9d3ae607e739" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd jl gy z fp op fr fs oq fu fw jk bi translated">仅使用Python代码从零开始进行逻辑回归</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">仅使用Python对多要素数据集应用逻辑回归。分步实现编码示例…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy ix ok"/></div></div></a></div><div class="ip iq gp gr ir ok"><a href="https://medium.com/towards-artificial-intelligence/gradient-descent-v-s-normal-equation-for-regression-problems-e6c3cdd705f" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd jl gy z fp op fr fs oq fu fw jk bi translated">回归问题的梯度下降v/s正规方程</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">选择正确的算法来找到使成本函数最小的参数。</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="oz l ov ow ox ot oy ix ok"/></div></div></a></div></div></div>    
</body>
</html>