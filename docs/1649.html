<html>
<head>
<title>Docker + Flask | Dockerizing a Python API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker + Flask |对Python API进行Dockerizing</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/docker-flask-dockerizing-a-python-api-168d3899f482?source=collection_archive---------0-----------------------#2021-03-10">https://pub.towardsai.net/docker-flask-dockerizing-a-python-api-168d3899f482?source=collection_archive---------0-----------------------#2021-03-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="71d2" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/programming" rel="noopener ugc nofollow" target="_blank">编程</a></h2><div class=""/><figure class="gl gn ka kb kc kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi jz"><img src="../Images/25a2d706d0c8e61e8026284c023409f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f2KssnlyaV-Dm8sZ2Fichw.jpeg"/></div></div></figure><p id="a961" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><a class="ae li" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">容器是目前软件开发中最热门的趋势之一。它不仅使创建、部署和运行应用程序变得更加容易，而且通过使用容器，您可以确信您的应用程序可以在任何机器上运行，不管您创建和测试的代码与您的机器有什么不同。</a></p><p id="109f" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">在本教程中，我们将向您展示如何轻松对接一个Flask API。我们将使用这个<a class="ae li" href="https://predictivehacks.com/python-rest-api-example/" rel="noopener ugc nofollow" target="_blank"> Python Rest API示例</a>。这是一个简单的API，给定一个图像URL，它返回图像的主色。</p><p id="e41a" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">我们强烈建议使用<a class="ae li" href="https://predictivehacks.com/working-with-anaconda-environments/" rel="noopener ugc nofollow" target="_blank"> Conda </a>或pip创建一个新的python环境，这样您就可以轻松地创建您的<strong class="km jd"> requirements.txt </strong>文件，其中包含您在项目中使用的所有库。</p><p id="8884" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">我们将要dockerize的Flask API使用了两个。py文件。</p><h1 id="aeea" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">颜色. py</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="3c76" class="mq lk it mm b gy mr ms l mt mu">import PIL<br/>from PIL import Image<br/>import requests<br/>from io import BytesIO<br/>import webcolors<br/>import pandas as pd<br/>import webcolors<br/>  <br/>def closest_colour(requested_colour):<br/>    min_colours = {}<br/>    for key, name in webcolors.css3_hex_to_names.items():<br/>        r_c, g_c, b_c = webcolors.hex_to_rgb(key)<br/>        rd = (r_c - requested_colour[0]) ** 2<br/>        gd = (g_c - requested_colour[1]) ** 2<br/>        bd = (b_c - requested_colour[2]) ** 2<br/>        min_colours[(rd + gd + bd)] = name<br/>    return min_colours[min(min_colours.keys())]<br/>def top_colors(url, n=10):<br/>    # read images from URL<br/>    response = requests.get(url)<br/>    img = Image.open(BytesIO(response.content))<br/>    # convert the image to rgb<br/>    image = img.convert('RGB')<br/>     <br/>    # resize the image to 100 x 100<br/>    image = image.resize((100,100))<br/>     <br/>    detected_colors =[]<br/>    for x in range(image.width):<br/>        for y in range(image.height):<br/>            detected_colors.append(closest_colour(image.getpixel((x,y))))<br/>    Series_Colors = pd.Series(detected_colors)<br/>    output=Series_Colors.value_counts()/len(Series_Colors)<br/>    return(output.head(n).to_dict())</span></pre><h1 id="2d6f" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">main.py</h1><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="ea38" class="mq lk it mm b gy mr ms l mt mu">from flask import Flask, jsonify, request<br/>app=Flask(__name__)<br/>#we are importing our function from the colors.py file<br/>from colors import top_colors<br/>@app.route("/",methods=['GET','POST'])<br/>def index():<br/>    if request.method=='GET':<br/>#getting the url argument       <br/>        url = request.args.get('url')<br/>        result=top_colors(str(url))<br/>        return jsonify(result)<br/>    else:<br/>        return jsonify({'Error':"This is a GET API method"})<br/>if __name__ == '__main__':<br/>    app.run(debug=True,host='0.0.0.0', port=9007)</span></pre><p id="e0c3" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">正如我们之前所说的，我们必须创建requirements.txt文件。我们在激活项目环境后使用pip冻结命令。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="f339" class="mq lk it mm b gy mr ms l mt mu">pip freeze &gt; requirements.txt</span></pre><p id="3f5f" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">如果您打开requirements.txt，您应该会看到列出了项目所需的所有库。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="9f4d" class="mq lk it mm b gy mr ms l mt mu">certifi==2020.6.20<br/>chardet==3.0.4<br/>click==7.1.2<br/>Flask==1.1.2<br/>idna==2.10<br/>itsdangerous==1.1.0<br/>Jinja2==2.11.2<br/>jsonify==0.5<br/>MarkupSafe==1.1.1<br/>numpy==1.19.2<br/>pandas==1.1.3<br/>Pillow==8.0.1<br/>python-dateutil==2.8.1<br/>pytz==2020.1<br/>requests==2.24.0<br/>six==1.15.0<br/>urllib3==1.25.11<br/>webcolors==1.4<br/>Werkzeug==1.0.1</span></pre><h1 id="da82" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">归档</h1><p id="cf98" class="pw-post-body-paragraph kk kl it km b kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld mz lf lg lh im bi translated">让我们开始整理过程。我们只需要创建一个名为Dockerfile的新文件。然后我们会在里面添加几行代码。</p><p id="8620" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">Dockerfile文件由定义如何构建映像的简单命令组成。第一行是我们的基本图像。有很多图像可以使用，比如Linux，预装Python的Linux，以及专门为数据科学项目制作的库或图像。你可以在<a class="ae li" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> docker hub </a>探索它们。我们将使用Python:3.8图像。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="c6a2" class="mq lk it mm b gy mr ms l mt mu">FROM python:3.8</span></pre><p id="9129" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">然后，我们需要从我们的主机复制所需的文件，并将其添加到容器的文件系统中。为了简单起见，我们将不添加任何子文件夹。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="7883" class="mq lk it mm b gy mr ms l mt mu">FROM python:3.8<br/><br/>COPY requirements.txt ./requirements.txt<br/>COPY colors.py ./colors.py<br/>COPY main.py ./main.py</span></pre><p id="9cb6" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">然后我们必须安装库，所以我们必须添加pip install命令来运行。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="62a8" class="mq lk it mm b gy mr ms l mt mu">FROM python:3.8<br/><br/>COPY requirements.txt ./requirements.txt<br/>COPY colors.py ./colors.py<br/>COPY main.py ./main.py<br/><br/>RUN pip install -r requirements.txt</span></pre><p id="003c" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">最后，我们必须使用<strong class="km jd"> CMD </strong>指定在容器中运行什么命令。在我们的例子中是<strong class="km jd"> python main.py </strong>。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="a405" class="mq lk it mm b gy mr ms l mt mu">FROM python:3.8<br/><br/>COPY requirements.txt ./requirements.txt<br/>COPY colors.py ./colors.py<br/>COPY main.py ./main.py<br/><br/>RUN pip install -r requirements.txt<br/><br/>CMD ["python", "./main.py"]</span></pre><h1 id="2d30" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">如何构建映像并运行容器</h1><p id="a493" class="pw-post-body-paragraph kk kl it km b kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld mz lf lg lh im bi translated">要构建docker映像，您需要转到Dockerfile所在的工作目录，并运行以下命令。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="8ae9" class="mq lk it mm b gy mr ms l mt mu">docker build -t your_docker_image_name -f Dockerfile .</span></pre><p id="2b1d" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">你只是建立你的形象！下一步是运行我们的容器。这里棘手的部分是端口的映射。第一个是我们将使用的本地端口，第二个是API在我们的容器中运行的端口。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="0733" class="mq lk it mm b gy mr ms l mt mu">docker run -d -p 5000:9007 your_docker_image_name</span></pre><p id="6a17" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">如果一切正常，在浏览器中点击以下按钮，您应该会得到响应。</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="6ef2" class="mq lk it mm b gy mr ms l mt mu"><a class="ae li" href="http://localhost:5000/?url=https://image.shutterstock.com/z/stock-photo-at-o-clock-at-the-top-of-the-mountains-sunrise-1602307492.jpg" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/?url=https://image.shutterstock.com/z/stock-photo-at-o-clock-at-the-top-of-the-mountains-sunrise-1602307492.jpg</a></span><span id="0b7e" class="mq lk it mm b gy na ms l mt mu">{<br/>burlywood: 0.1212,<br/>cornsilk: 0.0257,<br/>darksalmon: 0.229,<br/>darkslategrey: 0.0928,<br/>indianred: 0.1663,<br/>lemonchiffon: 0.021,<br/>lightsalmon: 0.0479,<br/>navajowhite: 0.0426,<br/>rosybrown: 0.097,<br/>wheat: 0.0308<br/>}</span></pre><p id="9fd9" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">你成功了！您刚刚对Flask API进行了对接！就这么简单。</p><figure class="mh mi mj mk gt kd gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/d89bdb14edf1e3c35065d0b5dd0b3306.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*Rx2S8vOsd5y3eRPt.gif"/></div></figure><h1 id="7610" class="lj lk it bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">Docker的一些有用命令</h1><p id="1529" class="pw-post-body-paragraph kk kl it km b kn mv kp kq kr mw kt ku kv mx kx ky kz my lb lc ld mz lf lg lh im bi translated">获取正在运行的容器的列表</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="d953" class="mq lk it mm b gy mr ms l mt mu">docker container list</span><span id="b1d7" class="mq lk it mm b gy na ms l mt mu">CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS              PORTS                    NAMES<br/>fe7726349933        image_name          "python ./main.py"   About an hour ago   Up About an hour    0.0.0.0:5000-&gt;9007/tcp   eager_chaum</span></pre><p id="0f13" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">如果要停止容器，请从previews命令中获取容器id的前3–4个字符，并运行以下命令</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="cbc5" class="mq lk it mm b gy mr ms l mt mu">docker stop fe77</span></pre><p id="aeeb" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">获取API的日志</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="2f2f" class="mq lk it mm b gy mr ms l mt mu">docker logs fe77</span></pre></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="224d" class="pw-post-body-paragraph kk kl it km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><em class="nj">最初发表于</em><a class="ae li" href="https://predictivehacks.com/how-to-use-docker-for-flask-api/" rel="noopener ugc nofollow" target="_blank"><em class="nj">【https://predictivehacks.com】</em></a><em class="nj">。</em></p></div></div>    
</body>
</html>