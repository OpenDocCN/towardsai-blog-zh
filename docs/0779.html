<html>
<head>
<title>Kafka Python Data processing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kafka Python数据处理</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/kafka-python-data-processing-25584415f7ab?source=collection_archive---------0-----------------------#2020-08-09">https://pub.towardsai.net/kafka-python-data-processing-25584415f7ab?source=collection_archive---------0-----------------------#2020-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="9dd2" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/programming" rel="noopener ugc nofollow" target="_blank">编程</a></h2><div class=""/><p id="a3ab" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">本文的目标是从Oracle DB表中读取数据，并将JSON格式的记录推送到Kafka Broker，然后从Kafka Broker中读取消息，并将JSON消息插入MongoDB集合。<br/>这个博客包含一个基本的ETL消息传递系统构建，使用Oracle作为源，Kafka作为中间件，MongoDB作为目标。</p><p id="243d" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这是我的卡夫卡系列的第三个博客，前两个博客链接包含了卡夫卡的概念细节，链接如下:</p><blockquote class="ku kv kw"><p id="d967" class="jw jx kx jy b jz ka kb kc kd ke kf kg ky ki kj kk kz km kn ko la kq kr ks kt ij bi translated"><a class="ae lb" href="https://medium.com/towards-artificial-intelligence/getting-started-with-apache-kafka-beginners-tutorial-d38e3634706c?source=friends_link&amp;sk=2b98454c001fb88527fff8c2217947e2" rel="noopener">https://medium . com/forward-artificial-intelligence/getting-started-with-Apache-Kafka-初学者-教程-d38e3634706c？source = friends _ link&amp;sk = 2b 98454 c 001 FB 88527 fff 8c 2217947 e 2</a></p><p id="6584" class="jw jx kx jy b jz ka kb kc kd ke kf kg ky ki kj kk kz km kn ko la kq kr ks kt ij bi translated"><a class="ae lb" href="https://medium.com/towards-artificial-intelligence/diving-deep-into-kafka-29160f32d408?source=friends_link&amp;sk=0cf78cc0ee1ef12f0bac1634e71d1550" rel="noopener">https://medium . com/forward-人工智能/diving-deep-into-Kafka-29160 f32d 408？source = friends _ link&amp;sk = 0 cf 78 cc 0 ee 1ef 12 f 0 BAC 1634 e 71d 1550</a></p></blockquote><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi lc"><img src="../Images/3c8b4b60ab5752c1917e0c6fc595efd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*2hTsAqdUl3VFORtYzrmu2A.png"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">卡夫卡ETL生态系统</figcaption></figure><ol class=""><li id="42fc" class="lo lp iq jy b jz ka kd ke kh lq kl lr kp ls kt lt lu lv lw bi translated"><strong class="jy ja">连接Oracle并提取数据:</strong></li></ol><pre class="ld le lf lg gt lx ly lz ma aw mb bi"><span id="bde6" class="mc md iq ly b gy me mf l mg mh">#import required libraries</span><span id="52c4" class="mc md iq ly b gy mi mf l mg mh">from json import dumps<br/>import json<br/>from kafka import KafkaProducer<br/>import cx_Oracle</span><span id="7d63" class="mc md iq ly b gy mi mf l mg mh">conn = cx_Oracle.connect('scott/scott@oracle')<br/>cursor=conn.cursor()<br/>query='select empno,ename,sal from emp'</span><span id="82d5" class="mc md iq ly b gy mi mf l mg mh">result=cursor.execute(query)<br/>data=[]</span><span id="256c" class="mc md iq ly b gy mi mf l mg mh">#convert data into JSON format<br/>for row in result:<br/>    data.append({'empno':row[0], 'ename':row[1], 'sal':row[2]})</span><span id="400a" class="mc md iq ly b gy mi mf l mg mh">conn.close()</span><span id="e289" class="mc md iq ly b gy mi mf l mg mh">for records in data:<br/>    print(records)</span></pre><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/b4d77dd7954faf51b27585767f34d7c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*gIlhPCs42biPSR7vRnzWiQ.png"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">Oracle数据</figcaption></figure><p id="6494" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">由于MongoDB接受JSON格式的数据，我们将把数据转换成JSON键值格式。</p><p id="47df" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja"> 2。创建一个生产者并向Kafka Broker推送消息:</strong></p><pre class="ld le lf lg gt lx ly lz ma aw mb bi"><span id="18ac" class="mc md iq ly b gy me mf l mg mh">producer = KafkaProducer(bootstrap_servers=[‘localhost:9092’],<br/> value_serializer=lambda x:json.dumps(x).encode(‘utf-8’))</span><span id="4d5f" class="mc md iq ly b gy mi mf l mg mh">#push message to kafka topic mongo_poc<br/>try:<br/> for val in data:<br/> producer.send(‘mongo_poc’,val)<br/>except Exception as e:<br/> print(e)</span></pre><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/e4d20e09b356c518531409c1bbc1fa11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*5u4l0ilBhRcxdkJwk3mFjg.png"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">卡夫卡的信息</figcaption></figure><blockquote class="ku kv kw"><p id="5103" class="jw jx kx jy b jz ka kb kc kd ke kf kg ky ki kj kk kz km kn ko la kq kr ks kt ij bi translated">消息采用键值对格式</p></blockquote><p id="c392" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja"> 3。创建一个消费者并将记录插入到MongoDB: </strong></p><pre class="ld le lf lg gt lx ly lz ma aw mb bi"><span id="2f30" class="mc md iq ly b gy me mf l mg mh">#import required libraries<br/>from kafka import KafkaConsumer</span><span id="2e79" class="mc md iq ly b gy mi mf l mg mh">from json import loads<br/>import json<br/>from pymongo import MongoClient</span><span id="c158" class="mc md iq ly b gy mi mf l mg mh">#mongodb connection details<br/>client = MongoClient(‘localhost:27017’)<br/>db=client.mydb</span><span id="5862" class="mc md iq ly b gy mi mf l mg mh">#write Kafka consumer<br/>consumer = KafkaConsumer(‘mongo_poc’,<br/> bootstrap_servers=[‘localhost:9092’],<br/> auto_offset_reset=’earliest’,<br/> enable_auto_commit=True,<br/> group_id=’my-group’,<br/> consumer_timeout_ms=1000,<br/> value_deserializer=lambda x: loads(x.decode(‘utf-8’)))</span><span id="2e63" class="mc md iq ly b gy mi mf l mg mh">#read messages from Kafka and insert into mongodb collection named kafka_mongo</span><span id="137a" class="mc md iq ly b gy mi mf l mg mh">for message in consumer:<br/> msg = message.value<br/> print(msg)<br/> db.kafka_mongo.insert(msg)<br/> consumer.commit()</span></pre><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/732f81d3f220e0bfad1eeed0cf76c508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yvBv56qrpJQfKEZfPliEJQ.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">MongoDB文档</figcaption></figure><p id="d016" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">MongoDB集合可以被解释为一个RDBMS表。MongoDB中的每个记录都被称为文档。所以一个Oracle记录就是MongoDB文档。</p><p id="e183" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><em class="kx">使用find() </em>方法查询收藏- kafka_mongo</p><blockquote class="ku kv kw"><p id="0c33" class="jw jx kx jy b jz ka kb kc kd ke kf kg ky ki kj kk kz km kn ko la kq kr ks kt ij bi translated">访问我的MongoDB博客了解基本的CRUD操作，链接如下:<a class="ae lb" href="https://mongocrud.blogspot.com/2020/03/mongodb-crud-operations.html" rel="noopener ugc nofollow" target="_blank">https://mongocrud . blogspot . com/2020/03/MongoDB-CRUD-operations . html</a></p></blockquote><p id="6afd" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">万岁，我们已经成功读取了来自Kafka Broker的消息，并将其插入到MongoDB集合中。</p><h1 id="3b40" class="mq md iq bd mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm bi translated">总结:</h1><p id="6ffb" class="pw-post-body-paragraph jw jx iq jy b jz nn kb kc kd no kf kg kh np kj kk kl nq kn ko kp nr kr ks kt ij bi translated">使用cx_Oracle的Python Oracle连接</p><p id="f0a0" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">JSON数据创建</p><p id="1899" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">使用Kafka Producer推送消息</p><p id="8707" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">Kafka消费者将数据插入MongoDB集合</p><p id="27be" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">感谢所有人阅读我的博客，如果你喜欢我的内容和解释，请在medium上关注我并分享你的反馈，这将永远帮助我们所有人提高我们的知识。</p></div></div>    
</body>
</html>