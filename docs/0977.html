<html>
<head>
<title>Transform your Data in Style with Kafka Connect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Kafka Connect以时尚的方式转变您的数据</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/transform-your-data-in-style-with-kafka-connect-2817d7bb39b9?source=collection_archive---------3-----------------------#2020-09-26">https://pub.towardsai.net/transform-your-data-in-style-with-kafka-connect-2817d7bb39b9?source=collection_archive---------3-----------------------#2020-09-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="b632" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/software-engineering" rel="noopener ugc nofollow" target="_blank">软件工程</a></h2><div class=""/><div class=""><h2 id="a597" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">让我们编写最简单但功能强大的单一消息转换</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/580c59014088ca61c69fe28403bba602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MqlPfEQHuVtRYXl3"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated"><a class="ae lh" href="https://unsplash.com/@k8_iv?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> K8 </a>在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><blockquote class="li lj lk"><p id="e121" class="ll lm ln lo b lp lq kd lr ls lt kg lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">做以前没做过的，写以前没写过的。</p></blockquote><p id="f22b" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">Kafka被证明是我们组织的弹性和性能指标的游戏规则改变者。实现松耦合、高可用性、容错以及最重要的易于适应的承诺；Kafka成为应用程序到应用程序通信的默认选择，留下了Restful API，<em class="ln">只要有可能</em>。</p><p id="b500" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">我使用<a class="ae lh" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>和<a class="ae lh" href="https://kafka.apache.org/documentation/#connect" rel="noopener ugc nofollow" target="_blank"> Kafka Connect </a>从几个应用程序中获取数据。在很大程度上，Kafka中数据的结构和格式(<em class="ln">记录</em>)非常符合我的需求。如果没有，我会使用Kafka内置的<a class="ae lh" href="https://docs.confluent.io/current/connect/transforms/index.html" rel="noopener ugc nofollow" target="_blank">转换</a>，这将很容易允许我稍微调整一下数据。如果仍然不满意，我会要求采购团队根据我的需要调整数据的结构。这种对另一个团队的依赖很快就要结束了，我将不得不寻找一个内置的工具来满足我的特定需求。<strong class="lo jd">回车，</strong> <a class="ae lh" href="https://docs.confluent.io/current/connect/transforms/custom.html#custom-transform" rel="noopener ugc nofollow" target="_blank"> <strong class="lo jd">自定义变换</strong> </a>！！</p><blockquote class="li lj lk"><p id="7679" class="ll lm ln lo b lp lq kd lr ls lt kg lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">唯一的问题，你需要懂Java我不知道。唯一可用的<a class="ae lh" href="https://www.confluent.io/blog/kafka-connect-single-message-transformation-tutorial-with-examples/" rel="noopener ugc nofollow" target="_blank">文档</a>试图谈论一切，而没有真正解释任何事情。</p></blockquote><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ml"><img src="../Images/6d3f212b00fff0ad5dd162c71cf0684d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OGAcjUYimIGR58-I"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">感觉卡住了；照片由<a class="ae lh" href="https://unsplash.com/@spce?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马里奥·阿齐</a>在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="a3fb" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">自学基础Java很快，但是弄清楚kafka方法和组件来完成我的转换工作却不容易。我惊讶地发现缺少文档和独立文章。因此，在本文中，让我们编写一个假设但相关的自定义Kafka转换，它将允许您将Kafka消息转换为特定的结构。为了使它简单易懂，让我们来看看:</p><ul class=""><li id="5386" class="mm mn it lo b lp lq ls lt mi mo mj mp mk mq mh mr ms mt mu bi translated">模式已禁用</li><li id="1485" class="mm mn it lo b lp mv ls mw mi mx mj my mk mz mh mr ms mt mu bi translated">没有运行时配置</li><li id="cc7e" class="mm mn it lo b lp mv ls mw mi mx mj my mk mz mh mr ms mt mu bi translated">仅值转换(<em class="ln">即</em>无键转换)</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi na"><img src="../Images/67fccca26082a8235739106424f15c39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eqAXI91-hZe46QJdUzBhLA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">图1:卡夫卡的信息价值转换</figcaption></figure><h2 id="7cc8" class="nb nc it bd nd ne nf dn ng nh ni dp nj mi nk nl nm mj nn no np mk nq nr ns iz bi translated">1.卡夫卡把内置的转换连接为基础结构</h2><p id="4b20" class="pw-post-body-paragraph ll lm it lo b lp nt kd lr ls nu kg lu mi nv lx ly mj nw mb mc mk nx mf mg mh im bi translated">Apache Kafka拥有可用于其内置转换的<a class="ae lh" href="https://github.com/apache/kafka/tree/trunk/connect/transforms/src" rel="noopener ugc nofollow" target="_blank">源代码</a>，这是一个<em class="ln">真正真正</em>开始探索和检验最佳范例的好地方。我们会复制相同的代码结构。有一个目录结构，就像你在Apache Kafka源代码中看到的那样，最后有一个java文件，它将包含你的定制转换代码，在我的例子中是<a class="ae lh" href="https://github.com/akash092/CustomKafkaTransformation/blob/master/transforms/src/main/java/org/mycompany/kafka/connect/transforms/CustomTransform.java" rel="noopener ugc nofollow" target="_blank"><em class="ln">【CustomTransform.java</em></a><em class="ln">。</em>该代码也可在<a class="ae lh" href="https://github.com/akash092/CustomKafkaTransformation" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ny"><img src="../Images/35bbeff1953e2c232ea54a10b82daf78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jo6jDgyouTd4XZiVvSQ48A.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">图2: Kafka定制转换存储库结构</figcaption></figure><h2 id="f72d" class="nb nc it bd nd ne nf dn ng nh ni dp nj mi nk nl nm mj nn no np mk nq nr ns iz bi translated">2.定义CustomTransform.java</h2><p id="3679" class="pw-post-body-paragraph ll lm it lo b lp nt kd lr ls nu kg lu mi nv lx ly mj nw mb mc mk nx mf mg mh im bi translated">从概念上讲，流程是您的定制转换从上游系统接收记录；对于源连接器，它将来自您的源系统或应用程序，而对于汇连接器，它将来自Kafka broker。然后，您的转换会将它转换成一个<em class="ln"> ConnectRecord </em>，然后通过已经配置好的转换的<em class="ln"> apply() </em>函数传递该记录，期望返回一个记录。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">图3:带有底层方法的CustomTransform类定义</figcaption></figure><p id="54be" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">上面展示了构建这个简单转换所需的一切(类、方法、导入)。<strong class="lo jd"> <em class="ln"> apply() </em> </strong>方法是我们接下来要写的真正的果汁，但是其他的都很好。在我们进入<em class="ln"> apply() </em>之前，请注意为简化程序而做的关键假设:</p><ul class=""><li id="eaaf" class="mm mn it lo b lp lq ls lt mi mo mj mp mk mq mh mr ms mt mu bi translated">我们的<em class="ln"> config() </em>返回一个空的<em class="ln"> CONFIG_DEF </em>对象。这是简化的，因为我们已经假设“没有运行时配置”。</li><li id="f486" class="mm mn it lo b lp mv ls mw mi mx mj my mk mz mh mr ms mt mu bi translated">没有提到<em class="ln"> operatingSchema(记录)</em>或<em class="ln"> applyWithSchema(记录)。</em>这与Kafka标准转换布局(例如<a class="ae lh" href="https://github.com/apache/kafka/blob/trunk/connect/transforms/src/main/java/org/apache/kafka/connect/transforms/Flatten.java" rel="noopener ugc nofollow" target="_blank"> <em class="ln">展平</em> </a>)形成对比，因为我们假设“模式被禁用”。</li><li id="3a87" class="mm mn it lo b lp mv ls mw mi mx mj my mk mz mh mr ms mt mu bi translated">没有提及<em class="ln">类键</em>和<em class="ln">类值。</em>这也被简化了，因为我们已经预先决定要进行“唯价值转换”。</li></ul><p id="c4f9" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">我希望这澄清了标准Kafka转换中每个方法和类的意义，这种自底向上的方法将允许逐步掌握每个类。</p><h2 id="00ac" class="nb nc it bd nd ne nf dn ng nh ni dp nj mi nk nl nm mj nn no np mk nq nr ns iz bi translated">3.实现apply()方法</h2><p id="4646" class="pw-post-body-paragraph ll lm it lo b lp nt kd lr ls nu kg lu mi nv lx ly mj nw mb mc mk nx mf mg mh im bi translated">应用是转换的核心。这可以用Kafka Key或Value中的数据做任何事情，不管有没有模式。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">图4:将数据转换为定制结构的apply()实现</figcaption></figure><p id="c94c" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">我们在<em class="ln"> originalRecord </em>中捕获了原始的JSON负载，然后遍历它们来构造<em class="ln"> updatedValue </em>。不用说，您可以在<em class="ln"> apply()，</em>中做各种事情，就像在现有Kafka转换的代码中已经可见的那样。</p><h2 id="0e74" class="nb nc it bd nd ne nf dn ng nh ni dp nj mi nk nl nm mj nn no np mk nq nr ns iz bi translated">4.不要忘记单元测试</h2><p id="c138" class="pw-post-body-paragraph ll lm it lo b lp nt kd lr ls nu kg lu mi nv lx ly mj nw mb mc mk nx mf mg mh im bi translated"><em class="ln">无法测试的代码是有缺陷的，</em>所以我们不要忘记它们<em class="ln">。如图2所示，我的测试文件<em class="ln">CustomTransformTest.java</em>和我的转换在同一个文件夹中。</em></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">图5:测试类实现</figcaption></figure><p id="6149" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">这是一个简单的测试，在测试方法<em class="ln"> testSampleData() </em>中，我们填充原始有效负载，将其传递给<em class="ln"> apply() </em>方法，然后通过<em class="ln"> assert() </em>确保转换后的响应符合预期。</p><h2 id="cc13" class="nb nc it bd nd ne nf dn ng nh ni dp nj mi nk nl nm mj nn no np mk nq nr ns iz bi translated">5.编译和验证</h2><pre class="ks kt ku kv gt ob oc od oe aw of bi"><span id="b01a" class="nb nc it oc b gy og oh l oi oj">$ pwd<em class="ln"><br/>~/CustomKafkaTransformation/transforms/src/main/java</em></span><span id="49bd" class="nb nc it oc b gy ok oh l oi oj">$ javac org/mycompany/kafka/connect/transforms/CustomTransform.java</span><span id="29af" class="nb nc it oc b gy ok oh l oi oj">$ javac org/mycompany/kafka/connect/transforms/CustomTransformTest.java</span><span id="06ba" class="nb nc it oc b gy ok oh l oi oj">$ java org.junit.runner.JUnitCore org.mycompany.kafka.connect.transforms.CustomTransformTest</span><span id="454e" class="nb nc it oc b gy ok oh l oi oj"><em class="ln">JUnit version 4.10<br/>.Inside method :: originalRecord :: {payload={additional={groupId=12345}, channel=sms}}<br/>Inside method :: originalRecord :: {Channel=SMS, GroupId=12345}</em></span><span id="29ac" class="nb nc it oc b gy ok oh l oi oj"><em class="ln">Time: 0.016</em></span><span id="2d3a" class="nb nc it oc b gy ok oh l oi oj"><em class="ln">OK (1 test)</em></span></pre><p id="f699" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated">如果您发现上面有任何错误，请确保您的<strong class="lo jd">类路径</strong>包含所有<a class="ae lh" href="https://jar-download.com/?search_box=kafka-connect" rel="noopener ugc nofollow" target="_blank"> Kafka相关jar</a>以及<a class="ae lh" href="https://github.com/junit-team/junit4/wiki/Download-and-Install" rel="noopener ugc nofollow" target="_blank"> JUnit </a>的路径。</p><p id="4bd7" class="pw-post-body-paragraph ll lm it lo b lp lq kd lr ls lt kg lu mi lw lx ly mj ma mb mc mk me mf mg mh im bi translated"><em class="ln">您的定制改造已经就绪！！</em>现在剩下的就是构建JAR并在Kafka worker配置文件的<strong class="lo jd"> <em class="ln"> plugin.path </em> </strong>属性中提及JAR的路径。</p><h1 id="d7cb" class="ol nc it bd nd om on oo ng op oq or nj ki os kj nm kl ot km np ko ou kp ns ov bi translated">结论</h1><p id="0e37" class="pw-post-body-paragraph ll lm it lo b lp nt kd lr ls nu kg lu mi nv lx ly mj nw mb mc mk nx mf mg mh im bi translated">定制转换非常强大，可以通过动态配置和随着需求的发展在单个消息级别上完成很多工作。希望这个简单的演练能让你写出各种复杂的业务需求！</p></div></div>    
</body>
</html>