<html>
<head>
<title>How to Use MongoDB to Store and Retrieve ML Models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用MongoDB存储和检索ML模型</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-use-mongodb-to-store-and-retrieve-ml-models-2a8a831e7326?source=collection_archive---------0-----------------------#2021-02-18">https://pub.towardsai.net/how-to-use-mongodb-to-store-and-retrieve-ml-models-2a8a831e7326?source=collection_archive---------0-----------------------#2021-02-18</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><h2 id="fdcf" class="is it iu bd b dl iv iw ix iy iz ja dk jb translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/machine-learning" rel="noopener ugc nofollow" target="_blank">机器学习</a>，<a class="ae ep" href="https://towardsai.net/p/category/data-science" rel="noopener ugc nofollow" target="_blank">数据科学</a></h2><div class=""/><div class=""><h2 id="38c7" class="pw-subtitle-paragraph ka jd iu bd b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dk translated">使用MongoDB的GridFS特性来存储和检索机器学习模型</h2></div><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ks"><img src="../Images/5858580afdffa012fb640219e93f45dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OXptNMQjweET2-W2.png"/></div></div><figcaption class="le lf gk gi gj lg lh bd b be z dk translated">来源:mongoDB.com<a class="ae li" href="https://webassets.mongodb.com/_com_assets/cms/mongodb_logo1-76twgcu2dm.png" rel="noopener ugc nofollow" target="_blank"/></figcaption></figure></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><p id="e28b" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">如果你正在寻找一个数据库来存储你的机器学习模型，那么这篇文章就是为你准备的。你可以使用<strong class="ls je"> MongoDB </strong>来存储和检索你的机器学习模型。不多说了，让我们直奔主题吧。</p></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="a13d" class="mm mn iu bd mo mp mq mr ms mt mu mv mw kj mx kk my km mz kn na kp nb kq nc nd bi translated">MongoDB</h1><p id="d2f2" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">MongoDB是一个非常流行的NoSQL数据库。在MongoDB中，数据以类似JSON的文档形式存储。更具体地说，文档是以BSON对象的形式存储的，它只不过是用JSON格式表示的二进制数据。</p><blockquote class="nj nk nl"><p id="8d7a" class="lq lr nm ls b lt lu ke lv lw lx kh ly nn ma mb mc no me mf mg np mi mj mk ml in bi translated">MongoDB中的<strong class="ls je">文档</strong>和<strong class="ls je">集合</strong>分别类似于关系数据库(RDBMS)中的<strong class="ls je">记录</strong>和<strong class="ls je">表</strong>。</p></blockquote><p id="ec24" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">如果您已经在使用MongoDB，那么您必须知道BSON文档的大小限制是16 MB。也就是说，如果文件大小超过16 MB，就不能存储。这对你来说也意味着，如果你的机器学习模型大小超过16 MB，你就不能使用MongoDB文档存储。</p><p id="67d6" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">参考下面的例子，当模型大小小于16 MB时，从MongoDB存储和检索。</p><pre class="kt ku kv kw gu nq nr ns nt aw nu bi"><span id="adf0" class="nv mn iu nr b gz nw nx l ny nz">from bson.binary import Binary<br/>from bson import ObjectId<br/>import pymongo, gridfs<br/>from gridfs import GridFS<br/>from pymongo import MongoClient</span><span id="bab5" class="nv mn iu nr b gz oa nx l ny nz">MONGO_HOST = "127.0.0.1"<br/>MONGO_PORT = 27017<br/>MONGO_DB = "myDB"</span><span id="4028" class="nv mn iu nr b gz oa nx l ny nz">model_file = 'keras_model.h5'</span><span id="c3a8" class="nv mn iu nr b gz oa nx l ny nz">myclient = pymongo.MongoClient(MONGO_HOST, MONGO_PORT)<br/>mydb = myclient[MONGO_DB]<br/>mycol = mydb['mycollection']</span><span id="c1c8" class="nv mn iu nr b gz oa nx l ny nz"># Store model as binary document<br/>with open(model_file, "rb") as f:<br/>    encoded = Binary(f.read())</span><span id="8be2" class="nv mn iu nr b gz oa nx l ny nz">mycol.insert_one({"filename": model_file, "file": encoded, "description": "Keras model" })</span><span id="6565" class="nv mn iu nr b gz oa nx l ny nz"># Retrieve and store the ML model from MongoDB<br/>data = mycol.find_one({'filename': 'keras_model.h5'})<br/>with open("keras_model_fromMongo.h5", "wb") as f:<br/>    f.write(data['file'])</span></pre><p id="de94" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">我知道你一定在想什么。<strong class="ls je">模型大小超过16 MB怎么办？这是一个非常合理的问题。不要惊讶，有时模型大小会以千兆字节为单位(例如transformer模型)。在这种情况下，MongoDB提供了GridFS API，可以用来存储大于16 MB的文档。让我们在下一节看看GridFS。</strong></p></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="582d" class="mm mn iu bd mo mp mq mr ms mt mu mv mw kj mx kk my km mz kn na kp nb kq nc nd bi translated">GridFS</h1><p id="f4a5" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">GridFS是一个文件系统，用于存储和检索大于BSON文档16 MB大小限制的文档。即使文件小于16 MB，也可以使用它。</p><h2 id="eec8" class="nv mn iu bd mo ob oc dn ms od oe dp mw lz of og my md oh oi na mh oj ok nc ja bi translated">GridFS如何存储数据</h2><p id="5e9f" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">GridFS把文件分成所谓的<strong class="ls je">块</strong>，每个块作为一个文档单独存储。默认情况下，每个卡盘的大小为255 KB。只有最后一个区块可以是255 KB或更小。</p><p id="edb4" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">GridFS使用两个集合(表)块和文件来存储文件。从下图中可以看出，GridFS将这两个集合添加到默认的bucket <strong class="ls je"> fs中。</strong></p><ul class=""><li id="6abb" class="ol om iu ls b lt lu lw lx lz on md oo mh op ml oq or os ot bi translated"><strong class="ls je"> chunks </strong>:这个集合存储所有包含二进制格式数据的块。</li><li id="a9d7" class="ol om iu ls b lt ou lw ov lz ow md ox mh oy ml oq or os ot bi translated"><strong class="ls je"> files: </strong>这个集合存储文件的元数据。</li></ul><p id="ba19" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">请参考关于<a class="ae li" href="https://docs.mongodb.com/manual/core/gridfs/#the-chunks-collection" rel="noopener ugc nofollow" target="_blank"> <strong class="ls je">组块</strong> </a>和<a class="ae li" href="https://docs.mongodb.com/manual/core/gridfs/#the-files-collection" rel="noopener ugc nofollow" target="_blank"> <strong class="ls je">文件</strong> </a> <strong class="ls je"> </strong>的官方文档，了解这两个集合中的字段及其描述等更多详细信息。</p><p id="60f5" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">本文的主要目标是使用GridFS来存储和检索机器学习模型。现在，让我们来看看一些代码。</p><h2 id="4f7f" class="nv mn iu bd mo ob oc dn ms od oe dp mw lz of og my md oh oi na mh oj ok nc ja bi translated">将ML模型存储到MongoDB中</h2><p id="6a93" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">首先，您需要导入所需的库并初始化一些变量，如<strong class="ls je"> MONGO_HOST </strong>、<strong class="ls je"> MONGO_PORT </strong>和<strong class="ls je"> MONGO_DB </strong>。接下来，创建MongoClient对象<strong class="ls je"> myclient </strong>，用于连接到特定的数据库(本例中为‘mydb’)。然后，创建一个GridFS实例，在特定数据库上运行。最后，使用GridFS对象的<strong class="ls je"> put() </strong>方法将模型存储到MongoDB中。</p><p id="dc47" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">注意，<strong class="ls je"> put() </strong>方法返回<strong class="ls je"> ObjectId </strong>，然后在从MongoDB中检索模型时使用它。</p><pre class="kt ku kv kw gu nq nr ns nt aw nu bi"><span id="0686" class="nv mn iu nr b gz nw nx l ny nz">import io <br/>import pymongo, gridfs<br/>from gridfs import GridFS<br/>from pymongo import MongoClient</span><span id="cda7" class="nv mn iu nr b gz oa nx l ny nz">MONGO_HOST = "127.0.0.1"<br/>MONGO_PORT = 27017<br/>MONGO_DB = "mydb"</span><span id="280f" class="nv mn iu nr b gz oa nx l ny nz">myclient = pymongo.MongoClient(MONGO_HOST, MONGO_PORT)<br/>mydb = myclient[MONGO_DB]<br/>fs = gridfs.GridFS(mydb)</span><span id="7277" class="nv mn iu nr b gz oa nx l ny nz">model_name = 'tf_model.h5'</span><span id="6279" class="nv mn iu nr b gz oa nx l ny nz">with io.FileIO(model_name, 'r') as fileObject:<br/>    docId = fs.put(fileObject, filename=model_name)</span></pre><p id="baa0" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">一旦运行上面的代码，它会将<strong class="ls je"> tf_model.h5 </strong>模型存储到MongoDB中。如前所述，数据被分割成<strong class="ls je">块</strong>并将存储在<strong class="ls je"> fs.chunks </strong>中，元信息将存储在<strong class="ls je"> fs.files </strong>中。</p><p id="9b77" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">对于上面的例子，<strong class="ls je"> tf_model.h5 i </strong>的大小约为347 MB，显然大于16 MB。当使用GridFS存储这个模型时，它被分成1392个块，并作为文档存储。建议您探究<strong class="ls je"> fs.chunks </strong>和<strong class="ls je"> fs.files </strong>的内容，以了解如何操作。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj oz"><img src="../Images/4e47a87e959e9374d35942740781ab8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2aMYdF-4CHBLbHtjzA25jQ.png"/></div></div></figure><h2 id="b30f" class="nv mn iu bd mo ob oc dn ms od oe dp mw lz of og my md oh oi na mh oj ok nc ja bi translated">从MongoDB检索ML模型</h2><p id="b7b2" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">要从MongoDB中检索ML模型，除了最后一个步骤之外，您需要遵循与前面相同的步骤。您需要将想要从MongoDB检索的文件(模型)的<strong class="ls je"> ObjectId </strong>传递给GridFS的<strong class="ls je"> get() </strong>方法。这将把模型从MongoDB下载到本地机器，名为<strong class="ls je">keras _ model _ from mongo . H5 .</strong></p><pre class="kt ku kv kw gu nq nr ns nt aw nu bi"><span id="bc2b" class="nv mn iu nr b gz nw nx l ny nz">import io<br/>import pymongo, gridfs<br/>from bson import ObjectId</span><span id="0cf1" class="nv mn iu nr b gz oa nx l ny nz">MONGO_HOST = "127.0.0.1"<br/>MONGO_PORT = 27017<br/>MONGO_DB = "mydb"</span><span id="c163" class="nv mn iu nr b gz oa nx l ny nz">con = pymongo.MongoClient(MONGO_HOST, MONGO_PORT)<br/>db = con[MONGO_DB]<br/>fs = gridfs.GridFS(db)</span><span id="15d6" class="nv mn iu nr b gz oa nx l ny nz">with open(’keras_model_fromMongo.h5’, 'wb’) as fileObject:<br/>    fileObject.write(fs.get(ObjectId(<strong class="nr je">docId</strong>))<br/>                     .read() )</span></pre><p id="407f" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">注意，GridFS的使用不仅限于存储和检索机器学习模型。你可以用它来存储任何类型的文件，如文本文件，图像，视频等。</p><p id="ca98" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated"><em class="nm">最初发表于</em><a class="ae li" href="https://pythonsimplified.com/how-to-use-mongodb-to-store-and-retrieve-ml-models/" rel="noopener ugc nofollow" target="_blank"><strong class="ls je"><em class="nm">python简化版</em></strong></a><strong class="ls je"><em class="nm"/></strong><em class="nm">2021年2月9日。</em></p><p id="f295" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated"><em class="nm">阅读更多关于Python和数据科学的有趣文章，</em> <a class="ae li" href="https://pythonsimplified.com/home/" rel="noopener ugc nofollow" target="_blank"> <strong class="ls je"> <em class="nm">订阅</em> </strong> </a> <em class="nm">到我的博客</em><a class="ae li" href="http://www.pythonsimplified.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ls je"><em class="nm">pythonsimplified.com</em></strong><strong class="ls je"><em class="nm">。</em> </strong>你也可以在</a><a class="ae li" href="https://www.linkedin.com/in/chetanambi/" rel="noopener ugc nofollow" target="_blank"><strong class="ls je">LinkedIn</strong></a><strong class="ls je">上联系我。</strong></p><h1 id="542f" class="mm mn iu bd mo mp pa mr ms mt pb mv mw kj pc kk my km pd kn na kp pe kq nc nd bi translated">结论</h1><p id="2189" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">MongoDB BSON文档有一个16 MB的大小限制，所以它不能用来存储任何大于这个限制的文档。您知道使用GridFS API，您可以将大型对象(包括机器学习模型)存储到MongoDB中。您还通过示例了解了如何从MongoDB存储和检索模型。</p><p id="a485" class="pw-post-body-paragraph lq lr iu ls b lt lu ke lv lw lx kh ly lz ma mb mc md me mf mg mh mi mj mk ml in bi translated">我希望你喜欢阅读这篇文章。如果你喜欢我的文章并想订阅Medium，你可以在这里这样做: </p><div class="pf pg gq gs ph pi"><a href="https://chetanambi.medium.com" rel="noopener follow" target="_blank"><div class="pj ab fp"><div class="pk ab pl cl cj pm"><h2 class="bd je gz z fq pn fs ft po fv fx jd bi translated">Chetan Ambi -介质</h2><div class="pp l"><h3 class="bd b gz z fq pn fs ft po fv fx dk translated">阅读Chetan Ambi在媒体上的文章。数据科学|机器学习| Python。参观https://pythonsimplified.com/…</h3></div><div class="pq l"><p class="bd b dl z fq pn fs ft po fv fx dk translated">chetanambi.medium.com</p></div></div><div class="pr l"><div class="ps l pt pu pv pr pw lc pi"/></div></div></a></div></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="bbc2" class="mm mn iu bd mo mp mq mr ms mt mu mv mw kj mx kk my km mz kn na kp nb kq nc nd bi translated">参考</h1><p id="4923" class="pw-post-body-paragraph lq lr iu ls b lt ne ke lv lw nf kh ly lz ng mb mc md nh mf mg mh ni mj mk ml in bi translated">[1].<a class="ae li" href="https://docs.mongodb.com/manual/core/gridfs/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/core/gridfs/</a></p></div></div>    
</body>
</html>