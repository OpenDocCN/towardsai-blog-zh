<html>
<head>
<title>How To Make Cloud Cost Estimation With Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Terraform进行云成本估算</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/cost-driven-infrastructure-development-with-infracost-183a83048bc6?source=collection_archive---------2-----------------------#2021-05-30">https://pub.towardsai.net/cost-driven-infrastructure-development-with-infracost-183a83048bc6?source=collection_archive---------2-----------------------#2021-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4cde" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在您的拉取请求中自动估算云成本</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/580722d825144f1c02bfe8ca016cc30e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-AH_uBWTx-izVK6G.jpg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@executium?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">行政长官</a>在<a class="ae kv" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">广场</a>拍照</figcaption></figure><p id="e29b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">云计算非常适合快速发展您的业务。您只需为您使用的东西付费。这是一把双刃剑，你可以节省很多，也可以付出很多。这就是为什么每天分析你的账单是很重要的一点。云计算提供商提供工具来分析成本。这是一项枯燥但必要的任务。</p><p id="5c3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将看到如何以一种更有趣的方式来做这件事。众所周知，云基础设施通常作为代码来管理。最常用的工具是Terraform。它能够跟踪代码和现有内容之间的变化。</p><p id="3166" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个变化都涉及成本，我们将看到如何用Infracost将这个维度添加到Terraform中。最后，您将知道如何度量变更的成本，并将其集成到您的代码审查中。这里以该项目为例进行介绍</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e09e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">什么是Infracost？</h1><blockquote class="mr ms mt"><p id="0387" class="kw kx mu ky b kz la jr lb lc ld ju le mv lg lh li mw lk ll lm mx lo lp lq lr ij bi translated"><em class="iq">“infra cost显示了基础设施即代码项目(如Terraform)的云成本估算。它有助于DevOps、SRE和开发人员快速看到成本明细，并提前比较不同的选项。”</em><a class="ae kv" href="https://github.com/infracost/infracost" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/infracost/infracost</em></a></p></blockquote><p id="3a07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Infracost是一个简单的可执行程序。所以在CI/CD管道中安装和使用它非常简单。这里我们将使用Terraform，但在项目路线图中，计划使用其他工具，如<a class="ae kv" href="https://www.pulumi.com/" rel="noopener ugc nofollow" target="_blank"> Pulumi </a>或<a class="ae kv" href="https://aws.amazon.com/cloudformation" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>。</p><p id="f114" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦下载，Infracost只需要注册，你就可以走了！</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="bd32" class="nd ma iq mz b gy ne nf l ng nh">$ infracost register <br/>Please enter your name and email address to get an API key. See our FAQ (https://www.infracost.io/docs/faq) for more details. <br/>Name: Guillaume Vincent <br/>Email: <a class="ae kv" href="https://getbetterdevops.io/cdn-cgi/l/email-protection" rel="noopener ugc nofollow" target="_blank">[email protected]</a> <br/>Thank you Guillaume Vincent! Your API key is: xxxxxxxxxxxxxxxxxxxxxxxxx <br/>Success: Your API key has been saved to /Users/gvincent/.config/infracost/credentials.yml You can now run infracost breakdown --path=... and point to your Terraform directory or JSON/plan file.</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="756b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">估计成本</h1><h2 id="3e72" class="nd ma iq bd mb ni nj dn mf nk nl dp mj lf nm nn ml lj no np mn ln nq nr mp ns bi translated">成本的详细分类</h2><p id="ed8a" class="pw-post-body-paragraph kw kx iq ky b kz nt jr lb lc nu ju le lf nv lh li lj nw ll lm ln nx lp lq lr ij bi translated">可以执行Infracost以获得完整的月度成本明细:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="8d6f" class="nd ma iq mz b gy ne nf l ng nh">$ infracost breakdown --path terraform_nlb_static_eips<br/>Detected Terraform directory at terraform_nlb_static_eips<br/>  ✔ Running terraform init<br/>  ✔ Running terraform plan<br/>  ✔ Running terraform show<br/>✔ Calculating monthly cost estimate<br/>Project: terraform_nlb_static_eips<br/>Name                                                      Monthly Qty  Unit            Monthly Cost<br/>aws_autoscaling_group.webserver<br/> └─ aws_launch_configuration.webserver<br/>    ├─ Instance usage (Linux/UNIX, on-demand, t2.micro)              0  hours                  $0.00<br/>    ├─ EC2 detailed monitoring                                       0  metrics                $0.00<br/>    └─ root_block_device<br/>       └─ Storage (general purpose SSD, gp2)                         0  GB-months              $0.00<br/>aws_eip.nlb<br/> └─ IP address (if unused)                                         730  hours                  $3.65<br/>aws_lb.this<br/> ├─ Network load balancer                                          730  hours                 $16.42<br/> └─ Load balancer capacity units                         Cost depends on usage: $0.006 per LCU-hours<br/>PROJECT TOTAL                                                                                $20.07</span></pre><p id="7062" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以修改代码并重新运行之前的命令，以获得新版本的更新成本估计。</p><h2 id="ee9c" class="nd ma iq bd mb ni nj dn mf nk nl dp mj lf nm nn ml lj no np mn ln nq nr mp ns bi translated">当前状态和计划状态之间的每月成本差异</h2><p id="eacf" class="pw-post-body-paragraph kw kx iq ky b kz nt jr lb lc nu ju le lf nv lh li lj nw ll lm ln nx lp lq lr ij bi translated">Terraform更新、删除或创建资源将基础结构状态保存在文件中。当您部署一个新版本时，Terraform能够根据您的更改检测出需要更新、删除和创建的内容。Infracost依靠这个状态文件向您显示当前计划变更的成本影响。</p><p id="2ef4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了说明这一点，我使用<code class="fe ny nz oa mz b">terraform apply</code>部署了初始代码版本。然后我将当前的EC2实例类型从<code class="fe ny nz oa mz b">t2.micro</code>扩展到<code class="fe ny nz oa mz b">m4.large</code>:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="6c79" class="nd ma iq mz b gy ne nf l ng nh">$ git --no-pager diff                                                                                                                             <br/>diff --git a/launch-configuration.tf b/launch-configuration.tf<br/>index db22265..bcf90c7 100644<br/>--- a/launch-configuration.tf<br/>+++ b/launch-configuration.tf<br/>@@ -1,7 +1,7 @@<br/> resource "aws_launch_configuration" "webserver" {<br/>   name_prefix                 = "${local.name_prefix}_webserver"<br/>   image_id                    = data.aws_ami.ubuntu.image_id<br/>-  instance_type               = "t2.micro"<br/>+  instance_type               = "m4.large"<br/>   security_groups             = [<br/>  aws_security_group.public.id]<br/>   user_data                   = data.template_cloudinit_config.this.rendered</span></pre><p id="882f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我使用diff参数启动Infracost命令:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="e67e" class="nd ma iq mz b gy ne nf l ng nh">$ infracost diff --path .                                                                                                                                                                           <br/>Detected Terraform directory at .<br/>  ✔ Running terraform plan<br/>  ✔ Running terraform show<br/>✔ Calculating monthly cost estimate<br/>Project: .<br/>~ aws_autoscaling_group.webserver<br/>  +$64.53 ($11.37 -&gt; $75.90)<br/>~ aws_launch_configuration.webserver<br/>- Instance usage (Linux/UNIX, on-demand, t2.micro)<br/>          -$8.47<br/>+ Instance usage (Linux/UNIX, on-demand, m4.large)<br/>          +$73.00<br/>Monthly cost change for .<br/>Amount:  +$64.53 ($27.79 -&gt; $92.32)<br/>Percent: +232%</span></pre><p id="e3e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">diff用法非常适合添加到代码评审的补充中，以证明和论证变更的成本。</p><h2 id="6617" class="nd ma iq bd mb ni nj dn mf nk nl dp mj lf nm nn ml lj no np mn ln nq nr mp ns bi translated">使用使用文件改进成本估算</h2><p id="fb09" class="pw-post-body-paragraph kw kx iq ky b kz nt jr lb lc nu ju le lf nv lh li lj nw ll lm ln nx lp lq lr ij bi translated">您可以向Infracost提供一个使用文件来细化成本估算:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">terracost-usage-example.yml</figcaption></figure><p id="0869" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该文件被添加到命令参数中:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="e844" class="nd ma iq mz b gy ne nf l ng nh">$ infracost breakdown --path . --format html &gt; report.html</span></pre><h2 id="6b2a" class="nd ma iq bd mb ni nj dn mf nk nl dp mj lf nm nn ml lj no np mn ln nq nr mp ns bi translated">报告</h2><p id="9120" class="pw-post-body-paragraph kw kx iq ky b kz nt jr lb lc nu ju le lf nv lh li lj nw ll lm ln nx lp lq lr ij bi translated">您可以生成<a class="ae kv" href="https://www.infracost.io/docs/multi_project/report" rel="noopener ugc nofollow" target="_blank">报告</a>来共享不同格式(HTML、JSON等)的成本估算..) :</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl od"><img src="../Images/e52860322ff780a7c3bc976e4cb33c98.png" data-original-src="https://miro.medium.com/v2/format:webp/1*yu4YGds9vQKZzV32zbm2fQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">HTML成本估算报告</figcaption></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="5781" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">将Infracost添加到GitHub操作</h1><p id="b5d7" class="pw-post-body-paragraph kw kx iq ky b kz nt jr lb lc nu ju le lf nv lh li lj nw ll lm ln nx lp lq lr ij bi translated">您可以将Infracost与许多CI/CD解决方案集成在一起。这里我们将关注Github动作，因为重用来自<a class="ae kv" href="https://github.com/marketplace?type=actions" rel="noopener ugc nofollow" target="_blank">市场</a>的现有动作很容易。在工作流中，我们将使用以下操作:</p><ul class=""><li id="d4e4" class="oe of iq ky b kz la lc ld lf og lj oh ln oi lr oj ok ol om bi translated"><a class="ae kv" href="https://github.com/infracost/infracost-gh-action" rel="noopener ugc nofollow" target="_blank"> Infracost动作</a></li><li id="770b" class="oe of iq ky b kz on lc oo lf op lj oq ln or lr oj ok ol om bi translated"><a class="ae kv" href="https://github.com/aws-actions/configure-aws-credentials" rel="noopener ugc nofollow" target="_blank">配置凭证的AWS操作</a></li></ul><p id="8da6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">工作流的配置在<code class="fe ny nz oa mz b">.github/workflows/infracost.yml</code>的terraform git项目中进行配置:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">。github/workflows/infracost.yml</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl od"><img src="../Images/4f2a5cc07d50de0ccc274a0e5a389a15.png" data-original-src="https://miro.medium.com/v2/format:webp/1*lakWaMzZEAywASPzvT7hsw.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">储存在保管库中的GitHub操作工作流所需的凭据</figcaption></figure><p id="f1df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将之前的实例类型更改提交给了名为dev的分支，并打开了一个pull请求。这将触发工作流的步骤:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl od"><img src="../Images/3277c986f671e94804a99728508f8579.png" data-original-src="https://miro.medium.com/v2/format:webp/1*RRRgeplL082b0pF1HOhbyw.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">GitHub拉请求的创建</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl od"><img src="../Images/5d7958ba35c5b2a6e7cc10ff6af7096c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*4-QjGbEms10SNK05NdCvpA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">GitHub动作工作流程步骤的执行</figcaption></figure><p id="5fdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当执行的工作流结束时，Infracost输出在pull请求中可见:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl od"><img src="../Images/e9e7e7a3109673e26f4f7e24ae8e60fd.png" data-original-src="https://miro.medium.com/v2/format:webp/1*XmccVPClc7O_Clbz0u0R-g.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">拉取请求中的Infracost输出</figcaption></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="b122" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">资源</h1><div class="os ot gp gr ou ov"><a href="https://guillaume-vincent.medium.com/aws-load-balancer-and-static-ip-with-terraform-939f49475c80" rel="noopener follow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">将静态Ip分配给AWS负载平衡器</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">用Terraform配置网络负载平衡器</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">guillaume-vincent.medium.com</p></div></div><div class="pe l"><div class="pf l pg ph pi pe pj kp ov"/></div></div></a></div><div class="os ot gp gr ou ov"><a href="https://www.infracost.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">拉式请求中Terraform的云成本估算| Infracost</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">Infracost显示Terraform项目的云成本估算。它集成到拉请求中，并允许开发人员和…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">www.infracost.io</p></div></div><div class="pe l"><div class="pk l pg ph pi pe pj kp ov"/></div></div></a></div><div class="os ot gp gr ou ov"><a href="https://github.com/infracost/infracost" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">低于成本/低于成本</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">Infracost显示了Terraform等基础设施即代码项目的云成本估算。它帮助德沃普斯，SRE和…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">github.com</p></div></div><div class="pe l"><div class="pl l pg ph pi pe pj kp ov"/></div></div></a></div><div class="os ot gp gr ou ov"><a href="https://github.com/features/actions" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">功能* GitHub操作</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">github.com</p></div></div><div class="pe l"><div class="pm l pg ph pi pe pj kp ov"/></div></div></a></div><div class="os ot gp gr ou ov"><a href="https://github.com/infracost/infracost-gh-action" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">infra cost/infra cost-GH-行动</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">每当Terraform文件发生变化时，这个GitHub操作都会针对pull请求运行Infracost。它会自动添加一个拉力…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">github.com</p></div></div></div></a></div><div class="os ot gp gr ou ov"><a href="https://github.com/aws-actions/configure-aws-credentials" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">AWS-操作/配置-AWS-凭据</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">配置AWS凭据和区域环境变量，以便在其他GitHub操作中使用。环境变量…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">github.com</p></div></div><div class="pe l"><div class="pn l pg ph pi pe pj kp ov"/></div></div></a></div></div></div>    
</body>
</html>