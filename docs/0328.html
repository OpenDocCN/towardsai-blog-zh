<html>
<head>
<title>How To Commit Your Cloud Credentials To Version Control Systems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将您的云凭证提交给版本控制系统</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-safely-commit-your-aws-credentials-to-github-21d3bf7771e7?source=collection_archive---------0-----------------------#2020-02-24">https://pub.towardsai.net/how-to-safely-commit-your-aws-credentials-to-github-21d3bf7771e7?source=collection_archive---------0-----------------------#2020-02-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="05a4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将您的云凭据安全地提交给版本控制系统</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/8936c7817c5bc70cf4a599389e265b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*_nHXWEamncDgRyWofq5Vog.png"/></div></figure><h1 id="718b" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">介绍</h1><p id="8464" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在本文中，我将分享一种安全地将敏感信息提交给版本控制系统(VCS)的方法。重点将是提交AWS凭证，但该方法也适用于Azure和谷歌云平台(GCP)。</p><p id="81ef" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">重现结果的代码可以在<a class="ae mj" href="https://github.com/hsm207/secure_credentials" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="62d8" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">本文面向数据科学家；您没有软件开发背景，因此不了解软件工程的最佳实践。然而，从这个<a class="ae mj" href="https://github.com/search?p=2&amp;q=removed+password&amp;type=Commits" rel="noopener ugc nofollow" target="_blank">搜索结果</a>来看，似乎总的来说开发者也能受益。</p><h1 id="e8a7" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">动机</h1><p id="745e" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">假设您是一名初级数据科学家，负责构建一个管道来分析文本数据。自然，这个任务包括在S3桶周围移动文件，并调用各种AWS服务来做诸如情感分析、命名实体识别、主题建模等事情。</p><p id="467e" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">您将获得一组允许您访问这些服务的凭据。您决定通过环境变量进行身份验证，因此您编写了一个名为<code class="fe mk ml mm mn b">env.sh</code>的脚本，它执行以下操作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/78b7f8f16507cc5b0d947458d624c710.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*a3Cik4wLnhSdhwJlwZQx2Q.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图1:导出环境变量以认证AWS服务的脚本</figcaption></figure><p id="e92f" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">你应该把这个剧本交给你的VCS吗？</p><p id="2be0" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">提交这个脚本可以方便您的同事从您停止的地方继续工作。他们不需要搜索合适的凭证。他们只需要克隆你的回购，一切都将开箱即用。</p><p id="b142" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">但是，提交该脚本存在安全风险。想象一下，有人入侵/泄露了你公司VCS服务器的内容。或者，也许你的公司有一天决定开源这个回购协议，从而意外地将他们的私人信息暴露给全世界，因为他们忘记了将它从回购协议的历史中抹去。</p><p id="bdcb" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">有没有兼顾便利性和安全性的解决方案？</p><h1 id="acbe" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">问题陈述</h1><p id="3fc5" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了使事情更加具体，我们将使用下面的脚本<code class="fe mk ml mm mn b">main.py</code>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/669a946b09a5ceea94e9394210c6ba16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Gf43HEeDB9Iksx5zl58Sbw.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图2:main . py的内容</figcaption></figure><p id="074f" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">用<code class="fe mk ml mm mn b">python main.py "this movie is really awesome!"</code>调用<code class="fe mk ml mm mn b">main.py</code>会调用亚马逊领悟为文本<code class="fe mk ml mm mn b">"this movie is really awesome!"</code>产生一个情感分类和置信度评分，像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/94cf0d938dea18ade756d98338d0c2e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:554/format:webp/1*saHWIvevq5v733JX-I_VSg.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图3:main . py的示例输出</figcaption></figure><p id="ee4c" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">本文中与<code class="fe mk ml mm mn b">main.py</code>相关的部分是第8行，它为所需的服务创建了一个客户机，并依赖于<code class="fe mk ml mm mn b">AWS_ACCESS_KEY_ID</code>和<code class="fe mk ml mm mn b">AWS_SECRET_ACCESS_KEY</code>环境变量的存在来进行认证。因此，您需要在运行<code class="fe mk ml mm mn b">main.py</code>之前执行<code class="fe mk ml mm mn b">source env.sh</code>。</p><p id="efdf" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">现在的问题是:我们应该如何承诺<code class="fe mk ml mm mn b">env.sh</code>？</p><h1 id="589a" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">解决办法</h1><h2 id="d64d" class="mv kr it bd ks mw mx dn kw my mz dp la lr na nb lc lv nc nd le lz ne nf lg ng bi translated">概观</h2><p id="512d" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">解决方案包括使用名为<a class="ae mj" href="https://github.com/mozilla/sops#sops-secrets-operations" rel="noopener ugc nofollow" target="_blank"> sops </a>的工具对<code class="fe mk ml mm mn b">env.sh</code>进行加密，并使用<a class="ae mj" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> AWS KMS </a>来管理加密和解密过程的密钥。Sops可以在Windows、Linux和Mac上运行，并且可以与AWS KMS以及Azure和GCP的类似服务很好地集成。</p><p id="04ea" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在使用sop加密<code class="fe mk ml mm mn b">env.sh</code>之前，我们需要经历几个步骤。</p><h2 id="00cb" class="mv kr it bd ks mw mx dn kw my mz dp la lr na nb lc lv nc nd le lz ne nf lg ng bi translated">先决条件</h2><p id="f880" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">就AWS服务而言，您需要访问AWS KMS的客户管理密钥(CMK)。一种方法是让您的帐户管理员为您创建和管理此密钥，并创建另一个IAM用户，其唯一目的是能够使用此密钥进行文件加密/解密。我们姑且称这个用户为<code class="fe mk ml mm mn b">sops-user</code>。</p><p id="1a47" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">作为普通帐户用户，您只需遵循以下步骤:</p><ol class=""><li id="c272" class="nh ni it lk b ll me lo mf lr nj lv nk lz nl md nm nn no np bi translated">安装sop。点击<a class="ae mj" href="https://github.com/mozilla/sops/releases" rel="noopener ugc nofollow" target="_blank">此处</a>为您的机器下载相关软件包。</li><li id="4869" class="nh ni it lk b ll nq lo nr lr ns lv nt lz nu md nm nn no np bi translated">更新您的AWS凭证文件以包含<code class="fe mk ml mm mn b">sop-user</code>的凭证:</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/3272db3ec55c85c11108e347131b49c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*avV6lCTYzBBLrrntxK1H4A.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图4:插入AWS凭证文件的额外内容</figcaption></figure><p id="5546" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">3.定义<code class="fe mk ml mm mn b">SOPS_KMS_ARN</code>环境变量，以便sop知道在哪里可以找到CMK:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/4127e518f1bae8586da95e63834a1d62.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*5lEeqGeWjvjQfa6tG9Vu2Q.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图5:如何告诉sop使用哪个CMK</figcaption></figure><p id="eeaa" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">解决了这个问题，我们现在准备加密<code class="fe mk ml mm mn b">env.sh</code>。</p><h2 id="03bd" class="mv kr it bd ks mw mx dn kw my mz dp la lr na nb lc lv nc nd le lz ne nf lg ng bi translated">加密敏感信息</h2><p id="eb62" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">加密<code class="fe mk ml mm mn b">env.sh</code>只是一个执行的问题:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/cbff10041d5b87ce93b3def85db41264.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*lKD3jeNVxnBInhdY3wyDqQ.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图6:如何加密env.sh</figcaption></figure><p id="36d1" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">这是加密过程后<code class="fe mk ml mm mn b">env.sh</code>的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/9f7533d3ed037e8cc5117145f53d714e.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*vW0Yv5zEoVR5ZTnQxwr8Gg.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图7:加密后的env.sh片段</figcaption></figure><h2 id="f16a" class="mv kr it bd ks mw mx dn kw my mz dp la lr na nb lc lv nc nd le lz ne nf lg ng bi translated">解密敏感信息</h2><p id="dd9f" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">运行<code class="fe mk ml mm mn b">source env.sh</code>将会抛出一个错误，因为<code class="fe mk ml mm mn b">env.sh</code>不再是一个有效的shell脚本。</p><p id="66f0" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在调用<code class="fe mk ml mm mn b">source</code>之前，您需要解密<code class="fe mk ml mm mn b">env.sh</code>。你可以这样做:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/56d6810389957ff5e6afc771b6ca41ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:404/format:webp/1*LAxHit8Qs1Y6eYywUabu_Q.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图8:如何获得加密的env.sh</figcaption></figure><h1 id="d16f" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">分析</h1><p id="173a" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们花点时间来考虑一下上一节中的解决方案实现了什么。</p><p id="8e3d" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">加密形式的<code class="fe mk ml mm mn b">env.sh</code>(图7)仍然可读，但实际上是乱码。因此，它可以安全地提交给贵公司的VCS。</p><p id="ec80" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">如果这个回购被黑或者泄露给公众会怎么样？如果没有正确的密钥来解密，几乎不可能恢复存储在中的凭据，因为只有密钥可以访问它。请注意，<code class="fe mk ml mm mn b">sops-user</code>的凭证永远不会提交给回购。</p><p id="ef7a" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在合作方面，你的同事只需要知道<code class="fe mk ml mm mn b">sops-user</code>的凭证就可以解密<code class="fe mk ml mm mn b">env.sh</code>，继续开发<code class="fe mk ml mm mn b">main.py</code>。</p><p id="b8c3" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">因此，这种解决方案是方便性和安全性之间的一个很好的折衷。</p><h1 id="6551" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">结论</h1><p id="a3ca" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">本文介绍了一种提交敏感信息的简单方法，即使用名为sops的工具，并利用云服务提供商提供的服务。</p><p id="fa7e" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">如果你有任何问题或者想分享替代方法，请在评论中告诉我。</p></div></div>    
</body>
</html>