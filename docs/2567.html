<html>
<head>
<title>Animating Covid-19 progress and variants over time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">随着时间的推移，动画新冠肺炎的进展和变化</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/animating-covid-19-progress-and-variants-over-time-2250b9ef1a87?source=collection_archive---------2-----------------------#2022-02-22">https://pub.towardsai.net/animating-covid-19-progress-and-variants-over-time-2250b9ef1a87?source=collection_archive---------2-----------------------#2022-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="1598" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/data-visualization" rel="noopener ugc nofollow" target="_blank">数据可视化</a></h2><div class=""/><div class=""><h2 id="9f0e" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">使用R和GGanimate</h2></div><p id="38e1" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我喜欢GGPlot的GGanimate功能，它允许你为你正在制作的任何情节添加第四维度。因此，这不是我归因于使用r构建gif的第一个<a class="ae lk" href="https://medium.com/mlearning-ai/building-animated-graphs-in-r-dcacf0be3255" rel="noopener">帖子</a>。但是，当一些事情很有趣时，你倾向于重复它。所以我们长话短说吧。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="53a7" class="lu lv iq lq b gy lw lx l ly lz">rm(list = ls())<br/>library(tidyverse)<br/>library(readr)<br/>library(ggthemes)<br/>library(lubridate)<br/>library(zoo)<br/>library(gganimate)<br/>library(cowplot)</span></pre><p id="884f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我从OWID下载了Covid数据，还从荷兰国家公共卫生和环境研究所下载了一些数据。我之前在<a class="ae lk" href="https://www.linkedin.com/pulse/omikron-tijd-om-oude-modellen-te-herzien-dr-marc-jacobs" rel="noopener ugc nofollow" target="_blank"> LinkedIN </a>上发布过这个特别的技术文章。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="d602" class="lu lv iq lq b gy lw lx l ly lz">getwd()<br/>data_folder &lt;- file.path("C:/Covid/")<br/>url &lt;- "<a class="ae lk" href="https://covid.ourworldindata.org/data/owid-covid-data.csv" rel="noopener ugc nofollow" target="_blank">https://covid.ourworldindata.org/data/owid-covid-data.csv</a>"<br/>name &lt;- "owid-covid-data.csv"<br/>download.file(url = url, destfile = paste0(data_folder,name))<br/>setwd(data_folder)<br/>Covidowid_covid_data &lt;- read_csv(paste0(data_folder,name))</span><span id="f507" class="lu lv iq lq b gy ma lx l ly lz">data_folder &lt;- file.path("C:/Covid/")<br/>url &lt;- "<a class="ae lk" href="https://data.rivm.nl/covid-19/COVID-19_varianten.csv" rel="noopener ugc nofollow" target="_blank">https://data.rivm.nl/covid-19/COVID-19_varianten.csv</a>"<br/>name &lt;- "COVID-19_varianten.csv"<br/>download.file(url = url, destfile = paste0(data_folder,name))<br/>setwd(data_folder)<br/>variants  &lt;- read_delim(paste0(data_folder,name),<br/>                        delim = ";", escape_double = FALSE, trim_ws = TRUE)</span></pre><p id="932d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">然后，我转换数据来模仿《纽约时报》的文章，该文章指出Omikron可能有一些潜在的威胁。所以我所做的是通过使用移动平均数，对数值和滞后来联系感染，住院和死亡。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="f570" class="lu lv iq lq b gy lw lx l ly lz">df&lt;-Covidowid_covid_data<br/>countries &lt;- c(unique(df_owid$iso_code))<br/>dfNLD &lt;- df%&gt;%<br/>  dplyr::filter(iso_code == "NLD")%&gt;%<br/>  dplyr::select(date,iso_code,date,new_cases_per_million, new_deaths_per_million)%&gt;%<br/>  dplyr::mutate(cases_07da       = zoo::rollmean(new_cases_per_million, k = 7, fill = NA),<br/>                deaths_07da      = zoo::rollmean(new_deaths_per_million, k = 7, fill = NA),<br/>                deathdate_21plus = date - 21)<br/>head(dfNLD)<br/>ggplot(dfNLD)+<br/>  geom_line(aes(x=date, y=log(cases_07da), colour="New Cases"))+<br/>  geom_line(aes(x=deathdate_21plus, y=log(deaths_07da), colour="New Deaths"))+<br/>  scale_colour_manual(name="",<br/>                      values=c('red', 'grey'), <br/>                      labels = c("Cases", "Deaths 21 days later"))+<br/>  theme_bw()+<br/>  theme(legend.position="bottom")+<br/>  labs(x="Date", <br/>        y="New Cases and New Deaths (log Scale)", <br/>        title="New Cases vs New Deaths on a 7-day moving average log scale")</span></pre><figure class="ll lm ln lo gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mb"><img src="../Images/54f9da31de78f3422d333c178bb15d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w06GMmpZX_6bQ4gaKPi3Pw.png"/></div></div></figure><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="2475" class="lu lv iq lq b gy lw lx l ly lz">dfNLD &lt;- df%&gt;%<br/>  dplyr::filter(iso_code == "NLD")%&gt;%<br/>  dplyr::select(date,iso_code,date,new_cases_per_million, icu_patients_per_million)%&gt;%<br/>  dplyr::mutate(cases_07da       = zoo::rollmean(new_cases_per_million, k = 7, fill = NA),<br/>                ICU_07da      = zoo::rollmean(icu_patients_per_million, k = 7, fill = NA),<br/>                ICUdate_14plus = date - 14)<br/>ggplot(dfNLD)+<br/>  geom_line(aes(x=date, y=log(cases_07da), colour="New Cases"))+<br/>  geom_line(aes(x=ICUdate_14plus , y=log(ICU_07da), colour="New ICU"))+<br/>  scale_colour_manual(name="",<br/>                      values=c('red', 'grey'), <br/>                      labels = c("Cases", "ICU 14 days later"))+<br/>  theme_bw()+<br/>  theme(legend.position="bottom")+<br/>  labs(x="Date", <br/>       y="New Cases and ICU (log Scale)", <br/>       title="New Cases vs ICU on a 7-day moving average log scale")</span></pre><figure class="ll lm ln lo gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mj"><img src="../Images/4ede51d364b8a3c412222fd028723f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qEhA8l2zR0TxZkNpp9cMtw.png"/></div></div></figure><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="b38e" class="lu lv iq lq b gy lw lx l ly lz">dfNLD &lt;- df%&gt;%<br/>  dplyr::filter(iso_code == "NLD")%&gt;%<br/>  dplyr::select(date,iso_code,date,new_cases_per_million, hosp_patients_per_million)%&gt;%<br/>  dplyr::mutate(cases_07da       = zoo::rollmean(new_cases_per_million, k = 7, fill = NA),<br/>                hosp_07da      = zoo::rollmean(hosp_patients_per_million, k = 7, fill = NA),<br/>                HOSPdate_14plus = date - 14)<br/>ggplot(dfNLD)+<br/>  geom_line(aes(x=date, y=log(cases_07da), colour="New Cases"))+<br/>  geom_line(aes(x=HOSPdate_14plus , y=log(hosp_07da), colour="New Hospital"))+<br/>  scale_colour_manual(name="",<br/>                      values=c('red', 'grey'), <br/>                      labels = c("Cases", "Hospital 14 days later"))+<br/>  theme_bw()+<br/>  theme(legend.position="bottom")+<br/>  labs(x="Date", <br/>       y="New Cases and Hospital (log Scale)", <br/>       title="New Cases vs Hospital on a 7-day moving average log scale")</span></pre><figure class="ll lm ln lo gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mk"><img src="../Images/9e2a409ca29ad5bac6a004f4e7574b83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VnnQYNRsh3GFmenSQXueAQ.png"/></div></div></figure><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="588d" class="lu lv iq lq b gy lw lx l ly lz">dfNLD &lt;- df%&gt;%<br/>  dplyr::filter(iso_code == "NLD")%&gt;%<br/>  dplyr::select(date,iso_code,date,new_cases_per_million, hosp_patients_per_million,icu_patients_per_million,new_deaths_per_million)%&gt;%<br/>  dplyr::mutate(cases_07da       = zoo::rollmean(new_cases_per_million, k = 7, fill = NA),<br/>                hosp_07da        = zoo::rollmean(hosp_patients_per_million, k = 7, fill = NA),<br/>                HOSPdate_14plus  = date - 14,<br/>                deaths_07da      = zoo::rollmean(new_deaths_per_million, k = 7, fill = NA),<br/>                deathdate_21plus = date - 21,<br/>                ICU_07da         = zoo::rollmean(icu_patients_per_million, k = 7, fill = NA),<br/>                ICUdate_14plus   = date - 14)<br/>ggplot(dfNLD)+<br/>  geom_line(aes(x=date, y=log(cases_07da), colour="New Cases"))+<br/>  geom_line(aes(x=HOSPdate_14plus , y=log(hosp_07da), colour="New Hosp"))+<br/>  geom_line(aes(x=ICUdate_14plus , y=log(ICU_07da), colour="New ICU"))+<br/>  geom_line(aes(x=deathdate_21plus, y=log(deaths_07da), colour="New Deaths"))+<br/>  scale_colour_manual(name="",<br/>                      values=c('grey', 'red','green','blue'), <br/>                      labels = c("Cases", "Hospital 14 days later", "ICU 14 days later","Deaths 21 days later"))+<br/>  theme_bw()+<br/>  theme(legend.position="bottom")+<br/>  labs(x="Date", <br/>       y="New Cases, Hospital, ICU and Deaths (log Scale)", <br/>       title="New Cases vs Hospital, ICU, and Deaths on a 7-day moving average log scale")</span></pre><figure class="ll lm ln lo gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ml"><img src="../Images/f9c2a50201d7dd10f439bfe55cb9b995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VqhzSBfq9MNgHBzOyX5gUA.png"/></div></div></figure><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="92e1" class="lu lv iq lq b gy lw lx l ly lz">knitr::opts_chunk$set(fig.width=unit(25,"cm"), fig.height=unit(11,"cm"))<br/>dfNLD&lt;-df%&gt;%<br/>  dplyr::filter(iso_code == "NLD")%&gt;%<br/>  dplyr::select(date,iso_code,date,new_cases_per_million, hosp_patients_per_million,icu_patients_per_million,new_deaths_per_million)%&gt;%<br/>  dplyr::mutate(cases_07da       = zoo::rollmean(new_cases_per_million, k = 7, fill = NA),<br/>                hosp_07da        = zoo::rollmean(hosp_patients_per_million, k = 7, fill = NA),<br/>                HOSPdate_14plus  = date - 14,<br/>                deaths_07da      = zoo::rollmean(new_deaths_per_million, k = 7, fill = NA),<br/>                deathdate_21plus = date - 21,<br/>                ICU_07da         = zoo::rollmean(icu_patients_per_million, k = 7, fill = NA),<br/>                ICUdate_14plus   = date - 14)<br/>my.animation&lt;-ggplot(dfNLD)+<br/>  geom_line(aes(x=date, y=log(cases_07da), colour="New Cases"))+<br/>  geom_line(aes(x=HOSPdate_14plus , y=log(hosp_07da), colour="New Hosp"))+<br/>  geom_line(aes(x=ICUdate_14plus , y=log(ICU_07da), colour="New ICU"))+<br/>  geom_line(aes(x=deathdate_21plus, y=log(deaths_07da), colour="New Deaths"))+<br/>  scale_colour_manual(name="",<br/>                      values=c('grey', 'red','green','blue'), <br/>                      labels = c("Cases", "Hospital 14 days later", "ICU 14 days later","Deaths 21 days later"))+<br/>  theme_bw()+<br/>  theme(legend.position="bottom")+<br/>  labs(x="Date", <br/>       y="New Cases, Hospital, ICU and Deaths (log Scale)", <br/>       title="New Cases vs Hospital, ICU, and Deaths on a 7-day moving average log scale")+<br/>  transition_reveal(date)<br/>animate(my.animation, width=2000, height=1000, <br/>        res=150,<br/>        end_pause = 60,<br/>        nframes=300);anim_save("Covid.gif")</span></pre><figure class="ll lm ln lo gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mm"><img src="../Images/a59541079e0957e3529cfec22b1b8f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*lFiH29hAa3hYTY5fLtFFZg.gif"/></div></div></figure><p id="1b38" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">正如您所看到的，只需要GGplot代码中的一行简单的代码就可以将前面的图形制作成动画。但这给了它一个完全不同的维度。</p><p id="a52e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，我想添加到图中的是变体的演变。幸运的是，我们也有数据，所以让我们加载它，绘制它，并连接它。我也没有将这些数据做成动画，虽然我可以这样做。我将把这项工作留给你去做。</p><pre class="ll lm ln lo gt lp lq lr ls aw lt bi"><span id="e229" class="lu lv iq lq b gy lw lx l ly lz">variants_sum&lt;-variants%&gt;%<br/>  group_by(Date_of_statistics_week_start,Variant_name)%&gt;%<br/>  summarize(ss=sum(Sample_size),<br/>            vc=sum(Variant_cases), <br/>            perc=(vc/ss)*100)<br/>variants_sum$date&lt;-variants_sum$Date_of_statistics_week_start<br/>combined&lt;-merge(dfNLD,variants_sum, by=c("date"))</span><span id="5d2f" class="lu lv iq lq b gy ma lx l ly lz">g1&lt;-ggplot(combined)+<br/>  geom_line(aes(x=date, y=log(cases_07da), colour="New Cases"))+<br/>  geom_line(aes(x=HOSPdate_14plus , y=log(hosp_07da), colour="New Hosp"))+<br/>  geom_line(aes(x=ICUdate_14plus , y=log(ICU_07da), colour="New ICU"))+<br/>  geom_line(aes(x=deathdate_21plus, y=log(deaths_07da), colour="New Deaths"))+<br/>  scale_colour_manual(name="",<br/>                      values=c('grey', 'red','green','blue'), <br/>                      labels = c("Cases", "Hospital 14 days later", "ICU 14 days later","Deaths 21 days later"))+<br/>  theme_bw()+<br/>  theme(legend.position="bottom")+<br/>  labs(x="Date", <br/>       y="New Cases, Hospital, ICU and Deaths (log Scale)", <br/>       title="New Cases vs Hospital, ICU, and Deaths on a 7-day moving average log scale")+<br/>  scale_x_date(limits = as.Date(c("2021-01-03", "2022-02-18")))<br/>g2&lt;-ggplot(combined, <br/>         aes(x=date,<br/>                     fill=Variant_name))+<br/>         geom_area(aes(y=perc), alpha=0.5)+<br/>  theme_bw()+<br/>  labs(x="Date", <br/>       y="Number of Variants / Sample Size ", <br/>       fill="Variant name",<br/>       title="Variant Progression over Time in the NL ")+<br/>  theme(legend.position = "bottom")+<br/>  scale_x_date(limits = as.Date(c("2021-01-03", "2022-02-18")))<br/>grid.arrange(g1,g2, ncol=1)       <br/>plot_grid(g1, g2, <br/>          align = "v", <br/>          nrow = 2, <br/>          rel_heights = c(2/3, 1/3))</span></pre><figure class="ll lm ln lo gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mn"><img src="../Images/9df9f82d9cd161ed340937732c8eb8a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VjaxTYIz-YbEn0GeDwfgMw.png"/></div></div></figure><p id="0052" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">所以，我们有它。现在，专栏的传播可能会更好，但我也将让您来决定。尽情享受吧！</p></div></div>    
</body>
</html>