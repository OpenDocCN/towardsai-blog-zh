<html>
<head>
<title>How To Use Counterfactual Evaluation To Estimate Online AB Test Results</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用反事实评估来评估在线AB测试结果</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-use-counterfactual-evaluation-to-approximate-online-ab-test-results-a1f29d6963a1?source=collection_archive---------0-----------------------#2019-12-22">https://pub.towardsai.net/how-to-use-counterfactual-evaluation-to-approximate-online-ab-test-results-a1f29d6963a1?source=collection_archive---------0-----------------------#2019-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><h1 id="a640" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="4e6d" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这篇文章中，我将解释一个原则性的方法，在一个在线AB测试中，仅使用离线数据来估计模型的预期性能。这对于帮助决定应该优先使用在线AB测试来验证哪组模型增强非常有用。</p><p id="addb" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">所有复制本文中图形的代码都可以在<a class="ae lr" href="https://github.com/hsm207/counterfactual_eval" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="ea01" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">动机</h1><p id="7019" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">想象一下，你为一家电子商务网站工作，任务是构建一个算法，在用户主页上向用户推荐网站的小部件。这些建议的商业目标是增加网站的收入。你将如何着手开发这样一个算法？</p><p id="cea5" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">构建推荐系统的传统方法包括使用一些信息检索指标来评估模型，例如precision@k、recall@k和NDCG@k。这被称为离线评估。然后，在这些指标上得分较高的模型将进入下一阶段，即在线AB测试，在该阶段，将根据实际业务目标对模型进行评估，例如最大化收入、最大化观看时间等。</p><p id="675f" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这种方法的缺点是没有理由期望任何离线指标与业务指标很好地相关。所以，完全有可能一个在线下测评阶段成绩很好的车型，在线上AB测试阶段表现很差。</p><p id="f599" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">难道不能跳过线下评测阶段，直接进入线上AB测试阶段吗？这是不实际的，原因如下:</p><ol class=""><li id="b2d7" class="ls lt it kq b kr lm kv ln kz lu ld lv lh lw ll lx ly lz ma bi translated">一个真正糟糕的模式可能会导致用户集体放弃网站。</li><li id="a815" class="ls lt it kq b kr mb kv mc kz md ld me lh mf ll lx ly lz ma bi translated">将模型集成到生产环境中是一个耗时的过程，因此我们应该只将它保存到有很大机会满足给定业务目标的潜在模型中。</li></ol><p id="e8fb" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">理想情况下，我们希望对模型在真实数据上的预期性能进行可靠的估计，而不必在生产中部署模型。所谓可靠，我们的意思是估计值是模型真实性能的一个很好的近似值。</p><p id="1c26" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这样的估计量存在吗？</p><h1 id="89cc" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">问题陈述</h1><p id="e038" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了简单起见，让我们假设我们需要向用户推荐七个产品广告中的一个。每个广告，如果被用户点击，将产生不同数额的收入。</p><p id="ef63" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">由于我们正在处理合成数据，我们知道当前算法的真实性能给出了63.30的平均收入。让我们称当前算法为日志策略。</p><p id="2acc" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">现在，我们开发了一种新的算法。姑且称之为目标政策。我们想知道目标策略是否比日志策略更好。</p><p id="5524" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">如果目标策略已经部署到生产中，它的平均收益将是100.99，因此目标策略确实优于日志策略。关键问题是:有没有一种方法可以让我们不必部署到生产环境中就能得出相同的结论？</p><h1 id="0a0e" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">反向倾向得分(IPS)估计量</h1><h2 id="48d0" class="mg jr it bd js mh mi dn jw mj mk dp ka kz ml mm ke ld mn mo ki lh mp mq km mr bi translated">定义</h2><p id="7449" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">假设我们已经设置了日志记录策略，以便它为推荐的每个广告记录以下内容:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/3e159a4c1c43f67b503f1040e3eddd56.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*Iz4wsLKPef_4mn9sP1VloQ.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图1:日志策略保存的日志样本</figcaption></figure><p id="73f0" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">图1显示了日志策略记录了它用来生成推荐的特征(<code class="fe ne nf ng nh b">user_features</code>)、实际上最终被推荐给用户的广告(<code class="fe ne nf ng nh b">ad_placed</code>)、广告被推荐给用户的概率(<code class="fe ne nf ng nh b">ad_prob</code>)以及特定推荐的结果(<code class="fe ne nf ng nh b">ad_revenue</code>)。假设我们有1000个这类日志条目。</p><p id="42f9" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">通过设计，我们能够询问我们的目标策略，告诉我们在给定用户特征x的情况下推荐广告Y的概率。让我们称这个概率为<code class="fe ne nf ng nh b">model_prob</code>，并为我们日志中的每个条目计算它。</p><p id="8da8" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">然后，我们可以定义以下估计量:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/d7e9c95303d2f96cf722ad9bdfcd5a57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*QjclQo9uvosdw-0QR4tUUA.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图2:目标策略的反向倾向分数(IPS)估计器的定义</figcaption></figure><p id="727e" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">图2定义了IPS估计量来估计目标政策的预期绩效，即平均收入。请注意，计算它所需的所有值都可以在不将目标策略部署到生产环境的情况下获得:</p><ul class=""><li id="fc84" class="ls lt it kq b kr lm kv ln kz lu ld lv lh lw ll nj ly lz ma bi translated"><code class="fe ne nf ng nh b">ad_prob</code>和<code class="fe ne nf ng nh b">ad_revenue</code>的值来自日志记录策略保存的日志</li><li id="ed64" class="ls lt it kq b kr mb kv mc kz md ld me lh mf ll nj ly lz ma bi translated"><code class="fe ne nf ng nh b">model_prob</code>的值是目标策略离线训练后的预测结果。</li></ul><p id="6719" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">下一节将展示根据日志计算的IPS估计器将允许我们得出结论，目标策略比日志记录策略更好。</p><h2 id="b667" class="mg jr it bd js mh mi dn jw mj mk dp ka kz ml mm ke ld mn mo ki lh mp mq km mr bi translated">结果</h2><p id="d2b2" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在我们的1，000个条目日志上计算图2中定义的IPS估计值，得出的平均收入为103.46(非常接近100.99的真实性能)，而日志记录策略的平均收入为63.43。因此，我们应该有信心将我们的目标策略部署到生产环境中，并进行AB测试，将其与日志策略进行比较，作为最终验证。</p><p id="9498" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">此示例假设我们有一个包含1，000个条目的日志来计算目标策略的预期回报的IPS估计值。如果我们有更多或更少的日志条目，我们的结论会有什么变化？它与实际进行在线AB测试相比如何？</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/296ebc66701222fcf6aaec4306591232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*6S9piUiSMG9DU_i4uXw8vQ.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图3:在不同的日志大小下，使用IPS estimator和AB测试评估目标策略的比较</figcaption></figure><p id="406a" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">图3显示IPS估计器很好地跟踪了AB测试的结果。样本大小是指我们记录生产中目标策略(AB测试)或日志策略(IPS)性能的条目数量。两种方法都很快收敛到真实目标策略的平均收益，因为在大约4000个样本大小后，预期回报相当稳定。</p><p id="75ee" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这里的结论是，记录日志策略建议的日志越多，我们就越有信心使用IPS估计器计算的任何目标策略的预期回报将与在线AB测试结果一致。</p><h2 id="a09d" class="mg jr it bd js mh mi dn jw mj mk dp ka kz ml mm ke ld mn mo ki lh mp mq km mr bi translated">为什么有效</h2><p id="b2b8" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这种方法是可行的，因为IPS估计量是目标保单平均收入的无偏估计量。证明这一点很简单，有兴趣的读者可以参考附录部分的细节。</p><h1 id="60d1" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">其他评估者</h1><p id="71a2" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">除了IPS估计量之外，还有许多估计量被提议作为目标政策预期回报的估计量。这些估计量在偏差和方差权衡方面与IPS估计量不同。</p><p id="a89c" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">例如，[1]提出了一种称为归一化上限重要性抽样(NCIS)的估计量。该估计器引入了一个名为<em class="nl"> λ </em>的参数，试图控制估计器的方差:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/1bc6547790c87a992c17b8b3e4369cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*w0weoYcziC8thsy__JTM6A.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图NCIS估计量的定义。来源:[1]</figcaption></figure><p id="b31a" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">这是我们数据集上估计量的样子:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/ac5f833ec912d9e33259ff0f74bb97fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*8SFlJutdiWkimrC16UeU4Q.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图IPS与NCIS评估者的行为</figcaption></figure><p id="ed97" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">图5显示，相对于IPS估计量，NCIS估计量确实具有较低的方差(不太起伏的曲线),但并不收敛于真实的预期回报，即，与IPS估计量相比，NCIS估计量具有较低的方差但较高的偏差。</p><p id="9006" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">然而，[1]认为，只要偏差不影响候选目标策略的相对顺序，NCIS就是一个很好的标准，可以用来从一组目标策略中挑选哪些策略转移到在线AB测试。</p><h1 id="044f" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">个案研究</h1><p id="b13b" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">[2]展示了本文中讨论的思想的一些有趣的真实世界用例。特别是:</p><ul class=""><li id="5dc3" class="ls lt it kq b kr lm kv ln kz lu ld lv lh lw ll nj ly lz ma bi translated">使用IPS estimator来决定将哪个策略部署到Yahoo FrontPage以向用户推荐故事</li><li id="5803" class="ls lt it kq b kr mb kv mc kz md ld me lh mf ll nj ly lz ma bi translated">使用IPS estimator来决定将哪个策略部署到Bing拼写器，以选择查询的单词重构，即自动更正</li></ul><p id="501b" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">由于所使用的日志记录策略，这两个案例研究值得注意。前者有一个日志策略，随机地向用户统一推荐故事(与本文中使用的例子相同)，而后者没有。然而，在这两种情况下，IPS估计器能够准确地估计目标策略的预期回报</p><h1 id="a202" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="882f" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">本文讨论了使用反事实评估来离线评估目标策略背后的主要概念。关键的先决条件是要有足够详细的历史日志，以便能够对目标策略的预期性能进行可靠的估计，而不必经历将其部署到生产环境的麻烦。</p><p id="c733" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">如果你有任何问题，请在评论中告诉我。我也有兴趣听听其他离线方法评估目标策略的案例研究。</p><h1 id="0812" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">参考</h1><p id="e914" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">[1] <a class="ae lr" href="http://pchandar.github.io/static/Gruson2019-a2c9a8576182dcb33019d20a7c7a51b7.pdf" rel="noopener ugc nofollow" target="_blank">在线评估，对播放列表推荐算法进行决策。</a>格鲁森等人。艾尔。2019</p><p id="1342" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">[2] <a class="ae lr" href="http://www.cs.cornell.edu/~adith/CfactSIGIR2016/" rel="noopener ugc nofollow" target="_blank"> SIGIR 2016搜索、推荐、广告投放反事实评估与学习教程</a>。约阿希姆和斯瓦米纳森。2016</p><h1 id="0f17" class="jq jr it bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">附录</h1><h2 id="8070" class="mg jr it bd js mh mi dn jw mj mk dp ka kz ml mm ke ld mn mo ki lh mp mq km mr bi translated">附录IPS估计量是一个无偏估计量</h2><p id="6947" class="pw-post-body-paragraph ko kp it kq b kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">本节将说明IPS估计量是一个无偏估计量。</p><p id="ec43" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">首先，我们定义一些符号:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/4e25ceb419e2a4435aaace88cc3d6f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*s9t_jpdRuWP8OkLONIAYHw.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图a 1.1:IPS估计量的定义</figcaption></figure><p id="1389" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">其中:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi no"><img src="../Images/235f83a6909cc43b4509b4d29352d28c.png" data-original-src="https://miro.medium.com/v2/resize:fit:414/format:webp/1*J-pMJqWqlJc1Fgr-TfH7gw.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图A1.2:表示目标和日志策略的符号</figcaption></figure><p id="4f40" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">为了说明IPS估计量是无偏的，我们需要证明:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi np"><img src="../Images/d25315fb2346f7c6d135cc9a6b71393c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*nU607FzX6EhE5sxKsBt4UQ.png"/></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图A1.3:证明的最终目标</figcaption></figure><p id="a634" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">所以，我们开始吧:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/9222ce196def07553bb298e3d293dcff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1--YQtItVfavYePD3heIXQ.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk translated">图a 1.4:IPS估计量无偏的证明</figcaption></figure><p id="c7ba" class="pw-post-body-paragraph ko kp it kq b kr lm kt ku kv ln kx ky kz lo lb lc ld lp lf lg lh lq lj lk ll im bi translated">如果有任何步骤不清楚，请在评论中告诉我。</p></div></div>    
</body>
</html>