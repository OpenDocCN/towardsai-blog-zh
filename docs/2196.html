<html>
<head>
<title>The Basics Of Enabling Pods To Communicate Across Namespaces In Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes中支持Pods跨名称空间通信的基础</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/the-basics-of-enabling-pods-to-communicate-across-namespaces-in-kubernetes-b6e5dbec2d3a?source=collection_archive---------3-----------------------#2021-09-22">https://pub.towardsai.net/the-basics-of-enabling-pods-to-communicate-across-namespaces-in-kubernetes-b6e5dbec2d3a?source=collection_archive---------3-----------------------#2021-09-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="e96f" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/devops" rel="noopener ugc nofollow" target="_blank"> DevOps </a></h2><div class=""/><figure class="gl gn ka kb kc kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi jz"><img src="../Images/c2d39a4e62359540d28154c01c2207c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BimEkdsufckZLCU69Tc1iw.png"/></div></div></figure><h1 id="cf85" class="kk kl it bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">介绍</h1><p id="68ac" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">本文将解释如何让pods在同一个K8s集群中跨不同的名称空间进行通信。</p><p id="168a" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">更具体地说，我们将尝试将一个名称空间中的<a class="ae ml" href="https://rasa.com/docs/rasa-x/" rel="noopener ugc nofollow" target="_blank"> Rasa X </a>部署连接到另一个名称空间中的PostgreSQL数据库。因此，我假设读者熟悉Rasa X部署的<a class="ae ml" href="https://rasa.com/docs/rasa-x/api/architecture" rel="noopener ugc nofollow" target="_blank">架构</a>以及<a class="ae ml" href="https://rasa.com/docs/rasa-x/installation-and-setup/install/helm-chart/" rel="noopener ugc nofollow" target="_blank">如何使用helm </a>部署它。</p><p id="00e1" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">复制本文中描述的部署的代码是<a class="ae ml" href="https://github.com/hsm207/k8s-cross-ns" rel="noopener ugc nofollow" target="_blank">这里是</a>。</p><h1 id="5e36" class="kk kl it bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">问题陈述</h1><p id="ef8e" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">假设我们在k8s集群中有一个名为<code class="fe mm mn mo mp b">db-ns</code>的PostgreSQL数据库，该数据库使用以下<a class="ae ml" href="https://github.com/bitnami/charts/tree/master/bitnami/postgresql" rel="noopener ugc nofollow" target="_blank"> helm </a> values.yml进行部署:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/aa9e5fc934c4ebf7e8e87175ffb5fdfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*FIQavA6g-aHDlIsXhtE4Eg.png"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图1:配置PostgreSQL部署</figcaption></figure><p id="c263" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">我们希望在同一个集群中名为<code class="fe mm mn mo mp b">rasa-x-ns</code>的名称空间中部署Rasa X的所有组件，除了它的数据库。然后，我们希望Rasa X使用名称空间<code class="fe mm mn mo mp b">db-ns</code>中的PostgreSQL数据库来存储对话、事件、用户角色等。</p><p id="773c" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">此图描述了我们想要创建的环境:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi mz"><img src="../Images/59bc5fd77e9a9ba2f8d28b0402760c12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CFxVkSvPg4w8F9FZGTzDZA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图2:我们想要创建的Rasa X部署</figcaption></figure><h1 id="dc4c" class="kk kl it bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">解决办法</h1><h2 id="b46c" class="na kl it bd km nb nc dn kq nd ne dp ku lt nf ng ky lx nh ni lc mb nj nk lg iz bi translated">概观</h2><p id="3461" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">我们假设数据库已经如图1所示进行了部署，我们只需要配置Rasa X部署。</p><p id="ac62" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">这是一个4步流程:</p><ol class=""><li id="49ff" class="nl nm it lk b ll mg lp mh lt nn lx no mb np mf nq nr ns nt bi translated">创建一个包含连接到数据库的凭据的密码</li><li id="e81d" class="nl nm it lk b ll nu lp nv lt nw lx nx mb ny mf nq nr ns nt bi translated">告诉Rasa X不要创建PostgreSQL <a class="ae ml" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank"> StatefulSet </a></li><li id="bacd" class="nl nm it lk b ll nu lp nv lt nw lx nx mb ny mf nq nr ns nt bi translated">告诉Rasa X在哪里可以找到数据库</li><li id="8ed0" class="nl nm it lk b ll nu lp nv lt nw lx nx mb ny mf nq nr ns nt bi translated">告诉Rasa X在哪里可以找到PostgreSQL连接凭证</li></ol><p id="9578" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">一旦完成上述步骤，部署Rasa X就可以正常进行了。</p><h2 id="340e" class="na kl it bd km nb nc dn kq nd ne dp ku lt nf ng ky lx nh ni lc mb nj nk lg iz bi translated">步骤1:创建保存数据库凭证的密码</h2><p id="1dc1" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">这一步很简单。只需运行:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi nz"><img src="../Images/6054199127228ace1ed9e2316b15913f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qtTvwhOkJXz1Bc7nUMQEw.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图3:连接到数据库的凭证</figcaption></figure><p id="445c" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">图3将在rasa x名称空间中创建一个名为<code class="fe mm mn mo mp b">db-credentials</code>的秘密。它有一个名为<code class="fe mm mn mo mp b">postgres</code>的键，保存作为<code class="fe mm mn mo mp b">postgres</code>用户连接到<code class="fe mm mn mo mp b">db-ns</code>名称空间中的数据库的密码。</p><h2 id="a4a1" class="na kl it bd km nb nc dn kq nd ne dp ku lt nf ng ky lx nh ni lc mb nj nk lg iz bi translated">步骤2:在部署Rasa X时，不要创建Postgresql StatefulSet</h2><p id="c6b3" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">这一步也很简单。我们只需要在Rasa X的values.yml中设置以下内容:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/3f4943d8d2a47fd249a379ed1384fc79.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/format:webp/1*oZnQd3XdtOPCDMxcj7oxVQ.png"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图4:配置Rasa X以创建另一个PostgreSQL有状态集</figcaption></figure><h2 id="5f1d" class="na kl it bd km nb nc dn kq nd ne dp ku lt nf ng ky lx nh ni lc mb nj nk lg iz bi translated">步骤3:指定数据库的位置</h2><p id="94b2" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">我们将通过其服务连接到<code class="fe mm mn mo mp b">db-ns</code>名称空间中的PostgreSQL数据库，也就是说，我们不会直接连接到它的pod。</p><p id="d154" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">为此，我们需要找出服务的完全限定名(FQN)。一种方法是查找服务的IP地址。例如:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi ob"><img src="../Images/46f6325eb587d21b67e7c4c385d70cb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*slNlk-wCZmPfFrnV_DFUwA.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图5:计算出PostgreSQL服务的FQN</figcaption></figure><p id="031e" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">这将输出:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi oc"><img src="../Images/28f4617765fe0f03cef98038e67a7915.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6zIieR3oYjZsVQn_fiRpjw.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图6:图5中脚本的输出</figcaption></figure><p id="31eb" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">因此，我们编辑Rasa X的values.yml以包含此信息:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi od"><img src="../Images/137ed72aec287d69f41736561582f4d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UajVJV9V3JRyC_nuPpzR7w.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图7:编辑图4以包含数据库的位置</figcaption></figure><h2 id="6ca4" class="na kl it bd km nb nc dn kq nd ne dp ku lt nf ng ky lx nh ni lc mb nj nk lg iz bi translated">步骤4:指定凭据的位置</h2><p id="cd0c" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">我们需要告诉Rasa X在<code class="fe mm mn mo mp b">db-ns</code>中连接数据库时如何使用我们在步骤1中创建的秘密。这是通过以下值实现的。yml:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi oe"><img src="../Images/06e67d7a5cff7ad882bbd1e0c9b1ad0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YD_Mk9Jcy98jOBK93h7Y-g.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图8:扩展图7以包括连接到数据库的凭证</figcaption></figure><p id="1db5" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">回想一下，在步骤1中，我们创建了一个名为<code class="fe mm mn mo mp b">db-credentials</code>的秘密，它有一个名为<code class="fe mm mn mo mp b">postgres</code>的密钥。这些细节分别反映在图8中的第8行和第4行。</p><h1 id="2b6a" class="kk kl it bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">什么会出错？</h1><p id="3e5b" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">快速检查名称空间之间的通信是否可行的方法是在安装并运行python和sqlalchemy的名称空间<code class="fe mm mn mo mp b">rasa-x-ns</code>中创建一个pod:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi of"><img src="../Images/3f0a5964b5962cf5b4bda9a981cf220b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SyEj4Hm989_6nR2gHc_VTQ.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图9:检查从rasa-x-ns到db-ns的通信是否可能</figcaption></figure><p id="1075" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">如果成功，将打印出以下内容:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi og"><img src="../Images/cd043faafa33287770a50ce557d2dc3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i2yfJUrD73QbmiTK06C6Og.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图10:运行图9中python脚本的预期输出</figcaption></figure><p id="99aa" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">另一方面，如果您得到以下输出:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi oh"><img src="../Images/a1553f08f3fcd322f5f1a211e4322a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CuYOxCxIeUynlakR3L7PgQ.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图11:运行图9中脚本的意外输出</figcaption></figure><p id="2d7a" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">这意味着pod无法到达数据库服务。</p><p id="f20d" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">其中一个原因是您的集群管理员使用以下网络策略阻止了所有进入<code class="fe mm mn mo mp b">db-ns</code>pod的流量:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/2465b00e64a2b02640fe693e158d3e27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*U-BHYro5zlPcQ8z34L7nlw.png"/></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图12:阻止所有传入网络流量进入db-ns名称空间中的pod的网络策略</figcaption></figure><p id="f24a" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">或者，您的集群管理员可能已经使用以下网络策略阻止了来自<code class="fe mm mn mo mp b">rasa-x-ns</code>pod的所有传出流量:</p><figure class="mr ms mt mu gt kd gh gi paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="gh gi oj"><img src="../Images/e7b19e4addfca6c0a6782190709686ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*0mMdwKsxK2hyPjjPKpMWug.png"/></div></div><figcaption class="mv mw gj gh gi mx my bd b be z dk translated">图13:阻止来自rasa-x-ns名称空间中的pod的所有传出网络流量的网络策略</figcaption></figure><p id="e587" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">或者两者都有！</p><p id="1548" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">这里的要点是，您需要检查k8s集群上应用了什么网络策略，并请求集群管理员帮助打开正确的路径。</p><h1 id="d03f" class="kk kl it bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">结论</h1><p id="817a" class="pw-post-body-paragraph li lj it lk b ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf im bi translated">本文解释了允许pod跨不同名称空间相互通信的一般思想。</p><p id="b39f" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">本文以设置Rasa X部署连接到不同名称空间中的PostgreSQL数据库为例，具体说明了各个步骤以及失败的原因。</p><p id="87bd" class="pw-post-body-paragraph li lj it lk b ll mg ln lo lp mh lr ls lt mi lv lw lx mj lz ma mb mk md me mf im bi translated">我希望你已经发现这是有用的。</p></div></div>    
</body>
</html>