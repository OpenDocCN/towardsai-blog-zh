<html>
<head>
<title>Detect Malicious JavaScript Code Using Machine Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用机器学习检测恶意JavaScript代码</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/detect-malicious-javascript-code-using-machine-learning-7709f9cdb7e7?source=collection_archive---------1-----------------------#2022-06-28">https://pub.towardsai.net/detect-malicious-javascript-code-using-machine-learning-7709f9cdb7e7?source=collection_archive---------1-----------------------#2022-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bee5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将考虑使用机器学习来检测混淆的JavaScript代码片段的方法。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ed4e00e05d7b6a5dec0d84d7016f3db7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XFKvzn30CglSpb3o"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">加布里埃尔·海因策在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h2 id="bf06" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">介绍</h2><p id="a0cb" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi ma translated"><span class="l mb mc md bm me mf mg mh mi di"> M </span> ost网站使用JavaScript (JS)代码制作动态内容；因此，JS代码成为针对浏览器、浏览器插件、电子邮件客户端和其他JS应用程序的有价值的攻击媒介。常见的基于JS的攻击包括下载驱动、跨站脚本(XSS)、跨站请求伪造(XSRF)、恶意广告等。大多数恶意的JS代码被混淆，以便隐藏它们正在做的事情，并避免被基于签名的安全系统检测到。换句话说，混淆技术是一系列混淆的代码转换，以损害其可理解性，但同时保存其功能。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mj"><img src="../Images/1697255e2d647dcae0292f9cb1102684.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YkmXBgkfe2cM9B3bUfEd0w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">随机化混淆的示例</figcaption></figure><p id="f48f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">传统的反病毒和入侵检测系统(IDS)采用基于启发式和基于签名的方法来检测恶意JS代码。但是在零日攻击的情况下，这种分析可能是低效的。目前正在各个行业积极开发的机器学习(ML)应用也在网络安全中找到了自己的位置。ML已经证明了它对零基攻击的有效性。当涉及到检测恶意JS代码时，有不同的方法，从自然语言处理(NLP)领域，使用表格数据的标准ML，到深度学习模型。</p><p id="ad43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ML模型的输入数据会有所不同，因为有两种方法来分析程序的行为:静态和动态代码分析。静态方法在不运行源代码的情况下分析数据，并且只基于源代码。例如，这可以通过遍历代码抽象语法树来存档。相反，动态代码分析需要执行源代码。在这篇文章中，我们将只考虑静态分析的情况。</p><p id="c328" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将查看一些相关的工作，以了解研究人员为混淆的JS代码检测提供了什么。还将考虑使用NLP特性和标准ML方法的组合来分类良性/恶意JS代码片段的任务。</p><h2 id="0ea6" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">相关著作</h2><p id="68c2" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在“<a class="ae lb" href="https://www.researchgate.net/publication/321805699_Detecting_Obfuscated_JavaScripts_using_Machine_Learning" rel="noopener ugc nofollow" target="_blank">使用机器学习检测混淆的JavaScript</a>中，作者使用了来自内容交付网络jsDelivr、Alexa 500强网站的常规、迷你和混淆样本数据集，以及来自瑞士信息保障报告和分析中心<a class="ae lb" href="https://www.ncsc.admin.ch/ncsc/en/home.html" rel="noopener ugc nofollow" target="_blank"> MELANI </a>的一组恶意JavaScript样本。作者表明，区分混淆和非混淆脚本是可能的，精确度和召回率约为99%。使用了以下一组功能:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/ccc961d8b8302931de9eb8840696daad.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*GVILYOzLt7CU0KftJYZzvw.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">JavaScript片段的静态特性，来源:<a class="ae lb" href="https://www.researchgate.net/publication/321805699_Detecting_Obfuscated_JavaScripts_using_Machine_Learning" rel="noopener ugc nofollow" target="_blank">使用机器学习检测混淆的JavaScript</a></figcaption></figure><p id="a615" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取的特征向量集用于训练和评估三种不同的分类器:线性判别分析(LDA)、随机森林(RF)和支持向量机(SVM)。</p><p id="3333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在“<a class="ae lb" href="https://www.sciencedirect.com/science/article/pii/S1568494619305022" rel="noopener ugc nofollow" target="_blank">使用AST特征和段落向量检测基于JavaScript的攻击的机器学习方法</a>中，作者使用了另一种方法从JS代码中提取特征。他们采用<a class="ae lb" href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" rel="noopener ugc nofollow" target="_blank">抽象语法树(AST) </a>作为代码结构表示，并将其用作Doc2Vec方法的输入。恶意JS代码的驱动下载数据和良性JS代码的JS unpack plus Alexa 100强网站数据集被用作训练数据集。为了构建AST，作者使用了一个语法和词汇分析工具<a class="ae lb" href="https://esprima.org/demo/parse.html#" rel="noopener ugc nofollow" target="_blank"> Esprima </a>。</p><p id="85e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然以前的方法依赖于词法和语法特征，但“<a class="ae lb" href="https://www.mdpi.com/2076-3417/10/10/3440" rel="noopener ugc nofollow" target="_blank">基于双向LSTM模型的恶意JavaScript检测</a>中考虑的方法利用了语义信息。除了AST特性，作者还构建了程序依赖图(PDG ),并生成了JS代码语义片，这些语义片被转换成数字向量。然后将这些向量输入双向长短期记忆神经网络。BLSTM模型表现出97.71%的准确率和98.29%的F1值。</p><p id="b39f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">综上所述，在静态分析的情况下，可以确定JS代码的几种常见<strong class="jp ir">方法:</strong></p><ul class=""><li id="044a" class="ml mm iq jp b jq jr ju jv jy mn kc mo kg mp kk mq mr ms mt bi translated">方法1(自然语言):将JS代码视为自然语言文本。特征可以表示为字符统计、文件熵、特殊功能计数、特殊符号数量等的集合。</li><li id="820d" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">方法2(词法特性):提取普通JS文本元素的正则表达式(如[a-z]+并删除特殊字符，如∫、=、！等。)与NLP特征化方法应用相结合，如词袋(BOW)、TF-IDF、Doc2Vec、LDA、嵌入等。</li><li id="53d1" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">方法3(句法特征):AST特征加NLP特征化；</li><li id="3434" class="ml mm iq jp b jq mu ju mv jy mw kc mx kg my kk mq mr ms mt bi translated">方法4(语义特征):获取AST特征-&gt;构建控制流图(CFG) -&gt;构建程序依赖图(PDG) -&gt;获取语义切片-&gt;转换为数字向量。</li></ul><h2 id="d977" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">编码部分:<strong class="ak"/>良性/恶意JS代码的分类</h2><p id="d2d8" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">出于这个目的，让我们为网络安全食谱使用来自<a class="ae lb" href="https://github.com/PacktPublishing/Machine-Learning-for-Cybersecurity-Cookbook/tree/master/Chapter03/Detecting%20Obfuscated%20Javascript" rel="noopener ugc nofollow" target="_blank">机器学习的数据集。为了简单起见，我将使用上面提到的方法1。</a></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="a427" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">数据下载</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nb"><img src="../Images/d130340db758bb86c8e102521ce40192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MtAxrM_3vuELvOJB3Wxu9Q.png"/></div></div></figure><p id="56e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">数据清理</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="7d2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">0标签—正常代码，1标签—混淆代码</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/e95621b67138de4b9d0f2c0a1eca60bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*kJy9U8Llz17wgnaKrsZcVg.png"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/028c7401ef89322d54d43abb83a7d585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23VuEJhK4L1p4QYCBHcdZQ.png"/></div></div></figure><p id="dff1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">特征工程</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ne"><img src="../Images/9747e4d229a3a5967919428501945397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EG6A9k7S_1D-5jokHZYz9Q.png"/></div></div></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nf"><img src="../Images/2c21eebf7e8e77421a06f925485b6891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jRq4TglluZWlo0BFtC2ZUQ.png"/></div></div></figure><p id="f262" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于其他特性，我使用了下面的JS函数列表，这些函数经常在恶意JS代码中使用:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ng"><img src="../Images/bf0df9bd8160428b19170c8b2bf7f5e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKYtUItFOFUS_ILMeKWB3A.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">恶意JavaScript中广泛使用的函数，来源:<a class="ae lb" href="https://www.mdpi.com/2076-3417/10/10/3440" rel="noopener ugc nofollow" target="_blank">基于双向LSTM模型的恶意JavaScript检测</a></figcaption></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nh"><img src="../Images/714b052599bd1e39311f343281085453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V-LGQ6CQiXKXv8xAPcJNdA.png"/></div></div></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ni"><img src="../Images/e69d968953389b8aef840d41bc6213f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AvbFHBR5txULLOorJxiljw.png"/></div></div></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nj"><img src="../Images/9ea4246bbe2a85c9770d012f43998a50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fqIBIQXV3hvoTtcZhR9FLQ.png"/></div></div></figure><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nk"><img src="../Images/63d3b399faa3f53251e91593f086b361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYeDSWlrFBLpABDXokSDxQ.png"/></div></div></figure><p id="1ba4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">训练/测试数据分割</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="9e07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">随机森林模型</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="0989" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">指标结果</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nl"><img src="../Images/e6f15163511e13a7656e58ca48c05c70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XwhAZC3XTJVxajOCrrGY8Q.png"/></div></div></figure><p id="b684" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">👉🏻完整的代码也可以通过我的GitHub获得。</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><h2 id="dc10" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">进一步阅读</h2><p id="fb10" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">[1] S. Aebersold等人，<a class="ae lb" href="https://www.researchgate.net/publication/321805699_Detecting_Obfuscated_JavaScripts_using_Machine_Learning" rel="noopener ugc nofollow" target="_blank">利用机器学习检测混淆JavaScript</a>(2016)，ICIMP 2016:第十一届互联网监控与保护国际会议</p><p id="e86d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[2] S. Ndichu等人，<a class="ae lb" href="https://www.sciencedirect.com/science/article/pii/S1568494619305022" rel="noopener ugc nofollow" target="_blank">使用AST特征和段落向量检测基于JavaScript的攻击的机器学习方法</a> (2019)，应用软计算</p><p id="08d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[3] A. Fass等人，<a class="ae lb" href="https://link.springer.com/chapter/10.1007/978-3-319-93411-2_14" rel="noopener ugc nofollow" target="_blank"> JAST:恶意(混淆)JavaScript的完全语法检测</a> (2018)，迪姆瓦</p><p id="f255" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[4] X. Song等，【基于双向LSTM模型的恶意JavaScript检测】 (2020)，应用科学</p></div></div>    
</body>
</html>