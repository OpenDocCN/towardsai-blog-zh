<html>
<head>
<title>Pyspark Kafka Structured Streaming Data Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pyspark Kafka结构化流数据管道</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/pyspark-kafka-structured-streaming-data-pipeline-803095b7398a?source=collection_archive---------1-----------------------#2020-10-16">https://pub.towardsai.net/pyspark-kafka-structured-streaming-data-pipeline-803095b7398a?source=collection_archive---------1-----------------------#2020-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="005b" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/programming" rel="noopener ugc nofollow" target="_blank">编程</a></h2><div class=""/><div class=""><h2 id="4b05" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">本文的目标是理解如何创建一个数据管道，使用Apache结构化流和Apache Kafka来处理数据。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/19caab83a71db63edebf63e41db545d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*_z3w9gwxdNiAcvGzDi7Uzw.png"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">来源:卡夫卡-火花流媒体</figcaption></figure><p id="e403" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja">商业案例讲解:</strong></p><p id="1b4e" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">让我们考虑一家商店，该商店生成客户发票，并且这些发票以实时方式到达集成平台，以通知客户他们在购物中已经赢得了多少“<strong class="lc ja">Edge Reward”</strong>积分。</p><p id="21a9" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">新德里市内各商店的发票以实时方式传送到Kafka Topic，根据总购物金额，我们的Kafka消费者计算边缘点并向客户发送通知消息。</p><ol class=""><li id="ef44" class="lw lx iq lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated"><strong class="lc ja">发票数据集</strong></li></ol><p id="8103" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">发票数据以<strong class="lc ja"> JSON </strong>格式生成。为了便于理解，我没有创建嵌套数据集。</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="834a" class="mk ml iq mg b gy mm mn l mo mp">{“BillNo”:”93647513",”CreatedTime”:1595688902254,”StoreID”:”STR8510",”PaymentMode”:”CARD”,”CustomerCardNo”:”5241-xxxx-xxxx-1142",”ItemID”:”258",”ItemDescription”:”Almirah”,”ItemPrice”:1687.0,”ItemQty”:1,”TotalValue”:1687.0}<br/>{“BillNo”:”93647514",”CreatedTime”:1595688901055,”StoreID”:”STR8511",”PaymentMode”:”CARD”,”CustomerCardNo”:”5413-xxxx-xxxx-1142",”ItemID”:”259",”ItemDescription”:”LED”,”ItemPrice”:1800.0,”ItemQty”:2,”TotalValue”:3900.0}<br/>{“BillNo”:”93647515",”CreatedTime”:1595688902258,”StoreID”:”STR8512",”PaymentMode”:”CARD”,”CustomerCardNo”:”5346-xxxx-xxxx-1142",”ItemID”:”257",”ItemDescription”:”AC”,”ItemPrice”:2290.0,”ItemQty”:2,”TotalValue”:4580.0}<br/></span></pre><p id="df38" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja"> 2。数据生产者:</strong></p><p id="d44c" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">发票数据发送到Kafka主题:<strong class="lc ja">建议</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mq"><img src="../Images/9e27d6ed1d4431638a047bd891994a47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xTkJHuRjAQaMM2HVOm_6iQ.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">建议系统卡夫卡</figcaption></figure><p id="5179" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja"> 3。数据消费者:</strong></p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="f565" class="mk ml iq mg b gy mm mn l mo mp">import findspark<br/>findspark.init(‘’)<br/>import pyspark<br/>from pyspark.sql import SparkSession<br/>from pyspark.sql.functions import from_json, col, expr<br/>from pyspark.sql.types import StructType, StructField, StringType, LongType, DoubleType, IntegerType, ArrayType</span><span id="edbc" class="mk ml iq mg b gy mv mn l mo mp">print(‘modules imported’)</span><span id="0c8a" class="mk ml iq mg b gy mv mn l mo mp">spark= SparkSession \<br/> .builder.appName(‘Kafka_read_mongo’) \<br/> .master(“local”) \<br/> .config(“spark.streaming.stopGracefullyOnShutdown”, “true”) \<br/> .config(“spark.jars.packages”,”org.apache.spark:spark-sql-kafka-0–10_2.11:2.3.3") \<br/> .getOrCreate()</span><span id="1a01" class="mk ml iq mg b gy mv mn l mo mp">schema = StructType([<br/> StructField(“BillNo”, StringType()),<br/> StructField(“CreatedTime”, LongType()),<br/> StructField(“StoreID”,StringType()),<br/> StructField(“PaymentMode”, StringType()),<br/> StructField(“CustomerCardNo”, StringType()),<br/> StructField(“ItemID”, StringType()),<br/> StructField(“ItemDescription”, StringType()),<br/> StructField(“ItemPrice”, DoubleType()),<br/> StructField(“ItemQty”, IntegerType()),<br/> StructField(“TotalValue”, DoubleType())])</span><span id="e0dc" class="mk ml iq mg b gy mv mn l mo mp">print(‘Now time to connect to Kafka broker to read Invoice Data’)</span><span id="5817" class="mk ml iq mg b gy mv mn l mo mp">kafka_df = spark.readStream.format(“kafka”) \<br/> .option(“kafka.bootstrap.servers”, “localhost:9092”) \<br/> .option(“subscribe”, “advice”) \<br/> .option(‘startingOffsets’,’earliest’) \<br/> .load()</span><span id="ba6a" class="mk ml iq mg b gy mv mn l mo mp">print(‘Create Invoice DataFrames’)<br/>invoice_df=kafka_df.select(from_json(col(“value”).cast(“string”), schema).alias(“value”))</span><span id="53a0" class="mk ml iq mg b gy mv mn l mo mp">print(‘Create Notification DF’)</span><span id="a21c" class="mk ml iq mg b gy mv mn l mo mp">notification_df = invoice_df.select(“value.BillNo”, “value.CustomerCardNo”,“value.TotalValue”).<br/>withColumn(“EarnedLoyaltyPoints”, expr(“TotalValue * 0.2”))</span><span id="933a" class="mk ml iq mg b gy mv mn l mo mp">print(‘Create Final Dataframe’)</span><span id="819a" class="mk ml iq mg b gy mv mn l mo mp">#Kafka accepts data in key-value format, below piece of code caters the same</span><span id="424c" class="mk ml iq mg b gy mv mn l mo mp">kafka_target_df = notification_df.selectExpr(“BillNo as key”,<br/> “””to_json(named_struct(<br/> ‘CustomerCardNo’, CustomerCardNo,<br/> ‘TotalValue’, TotalValue,<br/> ‘EarnedLoyaltyPoints’, TotalValue * 0.2)) as value”””)</span><span id="e3fe" class="mk ml iq mg b gy mv mn l mo mp">################tbc##################</span></pre><p id="0a38" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja"> readStream() </strong> - Spark通过<strong class="lc ja">Spark session . read stream()</strong>返回的<strong class="lc ja"> DataStreamReader </strong>接口创建流数据帧</p><p id="e246" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja">输出模式():</strong></p><p id="26a3" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">“输出”被定义为写出到外部存储器的内容。输出可以在不同的模式下定义:</p><ul class=""><li id="5705" class="lw lx iq lc b ld le lg lh lj ly ln lz lr ma lv mw mc md me bi translated"><em class="mx">完成模式</em> —整个更新后的结果表将被写入外部存储器。由存储连接器决定如何处理整个表的写入。</li><li id="3639" class="lw lx iq lc b ld my lg mz lj na ln nb lr nc lv mw mc md me bi translated"><em class="mx">追加模式</em> —只有自上次触发后追加到结果表中的新行才会被写入外部存储器。这仅适用于结果表中现有行不会发生变化的查询。</li><li id="d94f" class="lw lx iq lc b ld my lg mz lj na ln nb lr nc lv mw mc md me bi translated"><em class="mx">更新模式</em> —只有结果表中自上次触发后更新的行才会被写入外部存储器。请注意，这与完整模式的不同之处在于，该模式仅输出自上次触发后发生更改的行。如果查询不包含聚合，它将等同于追加模式。</li></ul><blockquote class="nd ne nf"><p id="4d5e" class="la lb mx lc b ld le ka lf lg lh kd li ng lk ll lm nh lo lp lq ni ls lt lu lv ij bi translated"><strong class="lc ja">#注意:</strong>在我们的用例中，我们使用追加模式，因为用例的需求是这样的。</p></blockquote><p id="ce7f" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated"><strong class="lc ja"> 4。发送通知:</strong></p><p id="c01b" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">因为我们没有向客户发送文本消息的基础设施，所以这个特定的功能是通过向另一个Kafka主题发送JSON消息来满足的:<strong class="lc ja"> NOTIFICATION，</strong>假设另一个下游管道从该主题读取消息，并通知客户关于赢得的忠诚度积分。</p><pre class="kp kq kr ks gt mf mg mh mi aw mj bi"><span id="51a3" class="mk ml iq mg b gy mm mn l mo mp">#################continuing#################</span><span id="7f06" class="mk ml iq mg b gy mv mn l mo mp">print(‘writing to notification topic’)</span><span id="af36" class="mk ml iq mg b gy mv mn l mo mp">#At this particular moment we are able to generate the notification message to be sent to consumer with necessary details such as CardNo, Total Shopping Amount and Reward points earned.#</span><span id="8a2f" class="mk ml iq mg b gy mv mn l mo mp">notification_writer_query = kafka_target_df \<br/> .writeStream \<br/> .queryName(“Notification Writer”) \<br/> .format(“kafka”) \<br/> .option(“kafka.bootstrap.servers”, “localhost:9092”) \<br/> .option(“topic”, “notification”) \<br/> .outputMode(“append”) \<br/> .start()</span><span id="a18b" class="mk ml iq mg b gy mv mn l mo mp">notification_writer_query.awaitTermination()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nj"><img src="../Images/3c70784cf8e5474698abdeb4bcf96d7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nVyXuiF1D9Tq5fuYi8txrA.png"/></div></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">通知消息</figcaption></figure><p id="d0e1" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">该主题上提供了通知消息。</p><p id="e9b6" class="pw-post-body-paragraph la lb iq lc b ld le ka lf lg lh kd li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">这里我们完成了设计一个基本应用程序的方法，该应用程序处理从商店收到的发票，计算奖励积分，并向客户发送通知。希望可以分享一下我的知识。</p></div></div>    
</body>
</html>