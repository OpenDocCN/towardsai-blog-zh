<html>
<head>
<title>Downloading Historical Stock prices with Alpha Vantage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Alpha Vantage下载历史股票价格</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/downloading-historical-stock-prices-with-alpha-vantage-688edad46a6d?source=collection_archive---------3-----------------------#2021-01-09">https://pub.towardsai.net/downloading-historical-stock-prices-with-alpha-vantage-688edad46a6d?source=collection_archive---------3-----------------------#2021-01-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="61df" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">金融</h2><div class=""/><div class=""><h2 id="0eb0" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">版本2.0，对我之前的代码做了一些改变。</h2></div><p id="3dfe" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">Alpha Vantage是一个可能的在线工具，你可以使用代码下载股票历史数据。这个网站为你提供了一个个人API密匙，你可以用它来下载有限的数据量(每天最多500次免费请求，还不错)。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/92e1d7c444aec547c625994dd8eada66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hDp55PjhtL_RB3n5D0PwBw.jpeg"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">阿尔法优势</figcaption></figure><p id="d984" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">请随意查看<a class="ae kr" href="https://medium.com/towards-artificial-intelligence/stock-downloader-api-a9e95c913363" rel="noopener">我的前一篇文章</a>，其中包含我的代码的不推荐版本，以及对我选择alpha vantage而不是许多其他API金融提供商的原因的深入分析。</p><h2 id="03a8" class="me mf it bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv iz bi translated">为什么用代码下载股票</h2><p id="9d57" class="pw-post-body-paragraph ks kt it ku b kv mw kd kx ky mx kg la lb my ld le lf mz lh li lj na ll lm ln im bi translated">如果你必须下载一只股票，你可以很容易地使用雅虎财经网站。然而，当您每天运行分析时，您需要已经导入到代码中的大量新数据，希望避免任何手动干预。这就是为什么在您的环境中直接下载股票的几行代码会变得很方便。</p><h2 id="c8ca" class="me mf it bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv iz bi translated">导入库</h2><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="4550" class="me mf it nc b gy ng nh l ni nj">!pip install alpha_vantage</span><span id="d87a" class="me mf it nc b gy nk nh l ni nj">from alpha_vantage.timeseries import TimeSeries<br/>import pandas as pd</span></pre><h2 id="4cdb" class="me mf it bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv iz bi translated">使用您的API密钥</h2><p id="8d74" class="pw-post-body-paragraph ks kt it ku b kv mw kd kx ky mx kg la lb my ld le lf mz lh li lj na ll lm ln im bi translated">要获得免费的API密匙，你只需在这个网站上<a class="ae kr" href="https://www.alphavantage.co/" rel="noopener ugc nofollow" target="_blank">申请即可。不像许多其他网站，它只会问你的电子邮件，而不是完全注册。不幸的是，目前如果不通过API，你无法下载任何历史股票数据，原因很简单，对于网站来说，大规模的程序是昂贵的。雅虎财经等工具已弃用。</a></p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="7f0d" class="me mf it nc b gy ng nh l ni nj">#credentials<br/>def download_stock(tag):<br/>  key = 'your key'<br/>  ts = TimeSeries(key)<br/>  stock, meta = ts.get_daily(symbol=tag, outputsize='full')<br/>  return stock, meta</span></pre><h2 id="d531" class="me mf it bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv iz bi translated">创建函数</h2><p id="9934" class="pw-post-body-paragraph ks kt it ku b kv mw kd kx ky mx kg la lb my ld le lf mz lh li lj na ll lm ln im bi translated">我现在将创建一系列函数。这些函数将创建一个空数据框，我将在其中下载我的股票数据。当我开始下载股票时，我会打电话给它。</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="827e" class="me mf it nc b gy ng nh l ni nj">import time</span><span id="6dfd" class="me mf it nc b gy nk nh l ni nj">def get_index(tag):<br/>  df_, _ = download_stock(tag)<br/>  df_ = pd.DataFrame(df_)<br/>  df_ = df_.transpose()<br/>  df_ = df_.loc['2020-09-10':'2019-09-10']<br/>  df_ = df_['1. open']<br/>  df_ = pd.DataFrame(df_)</span><span id="6e59" class="me mf it nc b gy nk nh l ni nj">#extract index and return it as series<br/>  df_ = df_.reset_index()<br/>  return df_['index']</span><span id="7fb5" class="me mf it nc b gy nk nh l ni nj">#moduli di download<br/>def stock(tag, df_to_add):<br/>  #passimo come df_to_add il database di stock già creato<br/>  try:<br/>    df_, _ = download_stock(tag)<br/>    df_ = pd.DataFrame(df_)<br/>    df_ = df_.transpose()<br/>    df_ = df_.loc['2020-09-10':'2019-09-10']<br/>    df_ = df_['1. open']<br/>    df_ = pd.DataFrame(df_)<br/>    df_.columns = [tag]<br/>    df_ = df_[tag].values.astype(float)<br/>    df_ = pd.concat([df_to_add, pd.DataFrame(df_)], axis=1)<br/>    return df_, 'Successful'<br/>  except:<br/>    return df_to_add, 'Error'</span></pre><h1 id="c46c" class="nl mf it bd mg nm nn no mj np nq nr mm ki ns kj mp kl nt km ms ko nu kp mv nv bi translated">下载算法</h1><p id="c0c9" class="pw-post-body-paragraph ks kt it ku b kv mw kd kx ky mx kg la lb my ld le lf mz lh li lj na ll lm ln im bi translated">我终于可以开始下载数据了。为了方便起见，您可以在<strong class="ku jd"> tag_list </strong>中添加您想要的股票列表，只需确保将列表的第一个元素保持为<strong class="ku jd">‘Skip’</strong>，因为第一次调用将简单地创建空数据集的结构，而不填充任何信息。</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="a365" class="me mf it nc b gy ng nh l ni nj">##Stock Downloader</span><span id="ca41" class="me mf it nc b gy nk nh l ni nj">#se lo volgiamo in più tranches, invece di utilizzare timers lo spezziamo<br/>tag_list = ['Skip', 'GOOG']</span><span id="3a95" class="me mf it nc b gy nk nh l ni nj">#questo scarica il giusto index, OVVERO IL TIMESTAMP<br/>index = get_index(tag_list[1])<br/>index = pd.DataFrame(index) #conta come 1 richiesta<br/>index</span><span id="9788" class="me mf it nc b gy nk nh l ni nj">#csv of remaining stocks<br/>empty = pd.DataFrame()<br/>df, _ = stock(tag_list[0], empty) #solo per la prima si utilizza empty<br/>for k in range(1, len(tag_list)):<br/>  <br/>  #print stock you are ATTEMPTING to download now<br/>  print('Iteration:', k, 'Trying to download:', tag_list[k])<br/>  <br/>  #diciamo di aggiungere al database creato il nuovo download<br/>  #se ci sono problemi da None e non viene aggiunto nulla<br/>  df, result = stock(tag_list[k], df)<br/>  print('Iteration:', k, result)</span></pre><h2 id="1fbe" class="me mf it bd mg mh mi dn mj mk ml dp mm lb mn mo mp lf mq mr ms lj mt mu mv iz bi translated">暂停算法</h2><p id="1047" class="pw-post-body-paragraph ks kt it ku b kv mw kd kx ky mx kg la lb my ld le lf mz lh li lj na ll lm ln im bi translated">在每次请求之间暂停算法是非常重要的。您的代码可以运行得非常快，并且大多数服务器，即使您使用自己的API密钥，也会确保限制您的请求，甚至在您发出太多请求时阻止您。这就是为什么我将使用<strong class="ku jd">时间库</strong>对每个请求进行4秒钟的快速暂停。</p><pre class="lp lq lr ls gt nb nc nd ne aw nf bi"><span id="9f16" class="me mf it nc b gy ng nh l ni nj">#every 4 stock pause 70 seconds<br/>  if k%4 == 0:<br/>    time.sleep(70)</span><span id="96ed" class="me mf it nc b gy nk nh l ni nj">#renaming the columns with tag_list<br/>df.columns = tag_list[1:]<br/>df</span><span id="cd30" class="me mf it nc b gy nk nh l ni nj">df1 = df.copy()</span><span id="908a" class="me mf it nc b gy nk nh l ni nj">#reattach index<br/>total = pd.concat([index, df1], axis=1)<br/>total = total.set_index('index')<br/>total</span><span id="6aab" class="me mf it nc b gy nk nh l ni nj">total.to_csv('GOOG.csv')</span></pre><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/2c11942c2e030b1291f6acde859abdc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*tnxHx3ZdH-o6np0d5Cn-CQ.png"/></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">数据帧的快照</figcaption></figure><p id="a7d0" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">我只使用了ticker GOOG，但是你可以在<strong class="ku jd"> tag_list </strong>中使用任意多的ticker。</p></div></div>    
</body>
</html>