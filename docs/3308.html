<html>
<head>
<title>Geocode Millions of Locations Without Being Sued</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对数百万个位置进行地理编码而不会被起诉</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/geocode-millions-of-locations-without-being-sued-8a85e8cc8793?source=collection_archive---------0-----------------------#2022-11-15">https://pub.towardsai.net/geocode-millions-of-locations-without-being-sued-8a85e8cc8793?source=collection_archive---------0-----------------------#2022-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e6e5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">考虑到地理批处理和地理空间分析</h2></div><p id="f60e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">指数时间平滑(ETS)是一种流行于时间序列预测社区的技术，它对来自越来越遥远的时间的信号进行加权处理。只要时间是问题的一部分，类似的方法在时间序列预测之外的预测模型中是标准的。你想预测客户流失吗？尝试使用过去购买金额的加权平均值。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/54638a76690d0ad6469ea091f14b6d08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Flj-HBSqtfq3J06248hkbA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">来自越来越遥远的时代的信号的重要性逐渐减弱。这反映在使用过去购买量的加权平均值作为预测器的流失预测模型中。图片由作者使用<a class="ae lr" href="https://excalidraw.com/" rel="noopener ugc nofollow" target="_blank"> Excalidraw </a>创建。</figcaption></figure><p id="7d67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">时间权重的地理空间等价物是空间权重矩阵。同样的想法也适用:计算加权平均值，权重取决于二维坐标系上的空间距离。但是，与时间不同，空间距离需要大量的前期工作。很可能，你从(结构化的)地址文本开始作为你的位置记录。那么，如何把它们放在一个坐标系上呢？</p><p id="5cb3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面我们将使用经纬度坐标系。从文本到经纬度的转换称为地理编码。有几十个，如果不是几百个，地理编码服务提供商。但由于成本和法律原因，这一选择被证明是有风险的。</p><h2 id="ba82" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">如果你不想被禁止或被起诉，请阅读许可证</h2><p id="97d7" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">选择地理服务提供商时最好要小心。Google Maps和Mapbox是我们分析用例的两个突出而糟糕的选择，因为它们的限制性许可——不允许存储和重新分发结果。例如，Google创建了检测滥用API的机制，在最好的情况下，会导致你的账户被封禁。因此，存储数百万地理编码供以后分析是不允许的。</p><p id="4811" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，一家名为<a class="ae lr" href="https://geoapify.com/" rel="noopener ugc nofollow" target="_blank"> Geoapify </a>的初创公司填补了这个空白。这不仅仅是法律原因。它还与成本、使用舒适度(批处理)以及与开放数据和开源标准的良好集成有关。</p><h2 id="241f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">为什么要为地理空间分析进行Geoapify</h2><p id="6a39" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">简而言之，这就是我们选择Geoapify的原因:</p><ul class=""><li id="7a95" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">我们需要在不破产的情况下对数百万条位置记录进行地理编码。Geoapify以50%的折扣提供批量地理编码。</li><li id="1fdb" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">Geoapify通过友好的许可使用OpenStreetMap和其他开放数据源，以便我们可以存储分析结果。作为一个副作用，我们可以将我们的内部位置记录与像维基数据这样的开放数据源的丰富生态系统联系起来。</li><li id="e8c2" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">Geoapify不仅仅是地理编码。它还提供地点详细信息、等值线、旅行距离等信息，其中大多数服务都以50%的价格包含在它们的Batch API中。</li></ul><p id="9c45" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从零成本开始使用Geoapify的服务，包括商业用途。他们的免费层允许每天批量地理编码6k个地址。在<a class="ae lr" href="https://geoapify.com/" rel="noopener ugc nofollow" target="_blank">geoapify.com</a>注册，立刻生成你的API密匙。</p><h2 id="a322" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">教程-用于批量地理编码的GeoBatchPy等</h2><p id="4a45" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们喜欢Python和命令行。当我们开始时，没有Geoapify API客户端满足我们的需求。所以，我们创建了<a class="ae lr" href="https://github.com/huels-originals/geobatchpy" rel="noopener ugc nofollow" target="_blank"> GeoBatchPy </a>。</p><p id="10ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GeoBatchPy是Geoapify API的Python客户端。它还附带了批处理API的命令行界面，当您需要处理大量位置时，该界面会大放异彩。你可以用<code class="fe ne nf ng nh b">pip install geobatchpy</code>安装PyPI的最新版本。但是我们建议<a class="ae lr" href="https://geobatchpy.readthedocs.io/en/latest/install/" rel="noopener ugc nofollow" target="_blank">创建一个新的Conda环境</a>覆盖<a class="ae lr" href="https://geopandas.org/" rel="noopener ugc nofollow" target="_blank"> GeoPandas </a>和<a class="ae lr" href="https://pysal.org/" rel="noopener ugc nofollow" target="_blank"> PySAL </a>如果你想使用你的数据跟随下面的教程。</p><p id="2735" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程介绍了如何将GeoBatchPy集成到地理空间分析工作流中，从简单的地址记录开始，然后进行批量地理编码，最后计算空间权重矩阵。我们以一个简单的分析用例结束。</p><h2 id="bf57" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">第1部分—数据预处理</h2><p id="6cad" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">本教程的数据集由1081个体育场组成，主要分布在德国、比利时和荷兰。我们使用Geoapify的Places API生成数据。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nk"><img src="../Images/c20e412e29afdd4fbd6c5f79eb997abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgdOA4zBPTNVLodLzMj6Dg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">作者创造的形象。</figcaption></figure><p id="b18c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Geoapify的地理编码服务接受自由文本搜索和结构化输入，后者只有在我们对数据质量非常有信心的情况下才有帮助。我在现实世界的结构化地址记录中看到过太多的数据质量问题。我的结论是去免费文本搜索。这里，我们将结构化数据解析为每行一个字符串。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nl"><img src="../Images/fa1de23308e95fda0044fa1e0b274958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Au04R6KAe5P6rR3alASrCA.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">作者创造的形象。</figcaption></figure><h2 id="56c0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">第2部分-地理编码</h2><p id="9741" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">是时候对我们的地址进行地理编码了。您可以使用我们的Python API做到这一点，但是我们更喜欢命令行。首先，我们使用Python准备输入文件:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="e93e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们切换到CLI。为了让下面两个命令工作，您需要设置您的<code class="fe ne nf ng nh b">GEOAPIFY_KEY</code>环境变量或者在每个<code class="fe ne nf ng nh b">geobatch</code>命令的末尾添加选项<code class="fe ne nf ng nh b">--api-key &lt;your-key&gt;</code>。首先，我们通过以下方式向Geoapify服务器提交作业</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8d32" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ne nf ng nh b">tutorial-geocode-urls.json</code>第一步的输出，是对下一步的输入:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="7a2e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">处理我们的请求需要时间，这取决于请求大小、订阅计划以及Geoapify服务器的繁忙程度。</p><p id="e182" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将结果转换成类似Python字典的GeoJSON的简化列表。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nm"><img src="../Images/c4ec636ed84caca2fdf3ede2ef9926ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LKvsnA_O5CXW2fDquhqMqQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">作者创造的形象。</figcaption></figure><p id="9e5b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GeoPandas 帮助我们将数据转换成表格格式。该方法将<code class="fe ne nf ng nh b">geometry</code>解析成一个<a class="ae lr" href="https://github.com/shapely/shapely" rel="noopener ugc nofollow" target="_blank">形状优美的</a>几何对象，将所有的<code class="fe ne nf ng nh b">properties</code>放入单独的列中，并忽略其余的。我们还将坐标参考系统(CRS)设置为“EPSG:4326”，这意味着几何图形的元组被解释为经度和纬度。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nn"><img src="../Images/3a928d3476397d7356a9fce99065a4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W8pQJfeQqKF_XvOJyDlr2Q.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">作者创造的形象。</figcaption></figure><h2 id="6c1b" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">第3部分—空间权重矩阵</h2><p id="8e19" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们将使用PySAL及其基于距离的方法来计算空间权重矩阵——py sal提供了几种方法，每种方法都有自己的要求。基于距离的方法接受我们的地理编码数据框作为输入，并计算权重，默认情况下，权重随着距离的增加而线性衰减。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi no"><img src="../Images/efe66d2384d0ea42981da78cdd6dc693.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s-VHbERB1NJnqolW1UMtqw.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">对于任何给定的位置L0，我们识别其最近邻居的集合，并计算作为距离的函数的权重。空间权重矩阵由所有位置L0的所有权重组成，按行组织，目标位置L0的权重在对角线上。出于分析目的，我们将对角线权重设置为零，即作者使用<a class="ae lr" href="https://excalidraw.com/" rel="noopener ugc nofollow" target="_blank"> Excalidraw </a>创建的图像。</figcaption></figure><p id="fb35" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们对默认行为进行了三项更改:</p><ul class=""><li id="c796" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">参数<code class="fe ne nf ng nh b">fixed=False</code>和<code class="fe ne nf ng nh b">k=10</code>导致每个目标位置的衰减强度可变。这样，非零权重的数量在每个位置的邻域中都是<code class="fe ne nf ng nh b">k=10</code>。</li><li id="5774" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">我们将对角线上的权重设为0。这将每个目标位置从其具有非零权重的邻居集合中排除。这将与我们的用例相关。</li><li id="8a93" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">设置属性<code class="fe ne nf ng nh b">transform='R'</code>对任何给定目标位置的权重进行归一化，使得它们的总和等于1。</li></ul><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi np"><img src="../Images/da839e255fbec378d491f0525eafa433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dTd7ovoR9zefBqsFacQSSg.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">位置0的邻居和相应权重的汇总，其中权重为正。通过构造，每组权重由k=10个邻居组成，并且每组权重之和等于1—作者创建的图像。</figcaption></figure><h2 id="230c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">第4部分—一个简单的分析用例</h2><p id="212c" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">比方说，我们希望根据某个位置附近的房价来预测该位置每平方米的房价。我们重新使用上一节中的空间权重矩阵来计算加权平均值:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nq"><img src="../Images/351753fe631ffa7a536a484c5cf6f439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fKOm2jGOFGulfrpesOvJsQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">作者创造的形象。</figcaption></figure><p id="6de9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下一幅图表明，加权平均值本身就是价格的无偏预测值。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nr"><img src="../Images/6ae0daaef174e426bb81fc7e69c6badd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqWbEcGaol33FD2msZ1JPQ.png"/></div></div><figcaption class="ln lo gj gh gi lp lq bd b be z dk translated">已知位置价格及其邻域加权平均值的散点图。红线是对角线Price = WeightedAverage —作者创建的图像。</figcaption></figure><p id="a721" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们为什么将对角线权重设置为0，将目标从其邻域权重中排除就变得很明显了。这样，我们可以用已知价格的邻居的加权平均值来预测任何新位置的价格。</p><p id="d8d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在更现实的情况下，您可能希望在预测模型中考虑比邻近价格更多的因素，以反映邻近位置的显著变化。例如，如果一个位置直接暴露于来自交通的大量噪声，则两个相邻位置的定价可能非常不同。然后，加权平均值可以用作拟合我们数据的回归模型中的众多预测值之一。</p><h2 id="d6fe" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">结论和展望</h2><p id="7769" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">大部分(还是全部？)企业出于日常运营目的处理地址数据。用于开发票、送货、拜访客户等。内部位置数据达到数千，如果不是数十万，位置记录非常快。利用相同的数据进行地理空间分析通常依赖于大量的准备工作，如地理编码。我们展示了如何使用Geoapify和我们的Python包来避免不必要的费用和法律风险——只需几行代码。几乎每个分析项目都有可能从地理空间维度中受益。</p><p id="94ae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过从时间等价开始来激励空间权重，这在分析空间中找到了广泛的适应性。这不仅仅是一个或另一个问题。模型可以结合时间和空间来解释这两者——首先，从时间距离上降低单个信号的权重。第二，在空间上组合那些暂时向下加权的信号。例如，当我们研究客户流失时，我们可以计算每个客户所在社区的平均忠诚度。我们识别过去每个搅拌器的日期和位置——这就是(二进制)信号。我们计算加权平均值时考虑了每个当前客户所在社区的活跃客户数量，并根据时间和空间距离进行了加权。例如，这表明客户是否生活在最近本地竞争加剧的地区——这是我们希望迅速采取行动的地方。</p></div></div>    
</body>
</html>