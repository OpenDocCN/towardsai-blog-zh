<html>
<head>
<title>Keras EarlyStopping Callback to train the Neural Networks Perfectly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Keras早期停止回调以完美训练神经网络</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/keras-earlystopping-callback-to-train-the-neural-networks-perfectly-2a3f865148f7?source=collection_archive---------1-----------------------#2022-09-10">https://pub.towardsai.net/keras-earlystopping-callback-to-train-the-neural-networks-perfectly-2a3f865148f7?source=collection_archive---------1-----------------------#2022-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="cad2" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">在Arrowverse系列中，当Arrow对Flash说“接受你自己的建议，戴上面具”，“你可以更好”时，我想，如果我们在神经网络中有一些相同的功能，模型可以在训练时接受它自己的建议，并相应地调整时期，这将会更好，并使选择时期数量的生活变得容易。Keras已经提供了这种方法，这也是我们这篇文章的目的</p></blockquote><p id="a600" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">神经网络中的一个问题是在训练时选择时期的数量，太多的时期将使模型过拟合，而太少的时期可能导致欠拟合。</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ks"><img src="../Images/5673e68df8b28d19a322f736372684f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LSjaVNMa-ku85I35of-mAw.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">照片由Muttineni Sai Rohith拍摄</figcaption></figure><p id="f686" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">EarlyStopping是在训练神经网络时使用的回调，它为我们提供了使用大量训练时期的优势，并且一旦模型的性能在验证数据集上停止改善，就停止训练。</p><p id="1e0c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir">提前停止有多有用？</strong></p><p id="d8e0" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">为了理解这一点，我们先来看一个例子</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="21c0" class="ln lo iq lj b gy lp lq l lr ls">model = tf.keras.models.Sequential([tf.keras.layers.Dense(10)])</span><span id="94ee" class="ln lo iq lj b gy lt lq l lr ls">model.compile(tf.keras.optimizers.SGD(), loss='mse')</span><span id="1a3e" class="ln lo iq lj b gy lt lq l lr ls">history = model.fit(np.arange(100).reshape(5, 20), np.zeros(5), epochs=10, batch_size=1,verbose=1)</span></pre><p id="ff3a" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">因此，在上面的例子中，我们正在考虑一个带有一些随机数据的小型神经网络。这些数据毫无意义，而且最有可能的是，无论有多少个历元，模型性能都不会提高。</p><p id="e91a" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">我们可以在输出中看到—</p><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lu"><img src="../Images/474a310d28b7c89098ecf793c0896c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ixDCPeWtOkj_EzMw72ZNg.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">输出</figcaption></figure><p id="ef63" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">因此，使用EarlyStopping回调，我们可以编写一个神经网络，这样当模型的性能没有改善时，训练就会停止</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="9c92" class="ln lo iq lj b gy lp lq l lr ls">callback = tf.keras.callbacks.EarlyStopping(monitor='loss', patience=3)</span><span id="4a78" class="ln lo iq lj b gy lt lq l lr ls">model = tf.keras.models.Sequential([tf.keras.layers.Dense(10)])</span><span id="5b83" class="ln lo iq lj b gy lt lq l lr ls">model.compile(tf.keras.optimizers.SGD(), loss='mse')</span><span id="9126" class="ln lo iq lj b gy lt lq l lr ls">history = model.fit(np.arange(100).reshape(5, 20), np.zeros(5), epochs=10, batch_size=1, callbacks=[callback],verbose=1)</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi lv"><img src="../Images/931dda0cd8ad104aece0ca40e6cb2e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ryMJ7P5VUaxnSLND_jz6Sw.png"/></div></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">输出</figcaption></figure><p id="3735" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">我们可以看到我们的训练在4个时期后停止了。</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="13d2" class="ln lo iq lj b gy lp lq l lr ls">len(history.history['loss']) #Number of Epochs</span></pre><figure class="kt ku kv kw gt kx gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/b5bdc51ebeaf5fbc87a7fe925ae11916.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*_8ztmP86o4ThegpraEJG3w.png"/></div><figcaption class="le lf gj gh gi lg lh bd b be z dk translated">输出</figcaption></figure><p id="e806" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">我们已经看到了早期停止是如何通过监控模型性能来帮助停止训练的。现在想象一种情况，我们不知道需要多少个历元来获得特定数据的一些好的准确性。在这种情况下，EarlyStopping为我们提供了一个优势，即设置一个较大的值作为时期数，并将耐心值设置为5或10，以便通过监控性能来停止训练。</p><p id="4d72" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir">重要提示:</strong></p><p id="a9ca" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">即使我们可以使用训练损失和准确性，如果我们有可以在训练期间评估的验证数据，早期停止是有意义的。基于这种验证数据的表现，我们将停止训练。</p><p id="3cdb" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">语法:</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="987d" class="ln lo iq lj b gy lp lq l lr ls">model.fit(train_X, train_y, validation_split=0.3,callbacks=EarlyStopping(monitor=’val_loss’), patience=3)</span></pre><p id="a791" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">所以从上面的例子来看，如果验证损失连续3个时期没有减少，那么训练将被停止。</p><p id="28b7" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir">提前停止的参数:</strong></p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="56f6" class="ln lo iq lj b gy lp lq l lr ls">tf.keras.callbacks.EarlyStopping(<br/>    monitor="val_loss",<br/>    min_delta=0,<br/>    patience=0,<br/>    verbose=0,<br/>    mode="auto",<br/>    baseline=None,<br/>    restore_best_weights=False,<br/>)</span></pre><p id="5f83" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">以上是早期停止可用的语法和参数以及默认值。让我们一个一个地详细介绍:</p><p id="a7ef" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> <em class="js">监控</em> </strong> —要监控的指标，例如:“val_loss”、“val_accuracy”</p><p id="0639" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> <em class="js"> min_delta </em> </strong> —被视为改进的受监控指标的最小变化。</p><p id="a43d" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> <em class="js">耐心</em> </strong> —训练后没有进步的次数将被停止</p><p id="5135" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"><em class="js">verbose</em></strong><em class="js">——(0或1) </em> 1代表true，表示回调动作时显示消息。</p><p id="af46" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> <em class="js">模式</em> </strong> <em class="js"> —(“自动”、“最小”、“最大”)</em>在“最小”模式下，当监控指标停止下降时，训练将停止。在“最大”模式下，当监控指标停止增加时，训练将停止。在“自动”模式下，方向是从度量的名称中自动推断出来的。</p><p id="a3e4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"> <em class="js">基线— </em> </strong>受监视度量的基本值。如果监控的指标没有显示出超过基线值的改善，训练将会停止。例如:如果监控的指标是val_accuracy，patience=10，baseline = 50，那么如果val_accuracy在前10个时期不超过50，训练将停止。</p><p id="f976" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated"><strong class="jt ir"><em class="js">restore _ best _ weights</em></strong><em class="js"/>—是否从具有被监控度量的最佳值的时期恢复模型权重。如果为False，则使用在最后一步训练中获得的模型权重。</p><p id="f19c" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">因此，通过使用restore_best_weights，我们可以保存来自具有最佳性能的时期的模型权重，并在其上使用它。</p><p id="e180" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">所以在结束这篇文章之前，让我提供另一个例子来演示提前停止的语法</p><pre class="kt ku kv kw gt li lj lk ll aw lm bi"><span id="2708" class="ln lo iq lj b gy lp lq l lr ls">early_stopping = EarlyStopping(<br/>                              patience=10,<br/>                              min_delta=0.001,                               <br/>                              monitor="val_loss",<br/>                              restore_best_weights=True<br/>                              )</span><span id="ef9e" class="ln lo iq lj b gy lt lq l lr ls">model_history = model.fit(X_train, y_train, batch_size=64, epochs = 100, validation_data = (X_test,y_test), steps_per_epoch= X_train.shape[0] // batch_size, callbacks=[early_stopping])</span></pre><p id="fc49" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">所以在上面的例子中，我们使用了一些训练数据和验证数据。并且如果在任何10个连续时期之后或者在任何10个连续时期中，我们的模型的度量“val_loss”没有减少至少0.001的值，则我们的回调(EarlyStopping)将停止训练。</p><p id="0aae" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">这就是今天文章的内容。我希望下次你训练你的神经网络模型时，使用EarlyStopping回调。</p><p id="d644" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb kp kd ke kf kq kh ki kj kr kl km kn ko ij bi translated">快乐编码…</p></div></div>    
</body>
</html>