<html>
<head>
<title>How To Use AWS for Web Scraping</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用AWS进行网页抓取</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-use-aws-for-web-scraping-f8e4b40993f5?source=collection_archive---------1-----------------------#2022-10-05">https://pub.towardsai.net/how-to-use-aws-for-web-scraping-f8e4b40993f5?source=collection_archive---------1-----------------------#2022-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2826" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用AWS批处理进行可伸缩抓取</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2eed37174ff7f9ab0ebb4ac1705f56e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cTit1LTiAgRVm_H2yk3Oeg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">埃里克·普劳泽特在<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="baee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几个月前，我决定辞职去旅行。接下来是一个夏天的冒险，然后，一瞬间，我发现自己回到了细雨蒙蒙的伦敦，准备考虑重新进入就业市场。自然地，我想知道我是否能收集一些数据来帮助引导我的思考。</p><p id="84a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://medium.com/@jontyhabs/how-to-automate-job-searches-with-python-9a1b04b33036" rel="noopener">的上一篇文章</a>中，我探索了如何使用Reed API以编程方式搜索相关的工作列表。但是如果我想让我的搜索保持新鲜呢？在本文中，我们将使用AWS来安排我们的代码每天获取和存储这些工作列表。</p><p id="bea7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能已经注意到这篇文章的标题有点骗人。使用API并不是真正的web抓取，但是如果它是一个选项，它会可靠得多。然而，从根本上来说，这篇文章是关于建立一个可伸缩的机制来重复调用互联网，所以它可以很容易地应用于web抓取。</p><blockquote class="lw lx ly"><p id="cebc" class="kz la lv lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><strong class="lb iu">免责声明:本文仅用于教育目的。我们不鼓励任何人抓取网站，尤其是那些可能有条款和条件反对此类行为的网站。</strong></p></blockquote><h2 id="4e0b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">先决条件</h2><p id="877e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">要在家里复制这一点，你需要一个AWS帐户，掌握python，Reed的API密匙(你可以在这里注册<a class="ae ky" href="https://www.reed.co.uk/developers/jobseeker" rel="noopener ugc nofollow" target="_blank"/>)，以及安装Docker Desktop的能力。AWS对完成的解决方案每天收取我12美分。</p><h2 id="4307" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">为什么是AWS批处理？</h2><p id="5998" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">需求非常简单——我有一些从API获取工作列表的代码，我希望这些代码每天都运行。鉴于我不想让我的笔记本电脑全天候运行，我需要使用AWS(或其他云计算服务)。</p><p id="1825" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了最大限度地降低成本和工作量，我需要一个无服务器或托管的解决方案。AWS Lambda是一种非常简单的方法，但是每个Lambda最多只能运行15分钟，不幸的是，这对我来说太短了。我的代码运行需要20分钟，即使不需要，我也想要一个可伸缩的解决方案。如果我决定大幅度扩大我的求职范围，这种方法同样有效。设计一个依赖我的代码的系统从来都不是一个好主意，永远不会变得更慢。</p><p id="7aaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我可以设计一些混乱的方式来触发连续的lambdas，直到全部工作完成，但是当理想情况下，我想要一些灵活的东西时，我会创建一个非常具体的解决方案。</p><p id="53f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输入<a class="ae ky" href="https://aws.amazon.com/batch/" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> AWS批次</strong> </a>。这项出色的服务允许您运行和安排批处理作业，而无需担心基础设施。我们只需要定义工作和我们想要的资源，剩下的就交给AWS了。</p><p id="35e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">本文大部分是技术教程，所以如果你对具体细节不感兴趣，可以去</em> <a class="ae ky" href="https://medium.com/@jontyhabs/jobs-in-data-what-the-data-tells-us-about-skills-and-salaries-fc2c030ef7cb" rel="noopener"> <em class="lv">我的下一个故事</em> </a>，<em class="lv">那里我会分析数据来了解工作薪水、技能、趋势等等！</em></p><h2 id="5804" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">绕道去码头</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b42a4bfdb3ed67cbd7ff77a6dbc54479.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFG159jBncHWCmUrEvB3OA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@ventiviews" rel="noopener ugc nofollow" target="_blank">通风视图</a>对<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">防溅板</a>拍照</figcaption></figure><p id="1b6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS Batch不会像Lambda那样执行简单的python脚本。AWS批处理通过执行Docker映像来工作。</p><p id="da6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不熟悉Docker，基本上有三点需要理解:</p><ul class=""><li id="9d28" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">一个<strong class="lb iu"> Docker容器</strong>类似于一个轻量级虚拟机。它本质上是一个独立的系统，包含我们运行给定应用程序所需的一切。例如，我们的容器将需要包含python的安装。</li><li id="5267" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">一个<strong class="lb iu"> Docker图像</strong>是一个可以用来创建容器的模板。它是一个多层文件，包含创建该容器所需的一切。容器是一个图像的可运行实例，虽然图像是不可变的，但是它可以产生几个独立的容器。</li><li id="b451" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">一个<strong class="lb iu"> Dockerfile <em class="lv"> </em> </strong>是一个文本文件，它包含一组简单的指令，用于定义Docker映像的创建。</li></ul><h2 id="fa63" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">创建Docker图像</h2><p id="1d50" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">首先，<a class="ae ky" href="https://docs.docker.com/desktop/windows/install/" rel="noopener ugc nofollow" target="_blank">安装Docker桌面</a>。</p><p id="2408" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://medium.com/@jontyhabs/how-to-automate-job-searches-with-python-9a1b04b33036" rel="noopener">上一篇文章</a>中，我们有两个脚本:一个用于搜索jobs数据库并返回清单的基本细节(<code class="fe no np nq nr b">reed_summary_fetcher.py</code>)，另一个用于遍历这些清单以获取它们的完整细节(<code class="fe no np nq nr b">reed_details_fetcher.py</code>)。提醒一下，这是第一个脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="96e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是第二个:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="714e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要为每个脚本创建不同的Docker映像，所以首先，在您的笔记本电脑上为每个脚本创建一个本地文件夹。每个本地文件夹都有三个组成部分:脚本、python包的requirements.txt文件和Docker文件(按照惯例，它总是被简单地命名为<em class="lv"> Dockerfile </em>，没有扩展名)。以下是第一个脚本的docker文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="fa3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这套简单的说明将告诉Docker如何制作图像:</p><ul class=""><li id="617e" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">从包含所有python设置的现有公共映像开始</li><li id="031a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">创建一个名为<code class="fe no np nq nr b">app</code>的新目录，将本地工作目录中的所有文件添加到映像中，并将<code class="fe no np nq nr b">app</code>定义为工作目录</li><li id="1115" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">安装我们需要的任何python包</li><li id="08f7" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">运行python脚本</li></ul><p id="cd0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的requirements.txt文件只需要以下python包:requests、boto3和datetime。</p><p id="e76c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了要运行的python文件的名称之外，第二个python脚本的Dockerfile(获取清单细节)是相同的。</p><p id="09b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要测试这是否有效，请打开一个终端并运行:</p><p id="ee27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe no np nq nr b">docker build -t &lt;image name&gt; .</code></p><p id="5e1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果成功，当你输入<code class="fe no np nq nr b">docker images</code>时，你应该能看到你的图像。你可以通过输入<code class="fe no np nq nr b">docker rmi &lt;image name or ID&gt;</code>来删除它。</p><h2 id="7945" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">设置AWS命令行界面(CLI)</h2><p id="9779" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">AWS Batch无法使用您笔记本电脑上的Docker映像。我们需要将您的图像放入亚马逊的图像存储ECR。由于没有办法将图像拖放到AWS中，我们必须使用命令行界面。</p><p id="e9e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你以前没有用过这个，你首先需要在你的本地机器上安装客户端。接下来，您需要导航到AWS中的IAM部分来生成一个密钥对(除非您已经有了一个)。这个密钥对对于验证您的本地机器和您的AWS帐户之间的连接是必需的。出于安全原因，最好为IAM角色而不是根用户生成访问密钥。最后，您可以配置您的AWS CLI，方法是在本地机器上的终端中键入<code class="fe no np nq nr b">aws configure</code>，并在出现提示时提供您的密钥对和区域。你可以在这里得到更详细的说明<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-creds-create" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ca88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您只需配置一次AWS CLI之后，它将能够自动认证。</p><h2 id="fefc" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用亚马逊的弹性容器注册中心(ECR)</h2><p id="636a" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">导航到AWS中的ECR控制台，并选择“创建新存储库”。一个存储库可以包含多个映像，但是通常的最佳实践是一个存储库包含一个映像(或者同一映像的所有不同开发版本)。因此，我们将需要一个存储库用于第一个脚本(我称之为mine <strong class="lb iu"> reed-summary </strong>)和一个存储库用于第二个脚本(我称之为mine <strong class="lb iu"> reed-details </strong>)。你可以只输入一个名字，其他的都是默认的。</p><p id="5573" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你点击进入你的新存储库，有一个方便的按钮，上面写着“查看推送命令”。点击这个按钮可以获得您需要在本地终端上运行的命令集。这些命令执行以下操作:</p><ul class=""><li id="bdd7" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">验证与AWS的连接</li><li id="d8f1" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">在当地建立你的形象</li><li id="c8c6" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">用您的ECR存储库标记您的映像(加上一个常规标记来表示这是映像的最新版本)</li><li id="9325" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">将您的映像推送到您的存储库</li></ul><p id="7d05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果因为任何原因，这些命令看不到，你可以在这里得到它们<a class="ae ky" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html" rel="noopener ugc nofollow" target="_blank">，你也可以从ECR存储库主页得到存储库URI。</a></p><p id="90f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住要做两次——我们有两个python脚本，每个脚本都需要放入自己的映像中，存储在自己的ECR存储库中。</p><h2 id="5f27" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">使用AWS批处理-概述</h2><p id="96ff" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们已经有了我们的图像——创建小python框来运行我们的脚本的模板——现在我们只需要AWS运行它们的方法。</p><p id="8978" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的基本设置如下图所示:Eventbridge触发器将告诉Batch运行一个作业；Batch将从ECR中获取我们的图像，并将其作为一个容器运行；该容器将运行我们的python代码，python代码将从Reed API获取数据并保存到s3。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/a2bb1abc37fb491f588d83041927a21e.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/format:webp/1*KQYpQGuJlUVFo8deiNYTQw.png"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">作者图表</figcaption></figure><p id="e9a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这听起来很简单，但是在它的内部，AWS Batch有以下组件:</p><ul class=""><li id="afd5" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">一个<strong class="lb iu">计算环境</strong>定义了你的工作将在其上运行的基础设施</li><li id="cc9a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">作业定义</strong>通过陈述相关的docker映像和其他配置来定义作业——您想要执行的任务</li><li id="f457" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">作业</strong>是<strong class="lb iu">作业定义</strong>的运行实例</li><li id="f9c1" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">作业队列</strong>将作业传递到相关的计算环境中执行</li></ul><p id="32f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是时候再次动手了！</p><h2 id="595b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">AWS批处理—网络、安全性和角色</h2><p id="163b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">任何令人兴奋的AWS服务的无聊序言——所有的设置都是为了确保我们的各种组件可以安全地相互通信。文档<a class="ae ky" href="https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html" rel="noopener ugc nofollow" target="_blank">非常好，所以我们将快速浏览一下。</a></p><ul class=""><li id="36f2" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">AWS Batch需要知道将计算资源放在哪里，所以创建一个VPC(指令<a class="ae ky" href="https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html#create-a-vpc" rel="noopener ugc nofollow" target="_blank">在这里</a>或<a class="ae ky" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html" rel="noopener ugc nofollow" target="_blank">在这里</a>)。确保它有一个公共子网。</li><li id="310d" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">您需要一个安全组来为您的计算环境把关入站和出站流量。<a class="ae ky" href="https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html#create-a-base-security-group" rel="noopener ugc nofollow" target="_blank">在你的新VPC里创造一个</a>。默认情况下，向导应该向所有IP建议一个通用出站规则，而不建议入站规则；这对我们来说很好。(在现实世界中，如果我们的Reed API端点坚持一组静态的IP地址，我们将进一步完善这条规则。)</li></ul><p id="ce86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的用例中有三个不同的IAM角色。</p><ul class=""><li id="7458" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><strong class="lb iu">服务角色</strong>管理AWS批处理调用其他AWS服务所需的权限。例如，Batch需要使用其他AWS服务来管理每个作业的计算资源。该角色将在我们设置计算环境时自动创建。</li><li id="3f13" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">执行角色</strong>管理ECS代理调用其他AWS服务所需的权限。例如，从ECR中提取图像。按照此处的说明<a class="ae ky" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html" rel="noopener ugc nofollow" target="_blank">设置该角色<em class="lv">ecstaxecutionrole</em>。</a></li><li id="bc18" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">任务角色</strong>授予正在运行的容器更多的权限。在现实世界的场景中，我们有许多作业都运行不同的映像用于不同的目的，每个作业可能有不同的作业角色，同时共享相同的最小执行角色。</li></ul><p id="b669" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要我们的容器能够向S3写对象，所以我们需要创建一个作业角色。转到IAM控制台中的<strong class="lb iu">创建角色</strong>向导，选择“AWS服务任务”作为可信实体，选择弹性容器服务作为用例，选择<em class="lv"> AmazonS3FullAccess </em>和<em class="lv">ecstaxecutionrole</em>作为您的策略。我把这个角色命名为<strong class="lb iu"> s3-put-iam </strong>。</p><h2 id="9006" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">AWS批处理—设置计算环境</h2><p id="ce11" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在AWS控制台中搜索<strong class="lb iu">批处理</strong>，转到<strong class="lb iu">计算环境</strong>，然后点击<strong class="lb iu">创建</strong>。</p><p id="1d49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里的几乎所有内容都可以保持默认，包括AWS提供的创建服务角色。使用Fargate选项可以最大程度地简化无服务器操作。</p><p id="393e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<strong class="lb iu">网络</strong>部分，选择我们的新VPC及其公共子网(我们的计算资源将需要访问互联网以获取我们的数据)，以及我们的新安全组。</p><h2 id="be2b" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">AWS批处理-设置作业定义</h2><p id="b73c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">从侧边栏进入<strong class="lb iu">工作定义</strong>控制台，点击<strong class="lb iu">创建</strong>。我们没有做任何繁重的工作，所以单节点选项对我们有好处。选择Fargate平台类型，并选择我们之前创建的<em class="lv">ecstakexecutionrole</em>。我们还需要启用公共IP，这样我们就可以享受出站互联网访问。</p><p id="412f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再往下，提供<strong class="lb iu">簧片-总结</strong>图像的位置(URI)。提供我们的<em class="lv">S3-put-iam</em><strong class="lb iu"><em class="lv"/></strong>角色作为作业角色，并提供环境变量配置中的Reed API键作为<code class="fe no np nq nr b">API_KEY</code>(因为这是python代码所期望的)。</p><p id="c4b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要设置其中两个作业定义——一个用于<strong class="lb iu">钢筘汇总</strong>图像，一个用于<strong class="lb iu">钢筘详细信息</strong>图像。</p><h2 id="acec" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">AWS批处理-设置作业队列</h2><p id="b5dd" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">从侧边栏进入<strong class="lb iu">作业队列</strong>控制台，点击<strong class="lb iu">创建</strong>。您只需要命名您的作业队列并选择计算环境。</p><p id="a36e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以为作业队列和作业定义设置优先级，让AWS知道哪些作业优先，但是因为我们每天只运行两个连续的作业，所以可以忽略这一点。</p><h2 id="cd48" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">计划作业</h2><p id="d5e3" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">您可以在<strong class="lb iu">批次</strong>中的<strong class="lb iu">作业</strong>部分提交一个新作业，点击<strong class="lb iu">提交新作业</strong>，选择作业定义和作业队列(其他保持默认)。这是检查一切是否正常的好方法——AWS Batch<strong class="lb iu">仪表板</strong>概述了提交到每个队列的作业，而<strong class="lb iu">作业</strong>部分显示正在运行或最近运行的作业。您可以通过单击这些作业来查找作业日志，以便解决任何问题。如果您需要更改作业定义，Batch允许您进行版本修订，这是跟踪更改的好方法。</p><p id="cb7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有点违背直觉，为了让这些作业按计划运行，我们需要脱离Batch，进入AWS <strong class="lb iu"> Eventbridge </strong>。该服务允许我们为其他服务创建触发器。</p><p id="e9f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Eventbridge中创建规则非常简单。出于我们的目的，我们需要两个规则，每个工作(图像)一个。为了简单起见，我使用一个cron表达式来每天运行一次每个作业，开始时间间隔为一小时(以确保第一个作业已经完成)。例如，<code class="fe no np nq nr b">10 2 ** ? *</code>将作业安排在每天早上02:10。在实际场景中，我们会给第一个作业一个基于时间的触发器，并设置第二个作业在第一个作业成功完成后运行。</p><h2 id="e7d1" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">包扎</h2><p id="e879" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">做一件极其简单的事情——每天运行两个小python脚本——可能感觉需要相当大的努力。而且……的确如此。如果不是AWS Lambda的超时限制，我们也不会为Batch费心，这篇文章也会短很多。</p><p id="3d28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是一旦我们设置好批处理，我们就有了一个非常可扩展的解决方案。我可以将数以千计的作业按优先级排序。如果我的工作变得更加繁重，我可以扩展我的计算环境。如果有必要，我甚至可以管理自己的资源，选择AWS提供的任何类型的计算机，包括GPU，如果我的任务需要它们的话。</p><h2 id="86c0" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">接下来呢？</h2><p id="c855" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在我的AWS批处理作业每天运行五个月后，我分析了产生的数据，以了解英国数据部门的职称、工资和技能。前往我的<a class="ae ky" href="https://medium.com/@jontyhabs/jobs-in-data-what-the-data-tells-us-about-skills-and-salaries-fc2c030ef7cb" rel="noopener">下一篇文章</a>了解更多信息！</p></div></div>    
</body>
</html>