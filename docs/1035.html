<html>
<head>
<title>Building an End to End Recommendation Engine using Matrix Factorization with Cloud Deployment using Amazon SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用矩阵分解构建端到端推荐引擎，使用Amazon SageMaker进行云部署</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/building-an-end-to-end-recommendation-engine-using-matrix-factorization-with-cloud-deployment-using-f878d43c1005?source=collection_archive---------2-----------------------#2020-10-12">https://pub.towardsai.net/building-an-end-to-end-recommendation-engine-using-matrix-factorization-with-cloud-deployment-using-f878d43c1005?source=collection_archive---------2-----------------------#2020-10-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="cd02" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/cloud-computing" rel="noopener ugc nofollow" target="_blank">云计算</a>，<a class="ae ep" href="https://towardsai.net/p/category/machine-learning" rel="noopener ugc nofollow" target="_blank">机器学习</a></h2><div class=""/><figure class="gl gn jx jy jz ka gh gi paragraph-image"><div class="gh gi jw"><img src="../Images/ef62d66b469baf36105667f356bfd096.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*SkpUQEZzj3NDYfiKhXRhbQ.png"/></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">图片提供:谷歌云</figcaption></figure><p id="20be" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">您访问过多少次购物网站并购买过任何东西，您是否注意到网站会根据您的购买历史进行个性化设置？</p><p id="ed18" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">你们一定都看过YouTube视频。这款应用会根据你观看的内容类型以某种方式推荐视频吗？</p><p id="552e" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">看电影或上网时，广告看起来熟悉吗？</p><p id="c2a9" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">推荐引擎是机器学习最重要的应用之一，它们改变了企业与客户互动的方式。它帮助用户找到相关内容，探索新项目，并改善决策，但它也帮助内容制作者了解用户行为，提高用户参与度。</p><p id="2171" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">这不仅有助于企业为其客户提供合适的产品，也有助于用户根据自己的兴趣和消费来个性化他们的用户体验。</p><p id="89c6" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">推荐系统的类型:</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lf"><img src="../Images/b85fbd44ac9da38048c2aca14069778d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ibnaqByrkTCY_dRPc6OIbg.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">图片提供:谷歌云</figcaption></figure><ol class=""><li id="0930" class="lo lp iq kj b kk kl ko kp ks lq kw lr la ls le lt lu lv lw bi translated"><strong class="kj ja">基于内容的过滤:</strong></li></ol><p id="7f42" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">基于内容的过滤使用项目的属性来向用户推荐新项目。推荐纯粹基于用户的内容消费历史。例如，如果用户观看了两部电影，并将科幻电影评为高，将恐怖电影评为低，则基于内容的推荐引擎将开始向该用户推荐更多科幻电影。</p><p id="d0b9" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">下面是一个用户-项目交互矩阵，其中对第二个用户的推荐将仅基于该用户对项目的评分。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lx"><img src="../Images/233129e363200de9663abb50a91b493a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UeutJNm6xo0JRrhng6VYNQ.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">图片提供:谷歌</figcaption></figure><p id="1f25" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">缺点:冷启动</strong>——假设用户没有对足够多的电影评级，推荐引擎不会考虑未评级的电影，因为它只考虑用户历史。</p><p id="5d4a" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">在</strong>时使用:有足够的用户历史可用。</p><p id="9d70" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 2。协同过滤:</strong></p><p id="cd40" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">它同时利用用户和商品之间的相似性来决定推荐什么。这考虑了整个用户-项目交互矩阵来向用户推荐项目。例如，如果两个用户显示出相似的物品购买行为，则很有可能两个用户都会购买相似类型的物品。</p><p id="2d8f" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">下面是一个例子，其中整个矩阵将被视为向第二个用户推荐商品。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ly"><img src="../Images/2b5389942e7af539e3cff5cd50358cce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_yjXFdhwzrnSlMrD35MaGA.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">图片提供:谷歌云</figcaption></figure><p id="e65f" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">优点:</strong>只要检测到用户之间的相似性，就克服了冷启动问题。</p><p id="4213" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">用于:</strong>用户交互矩阵稀疏的可能性很高(用户可能会也可能不会对大部分项目进行评分)。</p><p id="ed56" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">反对意见:在极少数情况下，用户很少与任何物品互动(例如购买任何超级奢侈品)，协同过滤可能帮助不大。</p><p id="b679" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 3。基于知识的过滤:</strong></p><p id="93e2" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在这种情况下，关于用户的明确知识被用来创建推荐。例如，在开始时以小测验或表格的形式问一些问题。</p><p id="9944" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">优点:</strong>它克服了以上问题。</p><p id="5abb" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">基于混合的过滤:</strong>在现实世界的场景中，所有三种技术的组合被用来构建推荐引擎。因此它被称为基于混合的过滤。</p><p id="07bb" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">今天我们将讨论构建推荐引擎的协同过滤。我们可以遵循两种方法来构建我们的推荐引擎:</p><ol class=""><li id="d4b8" class="lo lp iq kj b kk kl ko kp ks lq kw lr la ls le lt lu lv lw bi translated"><strong class="kj ja">矩阵分解:</strong></li></ol><p id="cbad" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">这个想法是将用户交互矩阵分解为用户因素和项目因素。使用给定的用户id，两个矩阵的乘积将产生预测评级。使用这些排名前k的用户将获得k个项目的推荐。在这篇博客中，我们将使用矩阵分解来构建我们的推荐。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lz"><img src="../Images/e1e8f2b1ca99ef6d199b7f180ab1c3e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UtjTph3usvRWL17boqZJng.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">来源:谷歌云</figcaption></figure><p id="9da5" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">这个模型可以用这个等式来表示。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/c068843f0caec44ee8173e2fa4b8a20b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*fa1PhMrcLogzV5P1mfG2Jw.png"/></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">资料来源:AWS</figcaption></figure><p id="9ee7" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">该方程中的三项分别对应于模型的三个组成部分:</p><ul class=""><li id="8f63" class="lo lp iq kj b kk kl ko kp ks lq kw lr la ls le mb lu lv lw bi translated">w0项代表全局偏差。</li><li id="1f40" class="lo lp iq kj b kk mc ko md ks me kw mf la mg le mb lu lv lw bi translated">wi线性项模拟第I个变量的强度。</li><li id="2470" class="lo lp iq kj b kk mc ko md ks me kw mf la mg le mb lu lv lw bi translated"><vi>因式分解项模拟第I个和第j个变量之间的成对相互作用。</vi></li></ul><p id="d748" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">该模型被训练为减少损失度量。</p><p id="b7b6" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">对于<strong class="kj ja">分类</strong>,测井曲线损失函数具有以下等式:</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/a197b61864d9763d13a07931ebcfd55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*Z_KXItpBomHQELIH8s9N5g.png"/></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">资料来源:AWS</figcaption></figure><p id="66ed" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在哪里</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/28f3d1b2a3abe4e2f79029a16b050f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:496/format:webp/1*hG_CElZ5TTHx01P8Ved-7g.png"/></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">资料来源:AWS</figcaption></figure><p id="eef0" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">ŷn:模型预测</p><p id="fea6" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">yn:目标值</p><p id="9449" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">对于<strong class="kj ja">回归</strong>任务，平方损失函数:</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/1170e3e3742a472f97c58f5a33d924e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/1*8KjmtKKEc4seayzBLpchow.png"/></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">资料来源:AWS</figcaption></figure><p id="2952" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">你可以使用白皮书阅读更多关于因式分解机器的信息。</p><p id="167f" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 2。神经协同过滤(NCF): </strong></p><p id="00d7" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在我们进入什么是神经协同过滤之前，我们应该理解两个术语:</p><p id="dc35" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">显式反馈</strong>:由用户明确提供给系统，例如喜欢或不喜欢，或者对视频的评分。基于用户交互，该数据可能存在，也可能不存在。</p><p id="87ca" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">隐性反馈</strong>:这些数据是通过用户的使用模式隐性收集的，比如观看视频的时间、点击量、浏览量。它更容易获得。</p><p id="33e8" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">通过使用来自用户-项目交互的隐式反馈，NCF比传统的矩阵分解技术更进了一步。为此，NCF利用多层感知器在解决方案中引入非线性。</p><p id="1a4a" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">先决条件:</strong></p><p id="debd" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">为了建立我们的模型，我们需要一个AWS帐户和访问AWS SageMaker服务。该数据集将是一个开源数据集。我们将使用像S3这样的AWS服务来存储模型工件，并使用AWS sagemaker托管服务来端到端地部署我们的模型。</p><p id="81b2" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">注意</strong>:虽然您可能正在使用AWS免费层服务，但如果不是免费试用，AWS Sagemaker服务可能会向您收取费用。因此，请留意您使用SageMaker服务的时间，以避免任何与账单相关的意外。</p><p id="c755" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">我们将从存储模型工件的存储桶创建开始。为此，我们将使用亚马逊S3服务。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ml"><img src="../Images/69f63c468221ed9b04c09586b2172f4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wgtOmbSs4B1RhFiVwQDAzg.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图1</figcaption></figure><p id="300f" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">确保选中“阻止所有公共访问”。</p><p id="e79c" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">一旦创建了bucket，就可以转到Amazon SageMaker服务来创建一个笔记本实例。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mm"><img src="../Images/5d735afaa5eeb39a21da66c897dfe331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ljw5XfSeKvXYNOcNqjQY4g.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图2</figcaption></figure><p id="c4c5" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">一旦实例准备就绪，您就可以打开jupyterlab了。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mn"><img src="../Images/f2bd13522b01f9e4f7ba6d1c03865654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUitricnSD5rU5AKeeNCDA.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图3</figcaption></figure><ol class=""><li id="f69f" class="lo lp iq kj b kk kl ko kp ks lq kw lr la ls le lt lu lv lw bi translated"><strong class="kj ja">使用以下命令从公共存储库中下载数据集:</strong></li></ol><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="0746" class="mt mu iq mp b gy mv mw l mx my">!wget <a class="ae mk" href="http://files.grouplens.org/datasets/movielens/ml-100k.zip" rel="noopener ugc nofollow" target="_blank">http://files.grouplens.org/datasets/movielens/ml-100k.zip</a><br/>!unzip -o ml-100k.zip</span></pre><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mz"><img src="../Images/69643318c381199d87f09c16c900768f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ms8DnmtrrTjfUOIH5cmMwg.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图4</figcaption></figure><p id="c3e0" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 2。检查数据集:</strong></p><p id="d055" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">下一个任务是检查下载的数据集。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="eb79" class="mt mu iq mp b gy mv mw l mx my">%cd ml-100k<br/>!shuf ua.base -o ua.base.shuffled<br/>!head -10 ua.base.shuffled</span><span id="ac1e" class="mt mu iq mp b gy na mw l mx my">!head -10 ua.test</span></pre><figure class="lg lh li lj gt ka gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/64e5d9f7a7bd29738a7b025c6c9891b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*mlpWpBVq8n_gbSAoD6z5YQ.png"/></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图5</figcaption></figure><p id="cf62" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 3。构建训练和测试数据集:</strong></p><p id="61c0" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在这一步中，我们将导入必要的库，并创建一个训练和测试数据集。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="d1f9" class="mt mu iq mp b gy mv mw l mx my">import sagemaker<br/>import sagemaker.amazon.common as smac<br/>from sagemaker import get_execution_role<br/>from sagemaker.predictor import json_deserializer</span><span id="5da9" class="mt mu iq mp b gy na mw l mx my">import boto3, csv, io, json<br/>import numpy as np<br/>from scipy.sparse import lil_matrix</span><span id="4991" class="mt mu iq mp b gy na mw l mx my">nbUsers=943<br/>nbMovies=1682<br/>nbFeatures=nbUsers+nbMovies</span><span id="6d31" class="mt mu iq mp b gy na mw l mx my">nbRatingsTrain=90570<br/>nbRatingsTest=9430</span><span id="8647" class="mt mu iq mp b gy na mw l mx my"># For each user, build a list of rated movies.<br/># We'd need this to add random negative samples.<br/>moviesByUser = {}<br/>for userId in range(nbUsers):<br/>    moviesByUser[str(userId)]=[]<br/> <br/>with open('ua.base.shuffled','r') as f:<br/>    samples=csv.reader(f,delimiter='\t')<br/>    for userId,movieId,rating,timestamp in samples:<br/>        moviesByUser[str(int(userId)-1)].append(int(movieId)-1)</span><span id="d35b" class="mt mu iq mp b gy na mw l mx my">def loadDataset(filename, lines, columns):<br/>    # Features are one-hot encoded in a sparse matrix<br/>    X = lil_matrix((lines, columns)).astype('float32')<br/>    # Labels are stored in a vector<br/>    Y = []<br/>    line=0<br/>    with open(filename,'r') as f:<br/>        samples=csv.reader(f,delimiter='\t')<br/>        for userId,movieId,rating,timestamp in samples:<br/>            X[line,int(userId)-1] = 1<br/>            X[line,int(nbUsers)+int(movieId)-1] = 1<br/>            if int(rating) &gt;= 4:<br/>                Y.append(1)<br/>            else:<br/>                Y.append(0)<br/>            line=line+1<br/>            <br/>    Y=np.array(Y).astype('float32')<br/>    return X,Y</span><span id="c9fd" class="mt mu iq mp b gy na mw l mx my">X_train, Y_train = loadDataset('ua.base.shuffled', nbRatingsTrain, nbFeatures)<br/>X_test, Y_test = loadDataset('ua.test',nbRatingsTest,nbFeatures)</span><span id="3f10" class="mt mu iq mp b gy na mw l mx my">print(X_train.shape)<br/>print(Y_train.shape)<br/>assert X_train.shape == (nbRatingsTrain, nbFeatures)<br/>assert Y_train.shape == (nbRatingsTrain, )<br/>zero_labels = np.count_nonzero(Y_train)<br/>print("Training labels: %d zeros, %d ones" % (zero_labels, nbRatingsTrain-zero_labels))</span><span id="e411" class="mt mu iq mp b gy na mw l mx my">print(X_test.shape)<br/>print(Y_test.shape)<br/>assert X_test.shape  == (nbRatingsTest, nbFeatures)<br/>assert Y_test.shape  == (nbRatingsTest, )<br/>zero_labels = np.count_nonzero(Y_test)<br/>print("Test labels: %d zeros, %d ones" % (zero_labels, nbRatingsTest-zero_labels))</span></pre><p id="7f04" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">一旦训练和测试数据集准备就绪，我们将进入下一步。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nc"><img src="../Images/c98d5228ee1b5b05a676bd8eb8d657d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZuVifekXFccQo0ezcmKS9w.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图6</figcaption></figure><p id="f9ba" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 4。将样本转换为protobuf格式并存储在s3: </strong></p><p id="3175" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">在这一步中，我们将数据集转换为protobuf格式，因为Sagemaker接受这种格式用于因式分解机器的训练作业，并将其保存到s3。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="d458" class="mt mu iq mp b gy mv mw l mx my">bucket = 'movierecommendationdemo'<br/>prefix = 'sagemaker/fm-movielens'</span><span id="d14e" class="mt mu iq mp b gy na mw l mx my">train_key      = 'train.protobuf'<br/>train_prefix   = '{}/{}'.format(prefix, 'train3')</span><span id="304f" class="mt mu iq mp b gy na mw l mx my">test_key       = 'test.protobuf'<br/>test_prefix    = '{}/{}'.format(prefix, 'test3')</span><span id="92f4" class="mt mu iq mp b gy na mw l mx my">output_prefix  = 's3://{}/{}/output'.format(bucket, prefix)</span><span id="5e4b" class="mt mu iq mp b gy na mw l mx my">def writeDatasetToProtobuf(X, Y, bucket, prefix, key):<br/>    buf = io.BytesIO()<br/>    smac.write_spmatrix_to_sparse_tensor(buf, X, Y)<br/>    buf.seek(0)<br/>    obj = '{}/{}'.format(prefix, key)<br/>    boto3.resource('s3').Bucket(bucket).Object(obj).upload_fileobj(buf)<br/>    return 's3://{}/{}'.format(bucket,obj)<br/>    <br/>train_data = writeDatasetToProtobuf(X_train, Y_train, bucket, train_prefix, train_key)    <br/>test_data  = writeDatasetToProtobuf(X_test, Y_test, bucket, test_prefix, test_key)    <br/>  <br/>print(train_data)<br/>print(test_data)<br/>print('Output: {}'.format(output_prefix))</span></pre><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nd"><img src="../Images/82b397983bef700edeb8309b41884a1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ww7cgTuIaV-cqQuQeqa3AQ.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图7</figcaption></figure><p id="387e" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">一旦工件被保存，您就可以在s3存储桶中看到它们。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ne"><img src="../Images/81d40120243a6b5a2785d9e6816aeb32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a7EiUFvF2xJSQQ7A5bb3Mw.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图8</figcaption></figure><p id="baf7" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">5.运行培训作业:</p><p id="29c0" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">下一步是创建一个训练作业，并使用预定义的超参数运行它。</p><p id="2c24" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">以下代码将触发培训作业。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="5c78" class="mt mu iq mp b gy mv mw l mx my">containers = {'us-west-2': '174872318107.dkr.ecr.us-west-2.amazonaws.com/factorization-machines:latest',<br/>              'us-east-1': '382416733822.dkr.ecr.us-east-1.amazonaws.com/factorization-machines:latest',<br/>              'us-east-2': '404615174143.dkr.ecr.us-east-2.amazonaws.com/factorization-machines:latest',<br/>              'eu-west-1': '438346466558.dkr.ecr.eu-west-1.amazonaws.com/factorization-machines:latest'}</span><span id="d8b9" class="mt mu iq mp b gy na mw l mx my">fm = sagemaker.estimator.Estimator(containers[boto3.Session().region_name],<br/>                                   get_execution_role(), <br/>                                   train_instance_count=1, <br/>                                   train_instance_type='ml.c4.xlarge',<br/>                                   output_path=output_prefix,<br/>                                   sagemaker_session=sagemaker.Session())</span><span id="4303" class="mt mu iq mp b gy na mw l mx my">fm.set_hyperparameters(feature_dim=nbFeatures,<br/>                      predictor_type='binary_classifier',<br/>                      mini_batch_size=1000,<br/>                      num_factors=64,<br/>                      epochs=100)</span><span id="b071" class="mt mu iq mp b gy na mw l mx my">fm.fit({'train': train_data, 'test': test_data})</span></pre><p id="5422" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">培训作业开始后，用户可以从控制面板的“培训作业”部分对其进行跟踪。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nf"><img src="../Images/94354fff59e94ac80ae87e559dea5e3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wT0di2oDYQGPzIenR6bGAw.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图9</figcaption></figure><p id="44aa" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">训练工作完成后，您可以开始使用训练好的模型。此外，您可以使用超参数作业来调整超参数。你可以参考我的<a class="ae mk" href="https://medium.com/towards-artificial-intelligence/building-an-end-to-end-deep-learning-model-with-deployment-on-aws-cloud-using-amazon-sagemaker-6b8584c9c6e7" rel="noopener">帖子</a>，在那里我展示了如何使用超参数调优作业</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ng"><img src="../Images/358ab40c81c771df6aea04ba87c4dc25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T0CjzgE0ol_fB49WAwxywQ.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">截图10</figcaption></figure><p id="d4e8" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 6。部署基线模型:</strong></p><p id="2491" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">现在，我们可以通过编程方式调用API来部署我们的模型，或者使用sagemaker仪表板来部署它。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="c4e9" class="mt mu iq mp b gy mv mw l mx my">fm_predictor = fm.deploy(instance_type='ml.c4.xlarge', initial_instance_count=1)</span><span id="e219" class="mt mu iq mp b gy na mw l mx my">def fm_serializer(data):<br/>    js = {'instances': []}<br/>    for row in data:<br/>        js['instances'].append({'features': row.tolist()})<br/>    #print js<br/>    return json.dumps(js)</span><span id="7dd6" class="mt mu iq mp b gy na mw l mx my">fm_predictor.content_type = 'application/json'<br/>fm_predictor.serializer = fm_serializer<br/>fm_predictor.deserializer = json_deserializer</span></pre><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nh"><img src="../Images/78e97419139ba21b179e68a88503a404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnHyKja2O1_hBNmvgux38A.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图11</figcaption></figure><p id="5101" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">一旦创建了端点，您就可以运行预测来为这组用户获得关于电影的推荐。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="ebb0" class="mt mu iq mp b gy mv mw l mx my">result = fm_predictor.predict(X_test[1000:1010].toarray())<br/>print(result)<br/>print (Y_test[1000:1010])</span></pre><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ni"><img src="../Images/851b19225c095cafa5da64d56632a396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkvtphvhVpZRjSBZH-jRdw.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图12</figcaption></figure><p id="6d53" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">这里预测标签(0或1)用置信度分数表示用户是否应该观看电影。</p><p id="8d52" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja"> 7。清理活动:</strong></p><p id="8109" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">为了避免产生任何费用，删除端点是一个好的实践，s3存储桶中的工件。</p><pre class="lg lh li lj gt mo mp mq mr aw ms bi"><span id="841d" class="mt mu iq mp b gy mv mw l mx my">sagemaker.Session().delete_endpoint(fm_predictor.endpoint)</span></pre><p id="fd2b" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">您还需要删除任何端点配置和端点。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nj"><img src="../Images/9787f3016bc0a4447bf8564d13b430ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mPE6NoTAJLSkcWKiDeEJ5w.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图13</figcaption></figure><p id="af96" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">删除任何创建的模型。</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/55eea1a5880be5f91bcebd6ac7a65200.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8XVJ7brQvGIL-rdAo79Z9g.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图14</figcaption></figure><p id="36aa" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">注意</strong>:停止任何正在运行的笔记本实例(如果需要，在终止后删除)</p><figure class="lg lh li lj gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nl"><img src="../Images/002fd570b63b845811fc05d940ff9f84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6rAN5EWTlEZjmqvG-nKkLQ.png"/></div></div><figcaption class="kd ke gj gh gi kf kg bd b be z dk translated">屏幕截图15</figcaption></figure><p id="3078" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">您还可以删除S3存储桶中的任何工件。</p><p id="ed93" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">你可以在这里找到完整的jupyter笔记本<a class="ae mk" href="https://github.com/anuragbisht12/AWS-SageMaker-Deployment/tree/master/Recommendation%20Engine" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="b784" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">希望你喜欢这篇文章，让我知道你的想法，如果你有任何疑问或建议，希望听到更多你的意见。如果你喜欢人工智能的旅程，请继续关注它，在未来的帖子中会很有趣。</p><p id="02e4" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">你可以关注我关于人工智能/机器学习、数据分析和商业智能的教程。你可以在<a class="ae mk" href="https://www.linkedin.com/in/anurag-bisht-39935a59/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上和我联系。</p><p id="e462" class="pw-post-body-paragraph kh ki iq kj b kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated"><strong class="kj ja">参考文献:</strong></p><ol class=""><li id="3e8d" class="lo lp iq kj b kk kl ko kp ks lq kw lr la ls le lt lu lv lw bi translated">亚马逊网络服务培训</li><li id="36c1" class="lo lp iq kj b kk mc ko md ks me kw mf la mg le lt lu lv lw bi translated">谷歌云培训</li><li id="78c1" class="lo lp iq kj b kk mc ko md ks me kw mf la mg le lt lu lv lw bi translated">算法<a class="ae mk" href="https://www.csie.ntu.edu.tw/~b97053/paper/Rendle2010FM.pdf" rel="noopener ugc nofollow" target="_blank">白皮书</a></li></ol></div></div>    
</body>
</html>