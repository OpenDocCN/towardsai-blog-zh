<html>
<head>
<title>Approximate Nearest Neighbors on Elastic Search with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Docker弹性搜索的近似最近邻</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/approximate-nearest-neighbors-on-elastic-search-with-docker-15342153f22a?source=collection_archive---------1-----------------------#2020-12-22">https://pub.towardsai.net/approximate-nearest-neighbors-on-elastic-search-with-docker-15342153f22a?source=collection_archive---------1-----------------------#2020-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="0974" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/data-science" rel="noopener ugc nofollow" target="_blank">数据科学</a></h2><div class=""/><div class=""><h2 id="ea83" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">将人工神经网络扩展到“大”数据量</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/2f1312d31cf0eaa56bd0dda41a7e3c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-X6SVBlHV6vjnQ_cDz6UTA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">HNSW人工神经网络在弹性搜索中的应用。图片作者。</figcaption></figure><p id="6130" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Docker容器对于大规模数据科学至关重要[ <a class="ae md" href="https://blogs.nvidia.com/blog/2020/09/03/what-is-mlops/" rel="noopener ugc nofollow" target="_blank">链接</a> ]。“大”数据上的近似最近邻(ann)也是如此！</p><blockquote class="me"><p id="bb4c" class="mf mg it bd mh mi mj mk ml mm mn mc dk translated">一切都必须在容器中运行</p></blockquote><p id="ffec" class="pw-post-body-paragraph lh li it lj b lk mo kd lm ln mp kg lp lq mq ls lt lu mr lw lx ly ms ma mb mc im bi translated">在选择最近邻或相似性搜索算法时，速度和准确性(或召回率)是最重要的两个考虑因素。在我的上一篇文章中，<a class="ae md" href="https://medium.com/towards-artificial-intelligence/knn-k-nearest-neighbors-is-dead-fc16507eb3e" rel="noopener"> KNN死了</a>，我已经证明了人工神经网络在相当的准确性上比KNN有巨大的(&gt;300倍)速度优势。我还讨论了如何在自己的数据集上选择最快、最准确的人工神经网络算法。</p><p id="162c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">然而，有时除了速度和准确性之外，您还需要扩展到大数据量的能力。在这些情况下，跨多台机器分发数据的便利性是第三个要考虑的因素。让我们在这篇文章中用神奇的<strong class="lj jd"><em class="mt">【OpenDistro】来解决这三个问题吧，弹性搜索</em> </strong> <a class="ae md" href="https://opendistro.github.io/for-elasticsearch/" rel="noopener ugc nofollow" target="_blank"> <strong class="lj jd"> <em class="mt">链接</em></strong></a><strong class="lj jd"><em class="mt"/></strong><em class="mt"/>。</p><h1 id="aa03" class="mu mv it bd mw mx my mz na nb nc nd ne ki nf kj ng kl nh km ni ko nj kp nk nl bi translated">为什么选择弹性搜索？</h1><p id="1ac1" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">对于阅读这篇文章的许多数据科学家来说，ES可能是一个陌生的概念，所以让我来介绍一下为什么它比您的it团队的典型用法更重要。</p><p id="6d01" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">ES是一个著名的搜索引擎数据库，它为维基百科的海量数据提供了搜索能力。它允许对来自Hadoop世界的人进行类似于Apache Solr的全文搜索。ES的分布式特性意味着它可以通过添加更多类似Hadoop的服务器/节点来处理大量数据。</p><p id="83b8" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">以下是数据科学家对弹性搜索感兴趣的三个原因。</p><ol class=""><li id="2f79" class="nr ns it lj b lk ll ln lo lq nt lu nu ly nv mc nw nx ny nz bi translated"><strong class="lj jd"> <em class="mt">可扩展ANN </em> </strong> : OpenDistro ES发行版已经将HNSW ANN算法实现为插件[ <a class="ae md" href="https://opendistro.github.io/for-elasticsearch/features/knn.html" rel="noopener ugc nofollow" target="_blank">链接</a> ]。ES的分布式特性使其能够将这种高速、高精度的HNSW人工神经网络搜索扩展到数百万条记录。</li><li id="fb0e" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated"><strong class="lj jd"> <em class="mt">支持</em> </strong>:大多数现代IT和基础设施团队已经熟悉(并且大量使用)ES。作为一名数据科学家，您可能希望IT基础架构团队设置和维护服务器硬件，因此使用他们已经熟悉的技术会增加您获得他们支持的机会。这种支持可以决定你的数据科学项目的成败，所以不要低估它！</li><li id="45aa" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated"><strong class="lj jd"> <em class="mt">更简单的堆栈</em> </strong> : ES可以作为数据库存储附加字段，然后可以和最近邻一起查询。例如，如果您使用产品名称嵌入搜索最近的邻居，您还可以获得产品价格、类别、添加日期等。只要您将它存储在ES中，您就可以在ANN搜索期间检索它。这简化了您的应用程序堆栈，因为您可以从一个位置获得您需要的所有信息，而不是从一个位置查询最近的邻居，然后访问另一个数据库来获得所有这些邻居的其他字段。</li></ol><h1 id="98b6" class="mu mv it bd mw mx my mz na nb nc nd ne ki nf kj ng kl nh km ni ko nj kp nk nl bi translated">安装OpenDistro ES(包括HNSW)</h1><p id="4192" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">使用Docker非常简单。我们将遵循官方文档[ <a class="ae md" href="https://opendistro.github.io/for-elasticsearch-docs/docs/install/docker/" rel="noopener ugc nofollow" target="_blank">链接</a> ]中的说明。</p><p id="990e" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jd"> <em class="mt">重要！</em> </strong>这个设置只是为了你在ES上实验HNSW ANN！对于生产设置，请要求您的IT基础架构团队设置必要的安全协议。</p><h2 id="f68e" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">单机</h2><ol class=""><li id="307d" class="nr ns it lj b lk nm ln nn lq oq lu or ly os mc nw nx ny nz bi translated">按照docker网站[ <a class="ae md" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">链接</a> ]上的说明，在您的机器上安装<code class="fe ot ou ov ow b">docker</code></li><li id="44e3" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">提取OpenDistro的docker映像:<code class="fe ot ou ov ow b">sudo docker pull amazon/opendistro-for-elasticsearch:1.12.0</code></li><li id="92f7" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">运行docker镜像:<code class="fe ot ou ov ow b">sudo docker run --rm -p 9200:9200 -p 9600:9600 -e "discovery.type=single-node" amazon/opendistro-for-elasticsearch:1.12.0</code></li></ol><p id="2c00" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">就是这样！现在，您可以与ES服务进行交互。</p><h2 id="5829" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">多台机器的集群</h2><p id="ece8" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">在您想要在集群中设置的每台机器 中运行以下步骤<strong class="lj jd"> <em class="mt">。<strong class="lj jd"> <em class="mt">再重要！</em> </strong>这只是实验性的，没有合适的安全协议不要在生产中使用。</em></strong></p><ol class=""><li id="fbd7" class="nr ns it lj b lk ll ln lo lq nt lu nu ly nv mc nw nx ny nz bi translated">按照docker网站[ <a class="ae md" href="https://docs.docker.com/engine/install/" rel="noopener ugc nofollow" target="_blank">链接</a> ]的说明，在每台机器上安装<code class="fe ot ou ov ow b">docker</code></li><li id="f961" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">在你的每台机器上提取OpenDistro的docker镜像:<code class="fe ot ou ov ow b">sudo docker pull amazon/opendistro-for-elasticsearch:1.12.0</code></li><li id="10a4" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">按照docker网站上的说明安装<code class="fe ot ou ov ow b">docker-compose</code></li><li id="0ea1" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">创建一个<code class="fe ot ou ov ow b">docker-compose.yml</code>文件</li><li id="64c5" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">创建一个<code class="fe ot ou ov ow b">elasticsearch.yml</code>文件</li><li id="d188" class="nr ns it lj b lk oa ln ob lq oc lu od ly oe mc nw nx ny nz bi translated">启动ES服务:<code class="fe ot ou ov ow b">sudo docker-compose up</code></li></ol><p id="9f1b" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">比如<code class="fe ot ou ov ow b">docker-compose.yml</code>和<code class="fe ot ou ov ow b">elasticsearch.yml</code>，看看我的<a class="ae md" href="https://github.com/stephenleo/adventures-with-ann/blob/main/ann_es_docker.ipynb" rel="noopener ugc nofollow" target="_blank"> Github库</a>。</p><p id="3952" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果您遇到任何错误，请尝试按照[ <a class="ae md" href="https://github.com/opendistro-for-elasticsearch/opendistro-build/issues/329" rel="noopener ugc nofollow" target="_blank">链接</a>:<code class="fe ot ou ov ow b">sudo sysctl -w vm.max_map_count=262144.</code>更新虚拟机映射计数</p><h2 id="24b4" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">检查ES状态</h2><p id="ba6f" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">在每台机器上完成上述步骤后，您可以使用<code class="fe ot ou ov ow b">curl -XGET &lt;ip_address_of_any_node&gt;:9200/_cat/nodes?v -u &lt;username&gt;:&lt;password&gt; —- insecure</code>来检查集群的状态。您应该会看到集群中的所有节点。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ox"><img src="../Images/d6a91c7f471c0b2da1a11ebb5a9593b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*egK0tij4SW65cXLmjErCKw.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">es集群中所有节点的示例。图片作者。</figcaption></figure><h1 id="7eea" class="mu mv it bd mw mx my mz na nb nc nd ne ki nf kj ng kl nh km ni ko nj kp nk nl bi translated">将专家系统用于人工神经网络</h1><h2 id="0b22" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">打开要加载到ES中的数据框架。</h2><p id="6a62" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">我们将使用在我之前的帖子<a class="ae md" href="https://medium.com/towards-artificial-intelligence/knn-k-nearest-neighbors-is-dead-fc16507eb3e" rel="noopener">中使用的相同的亚马逊500K产品数据集，KNN死了！</a></p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oy oz l"/></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/7f44f1e3ce45178d571e2f529e89a57e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*3rq1MJiG4nnjpTzAy4aEBQ.png"/></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">我们将加载到ES中的数据帧的头部。<a class="ae md" href="https://github.com/stephenleo/adventures-with-ann/blob/main/ann_es_docker.ipynb" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><h2 id="e906" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">使用HNSW创建ES索引</h2><p id="c28b" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">一旦你安装了OpenDistro ES，我们需要创建一个包含我们所有数据的ES索引。这可以通过使用Python请求库或者使用Python <a class="ae md" href="https://elasticsearch-py.readthedocs.io/en/7.10.0/" rel="noopener ugc nofollow" target="_blank"> ElasticSearch库</a> : <code class="fe ot ou ov ow b">pip install elasticsearch</code>来完成。在本文中，我将使用ElasticSearch库。</p><p id="fab4" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在这一步，我们需要指定HNSW参数<code class="fe ot ou ov ow b">ef_construction and M</code>作为ES索引设置的一部分。我们还需要指出是否使用<code class="fe ot ou ov ow b">l2 (euclidean) or cosinesimil (angular)</code>距离来寻找邻居。有些设置是[ <a class="ae md" href="https://medium.com/@kumon/how-to-realize-similarity-search-with-elasticsearch-3dd5641b9adb" rel="noopener"> Link </a> ]中的最佳实践</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="7a81" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">运行完上面的代码后，我们可以使用<code class="fe ot ou ov ow b">curl -XGET &lt;ip_address_of_any_node&gt;:9200/_cat/indices?v -u &lt;username&gt;:&lt;password&gt; —- insecure</code>来检查es集群上的可用索引</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pb"><img src="../Images/7ec1eb2cbe3d01ecb8337a4e7e44ad51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dP4-GJMabn3CiWuBDUGnbA.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">es集群中所有索引的示例。图片作者。</figcaption></figure><h2 id="35f2" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">上传数据</h2><p id="f64b" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">既然已经创建了索引，我们可以通过使用Python requests库或使用Python <a class="ae md" href="https://elasticsearch-py.readthedocs.io/en/7.10.0/" rel="noopener ugc nofollow" target="_blank"> ElasticSearch库</a>向它上传数据，如下所示。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oy oz l"/></div></figure><h2 id="bc29" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">查询最近邻居</h2><p id="308a" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">一旦我们将所有数据上传到ES索引中，我们就可以查询“K”个最近的邻居，以获得任何新的数据点，如下所示。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oy oz l"/></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pc"><img src="../Images/cc2febd6940610beb5b22337787f6769.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JwDl7qBjbV3zGaSbtUHFWw.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">ES中最近邻搜索的输出。<a class="ae md" href="https://github.com/stephenleo/adventures-with-ann/blob/main/ann_es_docker.ipynb" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="a3a2" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们仔细看看<code class="fe ot ou ov ow b">query_df</code>中某一排的邻居。它们都是同一部手机的手机壳，表明最近邻搜索有多好！</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oy oz l"/></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pd"><img src="../Images/0da52cf242aa68b6145e17c10ce7af10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jri0HI5a0-oXbmcS222FOg.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">所有邻居都是同一个手机的手机壳！<a class="ae md" href="https://github.com/stephenleo/adventures-with-ann/blob/main/ann_es_docker.ipynb" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><h2 id="66ef" class="of mv it bd mw og oh dn na oi oj dp ne lq ok ol ng lu om on ni ly oo op nk iz bi translated">删除ES索引</h2><p id="93f9" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">最后，在我们的实验完成之后(或者如果我们犯了一个错误，需要删除所有的东西来从头开始)，我们可以用下面的一行代码删除整个索引。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="oy oz l"/></div></figure></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><h1 id="3c37" class="mu mv it bd mw mx pl mz na nb pm nd ne ki pn kj ng kl po km ni ko pp kp nk nl bi translated">OpenDistro的HNSW与其他ES ANNs</h1><p id="ec28" class="pw-post-body-paragraph lh li it lj b lk nm kd lm ln nn kg lp lq no ls lt lu np lw lx ly nq ma mb mc im bi translated">OpenDistro ES现在可以在我在<a class="ae md" href="https://medium.com/towards-artificial-intelligence/how-to-choose-the-best-nearest-neighbors-algorithm-8d75d42b16ab" rel="noopener">如何选择最佳最近邻算法</a>中介绍的<a class="ae md" href="https://github.com/erikbern/ann-benchmarks" rel="noopener ugc nofollow" target="_blank"> ann-benchmarks </a>库中获得。OpenDistro的HNSW在可比较的召回率上比其他ES ANN算法快大约3倍，如下所示。尽管由于ES开销的原因，ES上的ANN在单核性能上无法与独立的ANN算法竞争，但对海量数据的可伸缩性使得OpenDistro ES的HNSW ANN插件值得考虑用于大型数据集！</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pq"><img src="../Images/41b9862bcd77180c95180bbbae9cf79d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VPPgZ_PKMbpH89MkamGx4g.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated"><a class="ae md" href="https://github.com/erikbern/ann-benchmarks" rel="noopener ugc nofollow" target="_blank">Ann-benchmarks</a>open distrok nn(HNSW)与其他弹性搜索Ann算法的比较。<a class="ae md" href="https://github.com/stephenleo/adventures-with-ann/blob/main/ann_es_docker.ipynb" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="a64b" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">感谢您的阅读！这篇文章中的所有代码都可以在我的<a class="ae md" href="https://github.com/stephenleo/adventures-with-ann/blob/main/ann_es_docker.ipynb" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中找到。</p><p id="d3ee" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">编辑1:更新了Github gists的代码片段</p></div></div>    
</body>
</html>