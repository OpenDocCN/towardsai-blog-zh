<html>
<head>
<title>Custom Vertex AI pipelines for beginners using Docker images[Part 2]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker图像为初学者定制顶点AI管道[第2部分]</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/devops-7f4c62f43eeb?source=collection_archive---------0-----------------------#2022-03-01">https://pub.towardsai.net/devops-7f4c62f43eeb?source=collection_archive---------0-----------------------#2022-03-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="1c6f" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">机器学习</h2><div class=""/><p id="ce2a" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">如何在Vertex AI上构建自定义Docker图像的分步教程</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/ed6e6b310e70cf6f4b58643b04dbec2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Wl3i9POPdBA20zbgtQeXw.jpeg"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">应用容器化。照片由来自Pexels 的Tom Fisk拍摄。</figcaption></figure><h2 id="0ff0" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">动机</h2><p id="ef93" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">在我的<a class="ae ln" href="https://medium.com/mlearning-ai/how-to-set-up-custom-vertex-ai-pipelines-step-by-step-467487f81cad" rel="noopener">上一篇文章</a>中，我已经讨论了如何使用Kubeflow组件在Vertex AI中实现自定义管道的过程。为了简单明了，我们讨论了一个常见的用例，叫做<strong class="kb jd"/><a class="ae ln" href="https://www.analyticsvidhya.com/blog/2021/04/wine-quality-prediction-using-machine-learning/" rel="noopener ugc nofollow" target="_blank"><strong class="kb jd"><em class="ml">预测葡萄酒质量</em> </strong> </a> <strong class="kb jd">。</strong></p><p id="e6b4" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">在这篇文章中，我将主要讨论docker图像的创建。目标是解释如何从头开始配置您的自定义docker映像。我们将继续创建Docker图像的步骤，然后是如何发布图像，以及如何在管道组件中使用图像。</p><h2 id="be28" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">背景术语</h2><p id="358c" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">在继续讨论之前，让我们澄清几个我们将要使用的术语。</p><p id="511c" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">那么docker是什么？Docker仅仅是一个开放的容器化平台，它将你的应用程序及其所有依赖项打包在一个容器中。它简化了开发和运行应用程序的过程。它帮助您轻松地从一个环境到另一个环境控制和运行您的应用程序。</p><p id="b8ce" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated"><a class="ae ln" href="https://cloud.google.com/build" rel="noopener ugc nofollow" target="_blank"> <strong class="kb jd">云构建</strong> </a>是谷歌官方云平台(GCP)映像构建器。它是一个完全托管的CI/CD平台，使您能够自动化您的构建。</p><p id="c6ba" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated"><a class="ae ln" href="https://cloud.google.com/artifact-registry" rel="noopener ugc nofollow" target="_blank"> <strong class="kb jd">工件注册表</strong> </a> <strong class="kb jd"> </strong>是一个完全自动化的包管理器，与大多数CI/CD工具集成。</p><h2 id="feb6" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">架构概述第2部分(重点关注蓝盒子)</h2><p id="d0cb" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">Docker映像的创建从Docker文件的创建开始。在Dockerfile准备好之后，我们使用GCP云构建来构建调用docker file的映像，并随后将其推送到工件注册表。一旦图像在工件注册表上可用，管道组件就可以使用该图像。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/2844bcd3b7830467608aa380d52b2b4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*Kae3ij4MK3mYDLvkblVlMA.png"/></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk translated">图片由作者提供。</figcaption></figure><h2 id="0007" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">环境设置</h2><p id="4c0a" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">要求:</p><ul class=""><li id="054e" class="mn mo it kb b kc kd kg kh kk mp ko mq ks mr kw ms mt mu mv bi translated">顶点人工智能工作台</li><li id="8492" class="mn mo it kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated">Python 3</li><li id="a5bc" class="mn mo it kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated">Kubeflow管道组件</li><li id="8471" class="mn mo it kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated">码头工人</li></ul><p id="6d3e" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">要安装Kubeflow组件、ai平台并导入所需的库，请参考我在<a class="ae ln" href="https://medium.com/mlearning-ai/how-to-set-up-custom-vertex-ai-pipelines-step-by-step-467487f81cad" rel="noopener">上一篇文章</a>中的环境设置部分。</p><h2 id="c798" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">创建用于培训的Docker图像</h2><h2 id="0f1d" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">1.DockerFile文件</h2><p id="f6be" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">在您的工作台上创建一个<em class="ml"> docker-train </em>目录来保存docker文件和所有需要的脚本。最后，它应该是这样的:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/61f218f39e7a017e6417d1cd50628f60.png" data-original-src="https://miro.medium.com/v2/resize:fit:328/format:webp/1*-EZLztj2n1khVtE3jz3IgA.png"/></div></figure><p id="67dd" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">每个docker映像创建都需要一个docker文件(一个文本文档),其中包含要构建的指令列表。事实上，在docker文件中，每条指令都在前一层之上创建一个新层。</p><p id="ad8b" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">重要的是要记住几个重要的说明:</p><ul class=""><li id="ed3e" class="mn mo it kb b kc kd kg kh kk mp ko mq ks mr kw ms mt mu mv bi translated">FROM:定义容器使用的基本图像。</li><li id="a910" class="mn mo it kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated">WORKDIR:指定容器的工作目录。</li><li id="eec9" class="mn mo it kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated">复制:将文件/目录从主机复制到docker容器。</li><li id="3a90" class="mn mo it kb b kc mw kg mx kk my ko mz ks na kw ms mt mu mv bi translated">RUN:允许在容器中执行命令。</li></ul><p id="7ce8" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">DockerFile总是以FROM命令开始，后面通常是一组指令。例如，在我们的例子中，WORKDIR指定了我们的应用程序将要使用的目录。我们可以使用复制指令将文件从本地文件复制或不复制到docker目录。在我们的例子中，我们将本地requirements.txt文件复制到app目录。我们使用RUN指令开始安装<em class="ml"> requirements.txt </em>文件中提到的Python库。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="265f" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">对于我们的例子，我们的<em class="ml"> requirements.txt </em>包含Pandas、NumPy和scikit-learn库。</p><pre class="ky kz la lb gt ne nf ng nh aw ni bi"><span id="1282" class="lo lp it nf b gy nj nk l nl nm">pandas==1.3.3<br/>numpy==1.19.5<br/>scikit-learn==0.24.2</span></pre><h2 id="bc07" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">2.码头工人建造</h2><p id="186a" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">一旦你的docker文件准备好了，我们需要构建它。检查本地<em class="ml"> docker-train </em>目录中是否有<em class="ml">docker file和</em>requirements . txt。脚本本身包含GCP环境的通用参数、映像的名称和构建映像的命令。要在本地生成docker映像，您需要通过键入<em class="ml">来构建它。工作台控制台中的/docker_build.sh </em>。请注意，为了能够跟踪GCP上的图像，我建议用Project_ID和地区来标记图像。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="91fb" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">3.将图像推送到工件注册表</h2><p id="8b63" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">首先，我们需要在工件注册中心为我们的应用程序创建一个存储库。我们必须提到存储库的格式，在我们的例子中是docker，以及区域。请注意，<em class="ml"> gcloud </em>需要在Docker注册表中注册。因此，我们使用<em class="ml">g cloud auth configure-docker</em>命令来确保<em class="ml"> gcloud </em>拥有正确的凭证。最后，我们使用<em class="ml"> docker-push </em>命令将本地docker映像推送到工件注册表中创建的存储库中。</p><p id="4f2e" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated"><strong class="kb jd">提醒</strong>使用您的GCP项目id更改所有文件中的项目ID。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="8c2e" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">不要忘记去GCP工件注册处检查你的图像是否可用。转到GCP的搜索选项卡:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/bfa2ba3c57435c986fb6ba0aa7bb2da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*U-lCHMoxmNxQYyqjCwJwuQ.png"/></div></figure><p id="1a24" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">点击工件注册表:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi no"><img src="../Images/dccc7469425cec2189ef1b555f2471bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*_71BktSDDQrgXyXE7PcxrQ.png"/></div></figure><p id="eb3d" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">如果是这样，我们可以使用它作为训练组件中的基础图像，如下所示:</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="4434" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated">为部署创建Docker映像</h2><p id="9edb" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">我们可以简单地使用之前创建的docker图像。否则，我们必须重复上述步骤，在所有脚本中将图像的名称从train修改为predict(即<em class="ml">IMAGE = sci kit-learn-wine quality-predict:latest)。最后，在<em class="ml"> requirements.txt文件中添加新的库。</em>在工件注册中心上有了映像之后，在您的部署组件上添加URL，并重新运行部署组件和管道。请提醒参考我用过的笔记本的<a class="ae ln" href="https://github.com/anabild/mlops/blob/main/notebook/ExampleWine.ipynb" rel="noopener ugc nofollow" target="_blank">。</a></em></p><p id="2315" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">要测试实时预测，请列出所有部署的模型。回想一下，每个管道和模型都有时间戳。列出最后部署的模型的端点id，并根据实例向量进行预测。默认预测支持实例矢量格式:[待预测特征列表]。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="c3d2" class="lo lp it bd lq lr ls dn lt lu lv dp lw kk lx ly lz ko ma mb mc ks md me mf iz bi translated"><strong class="ak">继续</strong></h2><p id="b65d" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">我们已经学习了如何在我们的本地工作台顶点AI上创建Docker图像，以及如何在我们的自定义顶点AI管道中使用它。</p><p id="2d51" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated">所有资源都可以在<a class="ae ln" href="https://github.com/anabild/mlops" rel="noopener ugc nofollow" target="_blank"> my GitHub </a>上找到。在我的下一篇文章中，我将向您展示如何使用Flask部署自定义预测服务。</p></div><div class="ab cl np nq hx nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="im in io ip iq"><h1 id="a79e" class="nw lp it bd lq nx ny nz lt oa ob oc lw od oe of lz og oh oi mc oj ok ol mf om bi translated">感谢您的阅读！</h1><p id="8e79" class="pw-post-body-paragraph jz ka it kb b kc mg ke kf kg mh ki kj kk mi km kn ko mj kq kr ks mk ku kv kw im bi translated">如果你想在收件箱里收到我未来的故事，别忘了订阅。</p><p id="b216" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated"><em class="ml">如果您喜欢阅读我的故事，并希望支持我成为一名作家，请考虑注册成为Medium会员，并获得数千篇数据工程和数据科学文章。</em></p><div class="on oo gp gr op oq"><a href="https://medium.com/@anna.bildea/membership" rel="noopener follow" target="_blank"><div class="or ab fo"><div class="os ab ot cl cj ou"><h2 class="bd jd gy z fp ov fr fs ow fu fw jc bi translated">用我的推荐链接加入媒体</h2><div class="ox l"><h3 class="bd b gy z fp ov fr fs ow fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oy l"><p class="bd b dl z fp ov fr fs ow fu fw dk translated">medium.com</p></div></div><div class="oz l"><div class="pa l pb pc pd oz pe lh oq"/></div></div></a></div><p id="a255" class="pw-post-body-paragraph jz ka it kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw im bi translated"><em class="ml">在</em><a class="ae ln" href="https://www.linkedin.com/in/ana-bildea-phd-2339b728/" rel="noopener ugc nofollow" target="_blank"><em class="ml">LinkedIn</em></a><em class="ml">和</em> <a class="ae ln" href="https://twitter.com/AnaBildea" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上找我！</p></div></div>    
</body>
</html>