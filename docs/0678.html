<html>
<head>
<title>Bitcoin Price Prediction with LSTM using Q Blocks (Part I)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Q块的LSTM比特币价格预测(上)</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/bitcoin-price-prediction-with-lstm-using-q-blocks-part-i-43322abf7556?source=collection_archive---------1-----------------------#2020-07-13">https://pub.towardsai.net/bitcoin-price-prediction-with-lstm-using-q-blocks-part-i-43322abf7556?source=collection_archive---------1-----------------------#2020-07-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="3dbf" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/machine-learning" rel="noopener ugc nofollow" target="_blank">机器学习</a>，递归神经网络</h2><div class=""/><div class=""><h2 id="f6d0" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">挖掘比特币数据。在我的<a class="ae kr" href="https://github.com/arditoibryan/Projects/tree/master/20200705_Bitcoin_Forecasting" rel="noopener ugc nofollow" target="_blank"> Github库</a>有完整的代码。</h2></div><p id="fece" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">比特币是一种非常特殊的资产。它的价格受需求和供给而非外部因素的影响，因此它可能高度依赖于感知的趋势而非感知的信息。对于这类问题，模式识别可能会证明非常有用。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/95af7001ece15ae85f29e9fdc51430d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tv7bj47S2QjNwJmPpjk_8Q.png"/></div></div></figure><h2 id="e5d0" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">第一部分(本文)</h2><p id="3290" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">因为这个问题很大，从头到尾，我就从文章的第一部分开始，通过挖掘比特币数据。</p><h2 id="c293" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">第二部分(下一条)</h2><p id="6665" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">在第二部分，我将建立LSTM来预测即将到来的比特币价格。因为运行代码所需的计算能力对于普通笔记本来说是不够的，所以我将从Q Blocks租用计算能力。在下一篇文章中，我将保留一个完整的部分，讲述如何使用对等分布式GPU连接到他们的笔记本电脑以提高性能。</p><h2 id="0e7d" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">第三部分</h2><p id="6ac9" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">在Q Blocks平台上运行所有东西之后，我将详细解释LSTM模型是如何工作的，并估计最终模型的准确性。</p><h2 id="11a2" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">导入库</h2><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="f91b" class="ma mb it my b gy nc nd l ne nf">import json<br/>import urllib.request<br/>import pandas as pd</span></pre><h2 id="ad5d" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">导入函数</h2><p id="9114" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">通过下面的函数，我将能够解码UTF-8数据并将数据分组为块(具体来说是几周)。现在，我不会进入细节，但随着进一步的代码将需要使用这两个主要功能。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="7674" class="ma mb it my b gy nc nd l ne nf">def group_chunks(df, id_loc, value_loc): #df, 0, 1<br/>  def average(list1):<br/>    sum1 = 0<br/>    for _ in list1:<br/>      sum1 += _<br/>    return sum1/len(list1)</span><span id="043c" class="ma mb it my b gy ng nd l ne nf">#convert DataFrame into a dict with a unique value per timestamp<br/>  mydict = {}<br/>  for x in range(len(df)):<br/>    currentid = df.iloc[x,id_loc]<br/>    currentvalue = df.iloc[x,value_loc]<br/>    mydict.setdefault(currentid, [])<br/>    mydict[currentid].append(currentvalue)<br/>  mydict</span><span id="2f79" class="ma mb it my b gy ng nd l ne nf">#convert dict into a list<br/>  dictlist = list()<br/>  for key, value in mydict.items():<br/>    temp = [key,value]<br/>    dictlist.append(temp)</span><span id="c3af" class="ma mb it my b gy ng nd l ne nf">#convert to DataFrame<br/>  dictlist = pd.DataFrame(dictlist)<br/>  dictlist</span><span id="d984" class="ma mb it my b gy ng nd l ne nf">#average of multiple values<br/>  dictlist[1] = dictlist[1].apply(lambda x : average(x))<br/>  return dictlist</span></pre><h2 id="40e5" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">指定初始周</h2><p id="f71e" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">在这段代码中，您唯一要做的手动干预就是指定何时开始计算周数。因为我正在下载最近5年的数据，所以我将2015年指定为初始日期。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="0b61" class="ma mb it my b gy nc nd l ne nf">#***cambiare questa per determinare inizio conteggio settimana<br/>benchmark_date = 2015</span><span id="b5f4" class="ma mb it my b gy ng nd l ne nf">import datetime<br/>def convert_week(date):<br/>  year = int(date[0:4])<br/>  return datetime.datetime.strptime(date, '%Y-%m-%d').isocalendar()[1] + (year-benchmark_date)*52<br/>convert_week('2018-01-01')<br/>convert_week('2019-01-01')</span><span id="ad1b" class="ma mb it my b gy ng nd l ne nf">def convert_week_back(week_n):<br/>  year_week = int(week_n/52)<br/>  year = benchmark_date + year_week<br/>  d = str(year)+'-W'+str(week_n%52)<br/>  r = datetime.datetime.strptime(d + '-1', "%Y-W%W-%w")<br/>  return r</span><span id="553a" class="ma mb it my b gy ng nd l ne nf">convert_week_back(129)</span></pre><h1 id="2274" class="nh mb it bd mc ni nj nk mf nl nm nn mi ki no kj ml kl np km mo ko nq kp mr nr bi translated">下载功能</h1><p id="a990" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">就我的经验而言，比特币数据很容易从互联网上获得，实际上有多种来源。问题是大部分数据必须手动下载，其余的只能通过使用API获得。</p><p id="f120" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">我将具体指导你如何构建一个连接到https://www.blockchain.com/<a class="ae kr" href="https://www.blockchain.com/" rel="noopener ugc nofollow" target="_blank">的函数来提取所有相关数据。</a></p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ns"><img src="../Images/350b474a97b050de2f556a54cec3d5b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M0J8QVJ6nqq9CHdki3VXzg.png"/></div></div><figcaption class="nt nu gj gh gi nv nw bd b be z dk translated">网站上可用数据的样本</figcaption></figure><p id="da45" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">* * *无需注册，数据可通过公开获取。json格式。因此，您不需要使用任何API令牌发出GET请求。</p><p id="9391" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">因为我不得不在不同的项目中使用这个算法，所以它比我们实际需要的更复杂。对于LSTM，我将只使用一个变量(市场价格)，而通过这个功能，您可以自动下载和解析blockchain.com上所有可用的图表。</p><h2 id="af60" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">正在下载JSON</h2><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="0a91" class="ma mb it my b gy nc nd l ne nf">def download_data(chart_name, data_=None, compress=True):<br/>  #<a class="ae kr" href="https://api.blockchain.info/charts/transactions-per-second?timespan=2years&amp;rollingAverage=8hours&amp;format=json" rel="noopener ugc nofollow" target="_blank">https://api.blockchain.info/charts/transactions-per-second?timespan=2years&amp;rollingAverage=8hours&amp;format=json</a></span><span id="a647" class="ma mb it my b gy ng nd l ne nf">if data_ is None:<br/>    with urllib.request.urlopen('<a class="ae kr" href="https://api.blockchain.info/charts/'" rel="noopener ugc nofollow" target="_blank">https://api.blockchain.info/charts/'</a> + chart_name + '?timespan=5years&amp;rollingAverage=24hours&amp;format=json') as url:</span></pre><h2 id="4329" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">解析JSON</h2><p id="fb37" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">我将使用JSON库将其转换为字典。然后，我将把字典中的每个元素存储到熊猫数据帧中。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="170c" class="ma mb it my b gy nc nd l ne nf">      response = url.read()<br/>      data = json.loads(response)<br/>  else:<br/>    data = open(data_)<br/>    data = json.load(data)<br/>  <br/>  import pandas as pd<br/>  data = pd.DataFrame(data)<br/>  data</span></pre><p id="6210" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">转换成熊猫数据集后，结果如下:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nx"><img src="../Images/73649b0a5117cc5e30f9e4262146cf39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8EOpZyykkrhtuyPc-qBB9A.png"/></div></div></figure><h2 id="f34d" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">提取时间和值</h2><p id="2ddf" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">数据是UTF 8编码的。我需要解码它，提取时间戳和市场价格(或我们从网站下载的任何其他值)。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="e95f" class="ma mb it my b gy nc nd l ne nf">#make backup<br/>  data_copy = data.copy()</span><span id="ccba" class="ma mb it my b gy ng nd l ne nf">def extract_time(dict1):<br/>    dict2 = list(dict1.values())<br/>    #dict2 = list(data['values'][0].values())[0],<br/>    return dict2</span><span id="a31d" class="ma mb it my b gy ng nd l ne nf">def time_converter(time1):<br/>    from datetime import datetime<br/>    #return datetime.fromtimestamp(time1).strftime('%Y-%m-%d %H:%M:%S')<br/>    return datetime.fromtimestamp(time1).strftime('%Y-%m-%d')</span><span id="c3b3" class="ma mb it my b gy ng nd l ne nf">#preprocessing data<br/>  data = data_copy.copy()<br/>  data['timestamp'] = data['values'].apply(lambda x : extract_time(x)[0])<br/>  data['timestamp'] = data['timestamp'].apply(lambda x : time_converter(x))<br/>  data[chart_name] = data['values'].apply(lambda x : extract_time(x)[1])<br/>  data.pop('values')<br/>  data</span><span id="5a80" class="ma mb it my b gy ng nd l ne nf">df = data.drop(['status', 'name', 'unit', 'period', 'description'], axis=1)<br/>  df</span></pre><p id="7eaf" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">到目前为止，该功能将允许我每天提取数据。但是，如果我想进一步推进并按周分组，我需要取这段时间内数据的平均值，以获得有效的指标。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="1506" class="ma mb it my b gy nc nd l ne nf">if compress == True:<br/>    #group by date<br/>    df = group_chunks(df, 0, 1)<br/>    #df = df.drop(df.index[[730]])<br/>    df</span><span id="2a7f" class="ma mb it my b gy ng nd l ne nf">#apply weeks<br/>    df['week'] = df[0].apply(lambda x : convert_week(x))<br/>    df.pop(0)<br/>    df</span><span id="a723" class="ma mb it my b gy ng nd l ne nf">#group by week<br/>    df = group_chunks(df, 1, 0)<br/>    df</span><span id="43d2" class="ma mb it my b gy ng nd l ne nf">return df</span></pre><h1 id="f25f" class="nh mb it bd mc ni nj nk mf nl nm nn mi ki no kj ml kl np km mo ko nq kp mr nr bi translated">下载</h1><p id="d2e3" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">如您所见，根据您希望获得的输出，您可以使用多个参数。</p><h2 id="b10a" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">按天分组的数据</h2><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="7996" class="ma mb it my b gy nc nd l ne nf">market_cap = download_data('market-cap', compress=False)<br/>market_cap.columns = ['day', 'market_cap']<br/>market_cap</span></pre><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/def6a955634424ceb2588b6e2e5d5f0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*pMjir5Ac7fjvMi0WWRqIbQ.png"/></div></figure><h2 id="d1ad" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">按周分组的数据</h2><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="c19f" class="ma mb it my b gy nc nd l ne nf">#download data compressed by week<br/>market_cap = download_data('market-cap')</span></pre><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/f22b6d4f6f4bd2e6efab38afa372524c.png" data-original-src="https://miro.medium.com/v2/resize:fit:484/format:webp/1*fd9q4bVnY26UHpE2ZuO41Q.png"/></div></figure><h2 id="5b98" class="ma mb it bd mc md me dn mf mg mh dp mi lb mj mk ml lf mm mn mo lj mp mq mr iz bi translated">来自下载的JSON的数据</h2><p id="1578" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">不幸的是，我在网站上发现了一些缺失的图表。每美元的交易费用就是一个例子。如果您希望下载类似的数据，您可以直接(但手动)下载son文件:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/4217bbd7527c7e7038d90e852963c703.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*lH1Mr7p70-ZDLLEntj6y1A.png"/></div></figure><p id="4277" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">将数据导入笔记本时，使用以下设置提取数据，而不执行GET请求。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="91ba" class="ma mb it my b gy nc nd l ne nf">#importing data by json, then compressing<br/>#transaction_fees = download_data('transaction-fees-usd') #url not working<br/>transaction_fees = download_data(0, data_='/content/drive/My Drive/Colab Notebooks/Projects_Work/20200617_Bitcoin/fees-usd-per-transaction.json')<br/>transaction_fees.columns = ['week', 'transaction_fees']<br/>transaction_fees</span></pre><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/262324d9a0658832305762c60d2191e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*Sj_4C5tZIqNp-ysEE0XK0g.png"/></div></figure><p id="f483" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">因为周会从2015年开始算，而且我下载了更早的数据，所以周会是负数。如果您希望放弃，可以删除周为负数的行。</p><h1 id="71b9" class="nh mb it bd mc ni nj nk mf nl nm nn mi ki no kj ml kl np km mo ko nq kp mr nr bi translated">合并数据集</h1><p id="b929" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">就我而言，我已经下载了几个不同的数据块。我需要将它们合并在一起。我将使用周作为一个公共因子，这样我就可以对它们进行分组。</p><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="ab8c" class="ma mb it my b gy nc nd l ne nf">#tps, market_cap, total_bitcoins, market_price<br/>result = pd.merge(tps, market_cap, on=0)<br/>result = pd.merge(result, total_bitcoins, on=0)<br/>result = pd.merge(result, market_price, on=0)<br/>result = pd.merge(result, miners_revenue, on=0)<br/>result = pd.merge(result, transaction_fees, on=0)<br/>result</span><span id="f9d5" class="ma mb it my b gy ng nd l ne nf">result.columns = ['week', 'tps', 'market_cap', 'total_bitcoins', 'market_price', 'miners_revenue', 'transaction_fees']<br/>result</span></pre><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi oc"><img src="../Images/b9ed61a5c6734b68c3067bd5612660e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hPykfXK680R9PMvPWZAZLA.png"/></div></div></figure><h1 id="f15e" class="nh mb it bd mc ni nj nk mf nl nm nn mi ki no kj ml kl np km mo ko nq kp mr nr bi translated">导出数据</h1><pre class="lp lq lr ls gt mx my mz na aw nb bi"><span id="2d0d" class="ma mb it my b gy nc nd l ne nf">market_price.to_csv('bitcoin.csv')</span></pre><h1 id="979b" class="nh mb it bd mc ni nj nk mf nl nm nn mi ki no kj ml kl np km mo ko nq kp mr nr bi translated">第二部分</h1><p id="a4cb" class="pw-post-body-paragraph ks kt it ku b kv ms kd kx ky mt kg la lb mu ld le lf mv lh li lj mw ll lm ln im bi translated">我们都为第二部分做好了准备…</p><p id="ae34" class="pw-post-body-paragraph ks kt it ku b kv kw kd kx ky kz kg la lb lc ld le lf lg lh li lj lk ll lm ln im bi translated">-&gt;转到第二部分(在建)</p></div></div>    
</body>
</html>