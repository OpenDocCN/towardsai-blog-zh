<html>
<head>
<title>How to Resample Data by Group In Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Pandas中按组重采样数据</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-resample-data-by-group-in-pandas-ca9063fe8961?source=collection_archive---------2-----------------------#2021-04-06">https://pub.towardsai.net/how-to-resample-data-by-group-in-pandas-ca9063fe8961?source=collection_archive---------2-----------------------#2021-04-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="9c69" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/data-science" rel="noopener ugc nofollow" target="_blank">数据科学</a></h2><div class=""/><div class=""><h2 id="880a" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">一个伟大的工具来消除一个因素的影响</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/2a32b868ad011dd51ea01c94a28f155d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GdGRhBthQjy8hCXV.jpg"/></div></div></figure><p id="2133" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">有时候，当我们在进行机器学习项目时，有一些因素会对性能产生巨大的影响，并且它们是不可管理或结构化的。一个解决方案是通过基于我们想要标准化的因子进行采样来消除它们在我们的数据中的影响。</p><p id="4c3d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们为我们的数据创建数据:</p><p id="6c36" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">假设我们有一个名为“活动”的因素，包含以下几个组:</p><ul class=""><li id="5d90" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly me mf mg mh bi translated">活动1: <strong class="lf jd">智能手机</strong>相关</li><li id="3794" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">战役二:<strong class="lf jd">摄像机</strong>相关</li><li id="48f9" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">战役3: <strong class="lf jd">电脑</strong>相关</li></ul><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="3a34" class="ms mt it mo b gy mu mv l mw mx">import pandas as pd<br/>import numpy as np<br/>import statsmodels.formula.api as smf<br/>import plotly.express as px<br/> <br/>Smartphone = pd.DataFrame(<br/>    {<br/>        "Gender": np.random.choice(["m", "f"], 200, p=[0.6, 0.4]),<br/>        "Age": np.random.choice(["[&lt;30]", "[30-65]", "[65 ]"], 200, p=[0.3, 0.6, 0.1]),<br/>        "Add_Color": np.random.choice(["Blue", "Red"], 200, p=[0.6, 0.4]),<br/>        "Campaign": ["Smartphone"] * 200,<br/>        "Click": np.random.binomial(1, size=200, p=0.6),<br/>    }<br/>)<br/> <br/> <br/>Camera = pd.DataFrame(<br/>    {<br/>        "Gender": np.random.choice(["m", "f"], 200, p=[0.6, 0.4]),<br/>        "Age": np.random.choice(["[&lt;30]", "[30-65]", "[65 ]"], 200, p=[0.3, 0.6, 0.1]),<br/>        "Add_Color": np.random.choice(["Blue", "Red"], 200, p=[0.3, 0.7]),<br/>        "Campaign": ["Camera"] * 200,<br/>        "Click": np.random.binomial(1, size=200, p=0.2),<br/>    }<br/>)<br/> <br/>Computer = pd.DataFrame(<br/>    {<br/>        "Gender": np.random.choice(["m", "f"], 200, p=[0.6, 0.4]),<br/>        "Age": np.random.choice(["[&lt;30]", "[30-65]", "[65 ]"], 200, p=[0.3, 0.6, 0.1]),<br/>        "Add_Color": np.random.choice(["Blue", "Red"], 200, p=[0.25, 0.75]),<br/>        "Campaign": ["Computer"] * 200,<br/>        "Click": np.random.binomial(1, size=200, p=0.25),<br/>    }<br/>)<br/> <br/>df=pd.concat([Smartphone,Camera,Computer])<br/> <br/>df.sample(10)</span><span id="b839" class="ms mt it mo b gy my mv l mw mx">Gender      Age Add_Color    Campaign  Click<br/>115      m    [&lt;30]       Red  Smartphone      1<br/>12       m  [30-65]       Red    Computer      0<br/>112      m  [30-65]       Red    Computer      0<br/>148      m    [&lt;30]       Red    Computer      1<br/>127      m    [&lt;30]      Blue    Computer      0<br/>83       f    [&lt;30]       Red  Smartphone      1<br/>168      f  [30-65]       Red    Computer      0<br/>80       f  [30-65]       Red    Computer      0<br/>25       m    [&lt;30]       Red      Camera      0<br/>11       f  [30-65]       Red  Smartphone      0</span></pre><p id="809f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">下面我们可以看到，每个组都有不同的点击率。如果我们想在我们的模型中使用这个特性，这是可以的。然而，如果我们不能使用它(也许因为将来我们可能会有不同的活动，我们想建立一个通用的模型)，我们必须以某种方式消除这种影响，否则我们将得到一个有偏见的模型。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="e4f6" class="ms mt it mo b gy mu mv l mw mx">print(df.groupby('Campaign').mean())</span><span id="95ef" class="ms mt it mo b gy my mv l mw mx">Click<br/>Campaign         <br/>Camera       0.21<br/>Computer     0.22<br/>Smartphone   0.59</span></pre><p id="33fc" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们想要实现的是对每个组进行重新采样，以获得相等的点击率。</p><h1 id="4efc" class="mz mt it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated">按组重新采样数据</h1><p id="320b" class="pw-post-body-paragraph ld le it lf b lg nq kd li lj nr kg ll lm ns lo lp lq nt ls lt lu nu lw lx ly im bi translated">在我们的例子中，我们正在处理点击。所以，我们有两个类，<strong class="lf jd"> 0 </strong>和<strong class="lf jd"> 1 </strong>。我们想要实现的是每一个活动都有相同的数量，所以点击率将是0.5。我们将使用熊猫函数<strong class="lf jd">示例</strong>。基本上，它所做的是给定一个数据帧和一个数字，它用这个数字得到等量的随机行，没有<strong class="lf jd">替换。</strong></p><p id="dab7" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">这里棘手的部分是，我们必须为每个活动定义少数群体和多数群体类别，因为正如我们所见，智能手机活动的少数群体类别是类别<strong class="lf jd"> 0 </strong>而电脑和相机的少数群体是<strong class="lf jd"> 1 </strong>。</p><pre class="ks kt ku kv gt mn mo mp mq aw mr bi"><span id="d337" class="ms mt it mo b gy mu mv l mw mx">#get the unique campaigns<br/>campaigns=df.Campaign.unique()<br/> <br/> <br/>sampled=pd.DataFrame()<br/>for i in campaigns:<br/>    print(i)<br/>    #keep the campaign we want to sample<br/>    z=df.query(f'Campaign=="{i}"')<br/>     <br/>    A=z[z['Click']==0][['Click']]<br/>    B=z[z['Click']==1][['Click']]<br/> <br/>    #find out which is the Minority and Majority<br/>    if len(A)&gt;len(B):<br/>        majority=A<br/>        minority=B<br/>    else:<br/>        majority=B<br/>        minority=A<br/>         <br/>    #Sampling<br/>    indexes=majority.sample(len(minority),random_state=7).index<br/>    #what we did here is to get the indexes that are NOT in the sampling above<br/>    #so we can remove them in the following steps from our dataframe z<br/>    indexes=majority.loc[~majority.index.isin(indexes)].index<br/>     <br/>     <br/>    z=z.loc[~z.index.isin(indexes)]<br/>    sampled=pd.concat([sampled,z])<br/> <br/> <br/>sampled.groupby('Campaign').mean()</span><span id="0b0b" class="ms mt it mo b gy my mv l mw mx">Click<br/>Campaign         <br/>Camera        0.5<br/>Computer      0.5<br/>Smartphone    0.5</span></pre><h1 id="cb76" class="mz mt it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated">结束语</h1><p id="4913" class="pw-post-body-paragraph ld le it lf b lg nq kd li lj nr kg ll lm ns lo lp lq nt ls lt lu nu lw lx ly im bi translated">我们丢失了一些数据，但我们正在生成更有意义的数据用于我们的模型。这不是处理此类问题的唯一方法，而是我们正在使用的一种简单解决方案。有偏差的数据是机器学习中最常见的问题之一，可能会导致重大问题，所以这是一个添加到您的工具集中的好工具。</p></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="429e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated"><em class="oc">原载于【https://predictivehacks.com】<a class="ae od" href="https://predictivehacks.com/how-to-resample-data-by-group-in-pandas/" rel="noopener ugc nofollow" target="_blank"><em class="oc"/></a><em class="oc">。</em></em></p></div></div>    
</body>
</html>