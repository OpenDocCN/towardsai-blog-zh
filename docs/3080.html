<html>
<head>
<title>How to use TorchMetrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用火炬计</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/improve-your-model-validation-with-torchmetrics-b457d3954dcd?source=collection_archive---------3-----------------------#2022-08-30">https://pub.towardsai.net/improve-your-model-validation-with-torchmetrics-b457d3954dcd?source=collection_archive---------3-----------------------#2022-08-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7c21" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">PyTorch或PyTorch Lightning火炬矩阵使用指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b35ccc19880c60effbe0f1154ad9bb37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V1I-AXu5Nc5APvSGefSsiA.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com//?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1186496" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/thomaswolter-92511/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1186496" rel="noopener ugc nofollow" target="_blank">托马斯·沃尔特</a></figcaption></figure><p id="88ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">良好培训的一个关键部分是正确管理验证指标。这是为了监控模型的哪个状态执行得最好所必需的。不同的任务需要不同的度量来评估模型的准确性，实现它们通常需要编写样板代码。<a class="ae ky" href="https://torchmetrics.readthedocs.io" rel="noopener ugc nofollow" target="_blank"> TorchMetrics </a>通过提供一种模块化方法来定义和跟踪所有评估指标，解决了这个问题。</p><h2 id="1066" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated"><strong class="ak">目录</strong></h2><ol class=""><li id="b8c2" class="mo mp it lb b lc mq lf mr li ms lm mt lq mu lu mv mw mx my bi translated">度量类如何工作</li><li id="c2f2" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">什么是度量集合</li><li id="d454" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">如何实现自定义指标</li><li id="286c" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">使用火炬和PyTorch闪电</li></ol><p id="982f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要从PyPI安装最新版本的TorchMetrics，请使用:</p><pre class="kj kk kl km gt ne nf ng bn nh ni bi"><span id="a934" class="nj lw it nf b be nk nl l nm nn">pip install torchmetrics</span></pre></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="dcbd" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">1.度量类如何工作</h1><p id="ea31" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li og lk ll lm oh lo lp lq oi ls lt lu im bi translated">TorchMetrics提供了许多现成的<a class="ae ky" href="https://torchmetrics.readthedocs.io/en/stable/all-metrics.html" rel="noopener ugc nofollow" target="_blank">指标</a>，如<em class="oj">准确度</em>、骰子、<em class="oj"> F1分数</em>、召回、<em class="oj">平均绝对误差、</em>等等。它们都继承自<code class="fe ok ol om nf b">Metric</code>，这是每个指标的父类:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/d88e08ab7944dfca14cf1b48e38ecd8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*UVviOj-HsqThiozE6EjKTg.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">度量类的主要方法。使用<a class="ae ky" href="https://www.diagrams.net/" rel="noopener ugc nofollow" target="_blank">图</a>生成的图像。</figcaption></figure><p id="9055" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在使用指标之前，必须对其进行实例化。之后，对于从dataloader中读取的每个批处理，目标和预测都被传递给metric对象。然后，它计算当前批处理的度量结果，并将其保存在其内部状态中，该状态跟踪到目前为止看到的数据。当批处理完成时，可以从度量对象中提取最终结果。</p><p id="901b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个指标都从<code class="fe ok ol om nf b">Metric</code>类继承了以下方法:</p><ul class=""><li id="79f2" class="mo mp it lb b lc ld lf lg li oo lm op lq oq lu or mw mx my bi translated"><code class="fe ok ol om nf b">metric.forward(preds, target)</code> —使用<code class="fe ok ol om nf b">preds</code>和<code class="fe ok ol om nf b">target</code>计算度量，它们是当前批次的预测和目标。然后，它更新度量状态并返回度量结果。作为一种快捷方式，可以使用<code class="fe ok ol om nf b">metric(preds, target)</code>，这两种语法没有区别。</li><li id="2fdf" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu or mw mx my bi translated"><code class="fe ok ol om nf b"><em class="oj">metric.update(preds, target)</em></code> —与forward相同，但不返回效率的度量结果。如果不需要记录或打印每个批次的指标结果，这是应该使用的方法，因为它更快。</li><li id="1f93" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu or mw mx my bi translated"><code class="fe ok ol om nf b"><em class="oj">metric.compute()</em></code> —返回到目前为止所有数据的计算结果。应该在所有批处理结束后调用它。</li><li id="e79a" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu or mw mx my bi translated"><code class="fe ok ol om nf b">metric.reset()</code> —清除度量状态。必须在每个验证阶段结束时调用它。</li></ul><p id="5ea2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">总结:</strong></p><ol class=""><li id="bd63" class="mo mp it lb b lc ld lf lg li oo lm op lq oq lu mv mw mx my bi translated">对于每一批，调用<code class="fe ok ol om nf b">forward</code>或<code class="fe ok ol om nf b">update</code>。</li><li id="0965" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">在验证加载器循环之外，调用<code class="fe ok ol om nf b">compute</code>获得最终结果。</li><li id="7578" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">最后调用<code class="fe ok ol om nf b">reset</code>清除度量状态。</li></ol><p id="c45f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下代码显示了完整的过程:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="7492" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果不需要打印批次指标，只需将第<em class="oj">行12 </em>替换为<code class="fe ok ol om nf b">metric.update(preds, target)</code>(并删除第<em class="oj">行13) </em>。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="d6a2" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">2.什么是公制集合？</h1><p id="2dd7" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li og lk ll lm oh lo lp lq oi ls lt lu im bi translated">在上面的例子中，验证只使用一个指标，但是大多数验证可能会使用多个指标。TorchMetrics提供了<code class="fe ok ol om nf b">MetricsCollection</code>，它将一个度量列表或字典包装到一个可调用的度量类中，该类具有与任何其他度量相同的接口(复合模式)。这种方式从集合中调用一次<code class="fe ok ol om nf b">forward</code>、<code class="fe ok ol om nf b">update</code>、<code class="fe ok ol om nf b">compute</code>和<code class="fe ok ol om nf b">reset</code>，而不是针对每个指标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/c3daac66734fdf676228a2078bd80906.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*xhsn6hQ_1rh82WHa8BEQng.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">公制集合。使用<a class="ae ky" href="https://www.diagrams.net/" rel="noopener ugc nofollow" target="_blank">图</a>生成的图像。</figcaption></figure><p id="9508" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码显示了<code class="fe ok ol om nf b">MetricCollection</code>是如何工作的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="04c0" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">3.如何实现自定义指标</h1><p id="3213" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li og lk ll lm oh lo lp lq oi ls lt lu im bi translated">尽管TorchMetrics为不同的任务提供了广泛的度量标准，但是可能有必要实现自定义的度量标准。要实现一个指标，创建一个从<code class="fe ok ol om nf b">Metric</code>继承的类。然后您应该扩展<code class="fe ok ol om nf b">__init__</code>方法并覆盖<code class="fe ok ol om nf b">update</code>和<code class="fe ok ol om nf b">compute</code>方法:</p><ol class=""><li id="5112" class="mo mp it lb b lc ld lf lg li oo lm op lq oq lu mv mw mx my bi translated"><code class="fe ok ol om nf b">__init__()</code>是每次创建对象时调用的方法。在其中，通过使用方法<code class="fe ok ol om nf b">self.add_state(state_name, default)</code>，添加所需的内部状态:<code class="fe ok ol om nf b">state_name</code>是您选择的字符串，<code class="fe ok ol om nf b">default</code>是初始值(以及复位后的值<em class="oj"> ) </em>。</li><li id="e5d6" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">在<code class="fe ok ol om nf b">update(preds, target)</code>方法中，使用<code class="fe ok ol om nf b">preds</code>和<code class="fe ok ol om nf b">target</code>更新状态。</li><li id="95a3" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated"><code class="fe ok ol om nf b">compute()</code>方法必须使用状态值返回最终结果。</li></ol><p id="5601" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，准确性是返回预测和目标之间相同元素的百分比的度量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/47bc716f811aa2db4acdadfc50f5d3af.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/format:webp/1*W4UaFVjXLQxyAi5zig6LGw.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">自定义指标。使用<a class="ae ky" href="https://www.diagrams.net/" rel="noopener ugc nofollow" target="_blank">图</a>生成的图像。</figcaption></figure><p id="bca3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从头开始实施该指标的步骤是:</p><ol class=""><li id="07dc" class="mo mp it lb b lc ld lf lg li oo lm op lq oq lu mv mw mx my bi translated">创建一个状态<code class="fe ok ol om nf b">total</code>来记忆总值。</li><li id="aa64" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">创建一个状态<code class="fe ok ol om nf b">corrects</code>来记忆与目标值相等的值。</li><li id="c767" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated"><code class="fe ok ol om nf b"><em class="oj">update(preds, target)</em></code>必须用值的数量增加<code class="fe ok ol om nf b">total</code>状态，用来自<code class="fe ok ol om nf b">preds</code>的值的数量增加<code class="fe ok ol om nf b">correct</code>状态，其值等于<code class="fe ok ol om nf b">target</code>。</li><li id="66b3" class="mo mp it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated"><code class="fe ok ol om nf b">compute()</code>返回<code class="fe ok ol om nf b">corrects</code>除以<code class="fe ok ol om nf b">total</code>再乘以<em class="oj"> 100 </em>。</li></ol><p id="22a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是完整的实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="bbf4" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">4.使用火炬和PyTorch闪电</h1><p id="581e" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li og lk ll lm oh lo lp lq oi ls lt lu im bi translated">TorchMetrics是PyTorch Lightning的一个很好的组合，可以进一步减少样板代码。如果您从未听说过PyTorch Lightning，它是一个简化模型编码的框架。更多信息，请参考<a class="ae ky" href="https://www.pytorchlightning.ai/" rel="noopener ugc nofollow" target="_blank">他们的网站</a>。如果你不用PyTorch Lightning，直接跳过这一节。</p><p id="01b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过PL方法<code class="fe ok ol om nf b">self.log_dict(collection, on_step, on_epoch)</code>可以记录度量收集对象。通过记录度量对象，PyTorch Lightning负责计算或重置度量的时间。 <br/>设置<code class="fe ok ol om nf b">on_step=True</code>记录每个批次的指标。设置<code class="fe ok ol om nf b">on_epoch=True</code>记录纪元指标(因此，所有批次的计算结果)。如果它们都被设置为<em class="oj">真</em>，则步长度量和时元度量都被记录。有关PyTorch闪电测井的更多信息，请查看他们的文档。</p><p id="65d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下代码显示了使用TorchMetrics处理指标的PyTorch Lightning模块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="4e96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过这种方式，在培训阶段，将为每批记录指标。而在验证阶段，步骤度量被累积以仅记录在时期结束时的最终度量。在这种情况下，<code class="fe ok ol om nf b">compute</code>和<code class="fe ok ol om nf b">reset</code>方法不会被调用，因为PyTorch Lightning会自己处理它们。</p><p id="c827" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在每次验证结束时打印指标，必须添加这段代码:</p><pre class="kj kk kl km gt ne nf ov ow aw ox bi"><span id="bfae" class="lv lw it nf b gy oy oz l pa nn">def validation_epoch_end(self, outputs):<br/>    results = metric_collection.compute()<br/>    print(results)<br/>    self.metric_collection.reset()</span></pre><p id="129b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是在大多数情况下，记录指标就足够了。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="7c4b" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">结束语</h1><p id="38d4" class="pw-post-body-paragraph kz la it lb b lc mq ju le lf mr jx lh li og lk ll lm oh lo lp lq oi ls lt lu im bi translated">你已经发现了火炬之力。我认为这个库是管理度量的一种非常干净的方式，并且显著地提高了代码的质量。更多信息，请查看<a class="ae ky" href="https://torchmetrics.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">的文档</a>。</p><p id="9bc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读，我希望你发现这是有用的。</p><p id="a8ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oj">如果你喜欢读我的故事，并且想支持我成为一名作家，考虑注册成为一名灵媒会员。每月5美元，你可以无限制地阅读所有的故事。如果你用我的链接注册，我会赚一点佣金，你也一样。</em><a class="ae ky" href="https://mattiagatti.medium.com/membership" rel="noopener">https://mattiagatti.medium.com/membership</a></p></div></div>    
</body>
</html>