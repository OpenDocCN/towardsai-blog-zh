<html>
<head>
<title>Survival Analysis: Produce a Single Time-to-Event Prediction from Survival Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生存分析:从生存函数中产生单一的事件时间预测</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/survival-analysis-produce-a-single-time-to-event-prediction-from-survival-functions-581d31dd625f?source=collection_archive---------1-----------------------#2022-08-08">https://pub.towardsai.net/survival-analysis-produce-a-single-time-to-event-prediction-from-survival-functions-581d31dd625f?source=collection_archive---------1-----------------------#2022-08-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5eeda4c1c65ef9fae19cd2805dd51958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bpWDG9O7wS2-rfL5LAHzUw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">照片由<a class="ae kc" href="https://unsplash.com/@merittthomas" rel="noopener ugc nofollow" target="_blank">merit Thomas</a>在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="199d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生存分析是一系列用于分析事件时间数据的统计方法。传统上，这种技术用于健康和保险领域，其中感兴趣的事件是死亡、再次住院和类似的病态事件。然而，生存分析可以应用于任何时间段的建模，比如一个人找到工作、一个系统失败或一个客户流失所需的时间。</p><p id="7489" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生存分析的独特之处在于其处理删失数据的能力，也就是说，对于某些受试者来说，事件发生时间的信息没有完全公开。发生这种情况有不同的原因。例如，受试者可能在研究终止前退出，或者试验在某些受试者感兴趣的事件发生前结束。</p><p id="6fcd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用不同的生存分析技术会产生一个或多个生存函数。生存函数描述了受试者或群体在过去时间t内生存的概率。在这种情况下，“生存”意味着避免感兴趣的事件。总存活时间或寿命是指“出生”(试验开始)和“死亡”(感兴趣的事件发生时)之间的时间段。自然地，函数是单调非递增的，因为随着时间的推移，生存的可能性越来越小。</p><p id="b296" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一个生存函数，例如:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="d0b4" class="lk ll iq lg b gy lm ln l lo lp">import pandas as pd<br/><br/>pd.DataFrame({'t': [1, 2, 5, 7, 9, 10, 12, 13], 'S(t)': [98, 95, 90, 80, 60, 50, 40, 0]}).set_index('t')</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi lq"><img src="../Images/523d78113817a5d985510babe8db382b.png" data-original-src="https://miro.medium.com/v2/resize:fit:198/format:webp/1*IKmrHBjiOfixtt4aEjDtUQ.png"/></div></figure><p id="7290" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据这个生存函数，有90%的可能性感兴趣的事件在时间5之前不会发生。</p><p id="7075" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">存活函数对于比较几个组的存活时间和描述附加变量对存活时间的影响也是有用的。这是一个保存大量信息的强大功能，但有时，您希望将其总结为一个单一的事件时间预测。在这篇文章中，我将讨论从生存函数预测寿命的多种方法。如果你想学习更多关于生存分析的知识，或者如何从你的数据中获得生存函数，试试python库“生命线”的<a class="ae kc" href="https://lifelines.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">文档</a>，或者这篇伟大的<a class="ae kc" href="https://towardsdatascience.com/survival-analysis-intuition-implementation-in-python-504fde4fcf8e" rel="noopener" target="_blank">博客文章</a>。</p><h1 id="1442" class="lr ll iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">让我们得到一些生存函数。</h1><p id="4b12" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">我们将从用python创建一个玩具数据集开始。在这个数据集中，我们在一项持续20多天的研究中有5名受试者。“观察”栏说明受试者在研究期间是否确实经历了症状的复发，“持续时间”栏表示症状再次出现的日期。如你所见，我们的数据没有被删截:症状复发的时间被记录为整个样本。我们还记录了一个预测变量。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="4d44" class="lk ll iq lg b gy lm ln l lo lp">df = pd.DataFrame({"predictor": [5, 3.5, 20, 9, 15], <br/>                   "observed": [True, True, True, True, True],<br/>                   "duration": [0, 12, 13, 3, 20]})</span></pre><p id="57cd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用生命线库来使<a class="ae kc" href="https://en.wikipedia.org/wiki/Proportional_hazards_model" rel="noopener ugc nofollow" target="_blank"> Cox比例风险模型</a>适合我们的数据。该模型用于描述一个或多个协变量对存活率的影响。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="5056" class="lk ll iq lg b gy lm ln l lo lp">from lifelines import CoxPHFitter<br/><br/>cph = CoxPHFitter()<br/>cph.fit(df, "duration", "observed")</span></pre><p id="b023" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv lg b">&lt;lifelines.CoxPHFitter: fitted with 5 total observations, 0 right-censored observations&gt;</code></p><p id="13f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们使用该模型来预测2名受试者的新样本的生存函数:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="eaa6" class="lk ll iq lg b gy lm ln l lo lp">X = pd.DataFrame({"predictor": [4, 18]}, index=['subject1', 'subject2'])<br/>X</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/d33998bf92a0917db46a53a1634b6627.png" data-original-src="https://miro.medium.com/v2/resize:fit:410/format:webp/1*8z5fcbxOLZAzIuunhr5c3w.png"/></div></figure><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="31c3" class="lk ll iq lg b gy lm ln l lo lp">survival_functions = cph.predict_survival_function(X)<br/>survival_functions</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/79511dc0f4b1e1ebdda66335befdb481.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/format:webp/1*iDAcQiZBV8Y6288xi0mgPw.png"/></div></figure><p id="59c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在对每个主题都有一个生存函数。但这些受试者感兴趣的是底线:他们的症状多久会复发？</p><h1 id="30a7" class="lr ll iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">计算预期寿命值作为生存曲线下的面积</h1><p id="44cc" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">连续随机变量最常见的集中趋势度量是期望值。一个随机变量的期望值是它的可能结果的平均值，用它们的概率加权。存活时间是一个连续变量(尽管我们的petite示例可以被认为是离散的)，所以我们需要在给定的范围内对函数进行积分。这意味着受试者寿命的期望值是生存曲线下的面积。</p><p id="e7aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生命线的回归拟合对象有一个计算主体寿命期望值的方法:predict_expectation()。它使用梯形法则计算曲线下的面积。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="cb9f" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_expectation(X)</span></pre><p id="e50e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv lg b">subject1 4.648343<br/>subject2 13.456205<br/>dtype: float64</code></p><p id="144c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">文档警告说“如果生存函数不收敛到0，那么期望真的是无穷大，返回值没有意义/太大”。这是为什么呢？我们来看看2号课题的生存函数，比如。我们的预测生存函数表示模型训练的每个持续时间的概率。对于最近的时间段，20天，受试者2的存活概率相对较高，为0.25。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9f08" class="lk ll iq lg b gy lm ln l lo lp">import matplotlib.pyplot as plt<br/><br/>survival_functions['subject2'].plot()<br/>xlabel = plt.xlabel("time")<br/>ylabel = plt.ylabel("probability")<br/>ylim = plt.ylim([0, 1])</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi my"><img src="../Images/f19ff774d6bc9f9475b1e1237cc55df4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/1*0mBiD6cxVVCWGSQJrUDCAA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这条曲线下的面积是13.456</figcaption></figure><p id="fea9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">计算存活曲线下的面积实际上产生了向下的偏差，因为曲线很可能在第20天后继续。然而，我们没有足够的信息来确定这个函数对于大于20的值的行为。很有可能会有更长的无症状期:</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/3c5c2bb272b0c49dabc26117e1b312ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*YegIk3M-WT5OO7NWk22ICA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这条曲线下的面积约为14.7</figcaption></figure><p id="fb57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但也有可能在第20天后,“存活”的几率会直接降至零。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/d579f64c636b5364c70388b4256de625.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*62HKmU4Lary2uIJsaifuaw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这条曲线下的面积约为13.58</figcaption></figure><h1 id="9a0b" class="lr ll iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">预测中值寿命</h1><p id="6065" class="pw-post-body-paragraph kd ke iq kf b kg mo ki kj kk mp km kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">我们已经确定，使用症状复发时间的期望值，虽然在数学上很美，但可能有问题。相反，我们可以使用概率达到50%阈值的时间作为我们的预测。在达到这个阈值时，事件未发生的概率变得低于它在每个随后的时间点发生的概率。使用中间值或其他百分位数简单而直接，不受极端值的影响。生命线通过predict_median()方法直接支持这个选项。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="331d" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_median(X)</span></pre><p id="4ff1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv lg b">subject1 3.0<br/>subject2 20.0<br/>Name: 0.5, dtype: float64</code></p><p id="ab75" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">毫不奇怪，中值会产生与期望值不同的预测。请注意，从技术上讲，2号受试者的函数在第20天越过了0.5的阈值，但它在第13天非常接近越过阈值。这是相对粗糙的生存函数的陷阱之一。</p><p id="339c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽管如此，也不能保证你的生存函数真的达到了50%的概率！当您的生存函数预测到特别高的存活率时，该函数甚至可能在跨过50%标记之前就结束了，生命线predict_median()方法返回值inf。在这种情况下，可以认为预测症状复发的时间没有意义，因为估计或模型没有获得足够的相关信息。让我们来看看:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="19d5" class="lk ll iq lg b gy lm ln l lo lp">X2 = pd.DataFrame({"predictor": [25]}, index=['subject3'])<br/>X2</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/d2e81a335d7b6e8a009cd8201c823acc.png" data-original-src="https://miro.medium.com/v2/resize:fit:378/format:webp/1*TOg0yrqD6UK0vRcn2W_53g.png"/></div></figure><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="5389" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_survival_function(X2)</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/56837cc946718be0727ee7c8fac7fdc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:308/format:webp/1*aBgU7DnWRqJiTmvi1jXWlA.png"/></div></figure><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="bc0d" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_median(X2)</span></pre><p id="211c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv lg b">inf</code></p><p id="48eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，如果生存机会很小，函数可能从低于0.5的概率开始，predict_median()将返回零。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="9218" class="lk ll iq lg b gy lm ln l lo lp">X3 = pd.DataFrame({"predictor": [-3]}, index=['subject4'])<br/>X3</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/c276c24d9a90470fac772f2a13f45977.png" data-original-src="https://miro.medium.com/v2/resize:fit:380/format:webp/1*CHEhaMGaOVBpifsxC0-0gQ.png"/></div></figure><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="7788" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_survival_function(X3)</span></pre><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/0d42b0058a13fe8b059ce2b6992e7dd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:364/format:webp/1*wk_gn2OOnf-mgFiJ_30O_A.png"/></div></div></figure><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="be5c" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_median(X3)</span></pre><p id="141a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv lg b">0.0</code></p><p id="5050" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想安全起见，根据您的用例，您可以使用不同的百分位数作为生存概率阈值。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="3fa9" class="lk ll iq lg b gy lm ln l lo lp">cph.predict_percentile(X, p=0.75)</span></pre><p id="1421" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mt mu mv lg b">subject1 0.0<br/>subject2 13.0<br/>Name: 0.75, dtype: float64</code></p><blockquote class="nf ng nh"><p id="2cb6" class="kd ke ni kf b kg kh ki kj kk kl km kn nj kp kq kr nk kt ku kv nl kx ky kz la ij bi translated"><strong class="kf ir">如果你在这篇文章中幸存下来(看我在那里做了什么？)，你准备把你的生存函数，变成一个结论性的预测。请记住，当生存函数不收敛到零时，中值比期望值更可取，但如果函数甚至不超过0.5，它也救不了你。祝你好运！</strong></p></blockquote></div></div>    
</body>
</html>