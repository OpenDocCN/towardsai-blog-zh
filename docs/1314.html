<html>
<head>
<title>Building a Product Recommendation Engine on Google Cloud’s Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云平台上构建产品推荐引擎</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/building-a-product-recommendation-engine-on-google-clouds-platform-cf559abafe6a?source=collection_archive---------0-----------------------#2020-12-29">https://pub.towardsai.net/building-a-product-recommendation-engine-on-google-clouds-platform-cf559abafe6a?source=collection_archive---------0-----------------------#2020-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="2c83" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/cloud-computing" rel="noopener ugc nofollow" target="_blank">云计算</a></h2><div class=""/><div class=""><h2 id="8b0e" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">使用DataProc、云SQL和云存储</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/24057a78d408589adbda9adb49e6281b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zl3GsjjEMwQIb966SzXmMA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片提供:谷歌</figcaption></figure><p id="5ccd" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在我的上一篇文章中，我讨论了如何使用Amazon Sagemaker轻松创建一个端到端的推荐引擎。<br/>今天，我们将利用谷歌云平台和Apache Spark来创建一个推荐引擎，您可以轻松地将其与数据工程管道集成。可以用同样的机制，部署在AI平台笔记本上。</p><p id="74e0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">先决条件:</strong></p><ol class=""><li id="6fe2" class="ma mb iq lg b lh li lk ll ln mc lr md lv me lz mf mg mh mi bi translated">你需要一个谷歌云平台订阅<a class="ae mj" href="https://cloud.google.com/pricing/?utm_source=google&amp;utm_medium=cpc&amp;utm_campaign=japac-IN-all-en-dr-bkws-all-all-trial-e-dr-1009137&amp;utm_content=text-ad-none-none-DEV_c-CRE_438601541971-ADGP_Hybrid%20%7C%20AW%20SEM%20%7C%20BKWS%20~%20T1%20%7C%20EXA%20%7C%20Pricing%20%7C%20M%3A1%20%7C%20IN%20%7C%20en%20%7C%20google%20cloud-KWID_43700036927608605-kwd-277810791968&amp;userloc_9302223-network_g&amp;utm_term=KW_try%20google%20cloud&amp;gclid=EAIaIQobChMIvKCJ1_Sp7QIViR0rCh3x0wVbEAAYASAAEgJMu_D_BwE" rel="noopener ugc nofollow" target="_blank">链接</a>。</li><li id="1883" class="ma mb iq lg b lh mk lk ml ln mm lr mn lv mo lz mf mg mh mi bi translated">访问google云服务:云存储、dataproc、云SQL。</li><li id="0848" class="ma mb iq lg b lh mk lk ml ln mm lr mn lv mo lz mf mg mh mi bi translated">PySpark和SQL知识。</li></ol><p id="f161" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在深入探讨之前，我们先讨论几个术语。</p><p id="c72a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">矩阵分解:</strong></p><p id="9290" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这是一种协作过滤技术，其中生成用户嵌入和项目嵌入矩阵。两个矩阵的矩阵乘积给出了产品推荐的用户反馈的近似。这些矩阵嵌入是经过一段时间学习的。</p><p id="790f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">更多信息，你可以查看我上一篇<a class="ae mj" href="https://medium.com/towards-artificial-intelligence/building-an-end-to-end-recommendation-engine-using-matrix-factorization-with-cloud-deployment-using-f878d43c1005" rel="noopener">帖子</a>或者查看谷歌开发者<a class="ae mj" href="https://developers.google.com/machine-learning/recommendation/collaborative/matrix" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="726c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在数学上，它可以用下面的公式表示:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/264438642bef021e53802f5b90e55b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*qQmY43D5RFSzVoklexvJkQ.png"/></div></figure><p id="d447" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">其中U和V是用户嵌入和项目嵌入矩阵。</p><p id="9d9e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">a是您想要表示的接近用户-项目交互的实际表示的点积。这个距离也被称为弗罗贝纽斯距离。<br/>在现实世界中，我们还需要考虑未观察到的配对，例如，假设一个用户是新用户，从未对某一类型的产品表现出兴趣，而现有用户对更多类别的产品表现出兴趣。</p><p id="cda1" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">因此，目标函数采用以下形式，也称为加权矩阵分解。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mq"><img src="../Images/1a54c4cf42e2601c8fb7fad1fa1fd386.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RUZ2UE02X0g3AxcS6WIdMA.png"/></div></div></figure><p id="0347" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">其中w0是超参数，它经过调整，对于平衡观察到的和未观察到的实体的总和非常重要。</p><p id="b404" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">有两种算法来最小化上述目标函数:</p><p id="fe33" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja"> SGD(随机梯度下降)</strong>:广义技术</p><p id="65f2" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">优点</strong>:灵活，可以并行化</p><p id="4a11" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">缺点</strong>:收敛较慢，处理未被观察到的条目很困难。</p><p id="c7e3" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja"> WALS(加权交替最小二乘法):</strong>专门针对我们的目标。</p><p id="3223" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">优点</strong>:快速收敛，并行化，处理未观察到的条目。</p><p id="4446" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">缺点</strong>:依赖损失平方函数。</p><p id="ed93" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在让我们进入现实世界的问题。</p><ol class=""><li id="32f9" class="ma mb iq lg b lh li lk ll ln mc lr md lv me lz mf mg mh mi bi translated">跟随此<a class="ae mj" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">链接</a>打开谷歌云控制台。确保为您的工作创建或选择一个项目。组织- &gt;项目- &gt;文件夹是google云平台中遵循的文件夹层级。</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mr"><img src="../Images/8d8076fff4aeaa61df4946a83ae8fa69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iiDPQsZCyBg_T1Jg8z0CcA.png"/></div></div></figure><p id="e530" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">2.打开导航菜单，通过导航到数据库-&gt;SQL-&gt;创建实例-&gt;mySQL来创建云SQL实例</p><p id="b63b" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">确保选择唯一的实例ID和root密码。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ms"><img src="../Images/645eeaaea32bb5b6f30c68af9f5ed857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mLJQ6Zo5O6Ryo6WtELkyrQ.png"/></div></div></figure><p id="216f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">3.现在，让我们在MySQL中创建表。</p><p id="fdf6" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">一旦实例准备就绪，就可以使用google cloud shell连接到数据库。</p><p id="1349" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在右上角，您会注意到一个激活云外壳的图标。单击云壳。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mt"><img src="../Images/289ed07b774e1d500353c5cb7334de4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ttBINrGnq7undw-Ns2zajg.png"/></div></div></figure><p id="25e2" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在让我们使用云shell连接到我们新创建的数据库。</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="2423" class="mz na iq mv b gy nb nc l nd ne">gcloud sql connect rentals --user=root --quiet</span></pre><p id="afce" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">如果系统提示您启用SQL admin API，请按照错误链接启用它。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nf"><img src="../Images/0f6efd2c27153d266571105bf7733195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*shoKQ4NMGiYVR2fZsmzmdw.png"/></div></div></figure><p id="409a" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">将您的IP加入白名单可能需要5分钟。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/22c2eff8f79ac3e8acbd15264c253449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hw5D_V7JKcrk6mg-tARoUA.png"/></div></div></figure><p id="0adb" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">4.进入MySQL控制台后，创建一个数据库和3个表来存储推荐数据。</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="3b3f" class="mz na iq mv b gy nb nc l nd ne">CREATE DATABASE IF NOT EXISTS recommendation_spark;</span><span id="1c97" class="mz na iq mv b gy nh nc l nd ne">USE recommendation_spark;</span><span id="7471" class="mz na iq mv b gy nh nc l nd ne">DROP TABLE IF EXISTS Recommendation;</span><span id="f587" class="mz na iq mv b gy nh nc l nd ne">DROP TABLE IF EXISTS Rating;</span><span id="80f1" class="mz na iq mv b gy nh nc l nd ne">DROP TABLE IF EXISTS Accommodation;</span><span id="e656" class="mz na iq mv b gy nh nc l nd ne">CREATE TABLE IF NOT EXISTS Accommodation</span><span id="3458" class="mz na iq mv b gy nh nc l nd ne">(</span><span id="4e8a" class="mz na iq mv b gy nh nc l nd ne">id varchar(255),</span><span id="406d" class="mz na iq mv b gy nh nc l nd ne">title varchar(255),</span><span id="8477" class="mz na iq mv b gy nh nc l nd ne">location varchar(255),</span><span id="5a30" class="mz na iq mv b gy nh nc l nd ne">price int,</span><span id="3c2c" class="mz na iq mv b gy nh nc l nd ne">rooms int,</span><span id="39a1" class="mz na iq mv b gy nh nc l nd ne">rating float,</span><span id="81e5" class="mz na iq mv b gy nh nc l nd ne">type varchar(255),</span><span id="6337" class="mz na iq mv b gy nh nc l nd ne">PRIMARY KEY (ID)</span><span id="b806" class="mz na iq mv b gy nh nc l nd ne">);</span><span id="4987" class="mz na iq mv b gy nh nc l nd ne">CREATE TABLE IF NOT EXISTS Rating</span><span id="8b71" class="mz na iq mv b gy nh nc l nd ne">(</span><span id="1a21" class="mz na iq mv b gy nh nc l nd ne">userId varchar(255),</span><span id="03af" class="mz na iq mv b gy nh nc l nd ne">accoId varchar(255),</span><span id="1b3b" class="mz na iq mv b gy nh nc l nd ne">rating int,</span><span id="71ac" class="mz na iq mv b gy nh nc l nd ne">PRIMARY KEY(accoId, userId),</span><span id="78ea" class="mz na iq mv b gy nh nc l nd ne">FOREIGN KEY (accoId)</span><span id="2727" class="mz na iq mv b gy nh nc l nd ne">REFERENCES Accommodation(id)</span><span id="9675" class="mz na iq mv b gy nh nc l nd ne">);</span><span id="8396" class="mz na iq mv b gy nh nc l nd ne">CREATE TABLE IF NOT EXISTS Recommendation</span><span id="da20" class="mz na iq mv b gy nh nc l nd ne">(</span><span id="3a5f" class="mz na iq mv b gy nh nc l nd ne">userId varchar(255),</span><span id="0ca0" class="mz na iq mv b gy nh nc l nd ne">accoId varchar(255),</span><span id="292e" class="mz na iq mv b gy nh nc l nd ne">prediction float,</span><span id="d272" class="mz na iq mv b gy nh nc l nd ne">PRIMARY KEY(userId, accoId),</span><span id="77ba" class="mz na iq mv b gy nh nc l nd ne">FOREIGN KEY (accoId)</span><span id="3826" class="mz na iq mv b gy nh nc l nd ne">REFERENCES Accommodation(id)</span><span id="7cd2" class="mz na iq mv b gy nh nc l nd ne">);</span><span id="b26b" class="mz na iq mv b gy nh nc l nd ne">SHOW DATABASES;</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ni"><img src="../Images/03e6c990b874c4523cb648d76ef0ce93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0iHlZchv4Vyp_WYq_1DfAg.png"/></div></div></figure><p id="95a0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在，桌子会是空的。您将把数据存放在云SQL中，然后将其拉至云SQL。</p><p id="3a84" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">5.在云外壳中创建新窗口，创建存储桶并将数据拉入云存储桶。</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="4c7f" class="mz na iq mv b gy nb nc l nd ne">echo “Creating bucket: gs://$DEVSHELL_PROJECT_ID”</span><span id="6b63" class="mz na iq mv b gy nh nc l nd ne">gsutil mb gs://$DEVSHELL_PROJECT_ID</span><span id="7fac" class="mz na iq mv b gy nh nc l nd ne">echo “Copying data to our storage from public dataset”</span><span id="2b38" class="mz na iq mv b gy nh nc l nd ne">gsutil cp gs://cloud-training/bdml/v2.0/data/accommodation.csv gs://$DEVSHELL_PROJECT_ID</span><span id="4d6c" class="mz na iq mv b gy nh nc l nd ne">gsutil cp gs://cloud-training/bdml/v2.0/data/rating.csv gs://$DEVSHELL_PROJECT_ID</span><span id="b8b1" class="mz na iq mv b gy nh nc l nd ne">echo “Show the files in our bucket”</span><span id="50b1" class="mz na iq mv b gy nh nc l nd ne">gsutil ls gs://$DEVSHELL_PROJECT_ID</span><span id="6bb2" class="mz na iq mv b gy nh nc l nd ne">echo “View some sample data”</span><span id="710d" class="mz na iq mv b gy nh nc l nd ne">gsutil cat gs://$DEVSHELL_PROJECT_ID/accommodation.csv</span></pre><p id="24e9" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">您可以通过导航菜单-&gt;存储-&gt;浏览器-&gt;项目ID来检查内容。</p><p id="d79e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">6.让我们将云存储桶中的数据加载到云SQL中。</p><p id="5ee5" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">导航至SQL-&gt;租赁-&gt;导入数据</p><p id="2bcb" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">指定存储桶、数据库和表名，然后单击导入。</p><p id="dfe1" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">对评级数据重复上述步骤。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nj"><img src="../Images/c7bb3db67eb5218c73c928794d9c90b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRNDu4Chge1-j4Bq3ipAWg.png"/></div></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mt"><img src="../Images/aea676dc528e07b23f22b78b1020b800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*suIy2ppK5VtsFKbg_vOa1g.png"/></div></div></figure><p id="cc64" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">7.使用cloud shell并运行一些命令来探索数据</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="677a" class="mz na iq mv b gy nb nc l nd ne">SELECT</span><span id="f6c2" class="mz na iq mv b gy nh nc l nd ne">userId,</span><span id="b6cd" class="mz na iq mv b gy nh nc l nd ne">COUNT(rating) AS num_ratings</span><span id="d721" class="mz na iq mv b gy nh nc l nd ne">FROM Rating</span><span id="4555" class="mz na iq mv b gy nh nc l nd ne">GROUP BY userId</span><span id="7674" class="mz na iq mv b gy nh nc l nd ne">ORDER BY num_ratings DESC;</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ms"><img src="../Images/66951253b9bccb9e37de0b70932c976e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gn-W17ynJCdOiKY1O-A99w.png"/></div></div></figure><p id="df51" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">8.让我们使用dataproc创建一个推荐引擎。</p><p id="78d7" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">通过导航到API和服务-&gt;仪表板-&gt;搜索云dataproc API来启用Dataproc API。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mt"><img src="../Images/501533f8be97ae855257a6cb51ec3d15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*up5lYezn1zRd0ixtVt8JAw.png"/></div></div></figure><p id="a8a9" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">完成后，导航到BigData-&gt; data proc-&gt; Cluster-&gt; create Cluster</p><p id="d427" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">确保该区域与您的云SQL实例相同。</p><p id="f02d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">另外，请注意集群中的名称、区域和工作节点总数。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/ed43e1e169312baeaa83fafc37ddbbe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fj9G5wq064H10WZKhpd66g.png"/></div></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/a5c30066fa7c76363fa865fec8cb7e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SAF2M0rdjAIno3L5CFS52Q.png"/></div></div></figure><p id="5112" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">8.授权dataproc连接到云SQL实例</p><p id="8efd" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在云壳中使用下面的脚本。确保检查集群名称、区域和工作线程数量。</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="3738" class="mz na iq mv b gy nb nc l nd ne">echo “Authorizing Cloud Dataproc to connect with Cloud SQL”</span><span id="bb11" class="mz na iq mv b gy nh nc l nd ne">CLUSTER=cluster-a20f</span><span id="dd9f" class="mz na iq mv b gy nh nc l nd ne">CLOUDSQL=rentals</span><span id="273c" class="mz na iq mv b gy nh nc l nd ne">ZONE=us-central1-f</span><span id="33b5" class="mz na iq mv b gy nh nc l nd ne">NWORKERS=2</span><span id="22de" class="mz na iq mv b gy nh nc l nd ne">machines=”$CLUSTER-m”</span><span id="a72b" class="mz na iq mv b gy nh nc l nd ne">for w in `seq 0 $(($NWORKERS — 1))`; do</span><span id="9cc7" class="mz na iq mv b gy nh nc l nd ne">machines=”$machines $CLUSTER-w-$w”</span><span id="669f" class="mz na iq mv b gy nh nc l nd ne">done</span><span id="717c" class="mz na iq mv b gy nh nc l nd ne">echo “Machines to authorize: $machines in $ZONE … finding their IP addresses”</span><span id="d418" class="mz na iq mv b gy nh nc l nd ne">ips=””</span><span id="9274" class="mz na iq mv b gy nh nc l nd ne">for machine in $machines; do</span><span id="a4f7" class="mz na iq mv b gy nh nc l nd ne">IP_ADDRESS=$(gcloud compute instances describe $machine — zone=$ZONE — format=’value(networkInterfaces.accessConfigs[].natIP)’ | sed “s/\[‘//g” | sed “s/’\]//g” )/32</span><span id="e9ca" class="mz na iq mv b gy nh nc l nd ne">echo “IP address of $machine is $IP_ADDRESS”</span><span id="edd5" class="mz na iq mv b gy nh nc l nd ne">if [ -z $ips ]; then</span><span id="983f" class="mz na iq mv b gy nh nc l nd ne">ips=$IP_ADDRESS</span><span id="68a1" class="mz na iq mv b gy nh nc l nd ne">else</span><span id="42ee" class="mz na iq mv b gy nh nc l nd ne">ips=”$ips,$IP_ADDRESS”</span><span id="9f9f" class="mz na iq mv b gy nh nc l nd ne">fi</span><span id="efc8" class="mz na iq mv b gy nh nc l nd ne">done</span><span id="33e7" class="mz na iq mv b gy nh nc l nd ne">echo “Authorizing [$ips] to access cloudsql=$CLOUDSQL”</span><span id="fe11" class="mz na iq mv b gy nh nc l nd ne">gcloud sql instances patch $CLOUDSQL — authorized-networks $ips</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/5c0d9b2da2cba2da7eb784135d21b84d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vPI8g9LChAfaKUT1fSaCEA.png"/></div></div></figure><p id="c2d8" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">9.将ML模型复制到datarproc集群，并使用cloud shell对其进行编辑。</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="3f92" class="mz na iq mv b gy nb nc l nd ne">gsutil cp gs://cloud-training/bdml/v2.0/model/train_and_apply.py train_and_apply.py</span><span id="9054" class="mz na iq mv b gy nh nc l nd ne">cloudshell edit train_and_apply.py</span></pre><p id="c5fc" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">下面是pyspark代码片段</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="d14b" class="mz na iq mv b gy nb nc l nd ne">import os</span><span id="ba14" class="mz na iq mv b gy nh nc l nd ne">import sys</span><span id="634b" class="mz na iq mv b gy nh nc l nd ne">import pickle</span><span id="3236" class="mz na iq mv b gy nh nc l nd ne">import itertools</span><span id="de96" class="mz na iq mv b gy nh nc l nd ne">from math import sqrt</span><span id="889e" class="mz na iq mv b gy nh nc l nd ne">from operator import add</span><span id="bdac" class="mz na iq mv b gy nh nc l nd ne">from os.path import join, isfile, dirname</span><span id="43af" class="mz na iq mv b gy nh nc l nd ne">from pyspark import SparkContext, SparkConf, SQLContext</span><span id="e3d9" class="mz na iq mv b gy nh nc l nd ne">from pyspark.mllib.recommendation import ALS, MatrixFactorizationModel, Rating</span><span id="9bd4" class="mz na iq mv b gy nh nc l nd ne">from pyspark.sql.types import StructType, StructField, StringType, FloatType</span><span id="0278" class="mz na iq mv b gy nh nc l nd ne"># MAKE EDITS HERE</span><span id="5080" class="mz na iq mv b gy nh nc l nd ne">CLOUDSQL_INSTANCE_IP = ‘104.155.188.32’ # ← — CHANGE (database server IP)</span><span id="e720" class="mz na iq mv b gy nh nc l nd ne">CLOUDSQL_DB_NAME = ‘recommendation_spark’ # ←- leave as-is</span><span id="6fb8" class="mz na iq mv b gy nh nc l nd ne">CLOUDSQL_USER = ‘root’ # ←- leave as-is</span><span id="8b46" class="mz na iq mv b gy nh nc l nd ne">CLOUDSQL_PWD = ‘root’ # ← — CHANGE</span><span id="9c9c" class="mz na iq mv b gy nh nc l nd ne"># DO NOT MAKE EDITS BELOW</span><span id="9346" class="mz na iq mv b gy nh nc l nd ne">conf = SparkConf().setAppName(“train_model”)</span><span id="016e" class="mz na iq mv b gy nh nc l nd ne">sc = SparkContext(<em class="nk">conf</em>=conf)</span><span id="7fb2" class="mz na iq mv b gy nh nc l nd ne">sqlContext = SQLContext(sc)</span><span id="78e0" class="mz na iq mv b gy nh nc l nd ne">jdbcDriver = ‘com.mysql.jdbc.Driver’</span><span id="b082" class="mz na iq mv b gy nh nc l nd ne">jdbcUrl = ‘jdbc:mysql://%s:3306/%s?user=%s&amp;password=%s’ % (CLOUDSQL_INSTANCE_IP, CLOUDSQL_DB_NAME, CLOUDSQL_USER, CLOUDSQL_PWD)</span><span id="4768" class="mz na iq mv b gy nh nc l nd ne"># checkpointing helps prevent stack overflow errors</span><span id="d07b" class="mz na iq mv b gy nh nc l nd ne">sc.setCheckpointDir(‘checkpoint/’)</span><span id="64ac" class="mz na iq mv b gy nh nc l nd ne"># Read the ratings and accommodations data from Cloud SQL</span><span id="7fca" class="mz na iq mv b gy nh nc l nd ne">dfRates = sqlContext.read.format(‘jdbc’).options(<em class="nk">driver</em>=jdbcDriver, <em class="nk">url</em>=jdbcUrl, <em class="nk">dbtable</em>=’Rating’, <em class="nk">useSSL</em>=’false’).load()</span><span id="3f5f" class="mz na iq mv b gy nh nc l nd ne">dfAccos = sqlContext.read.format(‘jdbc’).options(<em class="nk">driver</em>=jdbcDriver, <em class="nk">url</em>=jdbcUrl, <em class="nk">dbtable</em>=’Accommodation’, <em class="nk">useSSL</em>=’false’).load()</span><span id="e59c" class="mz na iq mv b gy nh nc l nd ne">print(“read …”)</span><span id="0eb7" class="mz na iq mv b gy nh nc l nd ne"># train the model</span><span id="6848" class="mz na iq mv b gy nh nc l nd ne">model = ALS.train(dfRates.rdd, 20, 20) # you could tune these numbers, but these are reasonable choices</span><span id="2fee" class="mz na iq mv b gy nh nc l nd ne">print(“trained …”)</span><span id="ec9a" class="mz na iq mv b gy nh nc l nd ne"># use this model to predict what the user would rate accommodations that she has not rated</span><span id="a268" class="mz na iq mv b gy nh nc l nd ne">allPredictions = None</span><span id="dadb" class="mz na iq mv b gy nh nc l nd ne">for USER_ID in range(0, 100):</span><span id="33ac" class="mz na iq mv b gy nh nc l nd ne">dfUserRatings = dfRates.filter(dfRates.userId == USER_ID).rdd.map(<em class="nk">lambda</em> <em class="nk">r</em>: r.accoId).collect()</span><span id="8199" class="mz na iq mv b gy nh nc l nd ne">rddPotential = dfAccos.rdd.filter(<em class="nk">lambda</em> <em class="nk">x</em>: x[0] not in dfUserRatings)</span><span id="a658" class="mz na iq mv b gy nh nc l nd ne">pairsPotential = rddPotential.map(<em class="nk">lambda</em> <em class="nk">x</em>: (USER_ID, x[0]))</span><span id="c6c3" class="mz na iq mv b gy nh nc l nd ne">predictions = model.predictAll(pairsPotential).map(<em class="nk">lambda</em> <em class="nk">p</em>: (<em class="nk">str</em>(p[0]), <em class="nk">str</em>(p[1]), <em class="nk">float</em>(p[2])))</span><span id="0e81" class="mz na iq mv b gy nh nc l nd ne">predictions = predictions.takeOrdered(5, <em class="nk">key</em>=<em class="nk">lambda</em> <em class="nk">x</em>: -x[2]) # top 5</span><span id="c41f" class="mz na iq mv b gy nh nc l nd ne">print(“predicted for user={0}”.format(USER_ID))</span><span id="c358" class="mz na iq mv b gy nh nc l nd ne">if (allPredictions == None):</span><span id="2cde" class="mz na iq mv b gy nh nc l nd ne">allPredictions = predictions</span><span id="bd6d" class="mz na iq mv b gy nh nc l nd ne">else:</span><span id="0a9d" class="mz na iq mv b gy nh nc l nd ne">allPredictions.extend(predictions)</span><span id="5e5f" class="mz na iq mv b gy nh nc l nd ne"># write them</span><span id="d3a8" class="mz na iq mv b gy nh nc l nd ne">schema = StructType([StructField(“userId”, StringType(), True), StructField(“accoId”, StringType(), True), StructField(“prediction”, FloatType(), True)])</span><span id="6d78" class="mz na iq mv b gy nh nc l nd ne">dfToSave = sqlContext.createDataFrame(allPredictions, schema)</span><span id="2cc8" class="mz na iq mv b gy nh nc l nd ne">dfToSave.write.jdbc(<em class="nk">url</em>=jdbcUrl, <em class="nk">table</em>=’Recommendation’, <em class="nk">mode</em>=’overwrite’)</span></pre><p id="807d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">出现提示时，单击在新窗口中打开。</p><p id="53b7" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">更改云实例IP和root密码。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/54a59dc470e60bdc085e8579d2b7700d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yy9_MD1ilUY_-FE8IlG-Xg.png"/></div></div></figure><p id="faab" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">现在保存并复制到桶中。我们将使用dataproc从存储位置选取代码。</p><pre class="kp kq kr ks gt mu mv mw mx aw my bi"><span id="63ca" class="mz na iq mv b gy nb nc l nd ne">gsutil cp train_and_apply.py gs://$DEVSHELL_PROJECT_ID</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/0054a960daaee542935c6358cb65d42d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cz1HswWPdUJcaSZ1eTre9A.png"/></div></div></figure><p id="6aa6" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">10.向dataproc集群提交ML作业的时间</p><p id="8683" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">导航到dataproc-&gt;作业-&gt;提交作业</p><p id="2d10" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">指定作业id、集群、pyspark形式的作业类型、主python文件存储桶路径，然后单击提交作业。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/90a51a185f4f5e7e0c9f551299607728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2g-jjwUdrXx86uo48FhvXg.png"/></div></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/cdddba776ef8f7a24f0b7618a672b1dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ewYoYVdF2rnL6jA6lB3I1g.png"/></div></div></figure><p id="ae5e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">11.查询推荐表</p><p id="9a8f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">一旦作业成功完成，您就可以查询MySQL表建议，以获得基于user_id的特定建议。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nm"><img src="../Images/1ab0a6973206204a2281e22c8803c24e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VuXkRwgSNQkxGPvgXQL4bA.png"/></div></div></figure><p id="ac83" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">注意:确保删除资源并关闭服务，以避免谷歌云的计费出现任何意外。</p><p id="3a28" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">一定要让我知道你的想法。你可以关注我关于人工智能/机器学习、数据分析和商业智能的教程。你可以在<a class="ae mj" href="https://www.linkedin.com/in/anurag-bisht-39935a59/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上和我联系。</p><p id="6b20" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">参考文献</strong></p><p id="79f0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">_【http://yifanhu.net/PUB/cf.pdf T4】</p><p id="1012" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">_<a class="ae mj" href="https://spark.apache.org/docs/latest/ml-collaborative-filtering.html" rel="noopener ugc nofollow" target="_blank">https://spark . Apache . org/docs/latest/ml-collaborative-filtering . html</a></p><p id="b236" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">_<a class="ae mj" href="http://stanford.edu/~rezab/classes/cme323/S15/notes/lec14.pdf" rel="noopener ugc nofollow" target="_blank">http://Stanford . edu/~ rezab/classes/CME 323/S15/notes/LEC 14 . pdf</a></p><p id="fab4" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">_<a class="ae mj" href="https://developers.google.com/machine-learning/recommendation/collaborative/matrix" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/machine-learning/recommendation/collaborative/matrix</a></p></div></div>    
</body>
</html>