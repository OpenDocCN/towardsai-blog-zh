<html>
<head>
<title>Non Max Suppression (NMS) in PyTorch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PyTorch中的非最大抑制(NMS)</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/non-max-suppression-nms-in-pytorch-35f77397a0aa?source=collection_archive---------1-----------------------#2022-10-26">https://pub.towardsai.net/non-max-suppression-nms-in-pytorch-35f77397a0aa?source=collection_archive---------1-----------------------#2022-10-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/c604029b80108bef5ce1afe2c7c9abd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a6IA_9Soe2N1Q6EpIrvUIw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="4671" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu"> <em class="ld">我在</em></strong><a class="ae le" href="https://www.linkedin.com/in/francesco-saverio-zuppichini-94659a150/?originalSubdomain=ch" rel="noopener ugc nofollow" target="_blank"><strong class="kh iu"><em class="ld">LinkedIn</em></strong></a><strong class="kh iu"><em class="ld">，过来打个招呼</em> </strong>👋</p><p id="b3ab" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">今天我们将看到如何在PyTorch中实现非最大值抑制</p><p id="77c2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><em class="ld">这里的代号是</em><a class="ae le" href="https://github.com/FrancescoSaverioZuppichini/non-max-suppression-in-pytorch" rel="noopener ugc nofollow" target="_blank"><em class="ld"/></a><em class="ld">而本文的互动版可以在</em> <a class="ae le" href="https://github.com/FrancescoSaverioZuppichini/non-max-suppression-in-pytorch/blob/main/README.ipynb" rel="noopener ugc nofollow" target="_blank"> <em class="ld">这里</em> </a></p><h1 id="fcb8" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">序言</h1><p id="b57a" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">如果你是做计算机视觉(尤其是物体检测)的，你知道什么是<em class="ld">非最大抑制(nms) </em>。网上有很多很好的文章给出了恰当的概述。简而言之，<em class="ld">非最大抑制</em>使用一些试探法来减少输出边界框的数量，例如并集交集(iou)。</p><p id="371f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">从<code class="fe mi mj mk ml b"><a class="ae le" href="https://pytorch.org/vision/stable/generated/torchvision.ops.nms.html" rel="noopener ugc nofollow" target="_blank">PyTorch</a></code> <a class="ae le" href="https://pytorch.org/vision/stable/generated/torchvision.ops.nms.html" rel="noopener ugc nofollow" target="_blank"> doc </a></p><blockquote class="mm mn mo"><p id="c7b6" class="kf kg ld kh b ki kj kk kl km kn ko kp mp kr ks kt mq kv kw kx mr kz la lb lc im bi translated"><em class="it"> NMS迭代地用另一个(得分较高的)盒子移除IoU大于iou_threshold的得分较低的盒子。</em></p></blockquote><p id="6e33" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><a class="ae le" href="https://towardsdatascience.com/non-maximum-suppression-nms-93ce178e177c" rel="noopener" target="_blank">这是一篇来自<a class="ae le" href="https://medium.com/@SambasivaraoK" rel="noopener"> Sambasivarao K </a>的精彩文章</a>，它贯穿了<em class="ld"> nms </em>的始终，让你对它的功能有一个很好的了解。</p><p id="73f4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在假设我们知道它是做什么的。让我们看看它是如何工作的。</p><h1 id="2a90" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">例子</h1><p id="14f0" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">让我们加载一个图像并创建边界框</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/c05b501192008d60219d93fa0c8db9e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ARFD4UbqsICgB036.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">鸣谢<a class="ae le" href="https://i0.wp.com/craffic.co.in/wp-content/uploads/2021/02/ai-remastered-rick-astley-never-gonna-give-you-up.jpg?w=1600&amp;ssl=1" rel="noopener ugc nofollow" target="_blank">https://i0 . WP . com/craffic . co . in/WP-content/uploads/2021/02/ai-remastered-Rick-astley-never-got-to-give-you-up . jpg？w=1600 &amp; ssl=1 </a></figcaption></figure><p id="aa27" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我创建两个<code class="fe mi mj mk ml b">bboxes</code>，一个用于<code class="fe mi mj mk ml b">head</code>，一个用于<code class="fe mi mj mk ml b">mic</code></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7186" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们在<code class="fe mi mj mk ml b">[0, 1]</code>范围内有<code class="fe mi mj mk ml b">bboxes</code>，这不是必须的，但是当你有多个类时它是有用的(我们将在后面看到为什么)。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/272c28fcb28ad6613da37cccd24b8bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*dp0VdP5Gt8ATUUoY.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="c35f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们添加更多的重叠框</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/7cf70f1cc235a6295ee9e4d9455d3973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*U5D57KVPtmMaPU09.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="31b2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">好吧，够乱了。我们现在有六辆<code class="fe mi mj mk ml b">bboxes</code>。我们也来定义一下<code class="fe mi mj mk ml b">scores</code>，这个通常是模型输出的。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="eff5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">还有我们的<code class="fe mi mj mk ml b">labels</code>、<code class="fe mi mj mk ml b">0</code>为<em class="ld">头</em>、<code class="fe mi mj mk ml b">1</code>为<em class="ld">头</em></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="39cd" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">作为最后一步，让我们排列数据</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="1001" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们看看他们</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/e4c6061f7861347542162a20277d305b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*FJsYr3ZKMDckoNKP.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="a702" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">很好！</p><h1 id="bfe7" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">履行</h1><p id="2559" class="pw-post-body-paragraph kf kg it kh b ki md kk kl km me ko kp kq mf ks kt ku mg kw kx ky mh la lb lc im bi translated">因此，NMS通过反复移除分数低的重叠包围盒来工作。所以，步骤如下。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7755" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">模仿torch的实现，我们的<code class="fe mi mj mk ml b">nms</code>有三个参数(实际上是从torch的doc中复制和粘贴的):</p><ul class=""><li id="cc72" class="na nb it kh b ki kj km kn kq nc ku nd ky ne lc nf ng nh ni bi translated">盒子(<code class="fe mi mj mk ml b">Tensor[N, 4]</code>)–执行NMS的盒子。它们应该是带有<code class="fe mi mj mk ml b">0 &lt;= x1 &lt; x2 and 0 &lt;= y1 &lt; y2</code>的(<code class="fe mi mj mk ml b">x1, y1, x2, y2</code>)格式。</li><li id="97ad" class="na nb it kh b ki nj km nk kq nl ku nm ky nn lc nf ng nh ni bi translated">分数(<code class="fe mi mj mk ml b">Tensor[N]</code>)–每个盒子的分数</li><li id="683f" class="na nb it kh b ki nj km nk kq nl ku nm ky nn lc nf ng nh ni bi translated">iou _ threshold(<code class="fe mi mj mk ml b">float</code>)–丢弃所有与<code class="fe mi mj mk ml b">IoU &gt; iou_threshold</code>重叠的框</li></ul><p id="1fbe" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们将返回非隐藏边界框的索引</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="3f87" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们一行一行来</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="af08" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们根据<code class="fe mi mj mk ml b">scores</code>得到排序的索引</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="53a4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们正在创建用于迭代<code class="fe mi mj mk ml b">bboxes</code>的<code class="fe mi mj mk ml b">indices</code></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="4637" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe mi mj mk ml b">keep</code>是一个向量，用来知道<code class="fe mi mj mk ml b">bbox</code>是否应该被保留，如果<code class="fe mi mj mk ml b">keep[i] == 1</code>则<code class="fe mi mj mk ml b">bboxes[order[i]]</code>不被抑制</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="8b29" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们迭代所有的<code class="fe mi mj mk ml b">bboxes</code></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="57b6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果电流<code class="fe mi mj mk ml b">bbox</code>未被抑制<code class="fe mi mj mk ml b">keep[i] = 1</code></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="36c7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">使用排序后的位置获取<code class="fe mi mj mk ml b">bbox</code></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="353b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">计算当前<code class="fe mi mj mk ml b">bbox</code>和所有其他候选之间的<code class="fe mi mj mk ml b">iou</code>。注意两件事</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="af29" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这将把所有被抑制的<code class="fe mi mj mk ml b">bboxes</code>置零(因为<code class="fe mi mj mk ml b">keep</code>将等于<code class="fe mi mj mk ml b">0</code>)</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="f8c5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们需要与排序后的所有下一个<code class="fe mi mj mk ml b">bboxes</code>进行比较，我们需要跳过当前的，所以这就是为什么我们有一个<code class="fe mi mj mk ml b">+ 1</code></p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="64c2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">选择<code class="fe mi mj mk ml b">iou</code>大于<code class="fe mi mj mk ml b">iou_threshold</code>的指数</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="6692" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于我们之前对<code class="fe mi mj mk ml b">bboxes</code>、<code class="fe mi mj mk ml b">(bboxes ...)[i + 1:])</code>进行了切片，我们需要将偏移量添加到那些索引中，所以我们添加了<code class="fe mi mj mk ml b">+ i + 1</code>。</p><p id="38f4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后，我们返回<code class="fe mi mj mk ml b">return order[keep]</code>，映射回原始的<code class="fe mi mj mk ml b">bboxes</code>索引(未排序)</p><p id="0afc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">好吧，我们试试！</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/60f0038ad91516f6dc5c89181632f6ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*TYpFQxGlTAIqNSm6.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="cbe8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于我们有多个类，我们需要让我们的<code class="fe mi mj mk ml b">nms</code>在同一个类中计算iou。有一个很好的技巧。</p><p id="c63a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">还记得我们的<code class="fe mi mj mk ml b">bboxes</code>在<code class="fe mi mj mk ml b">[0,1]</code>之间吗？嗯，我们可以把<code class="fe mi mj mk ml b">labels</code>加到他们身上，用不同的职业推开<code class="fe mi mj mk ml b">bboxes</code>。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/ea1191188ed497afd3bdc900c65907b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*N8gnG2OUpNrlkj9t.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="95ae" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果我们将阈值改为<code class="fe mi mj mk ml b">0.1</code></p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/29d7ea2854d3890030ca8cd4aa6d553d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*c7kHLQGJ47yZ3q1S.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="8c5a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们检查一下官方的<code class="fe mi mj mk ml b">torch</code>实现</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/2f9af19a6db5c61ea9e8452a110995ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*oQ0m8RZozpq8cF6S.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</figcaption></figure><p id="0ca4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一样的结果！让我们看表演吧</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="ms mt mu mv gt no ml np nq aw nr bi"><span id="48b6" class="ns lg it ml b gy nt nu l nv nw">534 µs ± 22.1 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</span></pre><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="ms mt mu mv gt no ml np nq aw nr bi"><span id="1153" class="ns lg it ml b gy nt nu l nv nw">54.4 µs ± 3.29 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</span></pre><p id="3c76" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们的实现大约慢了10倍，考虑到我们没有使用定制的cpp内核，我认为这是有意义的！</p><p id="f63c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果你认为我错过了什么，请在<a class="ae le" href="https://github.com/FrancescoSaverioZuppichini/non-max-suppression-in-pytorch" rel="noopener ugc nofollow" target="_blank"> GitHub </a>:)上自由发表</p><p id="97d8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在这篇文章中，我们已经看到了如何在PyTorch中实现非max抑制，希望它不再吓人！</p><p id="b7c9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">下一场见🚀</p><p id="0f28" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">弗朗西斯科</p></div></div>    
</body>
</html>