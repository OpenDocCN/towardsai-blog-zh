<html>
<head>
<title>How to Perform a Facial Landmark Detection with Keras</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Keras执行面部标志检测</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-perform-a-facial-landmark-detection-with-keras-eb6b4e7a2722?source=collection_archive---------0-----------------------#2021-12-29">https://pub.towardsai.net/how-to-perform-a-facial-landmark-detection-with-keras-eb6b4e7a2722?source=collection_archive---------0-----------------------#2021-12-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="2bb7" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/machine-learning/deep-learning" rel="noopener ugc nofollow" target="_blank">深度学习</a></h2><div class=""/><div class=""><h2 id="b04a" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">面部标志检测编程快速指南</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/a9af73df34a45fa64ed4b05895780bc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tu0e3rK58-2mZizVivtE4Q.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">从面部提取的标志</figcaption></figure><p id="542d" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">你学得快吗？</p><p id="7b91" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这篇文章的目的是通过使用预先训练好的模型从零开始，用<code class="fe md me mf mg b">Keras</code>库快速引导你检测面部标志(面部几何结构)。</p><ul class=""><li id="a814" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated"><strong class="lj jd"> <em class="mq">面部地标是什么？</em>T9】</strong></li><li id="0fcd" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated"><strong class="lj jd"> <em class="mq">下载模型</em> </strong></li><li id="db81" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated"><strong class="lj jd"> <em class="mq">怎么做？</em> </strong></li><li id="f563" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated"><strong class="lj jd"> <em class="mq">测试图像</em> </strong></li><li id="ea7e" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated"><strong class="lj jd"> <em class="mq">关闭思想</em> </strong></li></ul><h1 id="4835" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">面部标志检测是什么</h1><p id="fbbb" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">面部标志用于定位和表示面部的重要区域(例如，眼角、鼻尖、下颌线等)。</p><p id="329c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">有没有想过面部标志检测？面部标志检测是检测面部关键标志并跟踪它们的任务。您应该知道实现检测的几种不同方法，如Keras和Dlib库。</p><h1 id="2072" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">下载预先训练的模型</h1><p id="7ad7" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">你必须在这里下载预训练的重量文件<a class="ae nt" href="https://raw.githubusercontent.com/junhwanjang/face_landmark_dnn/master/landmark_model/Mobilenet_v1.hdf5" rel="noopener ugc nofollow" target="_blank">(23.2 MB)</a>。或者只运行这个:</p><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="25e8" class="ny mx it mg b gy nz oa l ob oc">wget <a class="ae nt" href="https://raw.githubusercontent.com/junhwanjang/face_landmark_dnn/master/landmark_model/Mobilenet_v1.hdf5" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/junhwanjang/face_landmark_dnn/master/landmark_model/Mobilenet_v1.hdf5</a> </span></pre><p id="0a48" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">它将<code class="fe md me mf mg b"><a class="ae nt" href="https://raw.githubusercontent.com/junhwanjang/face_landmark_dnn/master/landmark_model/Mobilenet_v1.hdf5" rel="noopener ugc nofollow" target="_blank">Mobilenet_v1.hdf5</a></code>文件保存在磁盘上。你也可以把这个文件移到<code class="fe md me mf mg b">models</code>文件夹。</p><h1 id="b249" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">创建虚拟环境</h1><p id="108b" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">当您想要处理多个项目时，使用虚拟环境非常重要。我们可以通过输入以下代码来创建一个新的虚拟环境。</p><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="14a9" class="ny mx it mg b gy nz oa l ob oc">python -m venv venv<br/>source venv/bin/actice</span></pre><h1 id="b235" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">安装并导入所需的库</h1><p id="c4d0" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">键入以下命令。几分钟后，库将安装到您的环境中。</p><h2 id="9c0d" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">NumPy</h2><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="143e" class="ny mx it mg b gy nz oa l ob oc">pip3 install numpy</span></pre><h2 id="d96c" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">OpenCV</h2><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="c09b" class="ny mx it mg b gy nz oa l ob oc">pip3 install opencv-python</span></pre><h2 id="c641" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">克拉斯</h2><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="0986" class="ny mx it mg b gy nz oa l ob oc">pip3 install keras</span></pre><h2 id="666f" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">准备好</h2><p id="4185" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">导入以下库，开始制作此食谱。</p><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="404e" class="ny mx it mg b gy nz oa l ob oc">import numpy as npimport matplotlib.pylab as plt<br/>import tensorflow as tf<br/>from keras.models import load_model<br/>from keras import backend as K<br/>from keras.utils.generic_utils import custom_object_scope<br/>import cv2</span></pre><h1 id="3c20" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">如何检测面部标志？</h1><p id="f3d7" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">我们将采取以下步骤开始。</p><ul class=""><li id="e4c1" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">加载样本图像</li><li id="8e79" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated">加载预训练模型</li><li id="d6e4" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated">预测面部标志</li><li id="7bcb" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated">显示结果</li></ul><h2 id="de12" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">使用OpenCV加载图像</h2><p id="a086" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">在这篇文章中，我决定使用Unsplash的免费酷图作为输入，使用<code class="fe md me mf mg b">opencv-python</code>库来检测上面的地标。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi on"><img src="../Images/c1f480116b4622c936cc861776401c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hQx7dgXzkdcbTbyE"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae nt" href="https://unsplash.com/@agnaes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aggy Wide </a>在<a class="ae nt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="b650" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们将从磁盘读取输入(<code class="fe md me mf mg b">girl.jpg</code>文件)，调整图像大小，并将其转换为灰度。</p><ul class=""><li id="3263" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">从特定目的地读取图像并调整其大小。</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="2861" class="ny mx it mg b gy nz oa l ob oc">image_color = cv2.resize(cv2.imread(‘images/girl.jpg’), (64, 64))</span></pre><ul class=""><li id="6098" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">在RGB/BGR和灰度之间转换图像。</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="fc2d" class="ny mx it mg b gy nz oa l ob oc">image_gray = cv2.cvtColor(image_color, cv2.COLOR_BGR2GRAY)</span></pre><ul class=""><li id="78b7" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">获取图像大小(宽度，高度)。</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="f2d1" class="ny mx it mg b gy nz oa l ob oc">w, h = image_gray.shape</span></pre><h2 id="b4ab" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">加载Keras模型并预测</h2><p id="f6bc" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">注意，预测地标位置的问题被构造为回归问题。</p><ul class=""><li id="a324" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">加载Keras模型(<code class="fe md me mf mg b">Mobilenet_v1.hdf5</code>文件)。</li><li id="8d6b" class="mh mi it lj b lk mr ln ms lq mt lu mu ly mv mc mm mn mo mp bi translated">预测灰度输入面中的界标。</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="9994" class="ny mx it mg b gy nz oa l ob oc">model = "models/Mobilenet_v1.hdf5"<br/>with custom_object_scope({'smoothL1': smoothL1, 'relu6': relu6, <br/>    'mask_weights': mask_weights, 'tf': tf}):<br/>    pr_model = load_model(model)<br/>    predictions = pr_model.predict_on_batch(np.reshape(image_gray, (1, w, h, 1)))</span></pre><p id="47df" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这个面部标志预测器在一个人的脸上生成68个点。</p><h2 id="0339" class="ny mx it bd my od oe dn nc of og dp ng lq oh oi ni lu oj ok nk ly ol om nm iz bi translated">显示预测的结果</h2><p id="3a3a" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">我们使用下面几行代码检测灰度图像中的标记。</p><ul class=""><li id="8306" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">脸上有印子。</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="3f15" class="ny mx it mg b gy nz oa l ob oc">marks = np.array(predictions).flatten()<br/>marks = np.reshape(marks, (-1, 2))</span></pre><ul class=""><li id="e36a" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">显示原始图像</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="cf0a" class="ny mx it mg b gy nz oa l ob oc">mage = image_color.copy()<br/>plt.figure(figsize=(10,5))<br/>plt.subplot(121), plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB)), plt.axis(‘off’), plt.title(‘Original image’, size=20)</span></pre><p id="cb8c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">最后，我们将显示带有地标的预测图像。</p><ul class=""><li id="621a" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">颚板(1–17)</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="dce0" class="ny mx it mg b gy nz oa l ob oc">for mark in marks[:17]:<br/>    cv2.circle(image, (int(w*mark[0]), int(h*mark[1])), 1, (0,0,255), -1, cv2.LINE_AA)</span></pre><ul class=""><li id="3a97" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">眉毛(18-27岁)</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="0f03" class="ny mx it mg b gy nz oa l ob oc">for mark in marks[17:27]:<br/>    cv2.circle(image, (int(w*mark[0]), int(h*mark[1])), 1, (255,255,0), -1, cv2.LINE_AA)</span></pre><ul class=""><li id="4b56" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">鼻子(28-36岁)</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="9c7a" class="ny mx it mg b gy nz oa l ob oc"><br/>for mark in marks[27:31]:<br/>    cv2.circle(image, (int(w*mark[0]), int(h*mark[1])), 1, (0,255,0), -1, cv2.LINE_AA)</span><span id="25b2" class="ny mx it mg b gy oo oa l ob oc">for mark in marks[31:36]:<br/>    cv2.circle(image, (int(w*mark[0]), int(h*mark[1])), 1, (0,255,255), -1, cv2.LINE_AA)</span></pre><ul class=""><li id="18ef" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">眼睛(37-48岁)</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="9e18" class="ny mx it mg b gy nz oa l ob oc">for mark in marks[36:48]:<br/>    cv2.circle(image, (int(w*mark[0]), int(h*mark[1])), 1, (255,255,255), -1, cv2.LINE_AA)</span></pre><ul class=""><li id="c226" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">唇(49–68)</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="7ff9" class="ny mx it mg b gy nz oa l ob oc">for mark in marks[48:]:<br/>    cv2.circle(image, (int(w*mark[0]), int(h*mark[1])), 1, (255,0,255), -1, cv2.LINE_AA)<br/></span></pre><ul class=""><li id="3e8b" class="mh mi it lj b lk ll ln lo lq mj lu mk ly ml mc mm mn mo mp bi translated">绘制结果</li></ul><pre class="ks kt ku kv gt nu mg nv nw aw nx bi"><span id="16d0" class="ny mx it mg b gy nz oa l ob oc">plt.subplot(122), plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB)), plt.axis('off'), plt.title('Detected Facial Landmarks', size=20)<br/>plt.show()</span></pre><h1 id="0d89" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">用各种图片测试程序</h1><p id="62fd" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">你运行程序，得到一个图像。下图显示了女孩脸上的68个地标。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi op"><img src="../Images/df761722ec0d7f2b1c14834f36e63dc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iDf3l5kQz4SG5aaUQGXzAQ.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">表面有68个地标</figcaption></figure><h1 id="70f6" class="mw mx it bd my mz na nb nc nd ne nf ng ki nh kj ni kl nj km nk ko nl kp nm nn bi translated">结束语</h1><p id="f31f" class="pw-post-body-paragraph lh li it lj b lk no kd lm ln np kg lp lq nq ls lt lu nr lw lx ly ns ma mb mc im bi translated">很简单，对吧？在这篇文章中，我们看到了如何使用预先训练的模型实现面部标志检测。如果你想改进这个程序，作为一个规则，试着训练你自己的模型或者实现一个新的模型。</p></div></div>    
</body>
</html>