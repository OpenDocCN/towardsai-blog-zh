<html>
<head>
<title>How to Share Flask APIs with Shiny</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何与Shiny共享Flask APIs</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/how-to-share-flask-apis-with-shiny-3442cd1bdca8?source=collection_archive---------5-----------------------#2021-02-07">https://pub.towardsai.net/how-to-share-flask-apis-with-shiny-3442cd1bdca8?source=collection_archive---------5-----------------------#2021-02-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/54f36c57375469770b17e172fc9d27d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1drkxVAmBnnG5Ci7.png"/></div></div></figure><h2 id="966e" class="jc jd je bd b dl jf jg jh ji jj jk dk jl translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/programming" rel="noopener ugc nofollow" target="_blank">编程</a>，<a class="ae ep" href="https://towardsai.net/p/category/programming/r" rel="noopener ugc nofollow" target="_blank"> R </a></h2><div class=""/><div class=""><h2 id="681a" class="pw-subtitle-paragraph kk jn je bd b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dk translated">关于如何与R Shiny共享python Flask APIs的实践教程</h2></div><p id="0c9c" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">作为一名数据科学家，您可能同时使用R和Python，对于某些特定的任务来说，更喜欢一种语言而不是另一种语言是很常见的。例如，对于统计、数据清理和数据可视化，您可能更喜欢R；对于NLP任务和深度学习，您可能更喜欢Python。此外，当谈到Restful APIs时，Python Flask APIs比<a class="ae ly" href="https://predictivehacks.com/rest-api-in-r-using-restrserve-plumber/" rel="noopener ugc nofollow" target="_blank"> R Plumber和rest serve</a>更有优势。</p><h2 id="c614" class="lz ma je bd mb mc md dn me mf mg dp mh ll mi mj mk lp ml mm mn lt mo mp mq jk bi translated">场景</h2><p id="212e" class="pw-post-body-paragraph lc ld je le b lf mr ko lh li ms kr lk ll mt ln lo lp mu lr ls lt mv lv lw lx im bi translated">假设您已经用Python构建了一个模型，并在此基础上构建了一个Flask API。关于UI，你更喜欢使用Shiny。因此，场景是您想要使用R Shiny共享您的Python Flask API。让我们通过一个实际操作的例子来看看如何做到这一点。</p><h2 id="33e4" class="lz ma je bd mb mc md dn me mf mg dp mh ll mi mj mk lp ml mm mn lt mo mp mq jk bi translated">烧瓶API</h2><p id="0729" class="pw-post-body-paragraph lc ld je le b lf mr ko lh li ms kr lk ll mt ln lo lp mu lr ls lt mv lv lw lx im bi translated">我们提供了一个用于情感分析的<a class="ae ly" href="https://predictivehacks.com/how-to-deploy-ml-models-into-aws-with-elastic-beanstalk/" rel="noopener ugc nofollow" target="_blank"> Flask API的例子</a>。为了方便起见，我们提供了以下代码:</p><p id="5709" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> </strong> <code class="fe mw mx my mz b"><strong class="le jo">requirements.txt</strong></code>文件如下:</p><pre class="na nb nc nd gt ne mz nf ng aw nh bi"><span id="df59" class="lz ma je mz b gy ni nj l nk nl">certifi==2020.12.5<br/>chardet==4.0.0<br/>click==7.1.2<br/>Flask==1.1.2<br/>idna==2.10<br/>itsdangerous==1.1.0<br/>Jinja2==2.11.3<br/>MarkupSafe==1.1.1<br/>requests==2.25.1<br/>urllib3==1.26.3<br/>vaderSentiment==3.3.2<br/>Werkzeug==1.0.1</span></pre><p id="14fb" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><code class="fe mw mx my mz b"><strong class="le jo">application.py</strong></code>文件:</p><pre class="na nb nc nd gt ne mz nf ng aw nh bi"><span id="d6f3" class="lz ma je mz b gy ni nj l nk nl">from flask import Flask, request, jsonify<br/>from vaderSentiment.vaderSentiment import SentimentIntensityAnalyzer<br/> <br/> <br/>analyzer = SentimentIntensityAnalyzer()<br/> <br/> <br/>application = Flask(__name__)<br/> <br/>def get_sentiment(my_text):<br/>    vs = analyzer.polarity_scores(my_text)<br/> <br/>    sentiment = ''<br/>    if vs['compound'] &gt;= 0.05:<br/>        sentiment = 'Positive'<br/>    elif vs['compound'] &lt;= -0.05:<br/>        sentiment = 'Negative'<br/>    else:<br/>        sentiment = 'Neutral'<br/> <br/>    return(sentiment)<br/> <br/> <br/> <br/><a class="ae ly" href="http://twitter.com/application" rel="noopener ugc nofollow" target="_blank">@application</a>.route("/endpoint", methods=['GET','POST'])<br/>def sentiment_endpoint():<br/>    if request.method == 'POST':<br/>        json_dict = request.get_json()<br/>        if 'my_text' in json_dict:<br/>            result = get_sentiment(json_dict['my_text'])<br/>            return jsonify({'output' : result})<br/>        else:<br/>            return jsonify({<br/>                "status": "failed",<br/>                "message": "parameter 'my_text' is required!"<br/>            })<br/> <br/>    if request.method == 'GET':<br/>    <br/>        my_text = request.args.get('my_text')<br/>        result = get_sentiment(my_text)<br/>        return jsonify({'output' : result})<br/> <br/> <br/> <br/> <br/> <br/>if __name__=='__main__':<br/>    application.run()</span></pre><h2 id="15c2" class="lz ma je bd mb mc md dn me mf mg dp mh ll mi mj mk lp ml mm mn lt mo mp mq jk bi translated">用R调用API</h2><p id="7aa2" class="pw-post-body-paragraph lc ld je le b lf mr ko lh li ms kr lk ll mt ln lo lp mu lr ls lt mv lv lw lx im bi translated">我们将提供一个例子，说明如何使用r调用上述Flask API。对于这个例子，我们在本地运行API，这就是为什么URL是<code class="fe mw mx my mz b">http://127.0.0.1:5000</code>和情感分析，路由是<code class="fe mw mx my mz b">endpoint</code>，这就是为什么我们将调用<code class="fe mw mx my mz b">http://127.0.0.1:5000/endpoint</code> URL。</p><p id="8c6c" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">让我们来体会一下这句话的含义:</p><blockquote class="nm nn no"><p id="5d00" class="lc ld np le b lf lg ko lh li lj kr lk nq lm ln lo nr lq lr ls ns lu lv lw lx im bi translated">多棒的体验啊！我觉得真的很开心🙂</p></blockquote><pre class="na nb nc nd gt ne mz nf ng aw nh bi"><span id="2a8c" class="lz ma je mz b gy ni nj l nk nl">library(jsonlite)<br/>library(httr)</span><span id="619e" class="lz ma je mz b gy nt nj l nk nl">url="<a class="ae ly" href="http://127.0.0.1:5000/endpoint" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000/endpoint</a>"</span><span id="c0bd" class="lz ma je mz b gy nt nj l nk nl">body&lt;-list(my_text="What a great experience! I feel really happy :)")</span><span id="1eac" class="lz ma je mz b gy nt nj l nk nl">b&lt;-POST(url, body = body, encode = "json")</span><span id="d9a9" class="lz ma je mz b gy nt nj l nk nl">t1&lt;-content(b, type="application/json")</span><span id="3f84" class="lz ma je mz b gy nt nj l nk nl">t1</span></pre><p id="0973" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo">输出:</strong></p><pre class="na nb nc nd gt ne mz nf ng aw nh bi"><span id="e3d5" class="lz ma je mz b gy ni nj l nk nl">$output [1] <br/>"Positive"</span></pre><p id="7eb4" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">不出所料，这句话的感情是<strong class="le jo"> <em class="np">正</em> </strong>。</p><h1 id="8bdc" class="nu ma je bd mb nv nw nx me ny nz oa mh kt ob ku mk kw oc kx mn kz od la mq oe bi translated">构建闪亮的应用程序</h1><p id="3b15" class="pw-post-body-paragraph lc ld je le b lf mr ko lh li ms kr lk ll mt ln lo lp mu lr ls lt mv lv lw lx im bi translated">我们已经提供了一个<a class="ae ly" href="https://predictivehacks.com/how-to-share-your-machine-learning-models-with-shiny/" rel="noopener ugc nofollow" target="_blank">如何与Shiny </a>分享你的机器学习模型的例子。因为我们将应用相同的架构，所以看一看它会很有帮助。</p><p id="b45a" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">闪亮的应用程序将有两个功能</p><ul class=""><li id="f456" class="of og je le b lf lg li lj ll oh lp oi lt oj lx ok ol om on bi translated">获得一个短语作为输入，并返回情感，例如“<strong class="le jo">正</strong>”、“<strong class="le jo">中性</strong>”、“<strong class="le jo">负</strong>”。</li><li id="931d" class="of og je le b lf oo li op ll oq lp or lt os lx ok ol om on bi translated">To可以选择<strong class="le jo">上传</strong>一个<code class="fe mw mx my mz b">.txt</code>文件，用制表符分隔许多短语，并通过添加情感列返回一个. txt文件。</li></ul><p id="06c0" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">让我们构建闪亮的应用程序:</p><pre class="na nb nc nd gt ne mz nf ng aw nh bi"><span id="3ac1" class="lz ma je mz b gy ni nj l nk nl">library(shiny)<br/>library(DT)<br/>library(tidyverse)<br/>library(jsonlite)<br/>library(httr)</span><span id="e165" class="lz ma je mz b gy nt nj l nk nl"># Define UI for application that draws a histogram<br/>ui &lt;- fluidPage(<br/>    <br/>    # Application title<br/>    titlePanel("Sentiment Analysis"),<br/>    <br/>    # Sidebar with a slider input for number of bins <br/>    sidebarLayout(<br/>        sidebarPanel(<br/>            <br/>            textInput("caption", label="Enter your text here.", value="", placeholder = "Phrase to get a Sentiment..."),<br/>            verbatimTextOutput("value"),<br/>            <br/>            <br/>            # Input: Select a file ----<br/>            fileInput("file1", "upload csv file here",<br/>                      multiple = FALSE,<br/>                      accept = c("text/csv",<br/>                                 "text/comma-separated-values,text/plain",<br/>                                 ".csv")), <br/>            <br/>            <br/>            # Button<br/>            downloadButton("downloadData", "Download the Predictions")<br/>        ),<br/>        <br/>        # Show the table with the predictions<br/>        mainPanel(<br/>            verbatimTextOutput("Sentiment"),<br/>            DT::dataTableOutput("mytable")<br/>        )<br/>    )<br/>)</span><span id="3aca" class="lz ma je mz b gy nt nj l nk nl"># Define server logic required to draw a histogram<br/>server &lt;- function(input, output) {<br/>    <br/>    <br/>    reactiveDF&lt;-reactive({<br/>        req(input$file1)<br/>        df &lt;- read.csv(input$file1$datapath, sep="\t", stringsAsFactors = FALSE)<br/>        <br/>        url="<a class="ae ly" href="http://127.0.0.1:5000/endpoint" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000/endpoint</a>"<br/>        <br/>        <br/>        fdf&lt;-NULL<br/>        for (i in 1:nrow(df)) {<br/>            body&lt;-list(my_text=df[i,1])<br/>            b&lt;-POST(url, body = body, encode = "json")<br/>            t1&lt;-content(b, type="application/json")<br/>            tmpdf&lt;-data.frame(InputText=df[i,1], Sentiment=t1$output)<br/>            <br/>            fdf&lt;-rbind(fdf, tmpdf)                   <br/>        }<br/>        return(fdf)<br/>        <br/>        <br/>        <br/>    })<br/>    <br/>    output$mytable &lt;- DT::renderDataTable({<br/>        req(input$file1)<br/>        <br/>        return(DT::datatable(reactiveDF(),  options = list(pageLength = 100), filter = c("top")))<br/>    })<br/>    <br/>    reactiveInput&lt;-reactive({<br/>        req(input$caption)<br/>        <br/>        <br/>        url="<a class="ae ly" href="http://127.0.0.1:5000/endpoint" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000/endpoint</a>"<br/>        <br/>        <br/>        body&lt;-list(my_text=input$caption)<br/>        <br/>        b&lt;-POST(url, body = body, encode = "json")<br/>        <br/>        t1&lt;-content(b, type="application/json")<br/>        <br/>        <br/>        df&lt;-data.frame(Sentiment=t1$output)<br/>        <br/>        return(df)<br/>        <br/>    })<br/>    <br/>    output$Sentiment&lt;-renderText({<br/>        <br/>        req(input$caption)<br/>        reactiveInput()$Sentiment<br/>        <br/>    })<br/>    <br/>    <br/>    # Downloadable csv of selected dataset ----<br/>    output$downloadData &lt;- downloadHandler(<br/>        filename = function() {<br/>            paste("data-", Sys.Date(), ".csv", sep="")<br/>        },<br/>        content = function(file) {<br/>            write.csv(reactiveDF(), file, row.names = FALSE)<br/>        }<br/>    )<br/>    <br/>    <br/>    <br/>}</span><span id="02fa" class="lz ma je mz b gy nt nj l nk nl"># Run the application <br/>shinyApp(ui = ui, server = server)</span></pre><h2 id="abb5" class="lz ma je bd mb mc md dn me mf mg dp mh ll mi mj mk lp ml mm mn lt mo mp mq jk bi translated">获得感悟</h2><p id="532d" class="pw-post-body-paragraph lc ld je le b lf mr ko lh li ms kr lk ll mt ln lo lp mu lr ls lt mv lv lw lx im bi translated">让我们看看闪亮的应用程序是如何工作的。</p><p id="5521" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo">以互动的方式获取文档的情感</strong></p><p id="2d7a" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">让我们给出以下输入作为输入:</p><blockquote class="nm nn no"><p id="0350" class="lc ld np le b lf lg ko lh li lj kr lk nq lm ln lo nr lq lr ls ns lu lv lw lx im bi translated"><em class="je">太棒了！干得好！</em></p></blockquote><p id="cec3" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">正如我们所看到的，这个闪亮的应用程序给了我们一个输入的机会，并且它以一种互动的方式返回情感</p><figure class="na nb nc nd gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/a5c0322b2495be1dd8183c6be1183c3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WliECadr0cHBCqNY.png"/></div></div></figure><p id="3a1d" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo">交互式获取多个文档的情感</strong></p><p id="455b" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">如果我们有很多文档，比如成千上万的评论，我们希望获得每一篇评论的情感，这个闪亮的应用程序给我们提供了上传数据的选项，它还可以下载这些数据，并有一个额外的情感得分栏。</p><p id="a5c2" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo">输入文件</strong></p><figure class="na nb nc nd gt iv gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/2898f1ce33e9f655ee8d5d9250a8213a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/0*p8ZiFm5w-gcp4VWP.png"/></div></figure><p id="5167" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">让我们把它上传到Shiny并得到结果:</p><figure class="na nb nc nd gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/54f36c57375469770b17e172fc9d27d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1drkxVAmBnnG5Ci7.png"/></div></div></figure><p id="3722" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">正如我们所看到的，它接受txt文件作为输入，并返回带有预测情绪的输入文本。我们也可以下载以下文件:</p><figure class="na nb nc nd gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ou"><img src="../Images/9e56ae5cefa2dd7b6648e4c43b710f9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4Q3OeEtlXWIMRZJh.png"/></div></div></figure><h1 id="9e98" class="nu ma je bd mb nv nw nx me ny nz oa mh kt ob ku mk kw oc kx mn kz od la mq oe bi translated">外卖</h1><p id="e822" class="pw-post-body-paragraph lc ld je le b lf mr ko lh li ms kr lk ll mt ln lo lp mu lr ls lt mv lv lw lx im bi translated">要点是，您可以使用Python和Flask APIs作为后端，使用Shiny作为前端，将您的模型作为应用程序共享。所以，让我们记住，Shiny可以成为Flask jinja的替代品。</p></div><div class="ab cl ov ow hx ox" role="separator"><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa"/></div><div class="im in io ip iq"><p id="1a64" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="np">原载于</em><a class="ae ly" href="https://predictivehacks.com/how-to-share-flask-apis-with-shiny-applications/" rel="noopener ugc nofollow" target="_blank"><em class="np">https://predictivehacks.com</em></a><em class="np">。</em></p></div></div>    
</body>
</html>