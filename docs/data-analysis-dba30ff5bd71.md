# 向销售预测添加疫情指数

> 原文：<https://pub.towardsai.net/data-analysis-dba30ff5bd71?source=collection_archive---------3----------------------->

## 我如何通过使用偶然推理开发指数来调整销售需求预测

![](img/6cf40e1bf7659afc21fa6401d4559a54.png)

图片来自 [Unsplash](https://unsplash.com/photos/6EnTPvPPL6I?utm_source=unsplash&utm_medium=referral&utm_content=creditShareLink)

2020 年对世界来说是一个冲击波，特别是对生产中现有的机器学习模型及其正确预测未来商业需求的能力(或缺乏能力)来说。企业要么从这种剧烈的变化中受益(无论是明显的还是不明显的)，要么从中受损。这使得需求预测模型的结果比通常情况下高估或低估需求。

减轻这些估计的一个很好的方法是创建一个捕捉这种剧烈变化的指数，并将其包含在模型预测中。

> 值得注意的是，2020 年的冲击波在不同程度上和不同时期影响了企业。这是因为世界各地在那一年的不同时间点经历了疫情病毒。因此，它对各地业务需求的影响存在滞后。

让我们通过创建一个案例研究来为这个业务问题添加更多的活力。

> 假设您在一家酒类零售店担任数据科学家，在疫情之前，您使用机器学习模型来预测未来每月的进货需求。您最近注意到模型的准确性降低了，错误率提高了。你也感受到了每月需求数量的变化。您可能会考虑到这种变化，创建一个指数来捕捉这种影响，并将其添加到模型预测中，等待这种新需求模式的有限可用数据。

考虑到这种情况，我用 4 个简单的步骤创建了疫情指数。

1.  理解数据，即趋势、季节性等
2.  检测需求模式的变化点，即这种突然的冲击从什么时候开始影响业务。
3.  捕捉这种突然冲击对业务的因果影响
4.  将此影响作为指数添加到模型预测需求中。

**关于本案例研究中使用的数据**

这是从【1992 年 1 月到【2021 年 4 月的白酒零售数据。你可以在 Kaggle 上的这里找到更多关于数据[的信息。对这些数据的一个合理假设是](https://www.kaggle.com/vishnucr/retails-sales-beer-wine-and-liquor-stores)

> 由于越来越多的人整天呆在家里，酒类需求增加，酒类的销售会增加，因为这一业务应该从疫情中获利。由于世界上大多数地方都处于封锁状态，除了独自一人喝一瓶酒放松之外，“享受美好时光”的选择更少。

这是数据的样子

作者笔记本中的表格

让我们一个接一个地总结这些步骤。

## 理解数据

这意味着像这样可视化数据随时间的变化

即来自作者的笔记本

像这样分解季节性和趋势行为

即来自作者的笔记本

从上面的两个可视化中，有四个关键点需要注意

*   需求肯定是有趋势的，而且这种趋势随着时间的推移而增加。然而，如果仔细观察趋势分量图，我们会发现这一趋势方向在 2020 年前后发生了变化，变得更加陡峭
*   这也是一个月度季节性(记住，数据时频是月度)。随着时间的推移，数据越来越多，这种季节性模式的规模也越来越大。*(该信息有助于决定使用哪个模型，即加法模型或乘法模型。在这种数据情况下，乘法模型是一个很好的选择。阅读这里了解更多* [*信息*](https://sigmundojr.medium.com/seasonality-in-python-additive-or-multiplicative-model-d4b9cf1f48a7) *)*
*   每年的 12 月份似乎总是需求量最大，次年 1 月份需求量急剧下降。这主要是因为 12 月是喜庆的月份，当然还有酒。
*   基于以上几点，该数据显然是非平稳的(没有恒定的平均值或方差)并且高度自相关(前一年的销售影响最近的销售数字)

## 检测需求模式的变化点

下一步是找出这种需求模式的突然变化是何时发生的。为此，我使用了脸书的 Kats 库，尤其是函数。此功能有助于检测时间序列数据中的突然变化。以下是可视化和结果。

即来自作者的笔记本

*你可以从* [*Kats 文档*](https://facebookresearch.github.io/Kats/) *和* [*教程*](https://github.com/facebookresearch/Kats/tree/main/tutorials) *中找到更多关于这个库的信息。*

算法的输出显示在 2020 年 5 月日**有一个突然的需求趋势变化。**

*此时，我决定将我的数据拆分成一个训练集和测试集，其中* ***训练集*** *包含 1992 年 1 月到 2020 年 8 月之间的数据点***和* ***测试集*** *包含 2020 年 9 月到 4 月之间的数据点**

## *3.捕捉对业务的因果影响*

*当计算因果关系时，你需要定义三个基本要素:前期、后期和季节性周期(如果有的话)。由于已经识别了变点月份，自动地，该月之前的所有数据点被认为是**前期数据**，即【1992 年 1 月-2020 年 4 月。我使用的**后期**在 2020 年 5 月**到 2020 年 8 月**之间(仅基于现在的训练集)。我使用了 [Google causal impact python 库](https://google.github.io/CausalImpact/CausalImpact.html)来计算因果效应，它返回了三个有意义的输出。*

*   *影响的可视化*

*即来自作者的笔记本*

*   *总结报告*

*作者笔记本中的表格*

*   *以及包含模型评估、系数等的回归表*

*作者笔记本中的表格*

*从以上三个信息中，有一些重要的东西需要注意*

*   *在上面的可视化中，蓝线显示了如果没有变化会发生什么。如果你仔细观察，我们会发现它试图**复制数据的季节性模式。**这都是因为在算法中指定了季节周期。*
*   *需求突变的**相对影响**为正，预计增长 16.7%，范围在 14.7%至 18.8%之间。这一积极迹象证实了我们之前的假设，即这项业务受益于疫情危机。*
*   ***AIC** 度量(在回归表中)为负，这是关于模型性能的另一个好迹象:**AIC 越小，模型越好。你可以在这里阅读更多关于 T21 的内容。***

*有趣的是，因果效应概率(在总结报告中)显示，这是一个 100%的偶然效应问题。*

**我决定用* ***相对效果*** *数字作为指标，而不是绝对效果*。*

*为了感受一下机器学习模型对需求销售的预测，我使用了 **prophet 算法** ( *也在* `*kats*` *库中*)来预测 2020 年 9 月**到 2020 年 4 月**的销售需求。我用训练集来训练模型。下面是可视化和数据框架*(与实际销售数字一起)*中的预测结果*****

*即来自作者的笔记本*

*作者笔记本中的表格*

*我们可以从上面观察到，该模型基于预测边界(即使用预测范围的下限和上限)低估了需求。这是意料之中的。*

## *4.将影响作为指数添加到模型预测需求中*

*这就是有趣的地方。*

*GIF 来自 [Giphy](https://giphy.com/gifs/funny-nickelodeon-bob-esponja-Dps6uX4XPOKeA)*

*记住，我们有三个**因果相对效应指数**可供选择:**下限相对效应、相对效应和上限相对效应。**而且我们有三个不同的预测界限，模型返回的是**，即下限预测，预测，上限预测**，都是低估了实际需求？*

*我创建了一个函数来调整这三个预测界限，分别使用三个相对影响界限作为指标。因此，创建一个矩阵。*

**指数乘以预测需求，因为相对影响代表百分比变化。**

*返回了包含调整后预测数字的字典。我将它们作为新列添加到预测数据框架中。看起来是这样的。*

*作者笔记本中的表格*

*为了决定哪个**预测估计值+相对效应指数组合**更有意义，我使用以下指标测量了所有预测数字(即实际预测值和调整后的预测值)的误差: **MAE** 、 **RMSE、**和 **MAPE** 。您可以在这里找到关于这些指标[的更多信息。](https://blog.exploratory.io/a-gentle-introduction-to-backtesting-for-evaluating-the-prophet-forecasting-models-66c132adc37c)*

*以下表格根据以下指标比较了所有调整后的预测组合**以及原始预测**:**MAE**， **RMSE，**和 **MAPE***

*作者笔记本中的表格*

**(这些误差非常大，可以通过改进模型/数据来减少，但这不是本案例研究的重点)**

***看着上面的表格…***

*虽然**实际预测+下限相对效果指数**在 **MAE** 和 **MAPE** 方面误差最小，但是我们看到**下限预测+下限相对效果指数**在 **RMSE** 方面误差最小。*

> *在这种情况下，我会选择 RMSE 最低的选项，因为 RSME 对更重要的错误赋予了更大的权重。*

## *假设我们决定坚持这个逻辑，并将这个指数添加到我们的生产模型中。接下来呢？*

*部署模型的一个关键部分是随着时间的推移进行监控和维护。*

*在这种商业案例中，额外的监控*(除了模型随时间的表现和用新数据重新训练模型)*需要定期检查新的变化点，即销售需求趋势是否已经恢复正常或发生了不同的变化。并且用更多的数据重新检查因果影响。这些信息将有助于决定是应该删除指数还是改进预测逻辑。*

> ****注意，建立机器学习模型是一个非常迭代的过程。在将模型推向生产之前，还有其他方法来改善模型性能和结果，如转换数据的非平稳性，向偶然影响模型添加控制组来改善它等*** 。*

*在 [Github](https://github.com/anitaokoh/Building-a-pandemic-index-for-sales-forecast) 上找到所有代码和输出。*

## ***其他参考文献***

*   *[Kats:用 Python 分析时间序列数据的通用框架](https://towardsdatascience.com/kats-a-generalizable-framework-to-analyze-time-series-data-in-python-3c8d21efe057)*
*   *[用因果影响 BSTS 估计对金融时间序列的因果影响](https://towardsdatascience.com/estimating-causal-effects-on-financial-time-series-with-causal-impact-bsts-85d3c403f4a0)*