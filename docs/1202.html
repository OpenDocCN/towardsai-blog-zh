<html>
<head>
<title>Big QueryML: Machine Learning for Data Scientists using SQL on Google Cloud Platform Quick Start Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Big QueryML:数据科学家在谷歌云平台上使用SQL的机器学习快速入门指南</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/big-queryml-machine-learning-for-data-scientists-using-sql-on-google-cloud-platform-quick-start-d9eec7b8641?source=collection_archive---------2-----------------------#2020-12-01">https://pub.towardsai.net/big-queryml-machine-learning-for-data-scientists-using-sql-on-google-cloud-platform-quick-start-d9eec7b8641?source=collection_archive---------2-----------------------#2020-12-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="e7d8" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/cloud-computing" rel="noopener ugc nofollow" target="_blank">云计算</a></h2><div class=""/><figure class="gl gn jx jy jz ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/af87c659bace17eef9e34b5cfd7fb0f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afZUCqsL-nk4Nshxdbps4w.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">来源:<a class="ae kl" href="https://blog.google/products/google-cloud/cloud-covered-what-was-new-with-google-cloud-in-october-2019/" rel="noopener ugc nofollow" target="_blank">谷歌</a></figcaption></figure><p id="28c4" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我希望你一切都好。这是一个迟到的帖子，因为我一直在努力保持健康。我已经通过学习新的技术和平台提升了自己的技能，并渴望与大家分享我的知识。别再浪费时间了，今天让我们学点新东西。</p><p id="5be9" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">云计算已经存在了一段时间，但由于疫情和IT公司意识到了好处和权衡，采用的速度如今已经呈指数级增长。有3个主要的云服务提供商:AWS、微软和GCP。</p><p id="210f" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">谷歌云计算服务已经存在了一段时间，但由于多种原因，比如提供的服务数量有限，其采用率一直很低。虽然谷歌已经率先在云上进行创新，例如，大数据的大表，无服务器编排的Kubernetes，等等，但它在营销自己方面一直很慢(GCP服务)。</p><p id="88a8" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">也就是说，如果你是云计算的新手，不知道该学习哪个平台，你可能不会意识到其中的区别，但是在使用了所有的云服务(AWS、GCP、Azure)之后，我已经意识到了每个平台的优缺点。如果你问我，我会说AWS有一个优秀的云服务营销战略和技术，可以在接触客户时领先一步，而且很容易使用。谷歌云平台是一个同样成熟的生态系统，确实提供了比其他平台更快部署和创建的服务，尽管与AWS相比，该平台更适合极客群体，AWS在每个步骤上都有更好的指南和文档资源。</p><p id="8243" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，有数据背景的人会认识到数据仓库对于改进商业决策的重要性。GCP提供了一个引人注目的数据仓库服务BigQuery。BigQuery允许在几秒钟内存储和查询数Pb的数据进行分析。</p><p id="e119" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">作为一名数据科学家，您现在可以使用BigQuery上的SQL直接创建和运行您的模型来回答业务问题。今天的教程就是关于这些的，所以让我们开始吧。</p><p id="083a" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja">先决条件:</strong></p><p id="b420" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您需要访问BigQuery服务。你可以免费试用。看看这个<a class="ae kl" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">链接。</a></p><p id="1d18" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您还需要访问我们将创建的数据集。请注意，当您运行SQL查询时，big-query会对处理的数据量收费，因此要对您查询的内容保持谨慎。</p><p id="7cc5" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您还需要对SQL有所了解，才能理解查询的是什么数据。</p><p id="a08a" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja">步骤:</strong></p><ol class=""><li id="385f" class="lk ll iq ko b kp kq kt ku kx lm lb ln lf lo lj lp lq lr ls bi translated">打开谷歌平台控制台，导航至BigQuery服务:<a class="ae kl" href="https://console.cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">链接</a></li></ol><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/f5ca9cdb035dfc65e0555a2394575f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f32jOO9hXb0_aXLiP118Ow.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图1</figcaption></figure><p id="e685" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">2.点击此<a class="ae kl" href="https://console.cloud.google.com/bigquery?p=data-to-insights&amp;d=ecommerce&amp;t=web_analytics&amp;page=table" rel="noopener ugc nofollow" target="_blank">链接</a>，添加数据到洞察数据集。</p><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/9915e8b861c9a8f1420b1e87135e3798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8OdTnZ42hBAp9ZBTMc_B5A.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图2</figcaption></figure><p id="2f82" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja"> 3。我们来做一些数据探索:</strong></p><p id="7085" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们试着找出访问我们网站的所有访问者中，有百分之多少进行了购买？</p><p id="3780" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在查询编辑器中粘贴以下SQL查询:</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="b04e" class="mc md iq ly b gy me mf l mg mh">WITH visitors AS</span><span id="f210" class="mc md iq ly b gy mi mf l mg mh">( SELECT</span><span id="1578" class="mc md iq ly b gy mi mf l mg mh">COUNT(DISTINCT fullVisitorId) AS total_visitors</span><span id="a29f" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`</span><span id="dc6d" class="mc md iq ly b gy mi mf l mg mh">),</span><span id="e511" class="mc md iq ly b gy mi mf l mg mh">purchasers AS(</span><span id="676a" class="mc md iq ly b gy mi mf l mg mh">SELECT</span><span id="41be" class="mc md iq ly b gy mi mf l mg mh">COUNT(DISTINCT fullVisitorId) AS total_purchasers</span><span id="e742" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`</span><span id="ac6f" class="mc md iq ly b gy mi mf l mg mh">WHERE totals.transactions IS NOT NULL</span><span id="0aed" class="mc md iq ly b gy mi mf l mg mh">)</span><span id="0164" class="mc md iq ly b gy mi mf l mg mh">SELECT</span><span id="a454" class="mc md iq ly b gy mi mf l mg mh">total_visitors,</span><span id="0800" class="mc md iq ly b gy mi mf l mg mh">total_purchasers,</span><span id="42f8" class="mc md iq ly b gy mi mf l mg mh">total_purchasers / total_visitors AS conversion_rate</span><span id="9130" class="mc md iq ly b gy mi mf l mg mh">FROM visitors, purchasers</span></pre><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/c6d0570102c9acc9aa6bd5dffe7f2796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQuHLs7fXIY3Vxama0mC_w.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图三</figcaption></figure><p id="c0b7" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们试着用电子商务数据算出市场上最畅销的5种产品。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="7383" class="mc md iq ly b gy me mf l mg mh">SELECT</span><span id="f1a5" class="mc md iq ly b gy mi mf l mg mh">p.v2ProductName,</span><span id="6e9e" class="mc md iq ly b gy mi mf l mg mh">p.v2ProductCategory,</span><span id="82d4" class="mc md iq ly b gy mi mf l mg mh">SUM(p.productQuantity) AS units_sold,</span><span id="b8b3" class="mc md iq ly b gy mi mf l mg mh">ROUND(SUM(p.localProductRevenue/1000000),2) AS revenue</span><span id="dacc" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`,</span><span id="b101" class="mc md iq ly b gy mi mf l mg mh">UNNEST(hits) AS h,</span><span id="b4c5" class="mc md iq ly b gy mi mf l mg mh">UNNEST(h.product) AS p</span><span id="bf6c" class="mc md iq ly b gy mi mf l mg mh">GROUP BY 1, 2</span><span id="3e75" class="mc md iq ly b gy mi mf l mg mh">ORDER BY revenue DESC</span><span id="6cd0" class="mc md iq ly b gy mi mf l mg mh">LIMIT 5;</span></pre><p id="cbd1" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们不会讨论SQL的每一种语法，但是如果你了解SQL，你会发现它很容易理解。UNNEST关键字展平数组以分隔表中的记录。</p><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/32731ea4c2dcf080b5c0f1ca5a93e05a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eZxYkJE-_MpQV_srcIy0CA.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图4</figcaption></figure><p id="c8fe" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们能回答有多少访问者在下次访问网站时购买了产品吗？</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="b21b" class="mc md iq ly b gy me mf l mg mh">WITH all_visitor_stats AS (</span><span id="a510" class="mc md iq ly b gy mi mf l mg mh">SELECT</span><span id="7955" class="mc md iq ly b gy mi mf l mg mh">fullvisitorid, </span><span id="6556" class="mc md iq ly b gy mi mf l mg mh">IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, 1, 0) AS will_buy_on_return_visit</span><span id="7d4e" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`</span><span id="cc3c" class="mc md iq ly b gy mi mf l mg mh">GROUP BY fullvisitorid</span><span id="a74e" class="mc md iq ly b gy mi mf l mg mh">)</span><span id="a9cb" class="mc md iq ly b gy mi mf l mg mh">SELECT</span><span id="cad7" class="mc md iq ly b gy mi mf l mg mh">COUNT(DISTINCT fullvisitorid) AS total_visitors,</span><span id="bb5b" class="mc md iq ly b gy mi mf l mg mh">will_buy_on_return_visit</span><span id="5754" class="mc md iq ly b gy mi mf l mg mh">FROM all_visitor_stats</span><span id="5b93" class="mc md iq ly b gy mi mf l mg mh">GROUP BY will_buy_on_return_visitcontent</span></pre><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/e314e34411ffce61a84037efd9aca835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nGLegl6Q09UR24ukZ5m6Og.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图5</figcaption></figure><p id="49d7" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">只有一小部分访问者会再次访问来购买产品，当我们联系到现实世界的场景时，这是有意义的:你可能会访问一个网站来浏览或比较产品，但可能不会购买它们。</p><p id="5ed6" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja"> 4。我们来做一个特征选择来回答一个机器学习的问题:</strong></p><p id="1df5" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">预测用户将来是否有可能购买。</p><p id="7027" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们使用big-query中的一些特性创建一个基线模型。对于这个领域，需要专业知识或与谷歌分析电子商务数据的前期工作。假设我们现在选择两个与购买决策相关的特性，反弹和现场时间。现在，您可以添加更多功能，但这超出了我们的基础知识范围。对于我们的情况，我们需要一个逻辑回归模型。</p><p id="69eb" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们将创建一个数据集，在其中保存模型。</p><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/792af12992d0c1b7c9a05f4b917750d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EPgAEC8pk9kA_ceeGM5JDg.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图6</figcaption></figure><p id="d6b6" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">创建数据集后，我们将创建一个逻辑回归模型。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="dd10" class="mc md iq ly b gy me mf l mg mh">CREATE OR REPLACE MODEL `mydataset.classification_model`<br/>OPTIONS<br/>(<br/>model_type=’logistic_reg’,<br/>labels = [‘will_buy_on_return_visit’]<br/>)<br/>AS</span><span id="0d14" class="mc md iq ly b gy mi mf l mg mh">#standardSQL<br/>SELECT<br/> * EXCEPT(fullVisitorId)<br/>FROM</span><span id="d05d" class="mc md iq ly b gy mi mf l mg mh"># features<br/> (SELECT<br/> fullVisitorId,<br/> IFNULL(totals.bounces, 0) AS bounces,<br/> IFNULL(totals.timeOnSite, 0) AS time_on_site<br/> FROM<br/> `data-to-insights.ecommerce.web_analytics`<br/> WHERE<br/> totals.newVisits = 1<br/> AND date BETWEEN ‘20160801’ AND ‘20170430’) # train on first 9 months<br/> JOIN<br/> (SELECT<br/> fullvisitorid,<br/> IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, 1, 0) AS will_buy_on_return_visit<br/> FROM<br/> `data-to-insights.ecommerce.web_analytics`<br/> GROUP BY fullvisitorid)<br/> USING (fullVisitorId);</span></pre><p id="2aa2" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦创建了模型，您就可以探索这个模型了。</p><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/61477413f0551f0e40e473bff8e57d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iaqiwc_5o0GJYxm-pIJUGQ.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图7</figcaption></figure><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/676e052164d5c311bccf28ffd244f49f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mmbBUBXAp7cMbYJRMVkgwA.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图8</figcaption></figure><p id="2799" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja"> 5。模型评估:</strong></p><p id="cb30" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您可以使用以下查询并检查roc_auc来评估模型。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="a5d8" class="mc md iq ly b gy me mf l mg mh">SELECT<br/> roc_auc,<br/> CASE<br/> WHEN roc_auc &gt; .9 THEN ‘good’<br/> WHEN roc_auc &gt; .8 THEN ‘fair’<br/> WHEN roc_auc &gt; .7 THEN ‘not great’<br/> ELSE ‘poor’ END AS model_quality<br/>FROM<br/> ML.EVALUATE(MODEL mydataset.classification_model, (</span><span id="5812" class="mc md iq ly b gy mi mf l mg mh">SELECT<br/> * EXCEPT(fullVisitorId)<br/>FROM</span><span id="8b4b" class="mc md iq ly b gy mi mf l mg mh"># features<br/> (SELECT<br/> fullVisitorId,<br/> IFNULL(totals.bounces, 0) AS bounces,<br/> IFNULL(totals.timeOnSite, 0) AS time_on_site<br/> FROM<br/> `data-to-insights.ecommerce.web_analytics`<br/> WHERE<br/> totals.newVisits = 1<br/> AND date BETWEEN ‘20170501’ AND ‘20170630’) # eval on 2 months<br/> JOIN<br/> (SELECT<br/> fullvisitorid,<br/> IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, 1, 0) AS will_buy_on_return_visit<br/> FROM<br/> `data-to-insights.ecommerce.web_analytics`<br/> GROUP BY fullvisitorid)<br/> USING (fullVisitorId)));</span></pre><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/03df1026bb8aec4a4d25cc2ade3aaca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d0JwURYady5T4JDIl-JipQ.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图9</figcaption></figure><p id="0b25" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja"> 6。特征工程:</strong></p><p id="4786" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在，我们可以尝试通过添加更多的功能来改进该模型。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="274e" class="mc md iq ly b gy me mf l mg mh">CREATE OR REPLACE MODEL `mydataset.classification_model_2`<br/>OPTIONS<br/> (model_type=’logistic_reg’, labels = [‘will_buy_on_return_visit’]) AS</span><span id="55fa" class="mc md iq ly b gy mi mf l mg mh">WITH all_visitor_stats AS (<br/>SELECT<br/> fullvisitorid,<br/> IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, 1, 0) AS will_buy_on_return_visit<br/> FROM `data-to-insights.ecommerce.web_analytics`<br/> GROUP BY fullvisitorid<br/>)</span><span id="b354" class="mc md iq ly b gy mi mf l mg mh"># add in new features<br/>SELECT * EXCEPT(unique_session_id) FROM (</span><span id="9592" class="mc md iq ly b gy mi mf l mg mh">SELECT<br/> CONCAT(fullvisitorid, CAST(visitId AS STRING)) AS unique_session_id,</span><span id="e449" class="mc md iq ly b gy mi mf l mg mh"># labels<br/> will_buy_on_return_visit,</span><span id="b656" class="mc md iq ly b gy mi mf l mg mh">MAX(CAST(h.eCommerceAction.action_type AS INT64)) AS latest_ecommerce_progress,</span><span id="9ac9" class="mc md iq ly b gy mi mf l mg mh"># behavior on the site<br/> IFNULL(totals.bounces, 0) AS bounces,<br/> IFNULL(totals.timeOnSite, 0) AS time_on_site,<br/> totals.pageviews,</span><span id="2203" class="mc md iq ly b gy mi mf l mg mh"># where the visitor came from<br/> trafficSource.source,<br/> trafficSource.medium,<br/> channelGrouping,</span><span id="88ce" class="mc md iq ly b gy mi mf l mg mh"># mobile or desktop<br/> device.deviceCategory,</span><span id="4960" class="mc md iq ly b gy mi mf l mg mh"># geographic<br/> IFNULL(geoNetwork.country, “”) AS country</span><span id="fc21" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`,<br/> UNNEST(hits) AS h</span><span id="3df7" class="mc md iq ly b gy mi mf l mg mh">JOIN all_visitor_stats USING(fullvisitorid)</span><span id="fc7b" class="mc md iq ly b gy mi mf l mg mh">WHERE 1=1<br/> # only predict for new visits<br/> AND totals.newVisits = 1<br/> AND date BETWEEN ‘20160801’ AND ‘20170430’ # train 9 months</span><span id="6888" class="mc md iq ly b gy mi mf l mg mh">GROUP BY<br/> unique_session_id,<br/> will_buy_on_return_visit,<br/> bounces,<br/> time_on_site,<br/> totals.pageviews,<br/> trafficSource.source,<br/> trafficSource.medium,<br/> channelGrouping,<br/> device.deviceCategory,<br/> country<br/>);</span></pre><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/46cedbb2731a23c5ee1417a74fd59d5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*261X4u2El1aGjt3p7nQyCQ.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图10</figcaption></figure><p id="6294" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们来评价一下模型。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="87f7" class="mc md iq ly b gy me mf l mg mh">SELECT<br/> roc_auc,<br/> CASE<br/> WHEN roc_auc &gt; .9 THEN ‘good’<br/> WHEN roc_auc &gt; .8 THEN ‘fair’<br/> WHEN roc_auc &gt; .7 THEN ‘not great’<br/> ELSE ‘poor’ END AS model_quality<br/>FROM<br/> ML.EVALUATE(MODEL mydataset.classification_model_2, (</span><span id="497f" class="mc md iq ly b gy mi mf l mg mh">WITH all_visitor_stats AS (<br/>SELECT<br/> fullvisitorid,<br/> IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, 1, 0) AS will_buy_on_return_visit<br/> FROM `data-to-insights.ecommerce.web_analytics`<br/> GROUP BY fullvisitorid<br/>)</span><span id="2201" class="mc md iq ly b gy mi mf l mg mh"># add in new features<br/>SELECT * EXCEPT(unique_session_id) FROM (</span><span id="989e" class="mc md iq ly b gy mi mf l mg mh">SELECT<br/> CONCAT(fullvisitorid, CAST(visitId AS STRING)) AS unique_session_id,</span><span id="513a" class="mc md iq ly b gy mi mf l mg mh"># labels<br/> will_buy_on_return_visit,</span><span id="f716" class="mc md iq ly b gy mi mf l mg mh">MAX(CAST(h.eCommerceAction.action_type AS INT64)) AS latest_ecommerce_progress,</span><span id="136e" class="mc md iq ly b gy mi mf l mg mh"># behavior on the site<br/> IFNULL(totals.bounces, 0) AS bounces,<br/> IFNULL(totals.timeOnSite, 0) AS time_on_site,<br/> totals.pageviews,</span><span id="d5f6" class="mc md iq ly b gy mi mf l mg mh"># where the visitor came from<br/> trafficSource.source,<br/> trafficSource.medium,<br/> channelGrouping,</span><span id="5db7" class="mc md iq ly b gy mi mf l mg mh"># mobile or desktop<br/> device.deviceCategory,</span><span id="ff3d" class="mc md iq ly b gy mi mf l mg mh"># geographic<br/> IFNULL(geoNetwork.country, “”) AS country</span><span id="d2d9" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`,<br/> UNNEST(hits) AS h</span><span id="af64" class="mc md iq ly b gy mi mf l mg mh">JOIN all_visitor_stats USING(fullvisitorid)</span><span id="412a" class="mc md iq ly b gy mi mf l mg mh">WHERE 1=1<br/> # only predict for new visits<br/> AND totals.newVisits = 1<br/> AND date BETWEEN ‘20170501’ AND ‘20170630’ # eval 2 months</span><span id="cd7a" class="mc md iq ly b gy mi mf l mg mh">GROUP BY<br/> unique_session_id,<br/> will_buy_on_return_visit,<br/> bounces,<br/> time_on_site,<br/> totals.pageviews,<br/> trafficSource.source,<br/> trafficSource.medium,<br/> channelGrouping,<br/> device.deviceCategory,<br/> country<br/>)<br/>));</span></pre><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/532235313bd6ee621bb86d3022cdccab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rDIRanxviYj4Ra0QmACB9A.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图11</figcaption></figure><p id="9f12" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">模型改进了很多。</p><p id="6512" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja"> 7。预测:</strong></p><p id="0841" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在我们来预测一下所有会成为顾客的新访客。</p><pre class="lt lu lv lw gt lx ly lz ma aw mb bi"><span id="049b" class="mc md iq ly b gy me mf l mg mh">SELECT</span><span id="32ca" class="mc md iq ly b gy mi mf l mg mh">*</span><span id="1f71" class="mc md iq ly b gy mi mf l mg mh">FROM</span><span id="bb9c" class="mc md iq ly b gy mi mf l mg mh">ml.PREDICT(MODEL `ecommerce.classification_model_2`,</span><span id="4a42" class="mc md iq ly b gy mi mf l mg mh">(</span><span id="a373" class="mc md iq ly b gy mi mf l mg mh">WITH all_visitor_stats AS (</span><span id="84ec" class="mc md iq ly b gy mi mf l mg mh">SELECT</span><span id="ce19" class="mc md iq ly b gy mi mf l mg mh">fullvisitorid,</span><span id="5971" class="mc md iq ly b gy mi mf l mg mh">IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, 1, 0) AS will_buy_on_return_visit</span><span id="f655" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`</span><span id="3142" class="mc md iq ly b gy mi mf l mg mh">GROUP BY fullvisitorid</span><span id="06e0" class="mc md iq ly b gy mi mf l mg mh">)</span><span id="2941" class="mc md iq ly b gy mi mf l mg mh">SELECT</span><span id="c1f6" class="mc md iq ly b gy mi mf l mg mh">CONCAT(fullvisitorid, ‘-’,CAST(visitId AS STRING)) AS unique_session_id,</span><span id="d0b4" class="mc md iq ly b gy mi mf l mg mh"><em class="mj"># labels</em></span><span id="ab7a" class="mc md iq ly b gy mi mf l mg mh">will_buy_on_return_visit,</span><span id="3fd0" class="mc md iq ly b gy mi mf l mg mh">MAX(CAST(h.eCommerceAction.action_type AS INT64)) AS latest_ecommerce_progress,</span><span id="f620" class="mc md iq ly b gy mi mf l mg mh"><em class="mj"># behavior on the site</em></span><span id="392e" class="mc md iq ly b gy mi mf l mg mh">IFNULL(totals.bounces, 0) AS bounces,</span><span id="5bca" class="mc md iq ly b gy mi mf l mg mh">IFNULL(totals.timeOnSite, 0) AS time_on_site,</span><span id="a2b8" class="mc md iq ly b gy mi mf l mg mh">totals.pageviews,</span><span id="2864" class="mc md iq ly b gy mi mf l mg mh"><em class="mj"># where the visitor came from</em></span><span id="8e56" class="mc md iq ly b gy mi mf l mg mh">trafficSource.source,</span><span id="5c66" class="mc md iq ly b gy mi mf l mg mh">trafficSource.medium,</span><span id="3e6b" class="mc md iq ly b gy mi mf l mg mh">channelGrouping,</span><span id="6867" class="mc md iq ly b gy mi mf l mg mh"><em class="mj"># mobile or desktop</em></span><span id="0107" class="mc md iq ly b gy mi mf l mg mh">device.deviceCategory,</span><span id="541b" class="mc md iq ly b gy mi mf l mg mh"><em class="mj"># geographic</em></span><span id="7fad" class="mc md iq ly b gy mi mf l mg mh">IFNULL(geoNetwork.country, “”) AS country</span><span id="575e" class="mc md iq ly b gy mi mf l mg mh">FROM `data-to-insights.ecommerce.web_analytics`,</span><span id="2698" class="mc md iq ly b gy mi mf l mg mh">UNNEST(hits) AS h</span><span id="a349" class="mc md iq ly b gy mi mf l mg mh">JOIN all_visitor_stats USING(fullvisitorid)</span><span id="561b" class="mc md iq ly b gy mi mf l mg mh">WHERE</span><span id="8d1c" class="mc md iq ly b gy mi mf l mg mh"><em class="mj"># only predict for new visits</em></span><span id="5cf6" class="mc md iq ly b gy mi mf l mg mh">totals.newVisits = 1</span><span id="4a85" class="mc md iq ly b gy mi mf l mg mh">AND date BETWEEN ‘20170701’ AND ‘20170801’ <em class="mj"># test 1 month</em></span><span id="0eed" class="mc md iq ly b gy mi mf l mg mh">GROUP BY</span><span id="108d" class="mc md iq ly b gy mi mf l mg mh">unique_session_id,</span><span id="9f3f" class="mc md iq ly b gy mi mf l mg mh">will_buy_on_return_visit,</span><span id="d097" class="mc md iq ly b gy mi mf l mg mh">bounces,</span><span id="4832" class="mc md iq ly b gy mi mf l mg mh">time_on_site,</span><span id="4d55" class="mc md iq ly b gy mi mf l mg mh">totals.pageviews,</span><span id="6247" class="mc md iq ly b gy mi mf l mg mh">trafficSource.source,</span><span id="fc7c" class="mc md iq ly b gy mi mf l mg mh">trafficSource.medium,</span><span id="3f5f" class="mc md iq ly b gy mi mf l mg mh">channelGrouping,</span><span id="5735" class="mc md iq ly b gy mi mf l mg mh">device.deviceCategory,</span><span id="bc8e" class="mc md iq ly b gy mi mf l mg mh">country</span><span id="0ad7" class="mc md iq ly b gy mi mf l mg mh">)</span><span id="70d8" class="mc md iq ly b gy mi mf l mg mh">)</span><span id="ed27" class="mc md iq ly b gy mi mf l mg mh">ORDER BY</span><span id="8d1e" class="mc md iq ly b gy mi mf l mg mh">predicted_will_buy_on_return_visit DESC;</span></pre><figure class="lt lu lv lw gt ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/7c4dd221707999d6de9e11551d0d0928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gqVXfpdARzxxA9-fiOwDQ.png"/></div></div><figcaption class="kh ki gj gh gi kj kk bd b be z dk translated">截图12</figcaption></figure><p id="5583" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">是不是很轻松很好玩？</p><p id="4132" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我希望你喜欢这篇文章。如果您有任何疑问或建议，请让我知道您的想法，我们希望听到更多您的意见。敬请关注未来的帖子。</p><p id="62aa" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你可以关注我关于人工智能/机器学习、数据分析和商业智能的教程。你可以在<a class="ae kl" href="https://www.linkedin.com/in/anurag-bisht-39935a59/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上联系我。</p></div></div>    
</body>
</html>