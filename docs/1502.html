<html>
<head>
<title>PySpark Snowflake Data Warehouse Read Write operations — Part1 (Read-Only)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PySpark雪花数据仓库读写操作—第1部分(只读)</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/pyspark-snowflake-data-warehouse-read-write-operations-part1-read-only-3331d113635e?source=collection_archive---------2-----------------------#2021-02-08">https://pub.towardsai.net/pyspark-snowflake-data-warehouse-read-write-operations-part1-read-only-3331d113635e?source=collection_archive---------2-----------------------#2021-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="d65e" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/programming" rel="noopener ugc nofollow" target="_blank">编程</a></h2><div class=""/><p id="f8d2" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这个故事的目标是使用Apache Spark API，Pyspark来理解对雪花数据仓库表的读写操作。</p><p id="f857" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">雪花是一个基于云的数据仓库解决方案，旨在提高可扩展性和性能。在我接下来的博客中，我肯定会分享关于雪花及其组件的详细见解，但目前把它作为一个基于云的数据库系统，具有大规模并行处理和巨大的计算能力，所以现在我将只限于雪花和Spark相关的东西。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ku"><img src="../Images/9b385ede6671ec4ab15c3156e1d69ec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vur2U14SA1cMOK3x9Yd-CQ.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">py spark-雪花</figcaption></figure><ol class=""><li id="a3b7" class="lk ll iq jy b jz ka kd ke kh lm kl ln kp lo kt lp lq lr ls bi translated"><strong class="jy ja">从亚马逊S3桶加载数据到雪花DB表</strong></li></ol><blockquote class="lt lu lv"><p id="68d7" class="jw jx lw jy b jz ka kb kc kd ke kf kg lx ki kj kk ly km kn ko lz kq kr ks kt ij bi translated">雪花提供30天免费试用。创建您的免费等级帐户，享受学习的好处。</p></blockquote><p id="b921" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">AWS S3时段中的数据:</strong></p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ma"><img src="../Images/1314e7ec36e4b3cecd9731dd962f11c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Oqos_GNVTCV0pMG9xP-pg.png"/></div></div></figure><p id="dacd" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">雪花表加载数据前的设置:</strong></p><ol class=""><li id="f35a" class="lk ll iq jy b jz ka kd ke kh lm kl ln kp lo kt lp lq lr ls bi translated">创建<strong class="jy ja">雪花自由层账户</strong>并创建<strong class="jy ja">数据库</strong>如下:</li></ol><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mb"><img src="../Images/ce9f499720ef3f30b6f3b87ee22314c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4y9crLGhoXQlFvPC0Fk9g.png"/></div></div></figure><p id="c3c9" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">2.创建一个指向AWS S3存储桶的<strong class="jy ja">阶段</strong>:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mc"><img src="../Images/7ee72ae4f90a7c82b381b258842896fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhyGuUHwghdLw-1nlzpjpg.png"/></div></div></figure><p id="5275" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">3.在<strong class="jy ja">文件格式</strong>选项卡下，创建一个CSV文件格式，用于将数据从AWS S3加载到雪花表格。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi md"><img src="../Images/7a3a600c38e71aac48c6187ab09e059c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*txhiFK2OITGE6AWQVpg0dg.png"/></div></figure><p id="69df" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">4.下一步是创建雪花表<strong class="jy ja">“EMP”，</strong>转到<strong class="jy ja">工作表</strong>选项卡，执行SnowSQL DDL命令创建一个表。</p><pre class="kv kw kx ky gt me mf mg mh aw mi bi"><span id="1124" class="mj mk iq mf b gy ml mm l mn mo">create table emp( empno INTEGER, <br/> ename string, <br/> sal integer, <br/> deptno integer, <br/> comm integer);</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/73ed9cd7323a1751333f7eeef925be6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*2J5OLjAgdXA_LA0o--AyLQ.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">Snow DDL</figcaption></figure><p id="d9a4" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">5.接下来，将数据从AWS S3复制到雪花表。</p><pre class="kv kw kx ky gt me mf mg mh aw mi bi"><span id="69e3" class="mj mk iq mf b gy ml mm l mn mo">copy into learning_db.emp <br/>from <a class="ae mq" href="http://twitter.com/csv_data_loads/emp" rel="noopener ugc nofollow" target="_blank">@csv_data_loads/emp</a>.csv file_format=csv_loads<br/>on_error=’skip_file’;</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/1f46fcac7ff11eb1dbf6ce4aea61ba72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*LB9GrUuFTTt_5T21kNXlNQ.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">数据复制命令</figcaption></figure><blockquote class="lt lu lv"><p id="61cd" class="jw jx lw jy b jz ka kb kc kd ke kf kg lx ki kj kk ly km kn ko lz kq kr ks kt ij bi translated"><strong class="jy ja"> csv_data_loads </strong>表示我们指向S3桶<strong class="jy ja">的<strong class="jy ja">阶段</strong>位置csv_loads </strong>是我们为csv数据集创建的<strong class="jy ja">文件格式</strong>。</p></blockquote><p id="86ed" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">使用SnowSQL验证数据集:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ms"><img src="../Images/27977dc8914133eddd3b9134bf5ce542.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tBf9uiitgwz8bQfTRJpWpg.png"/></div></div></figure><p id="aa61" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">数据成功加载到雪花。</p><p id="3938" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja"> 2。使用PySpark读取雪花表。</strong></p><p id="1590" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">导入先决条件并设置spark配置:</p><pre class="kv kw kx ky gt me mf mg mh aw mi bi"><span id="a58e" class="mj mk iq mf b gy ml mm l mn mo">import findspark<br/>findspark.init(‘D:\spark-2.3.3-bin-hadoop2.7’)<br/>import pyspark<br/>from pyspark.sql import SparkSession<br/>from pyspark import SparkContext, SparkConf</span><span id="4ef3" class="mj mk iq mf b gy mt mm l mn mo">import os<br/>os.environ[‘PYSPARK_SUBMIT_ARGS’] = ‘ — packages net.snowflake:snowflake-jdbc:3.11.1,net.snowflake:spark-snowflake_2.11:2.5.7-spark_2.4 pyspark-shell’</span><span id="7f5f" class="mj mk iq mf b gy mt mm l mn mo">spark = SparkSession.builder.appName(‘Pyspark_snowflake’).getOrCreate()<br/>spark._jvm.net.snowflake.spark.snowflake.SnowflakeConnectorUtils.enablePushdownSession(spark._jvm.org.apache.spark.sql.SparkSession.builder().getOrCreate())</span></pre><p id="4f81" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">设置雪花连接属性:</p><pre class="kv kw kx ky gt me mf mg mh aw mi bi"><span id="cc2f" class="mj mk iq mf b gy ml mm l mn mo">sfOptions = {<br/> “sfURL” : “wa29709.ap-south-1.aws.snowflakecomputing.com”,<br/> “sfAccount” : “xxxxxxx”,<br/> “sfUser” : “xxxxxxxx”,<br/> “sfPassword” : “xxxxxxx”,<br/> “sfDatabase” : “learning_db”,<br/> “sfSchema” : “public”,<br/> “sfWarehouse” : “compute_wh”,<br/> “sfRole” : “sysadmin”,<br/>}<br/> <br/>SNOWFLAKE_SOURCE_NAME = “net.snowflake.spark.snowflake”</span><span id="22ee" class="mj mk iq mf b gy mt mm l mn mo">df=spark.read.format(SNOWFLAKE_SOURCE_NAME).options(**sfOptions).option(“query”,”select * from emp”).load()<br/>df.show()</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/b886ded20bef81eced3a3bd6f2ad90a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*V3roysnZd9D-4ljHa5xPyw.png"/></div></figure><p id="60e9" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">数据验证成功后，我们可以连接到spark并将雪花表中的数据读入Spark。</p><h1 id="d390" class="mv mk iq bd mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr bi translated">总结:</h1><p id="11f1" class="pw-post-body-paragraph jw jx iq jy b jz ns kb kc kd nt kf kg kh nu kj kk kl nv kn ko kp nw kr ks kt ij bi translated">将AWS S3数据加载到雪花数据库表中</p><p id="0a42" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">雪花阶段和文件格式创建。</p><p id="ab2e" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">SnowSQL命令如DDL和复制数据。</p><p id="676b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">使用Pyspark读取雪花表数据</p><p id="5403" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">感谢大家阅读我的博客。请分享您的观点和反馈。</p></div></div>    
</body>
</html>