<html>
<head>
<title>IoT Real-Time Analytics — WAGO PLC with Databricks Auto Loader</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">物联网实时分析— WAGO PLC和Databricks自动加载器</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/iot-real-time-analytics-wago-plc-with-databricks-auto-loader-4cd9d3c8de15?source=collection_archive---------0-----------------------#2022-09-03">https://pub.towardsai.net/iot-real-time-analytics-wago-plc-with-databricks-auto-loader-4cd9d3c8de15?source=collection_archive---------0-----------------------#2022-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/67b5cced5d1330f4a2de2b7ab6796335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WOwBSWgT95TqsoSBw-LlQ.png"/></div></div></figure><p id="21ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现代企业拥有大量来自大量物联网设备和应用程序的数据，这些数据的文件格式多种多样。接收这些数据并将其转换为可读、有用的格式非常耗时且复杂。Auto Loader是Databricks的一款出色工具，它简化了解决方案，确保了流程的完全自动化，并支持实时决策。</p><p id="4575" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Databricks是一个可扩展的大数据分析平台，旨在用于数据科学和数据工程，以及与主要云平台亚马逊Web服务、微软Azure和谷歌云平台的集成。</p><p id="bc1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Auto Loader是Databricks的一项功能，每小时从数据湖中读取新到达的文件，以流形式或增量方式接收和转换数百万个文件。有关Databricks自动加载器的详细说明，请点击<a class="ae kw" href="http://linkedin.com/pulse/what-databricks-auto-loader-rory-mcmanus/" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="7ff0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Data Mastery最近与采矿行业的OEM合作部署了一个自动加载器解决方案，以接收和转换WAGO PLC设备到物联网中心的遥测数据。以前，OEM在现场手动下载数据文件，然后使用excel手动转换数据文件以生成可读的报告。Auto Loader完全自动化了这一过程，并自动提供可读的报告，消除了每班一个工时的手动数据处理，每个站点每周节省超过21个工时(24小时运行)。不用说，我们的客户对结果非常满意！</p><h1 id="14b6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何摄取和转换WAGO PLC设备数据</h1><p id="2114" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在本文中，我将解释我们如何创建一个流解决方案来接收和转换从多个站点和设备发送到物联网中心的WAGO PLC数据。</p><p id="b3ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据从1000x 16位Unicode寄存器开始。这用于MRA和PLC使用的ARM汇编语言中的计算。</p><p id="cb9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这种情况下，二进制寄存器内的编码被细分，以携带多条信息。日期和时间编码就是一个例子，秒和分钟在同一个16位寄存器中进行编码。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/65fbd9ec7d2468cd723dc17ba68ae7f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/0*lt_zqba7biLfS83A"/></div></figure><p id="b63d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然数据作为16位寄存器存储在WAGO PLC设备上，但它作为2000x 8位Unicode寄存器发送到物联网集线器，以减少发送的数据包大小。因此，作为转换为可读格式的一部分，它需要从8位寄存器转换回16位寄存器。</p><h1 id="a1cb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">解决办法</h1><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/c3402fb6f9d6fa1fa1235a819d2b1a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RLqgEOwVhMoDU2yW"/></div></div></figure><p id="6029" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用的解决方案遵循以下高级步骤:</p><ol class=""><li id="5947" class="mg mh iq ka b kb kc kf kg kj mi kn mj kr mk kv ml mm mn mo bi translated">WAGO PLC消息被发送到Azure IoT Hub，在那里这些消息根据它们的DeviceId以JSON格式被路由到特定的Azure存储容器。</li><li id="1bb0" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">当文件到达存储容器时，事件网格创建的订阅者在Azure存储队列上创建一条消息，包含新文件的位置和名称。</li><li id="1ab0" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">Databricks自动加载程序检查存储队列中的新消息，并在新消息到达时将文件流读入数据帧。</li></ol><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/4abd1c6e846e3028b0c41f002564697c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0HwR_LcIQUaVzIXc"/></div></div></figure><ol class=""><li id="7f84" class="mg mh iq ka b kb kc kf kg kj mi kn mj kr mk kv ml mm mn mo bi translated">然后，输入数据帧从2000×8位Unicode寄存器转换回1000×16位Unicode寄存器，并随后转换成所需的格式，例如，吨/小时、天、月/年等。</li><li id="8cec" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">然后将转换后的数据帧附加到功耗BI的增量表中。</li></ol><h1 id="ccfb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><ul class=""><li id="f73a" class="mg mh iq ka b kb lv kf lw kj mv kn mw kr mx kv my mm mn mo bi translated">配置WAGO PLC设备向Azure IoT Hub发送消息</li><li id="4f25" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv my mm mn mo bi translated">注册一个<a class="ae kw" href="https://docs.microsoft.com/en-us/azure/databricks/ingestion/auto-loader/file-detection-modes" rel="noopener ugc nofollow" target="_blank"> Azure服务主体</a> —用于自动创建事件网格/订阅和存储队列。或者，如果需要，您可以手动创建服务</li><li id="fcca" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv my mm mn mo bi translated">生成具有以下权限的存储队列<a class="ae kw" href="https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview" rel="noopener ugc nofollow" target="_blank">共享访问签名</a></li></ul><figure class="mb mc md me gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/6c4c017d33996c7bcbcc1c0dc3374ea8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/0*EI4rASjamGYzD0OJ"/></div></figure><ul class=""><li id="4589" class="mg mh iq ka b kb kc kf kg kj mi kn mj kr mk kv my mm mn mo bi translated">为<a class="ae kw" href="https://docs.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id" rel="noopener ugc nofollow" target="_blank"> SubscriptionId </a>、<a class="ae kw" href="https://docs.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id" rel="noopener ugc nofollow" target="_blank"> TenantId </a>、Bronze-Queue-ConnectionString(上面创建的)、服务主体ClientId &amp; ClientSecret(上面创建的)创建以下Azure密钥库机密</li></ul><h1 id="f08c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">要创建自动加载器流解决方案，必须完成以下步骤。</h1><ol class=""><li id="bcad" class="mg mh iq ka b kb lv kf lw kj mv kn mw kr mx kv ml mm mn mo bi translated">配置WAGO PLC设备向Azure IoT Hub发送消息</li><li id="f0ca" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">通过在DeviceId上过滤，将传入的物联网集线器消息路由到特定的存储容器</li><li id="edda" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">创建一个PySpark函数，使用Spark结构化流源cloudFiles从输入ADLS Gen2存储容器中读取数据</li><li id="e756" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">创建一个PySpark函数，将输入文件流转换成所需的输出列</li><li id="0961" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">将流或批处理数据帧写入数据块增量表</li><li id="e24d" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">测试:)</li></ol><h1 id="7057" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">详细步骤:</h1><ol class=""><li id="b0e6" class="mg mh iq ka b kb lv kf lw kj mv kn mw kr mx kv ml mm mn mo bi translated">配置WAGO PLC向Azure物联网中心发送消息</li><li id="3811" class="mg mh iq ka b kb mp kf mq kj mr kn ms kr mt kv ml mm mn mo bi translated">根据设备Id将传入的物联网集线器消息路由到特定的存储容器</li></ol><p id="6387" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.1.为ADLS第二代存储容器创建自定义端点</p><p id="63e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">物联网中心🠮消息路由🠮自定义端点🠮添加</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/88ba4fe554d186a1757911aedf01b91e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eCqhcjNC0eAyKcea"/></div></div></figure><p id="576b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.2.创建一个路由并添加一个查询以按设备Id进行筛选</p><p id="79cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">物联网中心🠮消息路由🠮路由🠮添加</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/1262a4ff61058fe07bb589e82869fac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FRF0nirKaWcgkqVB"/></div></div></figure><p id="d637" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.创建一个PySpark函数来读取存储队列中新到达的文件</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/353fd39def0d79dcc9ccf5e7020af329.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fsjTpr0M4M-WqmRp"/></div></div></figure><p id="d829" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.创建一个PySpark函数，将输入文件流dataframe转换为所需的输出列。</p><p id="a3ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:由于大量的转换，我只添加了一个样本转换</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/e9303606080835c431e4fdfdaf5a64d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*junYWlMWkL7E_eKC"/></div></div></figure><p id="e79f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.测试:)</p><p id="9b4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">端到端地运行该流程，以检查数据是否已经插入到表中。</p><h1 id="1dc8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="e571" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Auto Loader是一款出色的工具，可应用于任何行业的任何业务，以获得简单、省时的解决方案和实时数据。</p><p id="bac1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望您已经发现这是有帮助的，并将节省您的公司的金钱和时间开始使用Databricks自动装载机，我希望它将有助于推动见解，给你的业务带来价值。</p><p id="33ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想要一份我的代码，请在LinkedIn上给我留言，或者如果你像我一样喜欢阅读和写作，请与你的朋友分享。</p></div></div>    
</body>
</html>