<html>
<head>
<title>Monitor Machine Learning Experiments With MLFlow on Azure Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure Cloud上用MLFlow监控机器学习实验</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/monitor-machine-learning-experiments-with-mlflow-on-azure-cloud-a4de13a39735?source=collection_archive---------3-----------------------#2022-04-28">https://pub.towardsai.net/monitor-machine-learning-experiments-with-mlflow-on-azure-cloud-a4de13a39735?source=collection_archive---------3-----------------------#2022-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3ba7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">如何使用Azure Machine Learning在远程MLFlow跟踪服务器上设置和记录机器学习实验</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/b9b2f3c49b15322b0e6088e875fcf160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MdETjWvJUtussYRQ"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">奥斯卡·卡达克索在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="d985" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">1.介绍</h1><p id="8260" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">典型的机器学习工作流程包括数据预处理、超参数调整和模型评估等步骤。数据科学家可能需要试验超参数、模型算法和预处理步骤的组合，以获得所需的结果。记录超参数、模型算法、结果和模型工件对于确保机器学习实验的可重复性至关重要。使用MLFlow等MLOps工具可以简化这项艰巨的任务。</p><p id="8776" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">MLFlow  [1]是一个管理ML生命周期的开源平台，包括实验、可复制性、部署和中央模型注册。MLFlow提供4种不同的组件:</p><ol class=""><li id="b6a0" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated"><strong class="lu iu"> MLFlow Tracking: </strong>记录和查询实验:代码、数据、配置和结果</li><li id="b899" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><strong class="lu iu"> MLFlow项目:</strong>将数据科学代码打包成可在任何平台上运行的格式</li><li id="1f3b" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><strong class="lu iu"> MLFlow模型:</strong>在不同的服务环境中部署机器学习模型</li><li id="14fc" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated"><strong class="lu iu">模型注册:</strong>在中央存储库中存储、注释、发现和管理模型</li></ol><p id="0ae2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">人们可以在云虚拟机(如AWS EC2或Azure VM)上托管MLFlow跟踪服务器，但是设置服务器和工件存储的过程可能会很繁琐。一种替代方法是使用托管MLFlow解决方案，如Azure Machine Learning。</p><p id="0d1b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu"> Azure机器学习</strong>是微软Azure云计算平台的一部分，帮助数据科学家和工程师管理他们的机器学习工作流程[2]。每个Azure机器学习工作区都附带一个预配置的MLFlow服务器。我们将使用MLFlow跟踪功能将机器学习实验的参数、结果和工件记录到Azure机器学习服务托管的MLFLow服务器中。</p><p id="cafc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在本文中，我们将展示如何</p><ol class=""><li id="8b85" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">在Azure Machine Learning上设置远程MLFlow跟踪服务器</li><li id="05e2" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">使用scikit-learn在本地训练模型</li><li id="5ecb" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">将本地模型参数、结果和工件记录到远程MLFlow跟踪服务器上</li><li id="0349" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">从MLFlow跟踪服务器检索已训练的模型以进行离线批量评分</li></ol><h1 id="515f" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">2.设置</h1><p id="93b1" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在这一节中，我们看看如何设置Azure服务和模型训练环境。</p><h1 id="5cb4" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">2.1.创建Azure帐户</h1><p id="27d0" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">跟踪服务器将托管在Azure机器学习上，因此，我们需要有一个<a class="ae kz" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank"> Azure账户</a>。新帐户在前30天和12个月免费获得200美元的Azure点数，用于选择服务。</p><h1 id="d42b" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">2.2.设置Azure ML工作区</h1><p id="2e70" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated"><strong class="lu iu"> 1。创建资源组</strong></p><blockquote class="nh ni nj"><p id="9487" class="ls lt nk lu b lv mo ju lx ly mp jx ma nl mq md me nm mr mh mi nn ms ml mm mn im bi translated"><em class="it">资源组是一个为Azure解决方案[3]保存相关资源的容器。</em></p></blockquote><ul class=""><li id="0fed" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">转到<a class="ae kz" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">https://portal.azure.com/</a></li><li id="40f9" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn no mz na nb bi translated">在Azure Services下或通过搜索栏找到“资源组”</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi np"><img src="../Images/4bda1f4c43314183514dcf6ff1168eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*i31mS0k9R-lefzP1"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><ul class=""><li id="6191" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">创建新的资源组</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nq"><img src="../Images/fbff95b4f6d64b04f0fb0bee9cdf88e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pOgqe5opsbQJNx3W"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><ul class=""><li id="9698" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">填写详细信息，如订阅、资源组名称和区域</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nr"><img src="../Images/bce0cac75d3bac3b3cd8651341b73452.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QNPpmo4eDJAmlsMW"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><p id="be10" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu"> 2。创建Azure ML工作空间</strong></p><blockquote class="nh ni nj"><p id="6ef2" class="ls lt nk lu b lv mo ju lx ly mp jx ma nl mq md me nm mr mh mi nn ms ml mm mn im bi translated"><em class="it">工作区是Azure机器学习的顶级资源，提供了一个集中的地方来处理您在使用Azure机器学习时创建的所有工件。工作区保存了所有训练运行的历史，包括日志、指标、输出和脚本的快照。您使用这些信息来确定哪一次训练运行产生了最好的模型[4]。</em></p></blockquote><ul class=""><li id="440b" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">在Azure Services下或者通过搜索栏找到“机器学习”。</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ns"><img src="../Images/cdd24b18e4973c7a50c61bc20d5e3b26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qG8EHD_II_X63VHg"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><ul class=""><li id="5d80" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">点击创建</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nt"><img src="../Images/3321cd50983048b19f72fb6a9183d02e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*66RokNiKGDiBUSBp"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><ul class=""><li id="6419" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">填空。资源组是我们在上一步中创建的</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nu"><img src="../Images/99e8b1bea03058448787a1a314031152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fr6xn5UELKCt7jdP"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><ul class=""><li id="4312" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated">MLFlow跟踪服务器是作为Azure ML工作区的一部分自动创建的</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nv"><img src="../Images/b8ab59c8a11b2312ba83b3a556493403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3SPDq9CLrABG4CtUNr4qNQ.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><h1 id="99c8" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">2.3.设置培训环境</h1><p id="a556" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我们将使用本地培训环境(即在您的PC或笔记本电脑上)。</p><p id="66a4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu"> IDE </strong></p><p id="fcae" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我在Visual Studio代码中使用Jupyter笔记本。您可以自由使用任何IDE。</p><p id="d635" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">康达环境</strong></p><p id="94fc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">确保机器上安装了miniconda3。从命令行界面创建python 3.7 conda环境。环境名是任意的，我将其命名为<code class="fe nw nx ny nz b">general</code>。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="638a" class="oe lb it nz b gy of og l oh oi">#command line<br/>conda create -n general python=3.7</span></pre><p id="a307" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">激活康达环境。我们将在这种环境下进行所有的开发工作。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="57d0" class="oe lb it nz b gy of og l oh oi">#command line<br/>conda activate general</span></pre><p id="7a60" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu"> Python包</strong></p><p id="14cb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">确保Conda环境中安装了以下软件包</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="2539" class="oe lb it nz b gy of og l oh oi">azureml-core<br/>azureml-mlflow<br/>pandas<br/>numpy<br/>scikit-learn<br/>mlflow</span></pre><p id="b337" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu"> Azure机器学习工作区配置</strong></p><p id="f990" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">下载Azure机器学习工作区配置。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oj"><img src="../Images/bf7d3fad70ce96a55be09d372bec4a6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v9w9fkcwoZTOq7mK"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><p id="f0f7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">配置文件采用JSON格式，包含以下信息:</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="f563" class="oe lb it nz b gy of og l oh oi"># config.json</span><span id="9d40" class="oe lb it nz b gy ok og l oh oi">{<br/>    "subscription_id": "your-subscription-id",<br/>    "resource_group": "your-resource-group-name",<br/>    "workspace_name": "your-workspace-name"<br/>}</span></pre><p id="1f6f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们需要这些信息来连接到AML工作区进行记录实验。</p><p id="9518" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">项目结构</strong></p><p id="3950" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">下面是当前项目的本地目录。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/5e8cef7decb193eee45d671e981a148a.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/0*_ZO-fCv9sNYbMGML"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><ul class=""><li id="a2e2" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated"><code class="fe nw nx ny nz b">train.ipynb</code>:包含数据处理和训练代码</li><li id="36ac" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn no mz na nb bi translated"><code class="fe nw nx ny nz b">inference.ipynb</code>:包含离线批量评分代码</li><li id="679f" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn no mz na nb bi translated"><code class="fe nw nx ny nz b">config.json</code> : Azure ML工作区配置</li></ul><h1 id="0eee" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">3.<code class="fe nw nx ny nz b">train.ipynb</code></h1><p id="7079" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated"><strong class="lu iu">导入包</strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="96ac" class="oe lb it nz b gy of og l oh oi">import mlflow<br/>from azureml.core import Workspace<br/>import pandas as pd<br/>import numpy as np<br/>from sklearn.ensemble import RandomForestClassifier<br/>from sklearn.model_selection import GridSearchCV, train_test_split<br/>from sklearn.pipeline import Pipeline<br/>from sklearn.preprocessing import FunctionTransformer<br/>from sklearn.impute import SimpleImputer</span></pre><p id="6a7e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">设置工作空间</strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="32b1" class="oe lb it nz b gy of og l oh oi">ws = Workspace.from_config()</span></pre><p id="cf41" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">运行此单元后，您可能会得到一个URL来执行web身份验证。这是连接到Azure机器学习工作区所必需的。完成后，您可以返回IDE并继续下一步。</p><p id="4fdc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">设置跟踪URI </strong></p><p id="37ae" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">MLFlow跟踪URI是我们可以找到MLFlow跟踪服务器的地址。我们设置跟踪URI来让MLFlow也知道在哪里记录实验。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="2e1c" class="oe lb it nz b gy of og l oh oi">mlflow.set_tracking_uri(ws.get_mlflow_tracking_uri())</span></pre><p id="719f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">跟踪URI的格式如下</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="ac4d" class="oe lb it nz b gy of og l oh oi">azureml://&lt;region&gt;.api.azureml.ms/mlflow/v1.0/subscriptions/&lt;subscription-id&gt;/resourceGroups/&lt;resource-group&gt;/providers/Microsoft.MachineLearningServices/workspaces/&lt;aml-workspace&gt;?</span></pre><p id="a706" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你也可以在Azure机器学习工作区找到同样的追踪URI。</p><p id="8fd2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">设置MLFlow实验</strong></p><p id="4a05" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">下面的代码定义了MLFlow实验的名称。MLFlow实验是组织不同运行的一种方式。一个实验包含多次运行，每次运行都是训练代码的一次执行。我们可以为每次运行定义要存储的参数、结果和工件。如果实验名称不存在，将创建一个新的实验，否则它会将运行记录到同名的现有实验中。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="f2a5" class="oe lb it nz b gy of og l oh oi">experiment_name = 'diabetes'<br/>mlflow.set_experiment(experiment_name)</span></pre><p id="f6f2" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">数据预处理</strong></p><p id="49ea" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">让我们加载数据并执行训练测试分割。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="eca5" class="oe lb it nz b gy of og l oh oi">input_path = 'path/to/data.csv'</span><span id="56ac" class="oe lb it nz b gy ok og l oh oi">df = pd.read_csv(input_path, sep = ',')<br/>y = df.pop('Outcome')<br/>X = df</span><span id="835c" class="oe lb it nz b gy ok og l oh oi">X_train, X_test, y_train, y_test = train_test_split(X, y)</span></pre><p id="98cc" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们创建一个scikit-learn <code class="fe nw nx ny nz b">FunctionTransformer</code>来查找所选列中的“0”值，并用“NaN”替换它。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="2f85" class="oe lb it nz b gy of og l oh oi">def replace_zeros(x):<br/>		<br/>		x = x.copy()<br/>    x[['Glucose','BloodPressure','SkinThickness','Insulin','BMI']] = x[['Glucose','BloodPressure','SkinThickness','Insulin','BMI']].replace(0,np.NaN)</span><span id="cbf5" class="oe lb it nz b gy ok og l oh oi">    return x</span><span id="6c36" class="oe lb it nz b gy ok og l oh oi">ft_replace_zeros = FunctionTransformer(replace_zeros)</span></pre><p id="ea1d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">创建一个scikit-learn管道</strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="c92d" class="oe lb it nz b gy of og l oh oi">rf_clf = RandomForestClassifier()<br/>num_imputer = SimpleImputer()<br/>pipe = Pipeline([('replace_zeros', ft_replace_zeros), ('fillna', num_imputer), ('clf', rf_clf)])</span></pre><p id="6b01" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">以下是scikit-learn管道中的步骤:</p><ul class=""><li id="b4f5" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated"><code class="fe nw nx ny nz b">replace_zeros</code>:使用UDF和scikit-learn的<code class="fe nw nx ny nz b">FunctionTransformer</code>将所有“0”替换为“NaN”值</li><li id="aab2" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn no mz na nb bi translated"><code class="fe nw nx ny nz b">fillna</code>:使用scikit-learn的<code class="fe nw nx ny nz b">SimpleImputer</code>用列的平均值填充缺失值</li><li id="58ae" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn no mz na nb bi translated"><code class="fe nw nx ny nz b">clf</code>:随机森林分类器</li></ul><p id="1637" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">超参数调谐</strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="9cdf" class="oe lb it nz b gy of og l oh oi">mlflow.sklearn.autolog(max_tuning_runs=None)</span><span id="c6e9" class="oe lb it nz b gy ok og l oh oi">param_grid = {'clf__n_estimators': [1,2,3], 'clf__max_depth':[2,3,4]}</span><span id="b001" class="oe lb it nz b gy ok og l oh oi">clf = GridSearchCV(pipe, param_grid = param_grid, scoring = ['roc_auc', 'precision', 'recall', 'f1', 'accuracy'], refit = 'roc_auc')<br/>clf.fit(X_train, y_train)</span></pre><p id="6197" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">上述代码执行以下操作:</p><ol class=""><li id="8fb3" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">日志实验:在训练代码之前调用<code class="fe nw nx ny nz b">mlflow.sklearn.autolog()</code>可以自动记录参数、度量和模型。MLFlow向scikit-learn、TensorFlow、XGBoost等流行的机器学习框架提供<code class="fe nw nx ny nz b">autolog</code>。</li><li id="8ac1" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">用我们想要试验的参数创建一个参数网格<code class="fe nw nx ny nz b">param_grid</code></li><li id="53fa" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">执行<code class="fe nw nx ny nz b">GridSearchCV</code>搜索最佳参数。<code class="fe nw nx ny nz b">param_grid</code>中定义的每个超参数组合将用于交叉验证。结果、指标和工件将被记录到MLFlow中。</li></ol><p id="1e0a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我们可以在Azure机器学习(<a class="ae kz" href="https://ml.azure.com/" rel="noopener ugc nofollow" target="_blank">https://ml.azure.com/</a>)workspace→Experiments上查看运行结果。自动记录<code class="fe nw nx ny nz b">GridsearchCV</code>创建一个包含嵌套子运行的父运行。每组超参数被记录到单独子运行中。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi om"><img src="../Images/53225f9ce923ee171e730952689f14da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Gg8nTztPzt-qrgiYZukhA.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><p id="bac5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">子运行的详细信息可以在父运行中找到。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi on"><img src="../Images/a3021767b1ac3c5b6b69342733aa34a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkYyx0hqQAeDADBqnKpn5w.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><p id="20f7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">最佳子运行的参数、结果和模型也记录在父运行下。下图显示了最佳子运行的模型文件。带红色下划线的<code class="fe nw nx ny nz b">run_id</code>是产生最佳估计值的运行的唯一标识符。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oo"><img src="../Images/9f3528ec5352e3bec5d0cdb5872f43be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xxdsyuh6CfkbuQJI9B5lyw.png"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><h1 id="119d" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">4.<code class="fe nw nx ny nz b">inference.ipynb</code></h1><p id="b3dc" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">本节展示了如何基于其<code class="fe nw nx ny nz b">run_id</code>从Azure机器学习MLFlow实验中加载一个模型，并使用该模型进行离线批量评分。评分在本地计算机(即PC或笔记本电脑)上完成。本节假设推理环境与训练环境具有相同的依赖性。</p><p id="81ab" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">导入库</strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="6186" class="oe lb it nz b gy of og l oh oi">import mlflow<br/>from azureml.core import Workspace<br/>import pandas as pd</span></pre><p id="9498" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">配置Azure ML工作区&amp; MLFlow </strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="f06e" class="oe lb it nz b gy of og l oh oi">ws = Workspace.from_config()<br/>mlflow.set_tracking_uri(ws.get_mlflow_tracking_uri())</span></pre><p id="39db" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">负荷模型</strong></p><p id="ca8f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">可以使用<code class="fe nw nx ny nz b">run_id</code>从MLFlow中检索模型。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="9dbe" class="oe lb it nz b gy of og l oh oi">run_id = '15059f88-d2a8-4c7e-966a-e0a755c97a6e'<br/>model = mlflow.sklearn.load_model(f'runs:/{run_id}/best_estimator', './')</span></pre><p id="5995" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><code class="fe nw nx ny nz b">mlflow.sklearn.load_model()</code>的参数是:</p><ul class=""><li id="ab4e" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn no mz na nb bi translated"><code class="fe nw nx ny nz b">model_uri</code>:ml flow模型的位置，以URI格式表示。模型的路径采用格式<code class="fe nw nx ny nz b">runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model</code></li><li id="b837" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn no mz na nb bi translated"><code class="fe nw nx ny nz b">dst_path</code>–下载模型工件的本地文件系统路径。该目录必须已经存在。如果未指定，将创建本地输出路径。</li></ul><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi op"><img src="../Images/87dbb17ea1133ab4f095c265b5472920.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/0*iAk95mmDXbWakTcN"/></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk translated">作者图片</figcaption></figure><p id="5fe4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我们执行<code class="fe nw nx ny nz b">mlflow.sklearn.load_model()</code>时，包含<code class="fe nw nx ny nz b">model.pkl</code>的文件夹<code class="fe nw nx ny nz b">best_estimator</code>以及<code class="fe nw nx ny nz b">conda.yaml</code>、<code class="fe nw nx ny nz b">requirements.txt</code>和<code class="fe nw nx ny nz b">MLmodel</code>等依赖文件被下载到<code class="fe nw nx ny nz b">dst_path</code>中定义的本地目录。</p><p id="4e89" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">加载的模型(<code class="fe nw nx ny nz b">model.pkl</code>)是一个合适的scikit-learn管道对象。这与我们在培训阶段创建的管道相同。</p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="6cce" class="oe lb it nz b gy of og l oh oi">Pipeline(steps=[('replace_zeros',<br/>                 FunctionTransformer(func=&lt;function replace_zeros at 0x000001EBEF3F0AF8&gt;)),<br/>                ('fillna', SimpleImputer()),<br/>                ('clf', RandomForestClassifier(max_depth=3, n_estimators=3))])</span></pre><p id="b869" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><strong class="lu iu">根据新数据进行预测</strong></p><pre class="kk kl km kn gt oa nz ob oc aw od bi"><span id="7ff7" class="oe lb it nz b gy of og l oh oi">new_data = pd.read_csv('/path/to/new_data.csv', sep = ',')<br/>model.predict_proba(new_data) <br/>#OR<br/>model.predict(new_data)</span></pre><h1 id="096d" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">5.摘要</h1><p id="239d" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在本文中，我们讨论了在Azure Machine Learning上使用MLFlow跟踪机器学习实验的动机，并研究了如何:</p><ol class=""><li id="ff69" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">在Azure Machine Learning上设置远程MLFlow跟踪服务器</li><li id="557d" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">使用scikit-learn在本地训练模型</li><li id="6f3a" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">将模型参数、结果和工件记录到MLFlow上</li><li id="82a3" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">从MLFlow跟踪服务器检索已训练的模型以进行离线批量评分</li></ol><h1 id="1049" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">参考</h1><p id="5bed" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">[1] <a class="ae kz" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLFlow </a></p><p id="b71e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">[2] <a class="ae kz" href="https://docs.microsoft.com/en-us/azure/machine-learning/overview-what-is-azure-machine-learning" rel="noopener ugc nofollow" target="_blank">蔚蓝机器学习</a></p><p id="25fe" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">[3] <a class="ae kz" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal" rel="noopener ugc nofollow" target="_blank">资源组</a></p><p id="e0fa" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">[4] <a class="ae kz" href="https://docs.microsoft.com/en-us/azure/machine-learning/concept-workspace" rel="noopener ugc nofollow" target="_blank"> Azure机器学习工作区</a></p></div></div>    
</body>
</html>