<html>
<head>
<title>AWS Redshift ETL using Pandas API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pandas API的AWS红移ETL</h1>
<blockquote>原文：<a href="https://pub.towardsai.net/aws-redshift-etl-using-pandas-api-7609be7c9c4f?source=collection_archive---------5-----------------------#2021-01-28">https://pub.towardsai.net/aws-redshift-etl-using-pandas-api-7609be7c9c4f?source=collection_archive---------5-----------------------#2021-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="b38b" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsai.net/p/category/cloud-computing" rel="noopener ugc nofollow" target="_blank">云计算</a></h2><div class=""/><p id="44c3" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">这篇博客的目的是用AWS红移数据库执行一个简单的ETL练习。Oracle数据库表用作源数据集，使用Pandas方法对数据集执行简单的转换，并将数据集写入AWS红移表。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ku"><img src="../Images/3afdf88d275eaee671c57bdc5e10197f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*RuBbjYHXH7dJSj22WitczQ.png"/></div></figure><ol class=""><li id="6295" class="lc ld iq jy b jz ka kd ke kh le kl lf kp lg kt lh li lj lk bi translated"><strong class="jy ja">导入先决条件和与源Oracle的连接:</strong></li></ol><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="9344" class="lq lr iq lm b gy ls lt l lu lv">import pandas as pd<br/>from sqlalchemy import create_engine</span><span id="3bd1" class="lq lr iq lm b gy lw lt l lu lv">engine = create_engine(‘oracle://scott:scott@oracle’, echo=False)</span></pre><p id="d47c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">2 <strong class="jy ja">。从Oracle数据库中提取数据集:</strong></p><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="b412" class="lq lr iq lm b gy ls lt l lu lv">#Employee Dataset<br/>emp_df=pd.read_sql_query(‘select * from emp’,engine)<br/>emp_df.head(10)</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/04c9f6edfaf8b1c9361648f674aca54a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*xk1uYshhr8dg10hEsUZ8Tg.png"/></div></figure><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="699a" class="lq lr iq lm b gy ls lt l lu lv">#Department Dataset<br/>dept_df=pd.read_sql_query(‘select * from dept’,engine)<br/>dept_df.head(10)</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/d0e5a10360c8c40d42f25f08d5697187.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*0pUis_E8i_lfogFU_sjNvQ.png"/></div></figure><p id="5929" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">3.<strong class="jy ja">变换数据集</strong></p><p id="4784" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">使用以下脚本创建AWS红移目标表:</p><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="f67f" class="lq lr iq lm b gy ls lt l lu lv">create table emp (<br/> empno integer,<br/> ename varchar(20),<br/> sal integer,<br/> comm float,<br/> deptno integer, <br/> dname varchar(20)<br/>);</span></pre><p id="57c6" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">加入<strong class="jy ja"> EMP </strong>和<strong class="jy ja"> DEPT </strong>数据集:</p><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="11db" class="lq lr iq lm b gy ls lt l lu lv">joined_df=pd.merge(emp_df,dept_df,left_on=’deptno’,right_on=’deptno’,how=’inner’)<br/>joined_df.head(10)</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lz"><img src="../Images/508ab59dcb74ef7b92c2d6e1b56c1ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k1XrG-_q21tumIJkMMVWRQ.png"/></div></div></figure><p id="5bd2" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">删除目标中不存在的列:</p><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="a394" class="lq lr iq lm b gy ls lt l lu lv">joined_df.drop(columns=['job','mgr','hiredate','loc'],inplace=True)<br/>joined_df.head(10)</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div class="gh gi me"><img src="../Images/bee9c436fd2a28686b085dd945130103.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*8B_8Cie29V5QzFGA93f3Yg.png"/></div></figure><p id="149a" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja"> 4。创建红移连接并插入数据</strong></p><pre class="kv kw kx ky gt ll lm ln lo aw lp bi"><span id="ad92" class="lq lr iq lm b gy ls lt l lu lv">#create connection object<br/>conn=create_engine(‘postgresql+psycopg2://&lt;dbuser&gt;:<a class="ae mf" href="mailto:Hasard51@pyspark-redshift.ci5lzce0jb5u.us-east-2.redshift.amazonaws.com" rel="noopener ugc nofollow" target="_blank">&lt;dbpassword&gt;@&lt;</a>cluster_endpoint_URL&gt;:5439/&lt;dbname&gt;’)</span><span id="0bfe" class="lq lr iq lm b gy lw lt l lu lv">joined_df.to_sql(‘emp’, conn, index=False, if_exists=’append’)</span></pre><p id="022c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">验证红移表中的数据。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mg"><img src="../Images/b43af7feb23e86c7296ddef187982e41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*waCS6nTeBjy5Y3YAg9ojUw.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">AWS红移控制台</figcaption></figure><p id="2d7b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">从AWS控制台查询"<strong class="jy ja"> emp </strong>"表，我们还可以在本地系统上设置SQLWorkbench来查询红移表。</p><p id="745c" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">DML操作成功。</p><p id="825b" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja"> 5。我面临的连接问题</strong></p><blockquote class="ml mm mn"><p id="c0cb" class="jw jx mo jy b jz ka kb kc kd ke kf kg mp ki kj kk mq km kn ko mr kq kr ks kt ij bi translated">OperationalError: (psycopg2。OperationalError)无法连接到服务器:连接超时(0x0000274C/10060)服务器是否在主机" redshift _ cluster _ name . unique _ here . region . redshift . Amazon AWS . com "(<ip address="">)上运行并在端口5439上接受TCP/IP连接？</ip></p></blockquote><p id="4b37" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">问题描述</strong></p><p id="0967" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">问题是安全组中的入站规则将一个安全组指定为源。将它更改为包含我的IP地址的CIDR解决了这个问题。</p><p id="4ac1" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated"><strong class="jy ja">怎么修？</strong></p><p id="8fc9" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">转到群集属性→网络安全</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi ms"><img src="../Images/aec9bc62b24d8badc44ef31ee14f8bde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R1FzRihMAUAAS2OBUPS1Qg.png"/></div></div></figure><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mt"><img src="../Images/811162ae141c2925c875bb9d91b6bb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*piRDLdb87mPgTH3oOxTsuA.png"/></div></div></figure><p id="2ca0" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">转到VPC安全组→入站规则→编辑入站规则并在下面添加两个规则→单击保存规则。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mu"><img src="../Images/16f32e0c5bd01da64fd1a1e5764ca8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xfd2vZmaVLFrTdd2mAMpaQ.png"/></div></div></figure><p id="a6b8" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">我们准备好出发了。如果没有第二条规则，可能会出现AWS红移数据库的连接问题。因此，请按照上述步骤来避免/解决问题。</p><p id="bcc5" class="pw-post-body-paragraph jw jx iq jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ij bi translated">感谢大家阅读我的博客。请分享您的观点或反馈。</p></div></div>    
</body>
</html>